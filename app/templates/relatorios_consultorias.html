{% extends "consultorias_base.html" %}

{% block title %}Relatorios de Inclusoes{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 1200px;">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="text-primary mb-1">
                <i class="bi bi-bar-chart-line me-2"></i>Relatorios
            </h1>
            <p class="text-muted mb-0">Estatisticas de inclusoes</p>
        </div>
    </div>

    <form method="get" class="row g-3 mb-4">
        <div class="col-auto">
            <input type="date" name="inicio" class="form-control" value="{{ inicio }}">
        </div>
        <div class="col-auto">
            <input type="date" name="fim" class="form-control" value="{{ fim }}">
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-outline-secondary"><i class="bi bi-search"></i></button>
        </div>
    </form>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Inclusoes por Consultoria</span>
                    <span class="badge bg-primary bg-opacity-10 text-primary fw-semibold">Total {{ chart_consultoria.total }}</span>
                </div>
                <div class="card-body">
                    <div class="rounded border bg-white" style="height: 240px;">
                        <canvas id="consultoria-chart" class="p-2"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card shadow-sm h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Inclusoes por Usuario</span>
                    <span class="badge bg-primary bg-opacity-10 text-primary fw-semibold">Total {{ chart_usuario.total }}</span>
                </div>
                <div class="card-body">
                    <div class="rounded border bg-white" style="height: 240px;">
                        <canvas id="usuario-chart" class="p-2"></canvas>
                    </div>
                </div>
            </div>
        </div>

        {% if inicio or fim %}
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">Inclusoes por Data</div>
                <div class="table-responsive">
                    <table class="table table-striped mb-0">
                        <thead>
                            <tr><th>Data</th><th>Total</th></tr>
                        </thead>
                        <tbody>
                            {% for data, total in por_data %}
                            <tr><td>{{ data.strftime('%d/%m/%Y') if data else 'N/D' }}</td><td>{{ total }}</td></tr>
                            {% else %}
                            <tr><td colspan="2" class="text-center py-4 text-muted">Nenhum registro</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
    const chartPalette = ['#2563eb','#22c55e','#f97316','#a855f7','#facc15','#38bdf8','#ef4444','#14b8a6','#f472b6','#8b5cf6','#0ea5e9','#65a30d'];

    function shadeColor(color, percent) {
        const num = parseInt(color.slice(1), 16);
        const amt = Math.round(2.55 * percent);
        let r = (num >> 16) + amt;
        let g = (num >> 8 & 0x00ff) + amt;
        let b = (num & 0x0000ff) + amt;
        r = Math.max(Math.min(r, 255), 0);
        g = Math.max(Math.min(g, 255), 0);
        b = Math.max(Math.min(b, 255), 0);
        return `#${(1 << 24 | (r << 16) | (g << 8) | b).toString(16).slice(1)}`;
    }

    function buildPalette(size) {
        const colors = [];
        for (let i = 0; i < size; i++) {
            colors.push(chartPalette[i % chartPalette.length]);
        }
        return colors;
    }

    function buildDataset(config) {
        const colors = buildPalette(config.labels?.length || 0);
        const hover = colors.map(color => shadeColor(color, 12));
        const dataset = {
            label: config.datasetLabel || '',
            data: config.values || [],
            backgroundColor: colors,
            hoverBackgroundColor: hover,
        };
        if ((config.type || 'bar') === 'bar') {
            dataset.borderRadius = 10;
            dataset.maxBarThickness = 42;
        } else {
            dataset.borderWidth = 2;
            dataset.borderColor = '#ffffff';
        }
        return dataset;
    }

    function buildOptions(config) {
        const isBar = (config.type || 'bar') === 'bar';
        const options = {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 320, easing: 'easeOutQuart' },
            plugins: {
                legend: {
                    display: !isBar,
                    position: 'bottom',
                    labels: { usePointStyle: true, padding: 12, font: { size: 11 } },
                },
                title: {
                    display: Boolean(config.title),
                    text: config.title,
                    font: { size: 15, weight: '600' },
                    padding: { bottom: 8 },
                },
                tooltip: {
                    backgroundColor: '#111827',
                    titleFont: { size: 12, weight: '600' },
                    bodyFont: { size: 11 },
                    padding: 10,
                },
            },
        };
        if (isBar) {
            options.scales = {
                x: {
                    title: config.xTitle ? { display: true, text: config.xTitle } : undefined,
                    ticks: { autoSkip: true, maxRotation: 0, font: { size: 10 } },
                    grid: { display: false },
                },
                y: {
                    title: config.yTitle ? { display: true, text: config.yTitle } : undefined,
                    beginAtZero: true,
                    ticks: { stepSize: 1, precision: 0, font: { size: 10 } },
                    grid: { color: '#e5e7eb' },
                },
            };
        } else {
            options.cutout = '60%';
        }
        return options;
    }

    function createChart(canvasId, config) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !config) {
            return;
        }
        new Chart(canvas, {
            type: config.type || 'bar',
            data: { labels: config.labels || [], datasets: [buildDataset(config)] },
            options: buildOptions(config),
        });
    }

    createChart('consultoria-chart', {{ chart_consultoria|tojson }});
    createChart('usuario-chart', {{ chart_usuario|tojson }});
</script>
{% endblock %}
