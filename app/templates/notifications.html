{% extends "base.html" %}

{% block title %}Notificações{% endblock %}

{% block extra_css %}
<style>
  .notifications-header {
    background: linear-gradient(135deg, rgba(13, 110, 253, 0.16), rgba(13, 110, 253, 0.04));
    border-radius: 1.25rem;
    border: 1px solid rgba(13, 110, 253, 0.2);
    padding: 1.75rem;
    box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
  }

  .notifications-header__text h1 {
    color: #0b3b8c;
  }

  .notifications-header__text p {
    color: rgba(15, 23, 42, 0.72);
  }

  .notifications-header__cta {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .notification-summary {
    margin-top: 1.25rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
    gap: 0.85rem;
  }

  .notification-summary__card {
    border-radius: 1rem;
    background: #fff;
    border: 1px solid rgba(15, 23, 42, 0.08);
    padding: 1rem 1.25rem;
    box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
  }

  .notification-summary__card small {
    letter-spacing: 0.08em;
    font-size: 0.65rem;
    text-transform: uppercase;
  }

  .notification-summary__icon {
    width: 42px;
    height: 42px;
    border-radius: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    background: rgba(13, 110, 253, 0.08);
  }

  .notification-summary__card.text-success .notification-summary__icon {
    background: rgba(16, 185, 129, 0.12);
  }

  .notification-summary__card.text-warning .notification-summary__icon {
    background: rgba(251, 191, 36, 0.18);
  }

  .notification-summary__card p {
    font-size: 0.85rem;
    color: rgba(15, 23, 42, 0.72);
    margin: 0;
  }

  .notification-card {
    border: none;
    background: transparent;
    padding: 0;
  }

  .notification-card .list-group {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.85rem;
  }

  .notification-card .list-group-item {
    border: none;
    border-radius: 1.1rem;
    padding: 1.5rem;
    background: #fff;
    box-shadow: 0 18px 40px rgba(15, 23, 42, 0.05);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }

  .notification-card .list-group-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 22px 50px rgba(15, 23, 42, 0.08);
  }

  .notification-row {
    position: relative;
  }

  .notification-row-unread {
    border: 1px solid rgba(13, 110, 253, 0.2);
    background: linear-gradient(180deg, rgba(13, 110, 253, 0.08), #fff);
  }

  .notification-icon {
    width: 52px;
    height: 52px;
    min-width: 52px;
    border-radius: 1rem;
    background: rgba(13, 110, 253, 0.08);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #0a58ca;
    font-size: 1.4rem;
  }

  .notification-content__title {
    font-size: 1rem;
    line-height: 1.4;
  }

  .notification-pill {
    border-radius: 999px;
    padding: 0.25rem 0.9rem;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.02em;
  }

  .notification-pill--new {
    background: rgba(13, 110, 253, 0.15);
    color: #0a58ca;
  }

  .notification-pill--read {
    background: rgba(108, 117, 125, 0.1);
    color: #6c757d;
  }

  .notification-type-badge {
    border-radius: 0.75rem;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: 1px solid transparent;
  }

  .notification-type-badge--announcement {
    background: rgba(13, 110, 253, 0.12);
    color: #0d6efd;
    border-color: rgba(13, 110, 253, 0.3);
  }

  .notification-type-badge--task {
    background: rgba(14, 165, 233, 0.12);
    color: #0c85c2;
    border-color: rgba(14, 165, 233, 0.25);
  }

  .notification-type-badge--task-response {
    background: rgba(16, 185, 129, 0.15);
    color: #0f9d58;
    border-color: rgba(16, 185, 129, 0.3);
  }

  .notification-type-badge--task-status {
    background: rgba(251, 191, 36, 0.16);
    color: #ca8a04;
    border-color: rgba(251, 191, 36, 0.35);
  }

  .notification-row-unread .notification-content__title {
    color: #0d6efd;
    text-decoration: underline;
    text-underline-offset: 4px;
  }

  .notification-row-unread::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 2px solid rgba(13, 110, 253, 0.25);
    pointer-events: none;
  }

  .notification-actions .btn {
    border-radius: 999px;
    padding: 0.35rem 0.85rem;
    font-size: 0.85rem;
  }

  .notification-actions .badge {
    border-radius: 999px;
    font-size: 0.85rem;
  }

  .notification-empty-state {
    padding: 4rem 2rem;
    background: #fff;
    border-radius: 1.25rem;
    border: 1px dashed rgba(59, 130, 246, 0.4);
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.05);
  }

  @media (max-width: 576px) {
    .notification-actions {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container py-4">
  {% set total_notifications = notifications|length %}
  {% set read_total = total_notifications - unread_total if total_notifications > unread_total else 0 %}
  <div class="notifications-header mb-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
      <div class="notifications-header__text">
        <h1 class="h3 mb-1">Notificações</h1>
        <p class="text-muted mb-0">Acompanhe as tarefas e avisos atribuídos para você.</p>
      </div>
      <div class="notifications-header__cta">
        {% if current_user.role == 'admin' %}
        <button
          class="btn btn-sm btn-outline-primary"
          id="markAllNotifications"
          type="button"
          {% if unread_total == 0 %}disabled{% endif %}
        >
          Marcar todas como lidas
        </button>
        {% endif %}
        <span
          class="badge bg-white text-primary border border-primary border-opacity-25 fw-semibold"
          data-notifications-new-badge
        >
          {{ unread_total }} novas
        </span>
      </div>
    </div>
      <div class="notification-summary">
        <div class="notification-summary__card">
          <div class="d-flex align-items-center gap-2 mb-1">
            <span class="notification-summary__icon text-primary">
              <i class="bi bi-bell-fill"></i>
            </span>
            <div>
              <small>Pendentes</small>
              <div class="h4 mb-0 fw-semibold" data-notifications-pending>{{ unread_total }}</div>
            </div>
          </div>
        </div>
        <div class="notification-summary__card text-success">
          <div class="d-flex align-items-center gap-2 mb-1">
            <span class="notification-summary__icon text-success">
              <i class="bi bi-check-circle-fill"></i>
            </span>
            <div>
              <small>Lidas</small>
              <div class="h4 mb-0 fw-semibold" data-notifications-read>{{ read_total }}</div>
            </div>
          </div>
        </div>
      </div>
  </div>

  {% set notification_type_labels = {
    'announcement': 'Comunicado',
    'task': 'Tarefa',
    'task_response': 'Resposta',
    'task_status': 'Status'
  } %}

  {% if notifications %}
  <div class="card shadow-sm notification-card">
    <ul class="list-group list-group-flush" id="notificationsList">
      {% for notification in notifications %}
      <li
        class="list-group-item notification-row d-flex flex-column gap-3{% if not notification.is_read %} notification-row-unread{% endif %}"
        data-id="{{ notification.id }}"
        data-notification-type="{{ notification.type or 'task' }}"
      >
        {% set type_key = notification.type or 'task' %}
        <div class="d-flex align-items-start gap-3">
          <div class="notification-icon">
            <i class="bi bi-bell-fill"></i>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
              <div class="notification-content__title fw-semibold mb-1">{{ notification.message }}</div>
              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="notification-type-badge notification-type-badge--{{ type_key|replace('_','-') }}">
                  {{ notification_type_labels.get(type_key, 'Tarefa') }}
                </span>
                {% if not notification.is_read %}
                <span class="notification-pill notification-pill--new">Novo</span>
                {% endif %}
              </div>
            </div>
            <div class="text-muted small">{{ notification.created_at_display }}</div>
          </div>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2 align-items-start notification-actions">
          {% if notification.url %}
          <a class="btn btn-sm btn-outline-secondary open-notification-link" href="{{ notification.url }}" data-id="{{ notification.id }}" data-is-read="{{ notification.is_read|lower }}">
            {{ notification.action_label or 'Abrir' }}
          </a>
          {% endif %}
          {% if not notification.is_read %}
          <button class="btn btn-sm btn-primary mark-notification-read" data-id="{{ notification.id }}">
            Marcar como lida
          </button>
          {% else %}
          <span class="notification-pill notification-pill--read">Lida</span>
          {% endif %}
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% else %}
  <div class="card shadow-sm notification-card">
    <div class="notification-empty-state text-center">
      <i class="bi bi-bell-slash display-5 text-muted mb-3"></i>
      <h2 class="h5 mb-2">Você está em dia!</h2>
      <p class="text-muted mb-0">Nenhuma notificação pendente no momento.</p>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('notificationsList');
    const markAllBtn = document.getElementById('markAllNotifications');
    const csrfToken = window.csrfToken || '';
    const summaryPendingEl = document.querySelector('[data-notifications-pending]');
    const summaryReadEl = document.querySelector('[data-notifications-read]');
    const newBadgeEl = document.querySelector('[data-notifications-new-badge]');

    function updateNavBadge(unread) {
      const badge = document.querySelector('[data-notifications-badge]');
      if (!badge) {
        return;
      }
      if (unread > 0) {
        badge.textContent = unread;
        badge.classList.remove('d-none');
      } else {
        badge.textContent = '0';
        badge.classList.add('d-none');
      }
    }

    function markNotificationRead(id, row) {
      return fetch(`/notifications/${id}/read`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
        },
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error('Erro ao marcar notificação como lida');
          }
          return response.json();
        })
        .then(() => {
          if (row) {
            row.classList.remove('notification-row-unread');
            const badge = row.querySelector('.badge');
            const button = row.querySelector('.mark-notification-read');
            if (button) {
              button.remove();
            }
            if (badge) {
              badge.textContent = 'Lida';
            } else {
              const status = document.createElement('span');
              status.className = 'badge bg-light text-muted';
              status.textContent = 'Lida';
              const actions = row.querySelector('div.d-flex');
              if (actions) {
                actions.appendChild(status);
              }
            }
          }
        });
    }

    function updateSummaryCounts(unread) {
      let totalCount = 0;
      if (list) {
        totalCount = list.querySelectorAll('.notification-row').length;
      }

      const readCount = Math.max(totalCount - unread, 0);

      if (summaryPendingEl) {
        summaryPendingEl.textContent = unread;
      }
      if (summaryReadEl) {
        summaryReadEl.textContent = readCount;
      }
      if (newBadgeEl) {
        newBadgeEl.textContent = `${unread} novas`;
      }
    }

    function handleUnreadState() {
      if (!list) {
        return;
      }
      const unreadRows = list.querySelectorAll('.notification-row-unread');
      const unreadCount = unreadRows.length;
      if (markAllBtn) {
        markAllBtn.disabled = unreadCount === 0;
      }
      updateNavBadge(unreadCount);
      updateSummaryCounts(unreadCount);
    }

    if (list) {
      // Handler para o botão "Marcar como lida"
      list.addEventListener('click', (event) => {
        const button = event.target.closest('.mark-notification-read');
        if (!button) {
          return;
        }
        const id = button.dataset.id;
        const row = button.closest('.list-group-item');
        if (!id || !row) {
          return;
        }
        button.disabled = true;
        markNotificationRead(id, row)
          .catch(() => {
            button.disabled = false;
          })
          .finally(() => {
            handleUnreadState();
          });
      });

      // Handler para os botões "Abrir tarefa" e "Abrir comunicado"
      list.addEventListener('click', (event) => {
        const link = event.target.closest('.open-notification-link');
        if (!link) {
          return;
        }

        const id = link.dataset.id;
        const isRead = link.dataset.isRead === 'true';
        const targetUrl = link.getAttribute('href');

        if (!id || !targetUrl) {
          return;
        }

        // Se já está lida, apenas navega
        if (isRead) {
          return;
        }

        // Prevenir navegação padrão para marcar como lida primeiro
        event.preventDefault();

        const row = link.closest('.list-group-item');

        // Marcar como lida e depois navegar
        markNotificationRead(id, row)
          .catch(() => {})
          .finally(() => {
            handleUnreadState();
            // Navegar para a URL
            window.location.href = targetUrl;
          });
      });
    }

    if (markAllBtn) {
      markAllBtn.addEventListener('click', (event) => {
        event.preventDefault();
        if (markAllBtn.disabled) {
          return;
        }
        markAllBtn.disabled = true;
        fetch('/notifications/read-all', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error('Erro ao marcar todas como lidas');
            }
            return response.json();
          })
          .then(() => {
            if (list) {
              list.querySelectorAll('.notification-row-unread').forEach((row) => {
                row.classList.remove('notification-row-unread');
                const button = row.querySelector('.mark-notification-read');
                if (button) {
                  button.remove();
                }
                const badge = row.querySelector('.badge');
                if (badge) {
                  badge.textContent = 'Lida';
                } else {
                  const status = document.createElement('span');
                  status.className = 'badge bg-light text-muted';
                  status.textContent = 'Lida';
                  const actions = row.querySelector('div.d-flex');
                  if (actions) {
                    actions.appendChild(status);
                  }
                }
              });
            }
          })
          .catch(() => {
            markAllBtn.disabled = false;
          })
          .finally(() => {
            handleUnreadState();
          });
      });
    }

    handleUnreadState();
  });
</script>
{% endblock %}
