{% extends "base.html" %}

{% block title %}Notificações{% endblock %}

{% block extra_css %}
<style>
  .notifications-header {
    background: linear-gradient(120deg, #ffffff, #f6f8ff);
    border-radius: 1.1rem;
    border: 1px solid rgba(11, 40, 139, 0.08);
    padding: 1.5rem;
    box-shadow: 0 10px 28px rgba(15, 23, 42, 0.08);
  }

  .notifications-header__text h1 {
    color: #0b288b;
  }

  .notifications-header__text p {
    color: #4b5563;
  }

  .notifications-header__cta {
    display: flex;
    gap: 0.6rem;
    flex-wrap: wrap;
    align-itens: center;
  }

  .notification-summary {
    margin-top: 1.1rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 0.75rem;
  }

  .notification-summary__card {
    border-radius: 0.95rem;
    background: #fff;
    border: 1px solid rgba(11, 40, 139, 0.08);
    padding: 1rem 1.1rem;
    box-shadow: 0 8px 18px rgba(15, 23, 42, 0.05);
  }

  .notification-summary__card small {
    letter-spacing: 0.08em;
    font-size: 0.65rem;
    text-transform: uppercase;
  }

  .notification-summary__icon {
    width: 42px;
    height: 42px;
    border-radius: 12px;
    display: inline-flex;
    align-itens: center;
    justify-content: center;
    font-size: 1.05rem;
    background: rgba(11, 40, 139, 0.09);
    color: #0b288b;
  }

  .notification-summary__card.text-success .notification-summary__icon {
    background: rgba(16, 185, 129, 0.12);
  }

  .notification-summary__card.text-warning .notification-summary__icon {
    background: rgba(251, 191, 36, 0.15);
  }

  .notification-summary__card p {
    font-size: 0.85rem;
    color: rgba(15, 23, 42, 0.72);
    margin: 0;
  }

  .notification-card {
    border: none;
    background: transparent;
    padding: 0;
  }

  .notification-card .list-group {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.65rem;
  }

  .notification-card .list-group-item {
    border: 1px solid rgba(0, 0, 0, 0.06);
    border-radius: 0.95rem;
    padding: 1.1rem 1.25rem;
    background: #fff;
    box-shadow: 0 10px 20px rgba(15, 23, 42, 0.05);
    transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
  }

  .notification-card .list-group-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 16px 30px rgba(15, 23, 42, 0.08);
    border-color: rgba(11, 40, 139, 0.14);
  }

  .notification-row {
    position: relative;
  }

  .notification-row-unread {
    border: 1px solid rgba(13, 110, 253, 0.2);
    background: linear-gradient(180deg, rgba(13, 110, 253, 0.08), #fff);
  }

  .notification-icon {
    width: 48px;
    height: 48px;
    min-width: 48px;
    border-radius: 14px;
    background: linear-gradient(145deg, #0b288b, #1237b7);
    display: none;
    align-itens: center;
    justify-content: center;
    color: #fff;
    font-size: 1.2rem;
    box-shadow: 0 12px 22px rgba(11, 40, 139, 0.22);
  }

  .notification-row-unread .notification-icon {
    display: inline-flex;
  }

  .notification-content__title {
    font-size: 1rem;
    line-height: 1.4;
  }

  .notification-pill {
    border-radius: 999px;
    padding: 0.25rem 0.9rem;
    font-size: 0.8rem;
    font-weight: 600;
    letter-spacing: 0.02em;
  }

  .notification-pill--new {
    background: rgba(11, 40, 139, 0.12);
    color: #0b288b;
  }

  .notification-pill--read {
    background: rgba(108, 117, 125, 0.12);
    color: #4b5563;
  }

  .notification-type-badge {
    border-radius: 0.75rem;
    padding: 0.25rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    display: inline-flex;
    align-itens: center;
    justify-content: center;
    border: 1px solid transparent;
  }

  .notification-type-badge--announcement {
    background: rgba(11, 40, 139, 0.08);
    color: #0b288b;
    border-color: rgba(11, 40, 139, 0.25);
  }

  .notification-type-badge--client-announcement {
    background: rgba(14, 116, 144, 0.12);
    color: #0e7490;
    border-color: rgba(14, 116, 144, 0.3);
  }

  .notification-type-badge--task {
    background: rgba(14, 165, 233, 0.12);
    color: #0c85c2;
    border-color: rgba(14, 165, 233, 0.25);
  }

  .notification-type-badge--task-response {
    background: rgba(16, 185, 129, 0.15);
    color: #0f9d58;
    border-color: rgba(16, 185, 129, 0.3);
  }

  .notification-type-badge--task-status {
    background: rgba(251, 191, 36, 0.16);
    color: #ca8a04;
    border-color: rgba(251, 191, 36, 0.35);
  }

  .notification-row-unread .notification-content__title {
    color: #0b288b;
  }

  .notification-row-unread {
    border-color: rgba(11, 40, 139, 0.18);
    box-shadow: 0 12px 26px rgba(11, 40, 139, 0.08);
  }

  .notification-actions .btn {
    border-radius: 999px;
    padding: 0.35rem 0.85rem;
    font-size: 0.85rem;
  }

  .notification-actions .badge {
    border-radius: 999px;
    font-size: 0.85rem;
  }

  :root[data-theme="dark"] .notification-actions .btn-outline-secondary {
    border-color: rgba(255, 255, 255, 0.35);
    color: #e8ecf5;
    background: #111827;
  }

  :root[data-theme="dark"] .notification-actions .btn-outline-secondary:hover,
  :root[data-theme="dark"] .notification-actions .btn-outline-secondary:focus {
    border-color: rgba(255, 255, 255, 0.6);
    color: #ffffff;
    background: rgba(255, 255, 255, 0.08);
  }

  :root[data-theme="dark"] .notification-actions .btn-primary {
    background: #5c7cfa;
    border-color: #5c7cfa;
    color: #ffffff;
  }

  :root[data-theme="dark"] .notification-actions .btn-primary:hover,
  :root[data-theme="dark"] .notification-actions .btn-primary:focus {
    background: #708dff;
    border-color: #708dff;
  }

  .notification-empty-state {
    padding: 4rem 2rem;
    background: #fff;
    border-radius: 1.25rem;
    border: 1px dashed rgba(59, 130, 246, 0.4);
    box-shadow: 0 16px 40px rgba(15, 23, 42, 0.05);
  }

  @media (max-width: 576px) {
    .notification-actions {
      width: 100%;
    }
  }

  .notification-filters {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    align-itens: center;
    margin-bottom: 1rem;
  }

  .notification-filters .btn {
    border-radius: 999px;
    border-color: rgba(11, 40, 139, 0.25);
    color: #0b288b;
    background: #fff;
  }

  .notification-filters .btn.active {
    background: #0b288b;
    color: #fff;
    border-color: #0b288b;
  }

  .notification-search {
    min-width: 220px;
  }

  .notification-meta-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
    align-itens: center;
  }

  /* Tema escuro */
  :root[data-theme="dark"] .notifications-header {
    background: linear-gradient(120deg, #0f1625, #111b2c);
    border-color: var(--card-border-color);
    box-shadow: 0 16px 36px rgba(0, 0, 0, 0.4);
  }

  :root[data-theme="dark"] .notifications-header__text h1 {
    color: #e8ecf5;
  }

  :root[data-theme="dark"] .notifications-header__text p {
    color: #9aa6b5;
  }

  :root[data-theme="dark"] .notification-summary__card {
    background: #0f1625;
    border-color: var(--card-border-color);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
    color: #e8ecf5;
  }

  :root[data-theme="dark"] .notification-summary__card p,
  :root[data-theme="dark"] .notification-summary__card small {
    color: #cfd5e2;
  }

  :root[data-theme="dark"] .notification-summary__icon {
    background: rgba(92, 124, 250, 0.16);
    color: #dce3ff;
  }

  :root[data-theme="dark"] .notification-summary__card.text-success .notification-summary__icon {
    background: rgba(16, 185, 129, 0.18);
  }

  :root[data-theme="dark"] .notification-summary__card.text-warning .notification-summary__icon {
    background: rgba(251, 191, 36, 0.2);
  }

  :root[data-theme="dark"] .notification-card .list-group-item {
    background: #0f1625;
    border-color: var(--card-border-color);
    box-shadow: 0 12px 22px rgba(0, 0, 0, 0.4);
    color: #e8ecf5;
  }

  :root[data-theme="dark"] .notification-card .list-group-item:hover {
    border-color: rgba(92, 124, 250, 0.35);
    box-shadow: 0 14px 28px rgba(0, 0, 0, 0.45);
  }

  :root[data-theme="dark"] .notification-row-unread {
    border-color: rgba(92, 124, 250, 0.35);
    background: linear-gradient(180deg, rgba(92, 124, 250, 0.14), #0f1625);
    box-shadow: 0 14px 28px rgba(0, 0, 0, 0.45);
  }

  :root[data-theme="dark"] .notification-row-unread .notification-content__title {
    color: #dce3ff;
  }

  :root[data-theme="dark"] .notification-pill--new {
    background: rgba(92, 124, 250, 0.18);
    color: #e8ecf5;
  }

  :root[data-theme="dark"] .notification-pill--read {
    background: rgba(108, 117, 125, 0.2);
    color: #cfd5e2;
  }

  :root[data-theme="dark"] .notification-type-badge--announcement {
    background: rgba(92, 124, 250, 0.18);
    color: #e8ecf5;
    border-color: rgba(92, 124, 250, 0.35);
  }

  :root[data-theme="dark"] .notification-type-badge--client-announcement {
    background: rgba(20, 184, 166, 0.22);
    color: #ccfbf1;
    border-color: rgba(20, 184, 166, 0.4);
  }

  :root[data-theme="dark"] .notification-type-badge--task {
    background: rgba(14, 165, 233, 0.2);
    color: #cceeff;
    border-color: rgba(14, 165, 233, 0.35);
  }

  :root[data-theme="dark"] .notification-type-badge--task-response {
    background: rgba(16, 185, 129, 0.2);
    color: #d1ffe9;
    border-color: rgba(16, 185, 129, 0.35);
  }

  :root[data-theme="dark"] .notification-type-badge--task-status {
    background: rgba(251, 191, 36, 0.22);
    color: #ffe3a3;
    border-color: rgba(251, 191, 36, 0.35);
  }

  :root[data-theme="dark"] .notification-filters .btn {
    background: #0f1625;
    border-color: rgba(92, 124, 250, 0.35);
    color: #e8ecf5;
  }

  :root[data-theme="dark"] .notification-filters .btn.active {
    background: rgba(92, 124, 250, 0.9);
    border-color: rgba(92, 124, 250, 0.9);
    color: #ffffff;
  }

  :root[data-theme="dark"] .notification-empty-state {
    background: #0f1625;
    border-color: rgba(92, 124, 250, 0.35);
    color: #cfd5e2;
    box-shadow: 0 16px 36px rgba(0, 0, 0, 0.5);
  }

  :root[data-theme="dark"] .notification-search {
    background: #0f1625;
    border-color: var(--card-border-color);
    color: #e8ecf5;
  }

  :root[data-theme="dark"] .notification-card .btn-outline-secondary {
    border-color: rgba(255, 255, 255, 0.35);
    color: #e8ecf5;
    background: #111827;
  }

  :root[data-theme="dark"] .notification-card .btn-outline-secondary:hover,
  :root[data-theme="dark"] .notification-card .btn-outline-secondary:focus {
    border-color: rgba(255, 255, 255, 0.6);
    color: #ffffff;
    background: rgba(255, 255, 255, 0.08);
  }

  /* Botão "Abrir tarefa" mais destacado no escuro */
  :root[data-theme="dark"] .notification-card .open-notification-link {
    border-color: rgba(92, 124, 250, 0.65);
    color: #dce3ff;
    background: rgba(92, 124, 250, 0.12);
    font-weight: 700;
  }

  :root[data-theme="dark"] .notification-card .open-notification-link:hover,
  :root[data-theme="dark"] .notification-card .open-notification-link:focus {
    border-color: rgba(92, 124, 250, 0.9);
    background: rgba(92, 124, 250, 0.22);
    color: #ffffff;
    box-shadow: 0 0 0 0.15rem rgba(92, 124, 250, 0.25);
  }

  :root[data-theme="dark"] .notification-search::placeholder {
    color: #9aa6b5;
  }

</style>
{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container py-4">
  {% set total_notifications = notifications|length %}
  {% set read_total = total_notifications - unread_total if total_notifications > unread_total else 0 %}
  <div class="notifications-header mb-4">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-itens-start gap-3">
      <div class="notifications-header__text">
        <h1 class="h3 mb-1">Notificações</h1>
        <p class="text-muted mb-0">Acompanhe tarefas, avisos e responda rápido aos itens pendentes.</p>
      </div>
      <div class="notifications-header__cta">
        {% if current_user.role == 'admin' %}
        <button
          class="btn btn-sm btn-outline-primary"
          id="markAllNotifications"
          type="button"
          {% if unread_total == 0 %}disabled{% endif %}
        >
          Marcar todas como lidas
        </button>
        {% endif %}
        <span
          class="badge bg-white text-primary border border-primary border-opacity-25 fw-semibold"
          data-notifications-new-badge
        >
          {{ unread_total }} novas
        </span>
      </div>
    </div>
      <div class="notification-summary">
        <div class="notification-summary__card">
          <div class="d-flex align-itens-center gap-2 mb-1">
            <span class="notification-summary__icon text-primary">
              <i class="bi bi-bell-fill"></i>
            </span>
            <div>
              <small>Pendentes</small>
              <div class="h4 mb-0 fw-semibold" data-notifications-pending>{{ unread_total }}</div>
            </div>
          </div>
        </div>
        <div class="notification-summary__card text-success">
          <div class="d-flex align-itens-center gap-2 mb-1">
            <span class="notification-summary__icon text-success">
              <i class="bi bi-check-circle-fill"></i>
            </span>
            <div>
              <small>Lidas</small>
              <div class="h4 mb-0 fw-semibold" data-notifications-read>{{ read_total }}</div>
            </div>
          </div>
        </div>
      </div>
  </div>

  {% set notification_type_labels = {
    'announcement': 'Comunicado',
    'client_announcement': 'Comunicado cliente',
    'task': 'Tarefa',
    'task_response': 'Resposta',
    'task_status': 'Status'
  } %}

  {% if notifications %}
  <div class="card shadow-sm notification-card">
    <div class="card-body pb-0">
      <div class="notification-filters">
        <div class="btn-group btn-group-sm" role="group" aria-label="Filtro de notificações">
          <button type="button" class="btn btn-outline-primary active" data-filter="all">Todas</button>
          <button type="button" class="btn btn-outline-primary" data-filter="unread">Novas</button>
          <button type="button" class="btn btn-outline-primary" data-filter="read">Lidas</button>
        </div>
        <div class="ms-auto d-flex gap-2 align-itens-center flex-wrap">
          <input type="search" class="form-control form-control-sm notification-search" id="notificationSearch" placeholder="Buscar por texto">
          <span class="badge bg-light text-muted border">Total: <span id="notificationTotalCount">{{ notifications|length }}</span></span>
        </div>
      </div>
    </div>
    <ul class="list-group list-group-flush" id="notificationsList">
      {% for notification in notifications %}
      <li
        class="list-group-item notification-row d-flex flex-column gap-3{% if not notification.is_read %} notification-row-unread{% endif %}"
        data-id="{{ notification.id }}"
        data-notification-type="{{ notification.type or 'task' }}"
        data-read="{{ 'true' if notification.is_read else 'false' }}"
      >
        {% set type_key = notification.type or 'task' %}
        <div class="d-flex align-itens-start gap-3">
          <div class="notification-icon">
            <i class="bi bi-bell-fill"></i>
          </div>
          <div class="flex-grow-1">
            <div class="d-flex flex-wrap align-itens-center justify-content-between gap-2">
              <div class="notification-content__title fw-semibold mb-1">{{ notification.message }}</div>
              <div class="notification-meta-row">
                <span class="notification-type-badge notification-type-badge--{{ type_key|replace('_','-') }}">
                  {{ notification_type_labels.get(type_key, 'Tarefa') }}
                </span>
                {% if not notification.is_read %}
                <span class="notification-pill notification-pill--new">Novo</span>
                {% endif %}
              </div>
            </div>
            <div class="text-muted small">{{ notification.created_at_display }}</div>
          </div>
        </div>
        <div class="d-flex flex-column flex-sm-row gap-2 align-itens-start notification-actions">
          {% if notification.url %}
          <a class="btn btn-sm btn-outline-secondary open-notification-link" href="{{ notification.url }}" data-id="{{ notification.id }}" data-is-read="{{ notification.is_read|lower }}">
            {{ notification.action_label or 'Abrir' }}
          </a>
          {% endif %}
          {% if not notification.is_read %}
          <button class="btn btn-sm btn-primary mark-notification-read" data-id="{{ notification.id }}">
            Marcar como lida
          </button>
          {% else %}
          <span class="notification-pill notification-pill--read">Lida</span>
          {% endif %}
        </div>
      </li>
      {% endfor %}
    </ul>
  </div>
  {% else %}
  <div class="card shadow-sm notification-card">
    <div class="notification-empty-state text-center">
      <i class="bi bi-bell-slash display-5 text-muted mb-3"></i>
      <h2 class="h5 mb-2">Você está em dia!</h2>
      <p class="text-muted mb-0">Nenhuma notificação pendente no momento.</p>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('notificationsList');
    const markAllBtn = document.getElementById('markAllNotifications');
    const csrfToken = window.csrfToken || '';
    const summaryPendingEl = document.querySelector('[data-notifications-pending]');
    const summaryReadEl = document.querySelector('[data-notifications-read]');
    const newBadgeEl = document.querySelector('[data-notifications-new-badge]');
    const filterButtons = document.querySelectorAll('[data-filter]');
    const searchInput = document.getElementById('notificationSearch');
    const totalCountEl = document.getElementById('notificationTotalCount');
    let activeFilter = 'all';
    let searchTerm = '';

    function updateNavBadge(unread) {
      const badge = document.querySelector('[data-notifications-badge]');
      if (!badge) {
        return;
      }
      if (unread > 0) {
        badge.textContent = unread;
        badge.classList.remove('d-none');
      } else {
        badge.textContent = '0';
        badge.classList.add('d-none');
      }
    }

    function markNotificationRead(id, row) {
      return fetch(`/notifications/${id}/read`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken,
        },
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error('Erro ao marcar notificação como lida');
          }
          return response.json();
        })
        .then(() => {
          if (row) {
            row.classList.remove('notification-row-unread');
            const badge = row.querySelector('.badge');
            const button = row.querySelector('.mark-notification-read');
            if (button) {
              button.remove();
            }
            if (badge) {
              badge.textContent = 'Lida';
            } else {
              const status = document.createElement('span');
              status.className = 'badge bg-light text-muted';
              status.textContent = 'Lida';
              const actions = row.querySelector('div.d-flex');
              if (actions) {
                actions.appendChild(status);
              }
            }
          }
        });
    }

    function updateSummaryCounts(unread) {
      let totalCount = 0;
      if (list) {
        totalCount = list.querySelectorAll('.notification-row').length;
      }

      const readCount = Math.max(totalCount - unread, 0);

      if (summaryPendingEl) {
        summaryPendingEl.textContent = unread;
      }
      if (summaryReadEl) {
        summaryReadEl.textContent = readCount;
      }
      if (newBadgeEl) {
        newBadgeEl.textContent = `${unread} novas`;
      }
      if (totalCountEl) {
        totalCountEl.textContent = totalCount;
      }
    }

    function handleUnreadState() {
      if (!list) {
        return;
      }
      const unreadRows = list.querySelectorAll('.notification-row-unread');
      const unreadCount = unreadRows.length;
      if (markAllBtn) {
        markAllBtn.disabled = unreadCount === 0;
      }
      updateNavBadge(unreadCount);
      updateSummaryCounts(unreadCount);
    }

    function applyFilters() {
      if (!list) {
        return;
      }
      const rows = list.querySelectorAll('.notification-row');
      rows.forEach((row) => {
        const isRead = row.dataset.read === 'true';
        const text = (row.innerText || '').toLowerCase();
        const matchesFilter =
          activeFilter === 'all' ||
          (activeFilter === 'unread' && !isRead) ||
          (activeFilter === 'read' && isRead);
        const matchesSearch = !searchTerm || text.includes(searchTerm);
        row.style.display = matchesFilter && matchesSearch ? '' : 'none';
      });
    }

    filterButtons.forEach((btn) => {
      btn.addEventListener('click', () => {
        filterButtons.forEach((b) => b.classList.remove('active'));
        btn.classList.add('active');
        activeFilter = btn.dataset.filter || 'all';
        applyFilters();
      });
    });

    if (searchInput) {
      searchInput.addEventListener('input', (ev) => {
        searchTerm = (ev.target.value || '').trim().toLowerCase();
        applyFilters();
      });
    }

    if (list) {
      // Handler para o botão "Marcar como lida"
      list.addEventListener('click', (event) => {
        const button = event.target.closest('.mark-notification-read');
        if (!button) {
          return;
        }
        const id = button.dataset.id;
        const row = button.closest('.list-group-item');
        if (!id || !row) {
          return;
        }
        button.disabled = true;
        markNotificationRead(id, row)
          .catch(() => {
            button.disabled = false;
          })
          .finally(() => {
            handleUnreadState();
          });
      });

      // Handler para os botões "Abrir tarefa" e "Abrir comunicado"
      list.addEventListener('click', (event) => {
        const link = event.target.closest('.open-notification-link');
        if (!link) {
          return;
        }

        const id = link.dataset.id;
        const isRead = link.dataset.isRead === 'true';
        const targetUrl = link.getAttribute('href');

        if (!id || !targetUrl) {
          return;
        }

        // Se já está lida, apenas navega
        if (isRead) {
          return;
        }

        // Prevenir navegação padrão para marcar como lida primeiro
        event.preventDefault();

        const row = link.closest('.list-group-item');

        // Marcar como lida e depois navegar
        markNotificationRead(id, row)
          .catch(() => {})
          .finally(() => {
            handleUnreadState();
            // Navegar para a URL
            window.location.href = targetUrl;
          });
      });
    }

    if (markAllBtn) {
      markAllBtn.addEventListener('click', (event) => {
        event.preventDefault();
        if (markAllBtn.disabled) {
          return;
        }
        markAllBtn.disabled = true;
        fetch('/notifications/read-all', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
          },
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error('Erro ao marcar todas como lidas');
            }
            return response.json();
          })
          .then(() => {
            if (list) {
              list.querySelectorAll('.notification-row-unread').forEach((row) => {
                row.classList.remove('notification-row-unread');
                const button = row.querySelector('.mark-notification-read');
                if (button) {
                  button.remove();
                }
                const badge = row.querySelector('.badge');
                if (badge) {
                  badge.textContent = 'Lida';
                } else {
                  const status = document.createElement('span');
                  status.className = 'badge bg-light text-muted';
                  status.textContent = 'Lida';
                  const actions = row.querySelector('div.d-flex');
                  if (actions) {
                    actions.appendChild(status);
                  }
                }
              });
            }
          })
          .catch(() => {
            markAllBtn.disabled = false;
          })
          .finally(() => {
            handleUnreadState();
          });
      });
    }

    handleUnreadState();
    applyFilters();
  });
</script>
{% endblock %}
