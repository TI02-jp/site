{% extends "base.html" %}

{% block title %}VÍDEOS{% endblock %}

{% block sidebar_nav %}
{% include "sidebar_home.html" %}
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
        <div>
            <h1 class="h3 mb-1">Biblioteca de vídeos</h1>
            <p class="text-muted mb-0">Assista a treinamentos e comunicados sem sair do portal.</p>
        </div>
        {% if current_user.role == 'admin' %}
        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newFolderModal">
                <i class="bi bi-folder-plus me-2"></i>
                Nova pasta
            </button>
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newVideoModal" {% if not collections %}disabled{% endif %}>
                <i class="bi bi-plus-circle me-2"></i>
                Novo vídeo
            </button>
        </div>
        {% endif %}
    </div>

    {% if not collections %}
    <div class="alert alert-info">
        <div class="d-flex align-items-start">
            <i class="bi bi-play-circle me-3 fs-4"></i>
            <div>
                <h2 class="h5 mb-1">Nenhuma pasta cadastrada ainda</h2>
                <p class="mb-0">Crie uma pasta para reunir os vídeos da equipe. Você pode adicionar o link da pasta do Google Drive para exibir o conteúdo compartilhado automaticamente.</p>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row g-4">
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-body">
                    <h2 class="h6 text-uppercase text-muted mb-3">Pastas</h2>
                    <div class="list-group video-folders">
                        {% for collection in collections %}
                        <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-start {% if active_collection and active_collection.id == collection.id %}active{% endif %}"
                           href="{{ url_for('videos', collection_id=collection.id) }}">
                            <div class="me-3">
                                <div class="fw-semibold">{{ collection.name }}</div>
                                {% if collection.description %}
                                <small class="text-muted">{{ collection.description }}</small>
                                {% endif %}
                            </div>
                            <span class="badge bg-secondary rounded-pill">{{ collection.videos|length }}</span>
                        </a>
                        {% endfor %}
                    </div>
                    {% if current_user.role == 'admin' and active_collection %}
                    <form method="post" action="{{ url_for('delete_video_collection', collection_id=active_collection.id) }}" class="mt-3" onsubmit="return confirm('Tem certeza que deseja remover esta pasta e todos os vídeos?');">
                        {{ delete_folder_form.hidden_tag() }}
                        <button type="submit" class="btn btn-outline-danger w-100">
                            <i class="bi bi-trash me-2"></i>
                            Excluir pasta selecionada
                        </button>
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="h6 text-uppercase text-muted mb-3">Vídeos</h2>
                    {% if active_collection and active_collection.videos %}
                    <div class="list-group video-items" data-video-list>
                        {% for video in active_collection.videos %}
                        <div class="list-group-item list-group-item-action d-flex align-items-start {% if active_video and active_video.id == video.id %}active{% endif %}"
                             data-video-item
                             data-video-id="{{ video.id }}"
                             data-video-url="{{ video.embed_url }}"
                             data-video-name="{{ video.title }}"
                             data-video-description="{{ video.description or '' }}"
                             role="button" tabindex="0">
                            <div class="me-3">
                                <div class="fw-semibold">{{ video.title }}</div>
                                {% if video.description %}
                                <small class="text-muted">{{ video.description }}</small>
                                {% endif %}
                            </div>
                            <div class="ms-auto d-flex align-items-center gap-2">
                                {% if current_user.role == 'admin' %}
                                <form method="post" action="{{ url_for('delete_video_link', link_id=video.id) }}" onsubmit="return confirm('Remover este vídeo da biblioteca?');">
                                    {{ delete_video_form.hidden_tag() }}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                        <span class="visually-hidden">Excluir</span>
                                    </button>
                                </form>
                                {% endif %}
                                <span class="badge bg-light text-muted">#{{ loop.index }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted border rounded">
                        <i class="bi bi-collection-play fs-1 d-block mb-3"></i>
                        <p class="mb-2">Ainda não há vídeos cadastrados nesta pasta.</p>
                        {% if current_user.role == 'admin' %}
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newVideoModal">
                            <i class="bi bi-plus-circle me-2"></i>
                            Adicionar primeiro vídeo
                        </button>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h2 class="h6 text-uppercase text-muted mb-3">Assistir</h2>
                    {% if active_video %}
                    <div class="ratio ratio-16x9 mb-3">
                        <iframe data-video-player src="{{ active_video.embed_url }}" title="{{ active_video.title }}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                    </div>
                    <h3 class="h5" data-video-title>{{ active_video.title }}</h3>
                    <p class="text-muted{% if not active_video.description %} d-none{% endif %}" data-video-description>{{ active_video.description or '' }}</p>
                    {% elif active_collection and active_collection.embed_folder_url %}
                    <div class="ratio ratio-16x9">
                        <iframe src="{{ active_collection.embed_folder_url }}" allowfullscreen></iframe>
                    </div>
                    {% else %}
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-tv fs-1 d-block mb-3"></i>
                        <p class="mb-0">Selecione um vídeo para começar a assistir.</p>
                    </div>
                    {% endif %}

                    {% if active_collection and active_collection.embed_folder_url %}
                    <div class="alert alert-light border mt-3">
                        <div class="d-flex">
                            <i class="bi bi-folder-symlink me-3 fs-4 text-primary"></i>
                            <div>
                                <h3 class="h6 mb-1">Pasta compartilhada no Google Drive</h3>
                                <p class="mb-2">Acesse todos os arquivos da pasta conectada diretamente pelo portal.</p>
                                <a class="btn btn-sm btn-outline-primary" href="{{ active_collection.drive_folder_url }}" target="_blank" rel="noopener">
                                    <i class="bi bi-box-arrow-up-right me-2"></i>
                                    Abrir no Google Drive
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if current_user.role == 'admin' %}
<div class="modal fade" id="newFolderModal" tabindex="-1" aria-labelledby="newFolderModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{{ url_for('create_video_collection') }}">
                <div class="modal-header">
                    <h2 class="modal-title fs-5" id="newFolderModalLabel">Nova pasta de vídeos</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    {{ folder_form.hidden_tag() }}
                    <div class="mb-3">
                        {{ folder_form.name.label(class="form-label") }}
                        {{ folder_form.name(class="form-control") }}
                        {% for error in folder_form.name.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="mb-3">
                        {{ folder_form.description.label(class="form-label") }}
                        {{ folder_form.description(class="form-control") }}
                        {% for error in folder_form.description.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="mb-0">
                        {{ folder_form.drive_folder_url.label(class="form-label") }}
                        {{ folder_form.drive_folder_url(class="form-control") }}
                        <small class="form-text text-muted">Cole o endereço da pasta compartilhada no Google Drive para que ela seja exibida diretamente no portal.</small>
                        {% for error in folder_form.drive_folder_url.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    {{ folder_form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="newVideoModal" tabindex="-1" aria-labelledby="newVideoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" action="{{ url_for('create_video_link') }}">
                <div class="modal-header">
                    <h2 class="modal-title fs-5" id="newVideoModalLabel">Adicionar vídeo</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    {{ link_form.hidden_tag() }}
                    {% if not link_form.collection_id.choices %}
                    <div class="alert alert-warning">
                        Crie uma pasta antes de adicionar vídeos.
                    </div>
                    {% endif %}
                    <div class="row g-3">
                        <div class="col-md-6">
                            {{ link_form.title.label(class="form-label") }}
                            {{ link_form.title(class="form-control") }}
                            {% for error in link_form.title.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-6">
                            {{ link_form.collection_id.label(class="form-label") }}
                            {{ link_form.collection_id(class="form-select") }}
                            {% for error in link_form.collection_id.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-12">
                            {{ link_form.url.label(class="form-label") }}
                            {{ link_form.url(class="form-control") }}
                            <small class="form-text text-muted">Aceitamos links do Google Drive e do YouTube. Eles serão convertidos automaticamente para o modo de exibição.</small>
                            {% for error in link_form.url.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-12">
                            {{ link_form.description.label(class="form-label") }}
                            {{ link_form.description(class="form-control") }}
                            {% for error in link_form.description.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                        <div class="col-md-4">
                            {{ link_form.display_order.label(class="form-label") }}
                            {{ link_form.display_order(class="form-control") }}
                            {% for error in link_form.display_order.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    {{ link_form.submit(class="btn btn-primary", disabled=not link_form.collection_id.choices) }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='javascript/video_library.js') }}"></script>
{% endblock %}
