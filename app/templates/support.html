{% extends "base.html" %}

{% block title %}Suporte{% endblock %}

{% block sidebar_nav %}
<div class="nav-section">
    <div class="nav-section-title">PRINCIPAL</div>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('dashboard') }}">
                <i class="bi bi-list-task"></i>
                PARTICULARIDADES
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="https://app.acessorias.com/sysmain.php" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right"></i>
                ACESSÓRIAS
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="https://auth.sieg.com/login" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right"></i>
                SIEG
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('consultorias') }}">
                <i class="bi bi-buildings"></i>
                CONSULTORIAS
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('sala_reunioes') }}">
                <i class="bi bi-calendar-event"></i>
                SALA DE REUNIÕES
            </a>
        </li>
        {% if user_has_tag('Gestão') %}
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="return false;">
                <i class="bi bi-people"></i>
                DIRETORIA JP
            </a>
        </li>
        {% endif %}
    </ul>
</div>
<div class="nav-section">
    <div class="nav-section-title">SUPORTE</div>
    <ul class="nav flex-column">
        {% set support_endpoints = ['suporte', 'suporte_chamados'] %}
        <li class="nav-item">
            <a class="nav-link {% if request.endpoint in support_endpoints %}active{% endif %}" href="{{ url_for('suporte') }}">
                <i class="bi bi-question-circle"></i>
                Suporte
            </a>
            {% if request.endpoint in support_endpoints and (current_user.role == 'dev' or current_user.is_master) %}
            <ul class="nav flex-column ms-3">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'suporte_chamados' %}active{% endif %}" href="{{ url_for('suporte_chamados') }}">
                        Chamados Abertos
                    </a>
                </li>
            </ul>
            {% endif %}
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#" onclick="return false;">
                <i class="bi bi-book"></i>
                Documentação
            </a>
        </li>
    </ul>
</div>
<style>
    .content-breadcrumb { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4">Suporte</h1>
    {% if current_user.role == 'dev' or current_user.is_master %}
    <div class="mb-4">
        <a class="btn btn-secondary" href="{{ url_for('suporte_chamados') }}">Ver Chamados em Aberto</a>
    </div>
    {% endif %}
    <form id="support-form" method="post" class="mb-4">
        {{ form.hidden_tag() }}
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">Usuário</label>
                <input type="text" class="form-control" value="{{ current_user.username }}" readonly>
            </div>
            <div class="col-md-4">
                {{ form.email.label(class="form-label") }}
                {{ form.email(class="form-control") }}
            </div>
            <div class="col-md-4">
                <label class="form-label">Data e hora</label>
                <input type="text" class="form-control" value="{{ now.strftime('%d/%m/%Y %H:%M') }}" readonly>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-8">
                {{ form.subject.label(class="form-label") }}
                {{ form.subject(class="form-control") }}
            </div>
            <div class="col-md-4">
                {{ form.urgency.label(class="form-label") }}
                {{ form.urgency(class="form-select") }}
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label fw-semibold"><i class="bi bi-image me-1"></i>Descrição do Problema</label>
            <div id="editor-descricao" style="height: 300px; border: 1px solid #dee2e6; border-radius: 0.375rem;">
                {{ form.description.data|sanitize }}
            </div>
            {{ form.description(id='descricao', style='display:none;') }}
            <small class="text-muted"><i class="bi bi-info-circle me-1"></i>Use o editor para adicionar texto formatado, listas e imagens do problema</small>
        </div>
    {{ form.submit(class="btn btn-primary") }}
    </form>

    {% if tickets %}
    <h2 class="mt-5">Seus Chamados</h2>
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Assunto</th>
                    <th>Status</th>
                    <th>Criado em</th>
                </tr>
            </thead>
            <tbody>
                {% for ticket in tickets %}
                <tr>
                    <td>{{ ticket.id }}</td>
                    <td>{{ ticket.subject }}</td>
                    <td>{{ ticket.status }}</td>
                    <td>{{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="mt-5">Você ainda não abriu chamados.</p>
    {% endif %}

    <input type="file" id="image-input-descricao" accept="image/*" style="display:none;">
</div>
{% endblock %}


{% block scripts %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
const csrfToken = "{{ form.csrf_token._value() }}";

    function uploadImage(file) {
        const formData = new FormData();
        formData.append('image', file);
        return fetch('/upload_image', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        }).then(r => r.json());
    }

    function selectLocalImage() {
        document.getElementById('image-input-descricao').click();
    }

    const quill = new Quill('#editor-descricao', {
        theme: 'snow',
        placeholder: 'Digite a descrição do problema. Use o ícone de imagem para fazer upload...',
        modules: {
            toolbar: {
                container: [
                    ['bold', 'italic', 'underline'],
                    [{ list: 'ordered' }, { list: 'bullet' }],
                    ['link', 'image'],
                    ['clean'],
                ],
                handlers: {
                    image: selectLocalImage
                }
            }
        }
    });

    const hiddenInput = document.getElementById('descricao');
    const imageInput = document.getElementById('image-input-descricao');
    const form = document.getElementById('support-form');

    if (hiddenInput.value) {
        quill.root.innerHTML = hiddenInput.value;
    }

    imageInput.addEventListener('change', () => {
        if (imageInput.files && imageInput.files[0]) {
            const file = imageInput.files[0];
            const range = quill.getSelection(true);
            quill.insertText(range.index, 'Carregando imagem...', 'italic', true);
            uploadImage(file).then(result => {
                quill.deleteText(range.index, 'Carregando imagem...'.length);
                if (result.image_url) {
                    quill.insertEmbed(range.index, 'image', result.image_url);
                    quill.setSelection(range.index + 1);
                }
            }).catch(() => {
                quill.deleteText(range.index, 'Carregando imagem...'.length);
                quill.insertText(range.index, '[Erro ao carregar imagem]', 'color', 'red');
            });
            imageInput.value = '';
        }
    });

    form.addEventListener('submit', () => {
        hiddenInput.value = quill.root.innerHTML;
    });
</script>
{% endblock %}


