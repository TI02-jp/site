{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<style>
.participants-scroll {
    max-height: 240px;
    overflow-y: auto;
    background-color: #f8f9fa;
}
</style>
<div class="container mt-4" style="max-width: 1400px;">
    <div class="card shadow-lg">
        <div class="card-header bg-primary text-white py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0 fw-semibold"><i class="bi bi-people me-2"></i>{{ page_title }}</h2>
                <a href="{{ url_for('visualizar_empresa', id=empresa.id) }}#reunioes-cliente" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left me-1"></i>Voltar para o cliente
                </a>
            </div>
        </div>
        <div class="card-body p-4">
            <form method="POST" novalidate>
                {{ form.csrf_token }}
                {{ form.topicos_json(id="topicos-json", type="hidden") }}
                {{ form.decisoes(id="decisoes-field", style="display:none;") }}

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold" for="data">{{ form.data.label.text }}</label>
                        {{ form.data(class="form-control", id="data") }}
                        {% for error in form.data.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold" for="acompanhar-ate">{{ form.acompanhar_ate.label.text }}</label>
                        {{ form.acompanhar_ate(class="form-control", id="acompanhar-ate") }}
                        {% for error in form.acompanhar_ate.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold d-block">{{ form.participantes.label.text }}</label>
                    {% if form.participantes.choices %}
                        <div class="participants-scroll border rounded p-3">
                            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
                                {% for subfield in form.participantes %}
                                    <div class="col">
                                        <div class="form-check">
                                            {{ subfield(class="form-check-input", id=subfield.id) }}
                                            <label class="form-check-label" for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <p class="text-muted">Não há usuários ativos disponíveis para seleção.</p>
                    {% endif %}
                    {% for error in form.participantes.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold" for="setor">{{ form.setor_id.label.text }}</label>
                    {{ form.setor_id(class="form-select", id="setor") }}
                    {% for error in form.setor_id.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold d-block">Tópicos discutidos</label>
                    <div class="input-group mb-3">
                        <input type="text" id="topico-input" class="form-control" placeholder="">
                        <button type="button" id="add-topico" class="btn btn-primary"><i class="bi bi-plus-circle me-1"></i>Incluir</button>
                    </div>
                    <ul class="list-group" id="topicos-list"></ul>
                    {% for error in form.topicos_json.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="mb-4">
                    <label class="form-label fw-semibold d-block">{{ form.decisoes.label.text }}</label>
                    <div id="decisoes-editor" style="height: 240px;" class="border rounded"></div>
                    {% for error in form.decisoes.errors %}
                        <div class="invalid-feedback d-block">{{ error }}</div>
                    {% endfor %}
                </div>

                <div class="d-flex justify-content-end gap-3">
                    <a href="{{ url_for('visualizar_empresa', id=empresa.id) }}#reunioes-cliente" class="btn btn-outline-secondary">
                        Cancelar
                    </a>
                    {{ form.submit(class="btn btn-primary px-4") }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const topicosField = document.getElementById('topicos-json');
    const topicosList = document.getElementById('topicos-list');
    const topicoInput = document.getElementById('topico-input');
    const addTopicoBtn = document.getElementById('add-topico');
    const form = document.querySelector('form');
    const quill = new Quill('#decisoes-editor', {
        theme: 'snow',
        placeholder: ''
    });
    const decisoesField = document.getElementById('decisoes-field');

    function renderTopicos(topicos) {
        topicosList.innerHTML = '';
        if (!topicos.length) {
            const placeholder = document.createElement('li');
            placeholder.className = 'list-group-item text-muted';
            placeholder.textContent = 'Nenhum tópico adicionado ainda.';
            topicosList.appendChild(placeholder);
            return;
        }
        topicos.forEach((texto, index) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <span>${texto}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" data-index="${index}">
                    <i class="bi bi-x-lg"></i>
                </button>
            `;
            topicosList.appendChild(li);
        });
    }

    function getTopicos() {
        try {
            return JSON.parse(topicosField.value || '[]');
        } catch (err) {
            return [];
        }
    }

    function setTopicos(topicos) {
        topicosField.value = JSON.stringify(topicos);
        renderTopicos(topicos);
    }

    addTopicoBtn.addEventListener('click', function () {
        const texto = topicoInput.value.trim();
        if (!texto) {
            topicoInput.focus();
            return;
        }
        const topicos = getTopicos();
        topicos.push(texto);
        setTopicos(topicos);
        topicoInput.value = '';
        topicoInput.focus();
    });

    topicosList.addEventListener('click', function (event) {
        const target = event.target.closest('button[data-index]');
        if (!target) return;
        const index = parseInt(target.getAttribute('data-index'), 10);
        const topicos = getTopicos();
        topicos.splice(index, 1);
        setTopicos(topicos);
    });

    form.addEventListener('submit', function () {
        const pendingTopico = topicoInput.value.trim();
        if (pendingTopico) {
            const topicos = getTopicos();
            topicos.push(pendingTopico);
            setTopicos(topicos);
            topicoInput.value = '';
        }
        decisoesField.value = quill.root.innerHTML.trim();
    });

    // Inicialização
    const initialTopicos = getTopicos();
    setTopicos(initialTopicos);
    if (decisoesField.value) {
        quill.root.innerHTML = decisoesField.value;
    }
});
</script>
{% endblock %}
