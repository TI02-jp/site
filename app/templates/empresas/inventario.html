{% extends "base.html" %}

{% block title %}Inventário 2026{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 inventario-page">
    <!-- Cabeçalho da Página -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-primary mb-1">
                        <i class="bi bi-clipboard-data me-2"></i>Inventário 2026
                        <span class="badge bg-primary ms-2">{{ pagination.total }}</span>
                    </h1>
                    <p class="text-muted mb-0">Controle de inventário anual das empresas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Barra de Pesquisa e Filtros -->
    <div class="mb-3">
        <!-- Barra de Pesquisa -->
        <div class="row mb-2 align-items-start">
            <div class="col-md-4">
                <form method="get" id="inventarioSearchForm">
                    <input type="hidden" name="sort" value="{{ sort }}">
                    <input type="hidden" name="order" value="{{ order }}">
                    <input type="hidden" name="all" value="{{ all_param }}">
                    {% for trib in tributacao_filters %}
                    <input type="hidden" name="tributacao" value="{{ trib }}">
                    {% endfor %}
                    {% for tag in tag_filters %}
                    <input type="hidden" name="tag" value="{{ tag }}">
                    {% endfor %}
                    {% for st in status_filters %}
                    <input type="hidden" name="status" value="{{ st }}">
                    {% endfor %}
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-light">
                            <i class="bi bi-search"></i>
                        </span>
                        <input type="text" class="form-control" id="searchInput" name="q" value="{{ search_term }}"
                            placeholder="Pesquisar por ID ou Razão Social...">
                        <a class="btn btn-outline-secondary" id="clearSearch"
                            href="{{ url_for('empresas.inventario', sort=sort, order=order, tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, all=all_param) }}"
                            title="Limpar pesquisa">
                            <i class="bi bi-x"></i>
                        </a>
                    </div>
                </form>
            </div>
            <div class="col-md-8">
                <div class="d-flex align-items-start gap-2 flex-wrap inventario-toolbar">
                    <div class="inventario-dashboard-inline d-flex flex-wrap gap-2 justify-content-start">
                        {% for card in dashboard_cards %}
                        {% if card.tributacao != "MEI" %}
                        <div class="inventario-summary-card" data-tributacao="{{ card.tributacao }}"
                            data-total="{{ card.total }}" data-concluida="{{ card.concluida }}"
                            data-aguardando="{{ card.aguardando_arquivo }}" data-faltantes="{{ card.faltantes }}"
                            data-fechamento="{{ card.fechamento_fiscal }}">
                            <div class="summary-top">
                                <div class="summary-title">{{ card.tributacao }}</div>
                                <div class="summary-total">
                                    <span class="summary-number js-total">{{ card.total }}</span>
                                    <span class="summary-suffix">EMPRESAS</span>
                                </div>
                            </div>
                            <div class="summary-metrics">
                                <div class="summary-metric">
                                    <span class="summary-label">CONCLUIDA</span>
                                    <span class="summary-number js-concluida">{{ card.concluida }}</span>
                                </div>
                                <div class="summary-metric">
                                    <span class="summary-label">AGUARDANDO ARQUIVO</span>
                                    <span class="summary-number js-aguardando">{{ card.aguardando_arquivo }}</span>
                                </div>
                                <div class="summary-metric">
                                    <span class="summary-label">FALTANTES</span>
                                    <span class="summary-number js-faltantes">{{ card.faltantes }}</span>
                                </div>
                                <div class="summary-metric">
                                    <span class="summary-label">FECH. FISCAL</span>
                                    <span class="summary-number js-fechamento">{{ card.fechamento_fiscal }}</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <div class="inventario-action ms-auto d-flex align-items-center gap-2">
                        {% set is_tag_filtered = tag_filters|length != 1 or 'Matriz' not in tag_filters %}
                        <div class="dropdown" data-bs-auto-close="outside">
                            <button
                                class="btn btn-sm d-inline-flex align-items-center gap-1 {% if is_tag_filtered %}btn-primary{% else %}btn-outline-secondary{% endif %}"
                                type="button" id="tagFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                                aria-label="Filtrar por tag">
                                <i class="bi bi-tags"></i>
                                Tag
                                {% if is_tag_filtered %}
                                <span class="badge bg-light text-dark ms-1">{{ tag_filters|length }}</span>
                                {% endif %}
                            </button>
                            <div class="dropdown-menu dropdown-menu-end p-3 shadow-sm"
                                aria-labelledby="tagFilterDropdown" style="min-width: 220px;">
                                <form method="GET" class="tag-filter-form">
                                    <input type="hidden" name="sort" value="{{ sort }}">
                                    <input type="hidden" name="order" value="{{ order }}">
                                    <input type="hidden" name="q" value="{{ search_term }}">
                                    <input type="hidden" name="all" value="{{ all_param }}">
                                    {% for trib in tributacao_filters %}
                                    <input type="hidden" name="tributacao" value="{{ trib }}">
                                    {% endfor %}
                                    {% for st in status_filters %}
                                    <input type="hidden" name="status" value="{{ st }}">
                                    {% endfor %}
                                    <p class="text-uppercase text-muted fw-semibold small mb-2">Filtrar por tag</p>
                                    <div class="d-flex flex-column gap-1 mb-3">
                                        {% for tag in allowed_tag_filters %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" name="tag"
                                                id="tagFilter{{ loop.index }}" value="{{ tag }}" {% if tag in
                                                tag_filters %}checked{% endif %}>
                                            <label class="form-check-label" for="tagFilter{{ loop.index }}">{{ tag
                                                }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <a class="btn btn-link btn-sm text-decoration-none px-0 tag-filter-clear"
                                            href="{{ url_for('empresas.inventario', sort=sort, order=order, tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, q=search_term, all=all_param, clear_tag=1) }}">Limpar</a>
                                        <button type="submit"
                                            class="btn btn-primary btn-sm tag-filter-apply">Aplicar</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Botão de Configuração de Colunas -->
                        <button type="button"
                                class="btn btn-sm btn-primary d-inline-flex align-items-center gap-2 column-config-btn"
                                data-bs-toggle="modal"
                                data-bs-target="#columnSettingsModal"
                                title="Configurar colunas da tabela">
                            <i class="bi bi-gear-fill"></i>
                            <span>Configurar Colunas</span>
                        </button>

                        {% if show_all %}
                        <a class="btn btn-outline-secondary btn-sm"
                            href="{{ url_for('empresas.inventario', sort=sort, order=order, tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, q=search_term, all=0) }}">
                            Paginar resultados
                        </a>
                        {% else %}
                        <a class="btn btn-outline-primary btn-sm"
                            href="{{ url_for('empresas.inventario', sort=sort, order=order, tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, q=search_term, all=1) }}">
                            Listar tudo
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros Ativos -->
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="text-muted small">Filtros:</span>
                {% set show_tag_filter = tag_filters and (tag_filters|length != 1 or 'Matriz' not in tag_filters) %}
                {% if tributacao_filters or encerramento_filters or status_filters or show_tag_filter %}
                {% if show_tag_filter %}
                <span class="text-muted small">Tag:</span>
                {% for tag in tag_filters %}
                <span class="badge bg-secondary">{{ tag }}</span>
                {% endfor %}
                {% endif %}
                {% if tributacao_filters %}
                <span class="text-muted small">Tributação:</span>
                {% for trib in tributacao_filters %}
                <span class="badge bg-primary">{{ trib }}</span>
                {% endfor %}
                {% endif %}
                {% if encerramento_filters %}
                <span class="text-muted small">Encerramento:</span>
                {% for enc in encerramento_filters %}
                <span class="badge bg-success">{{ 'Sim' if enc == 'true' else 'Não' }}</span>
                {% endfor %}
                {% endif %}
                {% if status_filters %}
                <span class="text-muted small">Status:</span>
                {% for st in status_filters %}
                <span class="badge bg-info">{{ st }}</span>
                {% endfor %}
                {% endif %}
                <a href="{{ url_for('empresas.inventario', sort=sort, order=order, clear_tributacao=1, clear_encerramento=1, clear_status=1, clear_tag=1, q=search_term, all=all_param) }}"
                    class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-x-circle"></i> Limpar Tudo
                </a>
                {% else %}
                <span class="text-muted small">Nenhum filtro ativo</span>
                {% endif %}
            </div>
            {% if pagination.pages > 1 %}
            <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
                <span class="text-muted small">Página {{ pagination.page }} de {{ pagination.pages }}</span>
                <nav aria-label="Paginação do inventário">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item{% if not pagination.has_prev %} disabled{% endif %}">
                            <a class="page-link"
                                href="{% if pagination.has_prev %}{{ url_for('empresas.inventario', sort=sort, order=order, tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, q=search_term, all=all_param, page=pagination.prev_num) }}{% else %}#{% endif %}"
                                {% if not pagination.has_prev %}tabindex="-1" aria-disabled="true" {% endif %}>
                                Anterior
                            </a>
                        </li>
                        {% for p in pagination.iter_pages(left_edge=1, left_current=2, right_current=2, right_edge=1) %}
                        {% if p %}
                        <li class="page-item{% if p == pagination.page %} active{% endif %}">
                            <a class="page-link"
                                href="{{ url_for('empresas.inventario', sort=sort, order=order, tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, q=search_term, all=all_param, page=p) }}">{{
                                p }}</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled"><span class="page-link">?</span></li>
                        {% endif %}
                        {% endfor %}
                        <li class="page-item{% if not pagination.has_next %} disabled{% endif %}">
                            <a class="page-link"
                                href="{% if pagination.has_next %}{{ url_for('empresas.inventario', sort=sort, order=order, tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, q=search_term, all=all_param, page=pagination.next_num) }}{% else %}#{% endif %}"
                                {% if not pagination.has_next %}tabindex="-1" aria-disabled="true" {% endif %}>
                                Próximo
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Tabela de Inventário -->
    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive table-wrapper">
                <table class="table table-hover table-sm mb-0 compact-table" id="inventarioTable">
                    <thead class="table-light sticky-top">
                        <tr>

                            <th class="col-id" style="width: 65px;"
                                data-column-id="col_id"
                                data-hideable="false"
                                data-resizable="true">
                                <a href="{{ url_for('empresas.inventario', sort='codigo', order='desc' if sort == 'codigo' and order == 'asc' else 'asc', tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, q=search_term, all=all_param, page=pagination.page) }}"
                                    class="text-decoration-none text-dark d-flex align-items-center justify-content-between">
                                    ID
                                    {% if sort == 'codigo' %}
                                    <i class="bi bi-{{ 'sort-down' if order == 'desc' else 'sort-up' }} ms-1"></i>
                                    {% else %}
                                    <i class="bi bi-filter text-muted ms-1"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="col-razao" style="width: 220px;"
                                data-column-id="col_razao"
                                data-hideable="false"
                                data-resizable="true">
                                <a href="{{ url_for('empresas.inventario', sort='nome', order='desc' if sort == 'nome' and order == 'asc' else 'asc', tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, q=search_term, all=all_param, page=pagination.page) }}"
                                    class="text-decoration-none text-dark d-flex align-items-center justify-content-between">
                                    Razão Social
                                    {% if sort == 'nome' %}
                                    <i
                                        class="bi bi-{{ 'sort-alpha-down' if order == 'desc' else 'sort-alpha-up' }} ms-1"></i>
                                    {% else %}
                                    <i class="bi bi-filter text-muted ms-1"></i>
                                    {% endif %}
                                </a>
                            </th>
                            <th class="col-tributacao" style="width: 130px;"
                                data-column-id="col_tributacao"
                                data-hideable="true"
                                data-resizable="true">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center gap-1">
                                        <span>Tributação</span>
                                        <a href="{{ url_for('empresas.inventario', sort='tributacao', order='desc' if sort == 'tributacao' and order == 'asc' else 'asc', tributacao=tributacao_filters, encerramento=encerramento_filters, status=status_filters, tag=tag_filters, q=search_term, all=all_param, page=pagination.page) }}"
                                            class="text-decoration-none text-dark">
                                            {% if sort == 'tributacao' %}
                                            <i
                                                class="bi bi-{{ 'sort-alpha-down' if order == 'desc' else 'sort-alpha-up' }}"></i>
                                            {% endif %}
                                        </a>
                                    </div>
                                    <div class="dropdown" data-bs-auto-close="outside">
                                        <button
                                            class="btn btn-icon-xs {% if tributacao_filters %}btn-primary{% else %}btn-outline-secondary{% endif %}"
                                            type="button" id="tributacaoFilterDropdown" data-bs-toggle="dropdown"
                                            aria-expanded="false" aria-label="Filtrar por tributação">
                                            <i
                                                class="bi {% if tributacao_filters %}bi-funnel-fill{% else %}bi-funnel{% endif %}"></i>
                                            {% if tributacao_filters %}
                                            <span class="badge bg-light text-dark ms-1">{{ tributacao_filters|length
                                                }}</span>
                                            {% endif %}
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-end p-3 shadow-sm"
                                            aria-labelledby="tributacaoFilterDropdown" style="min-width: 240px;">
                                            <form method="GET" class="tributacao-filter-form">
                                                <input type="hidden" name="sort" value="{{ sort }}">
                                                <input type="hidden" name="order" value="{{ order }}">
                                                <input type="hidden" name="q" value="{{ search_term }}">
                                                <input type="hidden" name="all" value="{{ all_param }}">
                                                {% for tag in tag_filters %}
                                                <input type="hidden" name="tag" value="{{ tag }}">
                                                {% endfor %}
                                                <p class="text-uppercase text-muted fw-semibold small mb-2">Filtrar por
                                                    tributação</p>
                                                <div class="d-flex flex-column gap-1 mb-3">
                                                    {% for trib in allowed_tributacoes %}
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                            name="tributacao" id="tribFilter{{ loop.index }}"
                                                            value="{{ trib }}" {% if trib in tributacao_filters
                                                            %}checked{% endif %}>
                                                        <label class="form-check-label"
                                                            for="tribFilter{{ loop.index }}">{{ trib }}</label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <a class="btn btn-link btn-sm text-decoration-none px-0 tributacao-filter-clear"
                                                        href="{{ url_for('empresas.inventario', sort=sort, order=order, clear_tributacao=1, encerramento=encerramento_filters, tag=tag_filters, q=search_term, all=all_param) }}">Limpar</a>
                                                    <button type="submit"
                                                        class="btn btn-primary btn-sm tributacao-filter-apply">Aplicar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </th>
                            {% if not is_tadeu %}
                            <th class="col-cfop" style="width: 130px;"
                                data-column-id="col_cfop"
                                data-hideable="true"
                                data-resizable="true">CFOP</th>
                            <th class="col-cfop-move text-center" style="width: 44px;"
                                data-column-id="col_cfop_move"
                                data-hideable="false"
                                data-resizable="false">?</th>
                            {% endif %}
                            <th class="col-cfop" style="width: 150px;"
                                data-column-id="col_cfop_consolidado"
                                data-hideable="true"
                                data-resizable="true">CFOP Consolidado</th>
                            <th class="col-dief" style="width: 135px;"
                                data-column-id="col_dief"
                                data-hideable="true"
                                data-resizable="true">DIEF 2024</th>
                            <th class="col-balanco" style="width: 150px;"
                                data-column-id="col_balanco"
                                data-hideable="true"
                                data-resizable="true">Balanço Cliente 2025</th>
                            <th class="col-fechamento" style="width: 150px;"
                                data-column-id="col_fechamento"
                                data-hideable="true"
                                data-resizable="true">Fechamento Tadeu 2025</th>
                            <th class="col-obs" style="width: 175px;"
                                data-column-id="col_obs"
                                data-hideable="true"
                                data-resizable="true">Observação Tadeu</th>
                            <th class="col-status" style="width: 195px;"
                                data-column-id="col_status"
                                data-hideable="true"
                                data-resizable="true">
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>Status</span>
                                    <div class="dropdown" data-bs-auto-close="outside">
                                        <button
                                            class="btn btn-icon-xs {% if status_filters %}btn-info{% else %}btn-outline-secondary{% endif %}"
                                            type="button" id="statusFilterDropdown" data-bs-toggle="dropdown"
                                            aria-expanded="false" aria-label="Filtrar por status">
                                            <i
                                                class="bi {% if status_filters %}bi-funnel-fill{% else %}bi-funnel{% endif %}"></i>
                                            {% if status_filters %}
                                            <span class="badge bg-light text-dark ms-1">{{ status_filters|length
                                                }}</span>
                                            {% endif %}
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-end p-3 shadow-sm"
                                            aria-labelledby="statusFilterDropdown" style="min-width: 260px;">
                                            <form method="GET" class="status-filter-form">
                                                <input type="hidden" name="sort" value="{{ sort }}">
                                                <input type="hidden" name="order" value="{{ order }}">
                                                <input type="hidden" name="q" value="{{ search_term }}">
                                                <input type="hidden" name="all" value="{{ all_param }}">
                                                {% for tag in tag_filters %}
                                                <input type="hidden" name="tag" value="{{ tag }}">
                                                {% endfor %}
                                                {% for trib in tributacao_filters %}
                                                <input type="hidden" name="tributacao" value="{{ trib }}">
                                                {% endfor %}
                                                <p class="text-uppercase text-muted fw-semibold small mb-2">Filtrar por
                                                    status</p>
                                                <div class="d-flex flex-column gap-1 mb-3">
                                                    {% for status_opt in status_choices %}
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="status"
                                                            id="statusFilter{{ loop.index }}" value="{{ status_opt }}"
                                                            {% if status_opt in status_filters %}checked{% endif %}>
                                                        <label class="form-check-label"
                                                            for="statusFilter{{ loop.index }}">{{ status_opt }}</label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <a class="btn btn-link btn-sm text-decoration-none px-0 status-filter-clear"
                                                        href="{{ url_for('empresas.inventario', sort=sort, order=order, clear_status=1, tributacao=tributacao_filters, encerramento=encerramento_filters, tag=tag_filters, q=search_term, all=all_param) }}">Limpar</a>
                                                    <button type="submit"
                                                        class="btn btn-info btn-sm status-filter-apply">Aplicar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </th>


                            <th class="col-valor text-start" style="width: 175px;"
                                data-column-id="col_valor"
                                data-hideable="true"
                                data-resizable="true">Valor Enviado SPED Fiscal 02/2025
                            </th>
                            <th class="text-start" style="width: 125px;"
                                data-column-id="col_encerramento_fiscal"
                                data-hideable="true"
                                data-resizable="true">
                                <div class="d-flex align-items-center gap-1">
                                    <div class="flex-grow-1">
                                        <span>Encerramento Fiscal</span>
                                    </div>
                                    <div class="dropdown" data-bs-auto-close="outside">
                                        <button
                                            class="btn btn-icon-xs {% if encerramento_filters %}btn-primary{% else %}btn-outline-secondary{% endif %}"
                                            type="button" id="encerramentoFilterDropdown" data-bs-toggle="dropdown"
                                            aria-expanded="false" aria-label="Filtrar por encerramento fiscal">
                                            <i
                                                class="bi {% if encerramento_filters %}bi-funnel-fill{% else %}bi-funnel{% endif %}"></i>
                                            {% if encerramento_filters %}
                                            <span class="badge bg-light text-dark ms-1">{{ encerramento_filters|length
                                                }}</span>
                                            {% endif %}
                                        </button>
                                        <div class="dropdown-menu dropdown-menu-end p-3 shadow-sm"
                                            aria-labelledby="encerramentoFilterDropdown" style="min-width: 200px;">
                                            <form method="GET" class="encerramento-filter-form">
                                                <input type="hidden" name="sort" value="{{ sort }}">
                                                <input type="hidden" name="order" value="{{ order }}">
                                                <input type="hidden" name="q" value="{{ search_term }}">
                                                <input type="hidden" name="all" value="{{ all_param }}">
                                                {% for trib in tributacao_filters %}
                                                <input type="hidden" name="tributacao" value="{{ trib }}">
                                                {% endfor %}
                                                {% for tag in tag_filters %}
                                                <input type="hidden" name="tag" value="{{ tag }}">
                                                {% endfor %}
                                                {% for status in status_filters %}
                                                <input type="hidden" name="status" value="{{ status }}">
                                                {% endfor %}
                                                <p class="text-uppercase text-muted fw-semibold small mb-2">Filtrar por
                                                    encerramento</p>
                                                <div class="d-flex flex-column gap-1 mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                            name="encerramento" id="encerramentoFilterSim"
                                                            value="true" {% if "true" in encerramento_filters
                                                            %}checked{% endif %}>
                                                        <label class="form-check-label"
                                                            for="encerramentoFilterSim">Sim</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                            name="encerramento" id="encerramentoFilterNao"
                                                            value="false" {% if "false" in encerramento_filters
                                                            %}checked{% endif %}>
                                                        <label class="form-check-label"
                                                            for="encerramentoFilterNao">Não</label>
                                                    </div>
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <a class="btn btn-link btn-sm text-decoration-none px-0 encerramento-filter-clear"
                                                        href="{{ url_for('empresas.inventario', sort=sort, order=order, clear_encerramento=1, tributacao=tributacao_filters, tag=tag_filters, status=status_filters, q=search_term, all=all_param) }}">Limpar</a>
                                                    <button type="submit"
                                                        class="btn btn-primary btn-sm encerramento-filter-apply">Aplicar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </th>
                            <th class="text-start" style="width: 160px;"
                                data-column-id="col_arquivo_cliente"
                                data-hideable="true"
                                data-resizable="true">Arquivo Cliente</th>
                            <th class="text-start" style="width: 135px;"
                                data-column-id="col_data_encerramento"
                                data-hideable="true"
                                data-resizable="true">Data Encerramento</th>
                            <th class="text-start" style="width: 175px;"
                                data-column-id="col_usuario_encerramento"
                                data-hideable="true"
                                data-resizable="true">Usuário Encerramento</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% include 'empresas/_inventario_rows.html' %}

                    </tbody>
                </table>
            </div>
            {% if show_all and listall_token and listall_total_rows > listall_initial_loaded %}
            <div class="p-2 border-top d-flex justify-content-center align-items-center gap-2" id="listallLoadMoreWrap">
                <button type="button" class="btn btn-outline-primary btn-sm" id="listallLoadMoreBtn">
                    Carregar mais
                </button>
                <small class="text-muted" id="listallProgressText">
                    {{ listall_initial_loaded }} / {{ listall_total_rows }}
                </small>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    /* Colunas ocultas */
    .column-hidden {
        display: none !important;
    }

    /* Remover scroll do content-wrapper na página de inventário */
    .content-wrapper {
        overflow: hidden !important;
        height: 100vh !important;
    }

    .inventario-page {
        font-size: calc(1rem - 2px);
        margin-bottom: 0 !important;
        padding-bottom: 0 !important;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: calc(100vh - 32px);
        max-height: calc(100vh - 32px);
    }

    .inventario-page .card {
        margin-bottom: 0 !important;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .inventario-page .card-body {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .inventario-page h1 {
        font-size: 1.1rem;
    }

    .inventario-page .row.mb-4 {
        margin-bottom: 0.75rem !important;
    }

    .inventario-toolbar {
        row-gap: 0.4rem;
    }

    .inventario-dashboard-inline {
        flex: 1 1 auto;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.6rem;
        min-width: 0;
    }

    .inventario-action {
        flex: 0 0 auto;
    }

    .inventario-dashboard-inline .inventario-summary-card {
        --summary-accent: var(--primary);
        background: var(--card-bg);
        border: 1px solid var(--card-border-color);
        color: var(--text-color);
        border-radius: 0.65rem;
        padding: 0.65rem 0.85rem 0.7rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 6px 16px rgba(15, 23, 42, 0.08);
        display: flex;
        flex-direction: column;
        gap: 0.45rem;
        min-width: 200px;
    }

    :root[data-theme="dark"] .inventario-dashboard-inline .inventario-summary-card {
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
    }

    .inventario-dashboard-inline .inventario-summary-card::before {
        content: "";
        position: absolute;
        inset: 0 auto 0 0;
        width: 4px;
        background: var(--summary-accent);
        border-radius: 0.65rem 0 0 0.65rem;
        opacity: 0.9;
    }

    .inventario-dashboard-inline .inventario-summary-card[data-tributacao*="SIMPLES"] {
        --summary-accent: var(--primary);
    }

    .inventario-dashboard-inline .inventario-summary-card[data-tributacao*="PRESUMIDO"] {
        --summary-accent: var(--accent);
    }

    .inventario-dashboard-inline .inventario-summary-card[data-tributacao*="REAL"] {
        --summary-accent: var(--primary-hover);
    }

    .inventario-dashboard-inline .summary-top {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 0.5rem;
    }

    .inventario-dashboard-inline .summary-title {
        font-weight: 700;
        font-size: 0.72rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--text-muted);
    }

    .inventario-dashboard-inline .summary-total {
        display: inline-flex;
        align-items: baseline;
        gap: 0.25rem;
        font-weight: 700;
        font-size: 1rem;
    }

    .inventario-dashboard-inline .summary-total .summary-number {
        font-size: 1.1rem;
        color: var(--primary);
    }

    .inventario-dashboard-inline .summary-suffix {
        font-size: 0.65rem;
        font-weight: 600;
        letter-spacing: 0.05em;
        color: var(--text-muted);
    }

    .inventario-dashboard-inline .summary-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 0.35rem 0.6rem;
    }

    .inventario-dashboard-inline .summary-metric {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.35rem;
        padding: 0.2rem 0.45rem;
        border-radius: 0.5rem;
        background: var(--muted-surface);
        border: 1px solid var(--card-border-color);
        font-size: 0.68rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.03em;
        color: var(--text-muted);
    }

    .inventario-dashboard-inline .summary-label {
        line-height: 1.2;
        flex: 1 1 auto;
        min-width: 0;
        text-align: left;
    }

    .inventario-dashboard-inline .summary-number {
        font-weight: 700;
        color: var(--text-color);
        flex-shrink: 0;
    }

    .inventario-page .table {
        line-height: 1.15;
    }

    .inventario-page .table> :not(caption)>*>* {
        padding: 0.3rem 0.45rem;
    }

    .inventario-page .form-control,
    .inventario-page .form-select {
        font-size: 0.85rem;
        padding: 0.2rem 0.4rem;
        min-height: 1.6rem;
    }

    .inventario-page textarea.form-control {
        min-height: 1.6rem;
    }

    .inventario-page .btn {
        padding: 0.15rem 0.4rem;
        font-size: 0.8rem;
    }

    .inventario-page .badge {
        font-size: 0.68rem;
        padding: 0.28em 0.5em;
    }

    .inventario-page #inventarioTable td {
        vertical-align: middle;
    }

    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: var(--card-bg, #f8f9fa) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        /* Sombra sutil para destacar o cabeçalho ao rolar */
    }

    /* Tabela compacta */
    .compact-table {
        font-size: 0.75rem;
    }

    .compact-table thead th {
        padding: 0.3rem 0.3rem;
        font-size: 0.65rem;
        font-weight: 600;
        vertical-align: middle;
        line-height: 1.2;
    }

.compact-table tbody td {
        padding: 0.28rem 0.3rem;
        vertical-align: middle;
    }

    tr.virtual-spacer td {
        padding: 0 !important;
        border: 0 !important;
        height: 0;
        background: transparent !important;
    }

    tr.virtual-hidden {
        display: none !important;
    }

    /* Campos editáveis mais compactos */
    .compact-table .form-control,
    .compact-table .form-select {
        font-size: 0.68rem;
        padding: 0.2rem 0.3rem;
        min-height: 24px;
    }

    .compact-table textarea.form-control {
        padding: 0.2rem 0.3rem;
        line-height: 1.25;
    }

    .compact-table .btn-sm {
        padding: 0.2rem 0.35rem;
        font-size: 0.64rem;
    }

    .compact-table .load-files-btn-readable {
        font-size: 0.69rem !important;
        font-weight: 600;
        min-height: 22px;
        padding: 0.1rem 0.4rem !important;
        line-height: 1.1;
        border-width: 1px;
        letter-spacing: 0.01em;
        white-space: nowrap;
    }

    .compact-table .load-files-btn-readable .bi {
        font-size: 0.74rem;
    }

    .editable-field {
        border: 1px solid #e0e0e0;
        transition: border-color 0.2s, background-color 0.2s;
    }

    .editable-field:focus {
        border-color: #0d6efd;
        background-color: #fff;
        box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.1);
    }

    .editable-field.saving {
        background-color: #fff3cd;
        border-color: #ffc107;
    }

    .editable-field.saved {
        background-color: #d1e7dd;
        border-color: #198754;
    }

    .editable-field.error {
        background-color: #f8d7da;
        border-color: #dc3545;
    }

    #inventarioTable tbody tr:hover {
        background-color: #f8f9fa;
    }

    /* Estilos para cabeçalhos ordenáveis */
    #inventarioTable thead th a {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 2px;
        border-radius: 4px;
        transition: background-color 0.2s;
    }

    #inventarioTable thead th a:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    #inventarioTable thead th a i {
        font-size: 0.75rem;
    }

    /* Botão de filtro no cabeçalho */
    .btn-icon-xs {
        padding: 0.15rem 0.35rem;
        font-size: 0.7rem;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.2rem;
    }

    /* Dropdown de filtro */
    .dropdown {
        position: relative;
        z-index: 1050;
    }

    .dropdown-menu {
        border: 1px solid rgba(0, 0, 0, 0.15);
        z-index: 1051;
        position: absolute !important;
    }

    .tributacao-filter-form .form-check,
    .status-filter-form .form-check {
        padding-left: 1.5rem;
    }

    .tributacao-filter-form .form-check-input,
    .status-filter-form .form-check-input {
        cursor: pointer;
    }

    .tributacao-filter-form .form-check-label,
    .status-filter-form .form-check-label {
        cursor: pointer;
        user-select: none;
    }

    /* Ajustar z-index do thead para não sobrepor dropdown e manter fixo no scroll */
    #inventarioTable thead {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8f9fa;
        /* Fundo sólido para cobrir conteúdo ao rolar */
    }

    #inventarioTable thead th {
        position: relative;
        overflow: visible;
        background-color: #f8f9fa;
        /* Garantir que cada th tenha fundo sólido */
    }

    /* Permitir dropdown do filtro na coluna Tributação (3a coluna) */
    #inventarioTable thead th:nth-child(3) {
        overflow: visible;
        z-index: 1052;
    }

    /* Permitir dropdown do filtro na coluna Status (9a coluna) */
    #inventarioTable thead th:nth-child(9) {
        overflow: visible;
        z-index: 1052;
    }

    /* Container da tabela com scroll horizontal e vertical */
    .table-wrapper {
        overflow: auto;
        position: relative;
        width: 100%;
        max-width: 100%;
        scrollbar-gutter: stable both-edges;
        scrollbar-width: auto;
        scrollbar-color: #2563eb #bfdbfe;
        /* Altura equilibrada para criar o container de scroll */
        max-height: calc(100vh - 290px);
        min-height: 400px;
        /* Borda e sombra premium para delimitar o container */
        border: 1px solid var(--card-border-color, #e2e8f0);
        border-radius: 0 0 0.75rem 0.75rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        background: var(--card-bg, #fff);
    }

    /* Garantir que dropdowns não sejam cortados pelo overflow do container */
    .table-wrapper .dropdown-menu {
        position: fixed !important;
        z-index: 2000;
    }

    /* Garantir que a tabela não quebre e force o scroll */
    .table-wrapper .compact-table {
        min-width: 2290px;
        width: 2290px;
    }

    /* Garantir que todas as colunas respeitem a largura definida */
    .compact-table th {
        white-space: nowrap;
    }

    .compact-table td {
        overflow: visible;
    }

    /* Permitir que textareas e inputs quebrem linha normalmente */
    .compact-table textarea,
    .compact-table input,
    .compact-table select {
        white-space: normal;
    }

    /* Estilizar scrollbar horizontal e vertical */
    .table-wrapper::-webkit-scrollbar {
        height: 18px;
        width: 14px;
    }

    .table-wrapper::-webkit-scrollbar:horizontal {
        height: 18px;
    }

    .table-wrapper::-webkit-scrollbar-track {
        background: linear-gradient(180deg, #dbeafe 0%, #bfdbfe 100%);
        border-radius: 999px;
        border: 1px solid rgba(11, 94, 215, 0.3);
    }

    .table-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(180deg, #3b82f6 0%, #1d4ed8 100%);
        border-radius: 999px;
        border: 2px solid #bfdbfe;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2), inset 0 0 0 1px rgba(255, 255, 255, 0.25);
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(180deg, #2563eb 0%, #1e40af 100%);
    }

    .table-wrapper::-webkit-scrollbar-corner {
        background: #bfdbfe;
    }

    /* Inputs de upload compactos */
    .compact-table .pdf-upload-container,
    .compact-table .cliente-upload-container {
        gap: 0.2rem !important;
    }

    .compact-table .pdf-upload-container small,
    .compact-table .cliente-upload-container small {
        font-size: 0.65rem;
    }

    /* Melhorar estética dos inputs de upload */
    .compact-table .pdf-upload,
    .compact-table .cfop-consolidado-upload,
    .compact-table .cliente-upload {
        font-size: 0.68rem !important;
        padding: 0.2rem 0.3rem !important;
        min-height: 26px !important;
        height: 26px;
        color: transparent;
    }

    .compact-table .pdf-upload::-webkit-file-upload-button,
    .compact-table .cfop-consolidado-upload::-webkit-file-upload-button,
    .compact-table .cliente-upload::-webkit-file-upload-button {
        color: initial;
    }

    .compact-table .pdf-upload::file-selector-button,
    .compact-table .cfop-consolidado-upload::file-selector-button,
    .compact-table .cliente-upload::file-selector-button {
        color: initial;
    }

    .compact-table .pdf-upload::file-selector-button,
    .compact-table .cliente-upload::file-selector-button {
        font-size: 0.63rem;
        padding: 0.15rem 0.4rem;
        margin-right: 0.4rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 3px;
        cursor: pointer;
    }

    .compact-table .pdf-upload::file-selector-button:hover,
    .compact-table .cliente-upload::file-selector-button:hover {
        background-color: #e9ecef;
    }

    /* Input group compacto */
    .compact-table .input-group {
        gap: 0.2rem;
    }

    /* Ajuste dinâmico de fonte no select de status */
    .compact-table select[data-field="status"] {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .compact-table select[data-field="status"] option {
        font-size: 0.7rem;
    }

    /* Classes para ajustar tamanho de fonte baseado no comprimento */
    .compact-table select[data-field="status"].status-short {
        font-size: 0.7rem;
    }

    .compact-table select[data-field="status"].status-medium {
        font-size: 0.64rem;
    }

    .compact-table select[data-field="status"].status-long {
        font-size: 0.58rem;
    }

    /* Destacar CFOP quando encerramento fiscal = SIM e sem arquivo */
    .cfop-missing-file {
        background-color: #f8d7da !important;
        border: 2px solid #dc3545 !important;
        border-radius: 4px;
        padding: 0.3rem;
    }

    /* Estilo para lista de arquivos */
    .files-list {
        max-height: 150px;
        overflow-y: auto;
    }

    .files-list::-webkit-scrollbar {
        width: 4px;
    }

    .files-list::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .files-list::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 2px;
    }

    .files-list::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .file-item {
        background-color: #f8f9fa;
        padding: 0.2rem;
        border-radius: 3px;
    }

    .file-item:hover {
        background-color: #e9ecef;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const allowedTributacoes = {{ allowed_tributacoes | tojson
    }};
    const statusChoices = {{ status_choices | tojson }};
    const usuariosSelectOptions = {{ usuarios_select_options | tojson }};
    const dashboardAsync = {{ 'true' if dashboard_async else 'false' }};
    const dashboardApiUrl = {{ dashboard_api_url | tojson }};
    const dashboardQueryParams = {{ dashboard_query_params | tojson }};
    const listAllProgressive = {{ 'true' if show_all and listall_token else 'false' }};
    const listAllToken = {{ (listall_token or '') | tojson }};
    const listAllChunkSize = {{ listall_initial_batch or 0 }};
    let listAllLoaded = {{ listall_initial_loaded or 0 }};
    const listAllTotal = {{ listall_total_rows or 0 }};
    const tributacaoStorageKey = 'inventario-tributacao-filters';
    const statusStorageKey = 'inventario-status-filters';
    const currentUrl = new URL(window.location.href);
    const clearTributacao = currentUrl.searchParams.get('clear_tributacao') === '1';
    const clearStatus = currentUrl.searchParams.get('clear_status') === '1';
    const currentTributacoes = currentUrl.searchParams.getAll('tributacao');
    const currentStatus = currentUrl.searchParams.getAll('status');
    const dashboardCards = new Map();

    document.querySelectorAll('.inventario-summary-card').forEach((card) => {
        const tributacao = card.dataset.tributacao;
        if (!tributacao) return;
        dashboardCards.set(tributacao, {
            card,
            totalEl: card.querySelector('.js-total'),
            concluidaEl: card.querySelector('.js-concluida'),
            aguardandoEl: card.querySelector('.js-aguardando'),
            faltantesEl: card.querySelector('.js-faltantes'),
            fechamentoEl: card.querySelector('.js-fechamento')
        });
    });

    function parseCount(value) {
        const parsed = Number.parseInt(value, 10);
        return Number.isFinite(parsed) ?parsed : 0;
    }

    function setDashboardCardValues(cardData, totals) {
        if (!cardData || !cardData.card) return;
        const total = parseCount(totals.total);
        const concluida = parseCount(totals.concluida);
        const aguardando = parseCount(totals.aguardando_arquivo);
        const faltantes = parseCount(totals.faltantes);
        const fechamento = parseCount(totals.fechamento_fiscal);

        cardData.card.dataset.total = String(total);
        cardData.card.dataset.concluida = String(concluida);
        cardData.card.dataset.aguardando = String(aguardando);
        cardData.card.dataset.faltantes = String(faltantes);
        cardData.card.dataset.fechamento = String(fechamento);

        if (cardData.totalEl) cardData.totalEl.textContent = total;
        if (cardData.concluidaEl) cardData.concluidaEl.textContent = concluida;
        if (cardData.aguardandoEl) cardData.aguardandoEl.textContent = aguardando;
        if (cardData.faltantesEl) cardData.faltantesEl.textContent = faltantes;
        if (cardData.fechamentoEl) cardData.fechamentoEl.textContent = fechamento;
    }

    async function loadDashboardCardsAsync() {
        if (!dashboardAsync) return;
        try {
            const url = dashboardQueryParams ? `${dashboardApiUrl}?${dashboardQueryParams}` : dashboardApiUrl;
            const response = await fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!response.ok) return;
            const payload = await response.json();
            if (!payload || payload.success !== true || !Array.isArray(payload.cards)) return;
            payload.cards.forEach((card) => {
                if (!card || !card.tributacao) return;
                const cardData = dashboardCards.get(String(card.tributacao));
                if (!cardData) return;
                setDashboardCardValues(cardData, card);
            });
        } catch (_error) {
            // Fallback silencioso: mantem placeholders quando dashboard async falhar.
        }
    }
    loadDashboardCardsAsync();

    function hydrateLazySelectOptions(selectElement) {
        if (!selectElement || selectElement.dataset.hydrated === '1') return;
        const optionsType = selectElement.dataset.optionsType || '';
        const currentValue = (selectElement.dataset.currentValue || '').trim();
        const currentLabel = (selectElement.options[selectElement.selectedIndex]?.text || '').trim();

        const options = [{ value: '', label: 'Selecione...' }];
        if (optionsType === 'status') {
            statusChoices.forEach((status) => {
                options.push({ value: String(status), label: String(status) });
            });
        } else if (optionsType === 'usuarios') {
            usuariosSelectOptions.forEach((usuario) => {
                options.push({ value: String(usuario.id), label: String(usuario.name || '') });
            });
        } else {
            return;
        }

        if (currentValue && !options.some((item) => item.value === currentValue)) {
            options.push({ value: currentValue, label: currentLabel || currentValue });
        }

        const previousValue = selectElement.value || currentValue;
        selectElement.innerHTML = '';
        options.forEach((item) => {
            const option = document.createElement('option');
            option.value = item.value;
            option.textContent = item.label;
            selectElement.appendChild(option);
        });
        if (previousValue) {
            selectElement.value = previousValue;
        }
        selectElement.dataset.hydrated = '1';
    }

    function adjustDashboardConcluida(tributacao, delta) {
        const cardData = dashboardCards.get(tributacao);
        if (!cardData) return;
        const total = parseCount(cardData.card.dataset.total);
        let concluida = parseCount(cardData.card.dataset.concluida) + delta;
        concluida = Math.max(concluida, 0);
        const faltantes = Math.max(total - concluida, 0);
        cardData.card.dataset.concluida = String(concluida);
        cardData.card.dataset.faltantes = String(faltantes);
        if (cardData.concluidaEl) {
            cardData.concluidaEl.textContent = concluida;
        }
        if (cardData.faltantesEl) {
            cardData.faltantesEl.textContent = faltantes;
        }
    }

    function adjustDashboardAguardando(tributacao, delta) {
        const cardData = dashboardCards.get(tributacao);
        if (!cardData) return;
        let aguardando = parseCount(cardData.card.dataset.aguardando) + delta;
        aguardando = Math.max(aguardando, 0);
        cardData.card.dataset.aguardando = String(aguardando);
        if (cardData.aguardandoEl) {
            cardData.aguardandoEl.textContent = aguardando;
        }
    }

    function adjustDashboardFechamento(tributacao, delta) {
        const cardData = dashboardCards.get(tributacao);
        if (!cardData) return;
        let fechamento = parseCount(cardData.card.dataset.fechamento) + delta;
        fechamento = Math.max(fechamento, 0);
        cardData.card.dataset.fechamento = String(fechamento);
        if (cardData.fechamentoEl) {
            cardData.fechamentoEl.textContent = fechamento;
        }
    }

    function updateDashboardForStatus(row, newStatus) {
        if (!row) return;
        const tributacao = row.dataset.tributacao;
        const prevStatus = row.dataset.status || '';
        const nextStatus = newStatus || '';
        if (prevStatus === nextStatus) return;
        if (tributacao) {
            const wasConcluida = prevStatus === 'ENCERRADO';
            const isConcluida = nextStatus === 'ENCERRADO';
            if (wasConcluida !== isConcluida) {
                adjustDashboardConcluida(tributacao, isConcluida ?1 : -1);
            }
        }
        row.dataset.status = nextStatus;
    }

    function updateDashboardForClienteFile(row, hasFileNow) {
        if (!row) return;
        const tributacao = row.dataset.tributacao;
        const hadFile = row.dataset.hasClienteFile === '1';
        if (hadFile === hasFileNow) return;
        if (tributacao) {
            adjustDashboardAguardando(tributacao, hasFileNow ?-1 : 1);
        }
        row.dataset.hasClienteFile = hasFileNow ?'1' : '0';
    }

    function updateDashboardForEncerramento(row, value) {
        if (!row) return;
        const tributacao = row.dataset.tributacao;
        const prevValue = row.dataset.encerramentoFiscal === '1';
        const nextValue = value === true || value === 'true' || value === 'True' || value === '1';
        if (prevValue === nextValue) return;
        if (tributacao) {
            adjustDashboardFechamento(tributacao, nextValue ?1 : -1);
        }
        row.dataset.encerramentoFiscal = nextValue ?'1' : '0';
    }

    // Garantir que dropdowns dos filtros sobreponham a tabela (sem corte por scroll)
    const filterDropdownToggles = [
        document.getElementById('tributacaoFilterDropdown'),
        document.getElementById('statusFilterDropdown')
    ].filter(Boolean);
    let activeDropdown = null;

    function positionDetachedMenu(toggle, menu) {
        if (!toggle || !menu) return;
        const rect = toggle.getBoundingClientRect();
        const menuWidth = menu.offsetWidth || 0;
        const padding = 8;
        let left = rect.left;
        if (menu.classList.contains('dropdown-menu-end')) {
            left = rect.right - menuWidth;
        }
        const maxLeft = Math.max(padding, window.innerWidth - menuWidth - padding);
        left = Math.min(Math.max(left, padding), maxLeft);
        menu.style.position = 'fixed';
        menu.style.top = `${rect.bottom + 4}px`;
        menu.style.left = `${left}px`;
        menu.style.zIndex = '2000';
    }

    function detachDropdownMenu(toggle) {
        const menu = toggle?.parentElement?.querySelector('.dropdown-menu');
        if (!menu || menu.dataset.detached === '1') return;
        menu.dataset.detached = '1';
        menu._originalParent = menu.parentNode;
        menu._originalNextSibling = menu.nextSibling;
        document.body.appendChild(menu);
        positionDetachedMenu(toggle, menu);
        toggle._detachedMenu = menu;
        activeDropdown = toggle;
    }

    function restoreDropdownMenu(toggle) {
        const menu = toggle?._detachedMenu;
        if (!menu || menu.dataset.detached !== '1') return;
        if (menu._originalParent) {
            if (menu._originalNextSibling) {
                menu._originalParent.insertBefore(menu, menu._originalNextSibling);
            } else {
                menu._originalParent.appendChild(menu);
            }
        }
        delete menu._originalParent;
        delete menu._originalNextSibling;
        menu.dataset.detached = '';
        menu.style.position = '';
        menu.style.top = '';
        menu.style.left = '';
        menu.style.zIndex = '';
        toggle._detachedMenu = null;
        if (activeDropdown === toggle) {
            activeDropdown = null;
        }
    }

    filterDropdownToggles.forEach((toggle) => {
        toggle.addEventListener('shown.bs.dropdown', () => detachDropdownMenu(toggle));
        toggle.addEventListener('hide.bs.dropdown', () => restoreDropdownMenu(toggle));
    });

    window.addEventListener('resize', () => {
        if (activeDropdown && activeDropdown._detachedMenu) {
            positionDetachedMenu(activeDropdown, activeDropdown._detachedMenu);
        }
    });
    window.addEventListener('scroll', () => {
        if (activeDropdown && activeDropdown._detachedMenu) {
            positionDetachedMenu(activeDropdown, activeDropdown._detachedMenu);
        }
    }, true);

    function sanitizeTributacoes(values) {
        return values.filter((value) => allowedTributacoes.includes(value));
    }

    function sanitizeStatus(values) {
        return values.filter((value) => statusChoices.includes(value));
    }

    // Gerenciar filtro de tributação
    if (clearTributacao) {
        try {
            localStorage.removeItem(tributacaoStorageKey);
        } catch (_) {
            /* armazenamento indisponivel */
        }
    } else if (currentTributacoes.length) {
        const sanitized = sanitizeTributacoes(currentTributacoes);
        try {
            localStorage.setItem(tributacaoStorageKey, JSON.stringify(sanitized));
        } catch (_) {
            /* armazenamento indisponivel */
        }
    } else {
        let savedTributacoes = [];
        try {
            savedTributacoes = JSON.parse(localStorage.getItem(tributacaoStorageKey) || '[]');
        } catch (_) {
            savedTributacoes = [];
        }
        const sanitized = sanitizeTributacoes(Array.isArray(savedTributacoes) ?savedTributacoes : []);
        if (sanitized.length) {
            sanitized.forEach((value) => currentUrl.searchParams.append('tributacao', value));
            window.location.replace(currentUrl.toString());
            return;
        }
    }

    // Gerenciar filtro de status
    if (clearStatus) {
        try {
            localStorage.removeItem(statusStorageKey);
        } catch (_) {
            /* armazenamento indisponivel */
        }
    } else if (currentStatus.length) {
        const sanitized = sanitizeStatus(currentStatus);
        try {
            localStorage.setItem(statusStorageKey, JSON.stringify(sanitized));
        } catch (_) {
            /* armazenamento indisponivel */
        }
    } else {
        let savedStatus = [];
        try {
            savedStatus = JSON.parse(localStorage.getItem(statusStorageKey) || '[]');
        } catch (_) {
            savedStatus = [];
        }
        const sanitized = sanitizeStatus(Array.isArray(savedStatus) ?savedStatus : []);
        if (sanitized.length) {
            sanitized.forEach((value) => currentUrl.searchParams.append('status', value));
            window.location.replace(currentUrl.toString());
            return;
        }
    }

    // Debounce para evitar requests excessivos
    let debounceTimers = {};

    // Função para formatar valor como moeda
    function formatMoney(value) {
        // Remover tudo exceto números
        let numbers = value.replace(/\D/g, '');

        if (!numbers) return '';

        // Converter para número
        let amount = parseFloat(numbers) / 100;

        // Limite de R$ 1.000.000.000,00 (1 bilhão)
        const MAX_VALUE = 1000000000;
        if (amount > MAX_VALUE) {
            amount = MAX_VALUE;
        }

        // Formatar como moeda brasileira
        return 'R$ ' + amount.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }

    // Aplicar máscara de moeda em campos monetários
    document.querySelectorAll('.money-field').forEach(field => {
        field.addEventListener('input', function (e) {
            let cursorPosition = this.selectionStart;
            let oldLength = this.value.length;

            this.value = formatMoney(this.value);

            // Ajustar posição do cursor
            let newLength = this.value.length;
            let diff = newLength - oldLength;
            this.selectionStart = this.selectionEnd = cursorPosition + diff;
        });

        // Formatar ao carregar se já tiver valor
        if (field.value && !field.value.startsWith('R$')) {
            field.value = formatMoney(field.value);
        }
    });

    // Função para ajustar tamanho da fonte do status
    function adjustStatusFontSize(selectElement) {
        const selectedOption = selectElement.options[selectElement.selectedIndex];
        const text = selectedOption ?selectedOption.text : '';
        const length = text.length;

        selectElement.classList.remove('status-short', 'status-medium', 'status-long');

        if (length === 0) {
            selectElement.classList.add('status-short');
        } else if (length <= 15) {
            selectElement.classList.add('status-short');
        } else if (length <= 25) {
            selectElement.classList.add('status-medium');
        } else {
            selectElement.classList.add('status-long');
        }
    }

    // Aplicar ajuste inicial nos selects de status
    document.querySelectorAll('select[data-field="status"]').forEach(select => {
        adjustStatusFontSize(select);
    });

    document.querySelectorAll('.lazy-options-select').forEach((select) => {
        const hydrate = () => hydrateLazySelectOptions(select);
        select.addEventListener('focus', hydrate, { once: true });
        select.addEventListener('mousedown', hydrate, { once: true });
        select.addEventListener('touchstart', hydrate, { once: true });
    });

    // Função para verificar e destacar CFOP consolidado quando encerramento fiscal = SIM e sem arquivo
    function parseRowFileCount(row, key) {
        const raw = row?.dataset?.[key] || '0';
        const value = parseInt(raw, 10);
        return Number.isNaN(value) ?0 : Math.max(value, 0);
    }

    function setRowFileCount(row, key, value) {
        if (!row || !row.dataset) return;
        row.dataset[key] = String(Math.max(0, Number(value) || 0));
    }

    // Verifica destaque do CFOP consolidado e disponibilidade do botao de mover
    function checkCFOPConsolidadoStatus(row) {
        const encerramentoSelect = row.querySelector('select[data-field="encerramento_fiscal"]');
        const statusSelect = row.querySelector('select[data-field="status"]');
        const cfopContainer = row.querySelector('.cfop-consolidado-container');

        if (!encerramentoSelect || !cfopContainer) return;

        const encerramentoValue = encerramentoSelect.value;
        const statusValue = (statusSelect && statusSelect.value ?statusSelect.value : '').trim();
        const hasConsolidadoFile = parseRowFileCount(row, 'cfopConsolidadoCount') > 0;
        const isLiberadoBalanco = statusValue === 'LIBERADO PARA BALANÇO';

        if (encerramentoValue === 'true' && !hasConsolidadoFile && !isLiberadoBalanco) {
            cfopContainer.classList.add('cfop-missing-file');
        } else {
            cfopContainer.classList.remove('cfop-missing-file');
        }

        const moveButton = row.querySelector('.move-cfop-to-consolidado-btn');
        if (moveButton) {
            moveButton.disabled = parseRowFileCount(row, 'cfopCount') <= 0;
        }
    }

    // Listeners de linha e uploads s?o aplicados por bindRowHandlers para evitar duplicidade.

    function bindDeleteCFOPButton(btn) {
        if (!btn || btn.dataset.boundDelete === '1') return;
        btn.dataset.boundDelete = '1';
        btn.addEventListener('click', function () {
            window.portalConfirm({
                title: 'Confirmar acao',
                message: 'Deseja realmente remover este arquivo?',
                variant: 'danger'
            }).then((confirmed) => {
                if (!confirmed) {
                    return;
                }
                const row = this.closest('tr');
                const empresaId = row.dataset.empresaId;
                const fileItem = this.closest('.file-item');
                const fileIndex = parseInt(fileItem.dataset.fileIndex, 10);
                deleteCFOPFile(empresaId, fileIndex, fileItem);
            });
        });
    }

    function bindDeleteCfopConsolidadoButton(btn) {
        if (!btn || btn.dataset.boundDelete === '1') return;
        btn.dataset.boundDelete = '1';
        btn.addEventListener('click', function () {
            window.portalConfirm({
                title: 'Confirmar acao',
                message: 'Deseja realmente remover este arquivo?',
                variant: 'danger'
            }).then((confirmed) => {
                if (!confirmed) {
                    return;
                }
                const row = this.closest('tr');
                const empresaId = row.dataset.empresaId;
                const fileItem = this.closest('.file-item');
                const fileIndex = parseInt(fileItem.dataset.fileIndex, 10);
                deleteCfopConsolidadoFile(empresaId, fileIndex, fileItem);
            });
        });
    }

    function bindDeleteClienteButton(btn) {
        if (!btn || btn.dataset.boundDelete === '1') return;
        btn.dataset.boundDelete = '1';
        btn.addEventListener('click', function () {
            window.portalConfirm({
                title: 'Confirmar acao',
                message: 'Deseja realmente remover este arquivo?',
                variant: 'danger'
            }).then((confirmed) => {
                if (!confirmed) {
                    return;
                }
                const row = this.closest('tr');
                const empresaId = row.dataset.empresaId;
                const fileItem = this.closest('.file-item');
                const fileIndex = parseInt(fileItem.dataset.fileIndex, 10);
                deleteClienteFileV2(empresaId, fileIndex, fileItem);
            });
        });
    }

    function ensureFilesList(container, inputElement) {
        let filesList = container.querySelector('.files-list');
        if (!filesList) {
            filesList = document.createElement('div');
            filesList.className = 'files-list mb-1';
            filesList.dataset.loaded = '0';
            container.insertBefore(filesList, inputElement);
        }
        return filesList;
    }

    function updateRowStatus(row, statusValue) {
        if (!row || statusValue === undefined || statusValue === null) return;
        const statusSelect = row.querySelector('select[data-field="status"]');
        if (statusSelect) {
            if (statusSelect.dataset.hydrated !== '1') {
                hydrateLazySelectOptions(statusSelect);
            }
            if (!Array.from(statusSelect.options).some((opt) => opt.value === String(statusValue))) {
                const dynamicOption = document.createElement('option');
                dynamicOption.value = String(statusValue);
                dynamicOption.textContent = String(statusValue);
                statusSelect.appendChild(dynamicOption);
            }
            statusSelect.value = statusValue;
            adjustStatusFontSize(statusSelect);
            statusSelect.dataset.prevStatus = statusValue;
            statusSelect.dataset.currentValue = statusValue;
        }
        updateDashboardForStatus(row, statusValue);
    }

    function clearFilesPlaceholders(filesList) {
        if (!filesList) return;
        filesList.querySelectorAll('.files-placeholder').forEach(el => el.remove());
        filesList.querySelectorAll('small.text-muted').forEach(el => {
            if ((el.textContent || '').trim() === 'Nenhum arquivo') {
                el.remove();
            }
        });
    }

    function appendCfopFileItem(filesList, empresaId, fileIndex, filename) {
        clearFilesPlaceholders(filesList);
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item d-flex gap-1 align-items-center mb-1';
        fileItem.dataset.fileIndex = fileIndex;

        const nameEl = document.createElement('small');
        nameEl.className = 'text-muted text-truncate flex-grow-1';
        nameEl.style.maxWidth = '70px';
        nameEl.title = filename;
        nameEl.textContent = filename;

        const viewLink = document.createElement('a');
        viewLink.href = `/api/inventario/file/${empresaId}/cfop/${fileIndex}`;
        viewLink.target = '_blank';
        viewLink.className = 'btn btn-outline-primary btn-sm';
        viewLink.title = 'Visualizar';
        viewLink.innerHTML = '<i class="bi bi-eye"></i>';

        const downloadLink = document.createElement('a');
        downloadLink.href = viewLink.href;
        downloadLink.download = filename;
        downloadLink.className = 'btn btn-outline-success btn-sm';
        downloadLink.title = 'Baixar';
        downloadLink.innerHTML = '<i class="bi bi-download"></i>';

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-outline-danger btn-sm delete-cfop-file-btn';
        deleteBtn.title = 'Remover';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        bindDeleteCFOPButton(deleteBtn);

        fileItem.append(nameEl, viewLink, downloadLink, deleteBtn);
        filesList.appendChild(fileItem);
    }

    function appendCfopConsolidadoFileItem(filesList, empresaId, fileIndex, filename) {
        clearFilesPlaceholders(filesList);
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item d-flex gap-1 align-items-center mb-1';
        fileItem.dataset.fileIndex = fileIndex;

        const nameEl = document.createElement('small');
        nameEl.className = 'text-muted text-truncate flex-grow-1';
        nameEl.style.maxWidth = '70px';
        nameEl.title = filename;
        nameEl.textContent = filename;

        const viewLink = document.createElement('a');
        viewLink.href = `/api/inventario/file/${empresaId}/cfop-consolidado/${fileIndex}`;
        viewLink.target = '_blank';
        viewLink.className = 'btn btn-outline-primary btn-sm';
        viewLink.title = 'Visualizar';
        viewLink.innerHTML = '<i class="bi bi-eye"></i>';

        const downloadLink = document.createElement('a');
        downloadLink.href = viewLink.href;
        downloadLink.download = filename;
        downloadLink.className = 'btn btn-outline-success btn-sm';
        downloadLink.title = 'Baixar';
        downloadLink.innerHTML = '<i class="bi bi-download"></i>';

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-outline-danger btn-sm delete-cfop-consolidado-file-btn';
        deleteBtn.title = 'Remover';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        bindDeleteCfopConsolidadoButton(deleteBtn);

        fileItem.append(nameEl, viewLink, downloadLink, deleteBtn);
        filesList.appendChild(fileItem);
    }

    function appendClienteFileItem(filesList, empresaId, fileIndex, filename) {
        clearFilesPlaceholders(filesList);
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item d-flex gap-1 align-items-center mb-1';
        fileItem.dataset.fileIndex = fileIndex;

        const nameEl = document.createElement('small');
        nameEl.className = 'text-muted text-truncate flex-grow-1';
        nameEl.style.maxWidth = '60px';
        nameEl.title = filename;
        nameEl.textContent = filename;

        const viewLink = document.createElement('a');
        viewLink.href = `/api/inventario/file/${empresaId}/cliente/${fileIndex}`;
        viewLink.target = '_blank';
        viewLink.className = 'btn btn-outline-primary btn-sm';
        viewLink.title = 'Visualizar';
        viewLink.innerHTML = '<i class="bi bi-eye"></i>';

        const downloadLink = document.createElement('a');
        downloadLink.href = viewLink.href;
        downloadLink.download = filename;
        downloadLink.className = 'btn btn-outline-success btn-sm';
        downloadLink.title = 'Baixar';
        downloadLink.innerHTML = '<i class="bi bi-download"></i>';

        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'btn btn-outline-danger btn-sm delete-cliente-file-btn';
        deleteBtn.title = 'Remover';
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
        bindDeleteClienteButton(deleteBtn);

        fileItem.append(nameEl, viewLink, downloadLink, deleteBtn);
        filesList.appendChild(fileItem);
    }

    function updateFileListIndices(filesList, empresaId, fileType) {
        const items = Array.from(filesList.querySelectorAll('.file-item'));
        items.forEach((item, index) => {
            item.dataset.fileIndex = index;
            item.querySelectorAll('a').forEach(link => {
                link.href = `/api/inventario/file/${empresaId}/${fileType}/${index}`;
            });
        });
    }

    function getAppendFnByType(fileType) {
        if (fileType === 'cfop') return appendCfopFileItem;
        if (fileType === 'cfop-consolidado') return appendCfopConsolidadoFileItem;
        return appendClienteFileItem;
    }

    function getRowCountKeyByType(fileType) {
        if (fileType === 'cfop') return 'cfopCount';
        if (fileType === 'cfop-consolidado') return 'cfopConsolidadoCount';
        return 'clienteCount';
    }

    function getApiPayloadKey(fileType) {
        if (fileType === 'cfop-consolidado') return 'cfop_consolidado';
        return fileType;
    }

    function updateLoadButtonLabel(row, fileType) {
        const container = fileType === 'cfop'
            ?row.querySelector('.cfop-container')
            : fileType === 'cfop-consolidado'
                ?row.querySelector('.cfop-consolidado-container')
                : row.querySelector('.cliente-upload-container');
        if (!container) return;
        const button = container.querySelector(`.load-files-btn[data-file-type="${fileType}"]`);
        if (!button) return;
        const count = parseRowFileCount(row, getRowCountKeyByType(fileType));
        button.textContent = `Carregar (${count})`;
    }

    function setRowFileCountByType(row, fileType, count) {
        const key = getRowCountKeyByType(fileType);
        setRowFileCount(row, key, count);
        updateLoadButtonLabel(row, fileType);
        if (fileType === 'cliente') {
            const hasLegacy = row.dataset.hasClienteLegacy === '1';
            updateDashboardForClienteFile(row, hasLegacy || (count > 0));
        }
        checkCFOPConsolidadoStatus(row);
    }

    function loadFilesOnDemand(row, fileType, forceRefresh = false) {
        const empresaId = row.dataset.empresaId;
        const container = fileType === 'cfop'
            ?row.querySelector('.cfop-container')
            : fileType === 'cfop-consolidado'
                ?row.querySelector('.cfop-consolidado-container')
                : row.querySelector('.cliente-upload-container');
        if (!container) return Promise.resolve();

        const filesList = container.querySelector('.files-list');
        const inputElement = container.querySelector('.pdf-upload, .cfop-consolidado-upload, .cliente-upload');
        if (!filesList || !inputElement) return Promise.resolve();

        const alreadyLoaded = filesList.dataset.loaded === '1';
        if (alreadyLoaded && !forceRefresh) return Promise.resolve();

        filesList.dataset.loaded = 'loading';
        filesList.innerHTML = '<small class="text-muted">Carregando...</small>';

        return fetch(`/api/inventario/files/${empresaId}`)
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    throw new Error(data.error || 'Erro ao carregar arquivos');
                }
                const payloadKey = getApiPayloadKey(fileType);
                const files = Array.isArray(data[payloadKey]) ?data[payloadKey] : [];
                const appendFn = getAppendFnByType(fileType);
                const ensuredList = ensureFilesList(container, inputElement);
                ensuredList.innerHTML = '';
                files.forEach(file => {
                    appendFn(ensuredList, empresaId, file.index, file.filename || 'arquivo');
                });
                ensuredList.dataset.loaded = '1';
                setRowFileCountByType(row, fileType, files.length);
                if (files.length === 0) {
                    ensuredList.innerHTML = '<small class="text-muted">Nenhum arquivo</small>';
                }
            })
            .catch(error => {
                filesList.dataset.loaded = '0';
                filesList.innerHTML = '<small class="text-danger">Falha ao carregar</small>';
                console.error('Erro ao carregar arquivos sob demanda:', error);
            });
    }

    function bindRowHandlers(scope = document) {
        scope.querySelectorAll('.load-files-btn').forEach(btn => {
            if (btn.dataset.boundClick === '1') return;
            btn.dataset.boundClick = '1';
            btn.addEventListener('click', function () {
                const row = this.closest('tr');
                const fileType = this.dataset.fileType;
                loadFilesOnDemand(row, fileType);
            });
        });
        scope.querySelectorAll('.delete-cfop-file-btn').forEach(bindDeleteCFOPButton);
        scope.querySelectorAll('.delete-cfop-consolidado-file-btn').forEach(bindDeleteCfopConsolidadoButton);
        scope.querySelectorAll('.delete-cliente-file-btn').forEach(bindDeleteClienteButton);
        scope.querySelectorAll('.move-cfop-to-consolidado-btn').forEach(btn => {
            if (btn.dataset.boundClick === '1') return;
            btn.dataset.boundClick = '1';
            btn.addEventListener('click', function () {
                const row = this.closest('tr');
                const empresaId = row.dataset.empresaId;
                moveCfopToConsolidado(empresaId, row, this);
            });
        });
        scope.querySelectorAll('.cliente-upload').forEach(input => {
            if (input.dataset.boundChange === '1') return;
            input.dataset.boundChange = '1';
            input.addEventListener('change', function () {
                const row = this.closest('tr');
                const empresaId = row.dataset.empresaId;
                const file = this.files[0];
                if (file) {
                    uploadClienteFile(empresaId, file, this);
                }
            });
        });
        scope.querySelectorAll('.pdf-upload').forEach(input => {
            if (input.dataset.boundChange === '1') return;
            input.dataset.boundChange = '1';
            input.addEventListener('change', function () {
                const row = this.closest('tr');
                const empresaId = row.dataset.empresaId;
                const file = this.files[0];
                const isPdf = file && (
                    file.type === 'application/pdf'
                    || (file.name && file.name.toLowerCase().endsWith('.pdf'))
                );
                if (isPdf) {
                    uploadPDF(empresaId, file, this);
                } else if (file) {
                    alert('Por favor, selecione um arquivo PDF válido.');
                    this.value = '';
                }
            });
        });
        scope.querySelectorAll('.cfop-consolidado-upload').forEach(input => {
            if (input.dataset.boundChange === '1') return;
            input.dataset.boundChange = '1';
            input.addEventListener('change', function () {
                const row = this.closest('tr');
                const empresaId = row.dataset.empresaId;
                const file = this.files[0];
                const isPdf = file && (
                    file.type === 'application/pdf'
                    || (file.name && file.name.toLowerCase().endsWith('.pdf'))
                );
                if (isPdf) {
                    uploadCfopConsolidado(empresaId, file, this);
                } else if (file) {
                    alert('Por favor, selecione um arquivo PDF válido.');
                    this.value = '';
                }
            });
        });
        scope.querySelectorAll('.editable-field').forEach(field => {
            if (field.dataset.boundChange === '1') return;
            field.dataset.boundChange = '1';
            field.addEventListener('change', function () {
                const row = this.closest('tr');
                const empresaId = row.dataset.empresaId;
                const fieldName = this.dataset.field;
                const value = this.value;
                if (fieldName === 'status') {
                    const prevStatus = this.dataset.prevStatus || row.dataset.status || '';
                    adjustStatusFontSize(this);
                    updateDashboardForStatus(row, value);
                    this.dataset.prevStatus = prevStatus;
                }
                const shouldDebounceShort =
                    this.tagName === 'SELECT' ||
                    (this.tagName === 'INPUT' && this.type === 'date');
                if (shouldDebounceShort) {
                    const timerKey = `change:${fieldName}:${empresaId}`;
                    if (debounceTimers[timerKey]) {
                        clearTimeout(debounceTimers[timerKey]);
                    }
                    debounceTimers[timerKey] = setTimeout(() => {
                        updateInventario(empresaId, fieldName, value, this);
                    }, 250);
                } else {
                    updateInventario(empresaId, fieldName, value, this);
                }
            });
            if (field.tagName === 'INPUT' && field.type === 'text' && !field.classList.contains('money-field')) {
                if (field.dataset.boundInput === '1') return;
                field.dataset.boundInput = '1';
                field.addEventListener('input', function () {
                    const row = this.closest('tr');
                    const empresaId = row.dataset.empresaId;
                    const fieldName = this.dataset.field;
                    const value = this.value;
                    const element = this;
                    if (debounceTimers[fieldName + empresaId]) {
                        clearTimeout(debounceTimers[fieldName + empresaId]);
                    }
                    debounceTimers[fieldName + empresaId] = setTimeout(() => {
                        updateInventario(empresaId, fieldName, value, element);
                    }, 1000);
                });
            }
        });
        scope.querySelectorAll('.money-field').forEach(field => {
            if (field.dataset.boundInput === '1') return;
            field.dataset.boundInput = '1';
            field.addEventListener('input', function () {
                let cursorPosition = this.selectionStart;
                let oldLength = this.value.length;
                this.value = formatMoney(this.value);
                let newLength = this.value.length;
                let diff = newLength - oldLength;
                this.selectionStart = this.selectionEnd = cursorPosition + diff;
            });
            if (field.value && !field.value.startsWith('R$')) {
                field.value = formatMoney(field.value);
            }
        });
        scope.querySelectorAll('select[data-field="status"]').forEach(select => {
            adjustStatusFontSize(select);
        });
        scope.querySelectorAll('select[data-field="encerramento_fiscal"]').forEach(select => {
            if (select.dataset.boundChange === '1') return;
            select.dataset.boundChange = '1';
            select.addEventListener('change', function () {
                const row = this.closest('tr');
                checkCFOPConsolidadoStatus(row);
            });
        });
        scope.querySelectorAll('.lazy-options-select').forEach((select) => {
            if (select.dataset.boundLazy === '1') return;
            select.dataset.boundLazy = '1';
            const hydrate = () => hydrateLazySelectOptions(select);
            select.addEventListener('focus', hydrate, { once: true });
            select.addEventListener('mousedown', hydrate, { once: true });
            select.addEventListener('touchstart', hydrate, { once: true });
        });
        scope.querySelectorAll('tr[data-empresa-id]').forEach(row => {
            updateLoadButtonLabel(row, 'cfop');
            updateLoadButtonLabel(row, 'cfop-consolidado');
            updateLoadButtonLabel(row, 'cliente');
            checkCFOPConsolidadoStatus(row);
        });
    }

    // Evita duplicar listeners já registrados nos elementos iniciais.
    document.querySelectorAll('.editable-field').forEach(el => {
        el.dataset.boundChange = '1';
        if (el.tagName === 'INPUT' && el.type === 'text' && !el.classList.contains('money-field')) {
            el.dataset.boundInput = '1';
        }
    });
    document.querySelectorAll('.money-field').forEach(el => el.dataset.boundInput = '1');
    document.querySelectorAll('.pdf-upload, .cfop-consolidado-upload').forEach(el => {
        el.dataset.boundChange = '1';
    });
    document.querySelectorAll('select[data-field="encerramento_fiscal"]').forEach(el => el.dataset.boundChange = '1');
    document.querySelectorAll('.lazy-options-select').forEach(el => el.dataset.boundLazy = '1');

    bindRowHandlers(document);

    if (listAllProgressive && listAllToken) {
        const loadMoreBtn = document.getElementById('listallLoadMoreBtn');
        const progressText = document.getElementById('listallProgressText');
        const tbody = document.querySelector('#inventarioTable tbody');
        const tableWrapper = document.querySelector('.table-wrapper');
        let isLoadingChunk = false;
        let refreshVirtualization = null;

        const updateProgress = () => {
            if (progressText) {
                progressText.textContent = `${listAllLoaded} / ${listAllTotal}`;
            }
            if (loadMoreBtn && listAllLoaded >= listAllTotal) {
                loadMoreBtn.disabled = true;
                loadMoreBtn.textContent = 'Carregado';
            }
        };

        const requestNextChunk = (source = 'manual') => {
            if (!loadMoreBtn || !tbody) return;
            if (isLoadingChunk || listAllLoaded >= listAllTotal) return;
            isLoadingChunk = true;
            loadMoreBtn.disabled = true;
            loadMoreBtn.textContent = source === 'auto' ? 'Carregando automaticamente...' : 'Carregando...';

            fetch(`/api/inventario/chunk?token=${encodeURIComponent(listAllToken)}&offset=${listAllLoaded}&limit=${listAllChunkSize}`)
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        throw new Error(data.error || 'Erro ao carregar lote');
                    }
                    if (data.html) {
                        const tmp = document.createElement('tbody');
                        tmp.innerHTML = data.html;
                        const newRows = Array.from(tmp.querySelectorAll('tr'));
                        newRows.forEach(row => tbody.appendChild(row));
                        bindRowHandlers(tbody);
                        if (typeof refreshVirtualization === 'function') {
                            refreshVirtualization();
                        }
                    }
                    listAllLoaded = Number(data.loaded || listAllLoaded);
                    updateProgress();
                    if (listAllLoaded < listAllTotal) {
                        loadMoreBtn.disabled = false;
                        loadMoreBtn.textContent = 'Carregar mais';
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar mais linhas:', error);
                    loadMoreBtn.disabled = false;
                    loadMoreBtn.textContent = 'Tentar novamente';
                })
                .finally(() => {
                    isLoadingChunk = false;
                });
        };

        updateProgress();

        if (loadMoreBtn && tbody) {
            loadMoreBtn.addEventListener('click', () => requestNextChunk('manual'));
        }

        if (tableWrapper) {
            const enableVirtualization = () => {
                const topSpacer = document.createElement('tr');
                topSpacer.className = 'virtual-spacer';
                const topSpacerCell = document.createElement('td');
                topSpacerCell.colSpan = document.querySelectorAll('#inventarioTable thead th').length || 1;
                topSpacer.appendChild(topSpacerCell);

                const bottomSpacer = document.createElement('tr');
                bottomSpacer.className = 'virtual-spacer';
                const bottomSpacerCell = document.createElement('td');
                bottomSpacerCell.colSpan = topSpacerCell.colSpan;
                bottomSpacer.appendChild(bottomSpacerCell);

                const ensureSpacers = () => {
                    if (!tbody.firstElementChild || !tbody.firstElementChild.classList.contains('virtual-spacer')) {
                        tbody.insertBefore(topSpacer, tbody.firstChild);
                    }
                    if (!tbody.lastElementChild || !tbody.lastElementChild.classList.contains('virtual-spacer')) {
                        tbody.appendChild(bottomSpacer);
                    }
                };

                const renderWindow = () => {
                    const rows = Array.from(tbody.querySelectorAll('tr[data-empresa-id]'));
                    const totalRows = rows.length;
                    if (totalRows <= 220) {
                        rows.forEach(row => row.classList.remove('virtual-hidden'));
                        topSpacerCell.style.height = '0px';
                        bottomSpacerCell.style.height = '0px';
                        return;
                    }

                    const firstVisible = rows.find(row => !row.classList.contains('virtual-hidden')) || rows[0];
                    const rowHeight = Math.max(36, firstVisible.getBoundingClientRect().height || 48);
                    const overscan = 14;
                    const viewportRows = Math.ceil(tableWrapper.clientHeight / rowHeight) + overscan * 2;
                    const rawStart = Math.floor(tableWrapper.scrollTop / rowHeight) - overscan;
                    const start = Math.max(0, rawStart);
                    const end = Math.min(totalRows, start + viewportRows);

                    rows.forEach((row, idx) => {
                        if (idx >= start && idx < end) {
                            row.classList.remove('virtual-hidden');
                        } else {
                            row.classList.add('virtual-hidden');
                        }
                    });

                    topSpacerCell.style.height = `${start * rowHeight}px`;
                    bottomSpacerCell.style.height = `${Math.max(0, (totalRows - end) * rowHeight)}px`;
                };

                ensureSpacers();
                renderWindow();
                refreshVirtualization = () => {
                    ensureSpacers();
                    renderWindow();
                };
                tableWrapper.addEventListener('scroll', renderWindow, { passive: true });
            };

            enableVirtualization();

            tableWrapper.addEventListener('scroll', () => {
                if (isLoadingChunk || listAllLoaded >= listAllTotal) return;
                const remaining = tableWrapper.scrollHeight - tableWrapper.scrollTop - tableWrapper.clientHeight;
                if (remaining <= 220) {
                    requestNextChunk('auto');
                }
            }, { passive: true });

            // Se o viewport inicial não preencher a área, puxa o próximo lote automaticamente.
            setTimeout(() => {
                const remaining = tableWrapper.scrollHeight - tableWrapper.clientHeight;
                if (remaining <= 220 && listAllLoaded < listAllTotal) {
                    requestNextChunk('auto');
                }
            }, 120);
        }
    }

    // Mantém dropdown de tributação aberto ao marcar checkboxes
    const tribDropdownToggle = document.getElementById('tributacaoFilterDropdown');
    if (tribDropdownToggle && bootstrap?.Dropdown) {
        const tribDropdownInstance = bootstrap.Dropdown.getOrCreateInstance(tribDropdownToggle, { autoClose: 'outside' });
        const dropdownParent = tribDropdownToggle.closest('.dropdown');

        if (dropdownParent) {
            dropdownParent.addEventListener('hide.bs.dropdown', function (event) {
                const clickTarget = event?.clickEvent?.target;
                if (!clickTarget) return;

                const insideForm = clickTarget.closest('.tributacao-filter-form');
                const isApply = clickTarget.closest('.tributacao-filter-apply');
                const isClear = clickTarget.closest('.tributacao-filter-clear');

                if (insideForm && !isApply && !isClear) {
                    event.preventDefault();
                }
            });
        }

        // Evita propagação nos checkboxes para não fechar por engano
        document.querySelectorAll('.tributacao-filter-form .form-check-input').forEach(function (input) {
            input.addEventListener('click', function (ev) {
                ev.stopPropagation();
            });
        });
    }

    // Mantém dropdown de status aberto ao marcar checkboxes
    const statusDropdownToggle = document.getElementById('statusFilterDropdown');
    if (statusDropdownToggle && bootstrap?.Dropdown) {
        const statusDropdownInstance = bootstrap.Dropdown.getOrCreateInstance(statusDropdownToggle, { autoClose: 'outside' });
        const statusDropdownParent = statusDropdownToggle.closest('.dropdown');

        if (statusDropdownParent) {
            statusDropdownParent.addEventListener('hide.bs.dropdown', function (event) {
                const clickTarget = event?.clickEvent?.target;
                if (!clickTarget) return;

                const insideForm = clickTarget.closest('.status-filter-form');
                const isApply = clickTarget.closest('.status-filter-apply');
                const isClear = clickTarget.closest('.status-filter-clear');

                if (insideForm && !isApply && !isClear) {
                    event.preventDefault();
                }
            });
        }

        // Evita propagação nos checkboxes para não fechar por engano
        document.querySelectorAll('.status-filter-form .form-check-input').forEach(function (input) {
            input.addEventListener('click', function (ev) {
                ev.stopPropagation();
            });
        });
    }

    // Mantém dropdown de tag aberto ao marcar checkboxes
    const tagDropdownToggle = document.getElementById('tagFilterDropdown');
    if (tagDropdownToggle && bootstrap?.Dropdown) {
        const tagDropdownInstance = bootstrap.Dropdown.getOrCreateInstance(tagDropdownToggle, { autoClose: 'outside' });
        const tagDropdownParent = tagDropdownToggle.closest('.dropdown');

        if (tagDropdownParent) {
            tagDropdownParent.addEventListener('hide.bs.dropdown', function (event) {
                const clickTarget = event?.clickEvent?.target;
                if (!clickTarget) return;

                const insideForm = clickTarget.closest('.tag-filter-form');
                const isApply = clickTarget.closest('.tag-filter-apply');
                const isClear = clickTarget.closest('.tag-filter-clear');

                if (insideForm && !isApply && !isClear) {
                    event.preventDefault();
                }
            });
        }

        document.querySelectorAll('.tag-filter-form .form-check-input').forEach(function (input) {
            input.addEventListener('click', function (ev) {
                ev.stopPropagation();
            });
        });
    }

    const updateQueue = new Map();
    const updateInFlight = new Set();
    let updateSeq = 0;

    function _updateQueueKey(empresaId, field) {
        return `${empresaId}:${field}`;
    }

    function _drainInventarioUpdate(key) {
        const queued = updateQueue.get(key);
        if (!queued || updateInFlight.has(key)) return;
        updateInFlight.add(key);

        const { empresaId, field, value, element, seq } = queued;
        element.classList.remove('saved', 'error');
        element.classList.add('saving');

        fetch('/api/inventario/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                empresa_id: empresaId,
                field: field,
                value: value
            })
        })
            .then(response => response.json())
            .then(data => {
                element.classList.remove('saving');
                if (data.success) {
                    const resolvedValue = data.value !== undefined ? data.value : value;
                    if (data.value !== undefined && data.value !== value) {
                        element.value = data.value;
                    }
                    let resolvedStatus = null;
                    if (data.status) {
                        resolvedStatus = data.status;
                        const row = element.closest('tr');
                        updateRowStatus(row, data.status);
                    }
                    if (field === 'pdf_path' || field === 'cliente_pdf_path') {
                        const group = element.closest('.input-group');
                        if (group) {
                            const currentLink = group.querySelector('a');
                            const raw = (element.value || '').trim();
                            if (raw) {
                                const isUrl = raw.startsWith('http://') || raw.startsWith('https://');
                                const href = isUrl ? raw : `/static/${raw}`;
                                if (currentLink) {
                                    currentLink.href = href;
                                } else {
                                    const link = document.createElement('a');
                                    link.href = href;
                                    link.target = '_blank';
                                    link.className = 'btn btn-outline-primary btn-sm';
                                    link.title = 'Abrir PDF';
                                    link.innerHTML = '<i class="bi bi-file-pdf"></i>';
                                    group.appendChild(link);
                                }
                            } else if (currentLink) {
                                currentLink.remove();
                            }
                        }
                    }
                    if (field === 'status') {
                        const row = element.closest('tr');
                        const nextStatus = resolvedStatus || resolvedValue;
                        updateDashboardForStatus(row, nextStatus);
                        element.dataset.prevStatus = nextStatus;
                    }
                    if (field === 'encerramento_fiscal') {
                        const row = element.closest('tr');
                        updateDashboardForEncerramento(row, resolvedValue);
                    }
                    element.classList.add('saved');
                    setTimeout(() => element.classList.remove('saved'), 2000);
                } else {
                    element.classList.add('error');
                    if (field === 'status') {
                        const row = element.closest('tr');
                        const prevStatus = element.dataset.prevStatus || row?.dataset.status || '';
                        element.value = prevStatus;
                        adjustStatusFontSize(element);
                        updateDashboardForStatus(row, prevStatus);
                    }
                    // Evita alert de request antiga já substituída por valor mais novo na fila.
                    const latest = updateQueue.get(key);
                    if (!latest || latest.seq === seq) {
                        alert('Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                    }
                }
            })
            .catch(error => {
                element.classList.remove('saving');
                element.classList.add('error');
                console.error('Erro:', error);
                if (field === 'status') {
                    const row = element.closest('tr');
                    const prevStatus = element.dataset.prevStatus || row?.dataset.status || '';
                    element.value = prevStatus;
                    adjustStatusFontSize(element);
                    updateDashboardForStatus(row, prevStatus);
                }
                const latest = updateQueue.get(key);
                if (!latest || latest.seq === seq) {
                    alert('Erro ao salvar. Tente novamente.');
                }
            })
            .finally(() => {
                updateInFlight.delete(key);
                const latest = updateQueue.get(key);
                if (!latest) return;
                if (latest.seq !== seq) {
                    _drainInventarioUpdate(key);
                } else {
                    updateQueue.delete(key);
                }
            });
    }

    function updateInventario(empresaId, field, value, element) {
        const key = _updateQueueKey(empresaId, field);
        updateSeq += 1;
        updateQueue.set(key, {
            empresaId,
            field,
            value,
            element,
            seq: updateSeq,
        });
        _drainInventarioUpdate(key);
    }

    function uploadPDF(empresaId, file, inputElement) {
        const formData = new FormData();
        formData.append('pdf', file);
        const csrfToken = window.csrfToken || '';

        const container = inputElement.closest('.pdf-upload-container');

        // Mostrar indicador de envio
        const uploadIndicator = document.createElement('small');
        uploadIndicator.className = 'text-muted d-block';
        uploadIndicator.textContent = 'Enviando...';
        container.insertBefore(uploadIndicator, inputElement);

        fetch(`/api/inventario/upload-pdf/${empresaId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                uploadIndicator.remove();

                if (data.success) {
                    const row = inputElement.closest('tr');
                    const filesList = ensureFilesList(container, inputElement);
                    const filename = data.filename || (file && file.name) || 'arquivo.pdf';
                    appendCfopFileItem(filesList, empresaId, data.file_index, filename);
                    filesList.dataset.loaded = '1';
                    setRowFileCountByType(row, 'cfop', parseRowFileCount(row, 'cfopCount') + 1);
                    updateRowStatus(row, data.status);
                    checkCFOPConsolidadoStatus(row);
                    inputElement.value = '';
                } else {
                    alert('Erro ao fazer upload: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                uploadIndicator.remove();
                console.error('Erro:', error);
                alert('Erro ao fazer upload. Tente novamente.');
            });
    }

    function moveCfopToConsolidado(empresaId, row, buttonEl) {
        const csrfToken = window.csrfToken || '';
        buttonEl.disabled = true;

        fetch(`/api/inventario/move-cfop-to-consolidado/${empresaId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
            .then(response => response.json())
            .then(data => {
                buttonEl.disabled = false;
                if (!data.success) {
                    alert('Erro ao mover CFOP: ' + (data.error || 'Erro desconhecido'));
                    return;
                }

                const cfopContainer = row.querySelector('.cfop-container');
                const consolidatedContainer = row.querySelector('.cfop-consolidado-container');
                const cfopInput = cfopContainer?.querySelector('.pdf-upload');
                const consolidatedInput = consolidatedContainer?.querySelector('.cfop-consolidado-upload');

                if (cfopContainer && cfopInput) {
                    const filesList = ensureFilesList(cfopContainer, cfopInput);
                    filesList.innerHTML = '';
                    filesList.dataset.loaded = '1';
                    setRowFileCountByType(row, 'cfop', 0);
                }

                if (consolidatedContainer && consolidatedInput) {
                    const filesList = ensureFilesList(consolidatedContainer, consolidatedInput);
                    filesList.innerHTML = '';
                    (data.cfop_consolidado_files || []).forEach((file, idx) => {
                        appendCfopConsolidadoFileItem(filesList, empresaId, idx, file.filename || 'arquivo.pdf');
                    });
                    filesList.dataset.loaded = '1';
                    setRowFileCountByType(row, 'cfop-consolidado', (data.cfop_consolidado_files || []).length);
                }

                updateRowStatus(row, data.status);
                checkCFOPConsolidadoStatus(row);
            })
            .catch(error => {
                buttonEl.disabled = false;
                console.error('Erro ao mover CFOP:', error);
                alert('Erro ao mover CFOP. Tente novamente.');
            });
    }

    function uploadCfopConsolidado(empresaId, file, inputElement) {
        const formData = new FormData();
        formData.append('pdf', file);
        const csrfToken = window.csrfToken || '';

        const container = inputElement.closest('.cfop-consolidado-container');

        const uploadIndicator = document.createElement('small');
        uploadIndicator.className = 'text-muted d-block';
        uploadIndicator.textContent = 'Enviando...';
        container.insertBefore(uploadIndicator, inputElement);

        fetch(`/api/inventario/upload-cfop-consolidado/${empresaId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                uploadIndicator.remove();

                if (data.success) {
                    const row = inputElement.closest('tr');
                    const filesList = ensureFilesList(container, inputElement);
                    const filename = data.filename || (file && file.name) || 'arquivo.pdf';
                    appendCfopConsolidadoFileItem(filesList, empresaId, data.file_index, filename);
                    filesList.dataset.loaded = '1';
                    setRowFileCountByType(row, 'cfop-consolidado', parseRowFileCount(row, 'cfopConsolidadoCount') + 1);
                    updateRowStatus(row, data.status);
                    checkCFOPConsolidadoStatus(row);
                    inputElement.value = '';
                } else {
                    alert('Erro ao fazer upload: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                uploadIndicator.remove();
                console.error('Erro:', error);
                alert('Erro ao fazer upload. Tente novamente.');
            });
    }

    function deleteCFOPFile(empresaId, fileIndex, fileItem) {
        const csrfToken = window.csrfToken || '';

        fetch(`/api/inventario/delete-cfop-file/${empresaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ file_index: fileIndex })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Erro ao remover arquivo');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (fileItem) {
                        const row = fileItem.closest('tr');
                        const filesList = fileItem.closest('.files-list');
                        fileItem.remove();
                        if (filesList) {
                            updateFileListIndices(filesList, empresaId, 'cfop');
                            const currentCount = filesList.querySelectorAll('.file-item').length;
                            setRowFileCountByType(row, 'cfop', currentCount);
                            if (currentCount === 0) {
                                filesList.innerHTML = '<small class="text-muted">Nenhum arquivo</small>';
                            }
                        }
                        if (row) {
                            if (data.status) {
                                updateRowStatus(row, data.status);
                            }
                            checkCFOPConsolidadoStatus(row);
                        }
                    }
                } else {
                    alert('Erro ao remover arquivo: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro ao deletar CFOP:', error);
                alert('Erro ao remover arquivo: ' + (error.message || 'Tente novamente.'));
            });
    }

    function deleteCfopConsolidadoFile(empresaId, fileIndex, fileItem) {
        const csrfToken = window.csrfToken || '';

        fetch(`/api/inventario/delete-cfop-consolidado-file/${empresaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ file_index: fileIndex })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Erro ao remover arquivo');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (fileItem) {
                        const row = fileItem.closest('tr');
                        const filesList = fileItem.closest('.files-list');
                        fileItem.remove();
                        if (filesList) {
                            updateFileListIndices(filesList, empresaId, 'cfop-consolidado');
                            const currentCount = filesList.querySelectorAll('.file-item').length;
                            setRowFileCountByType(row, 'cfop-consolidado', currentCount);
                            if (currentCount === 0) {
                                filesList.innerHTML = '<small class="text-muted">Nenhum arquivo</small>';
                            }
                        }
                        if (row) {
                            if (data.status) {
                                updateRowStatus(row, data.status);
                            }
                            checkCFOPConsolidadoStatus(row);
                        }
                    }
                } else {
                    alert('Erro ao remover arquivo: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro ao deletar CFOP consolidado:', error);
                alert('Erro ao remover arquivo: ' + (error.message || 'Tente novamente.'));
            });
    }

    function uploadClienteFile(empresaId, file, inputElement) {
        const formData = new FormData();
        formData.append('file', file);
        const csrfToken = window.csrfToken || '';

        const container = inputElement.closest('.cliente-upload-container');

        // Mostrar indicador de envio
        const uploadIndicator = document.createElement('small');
        uploadIndicator.className = 'text-muted d-block';
        uploadIndicator.textContent = 'Enviando...';
        container.insertBefore(uploadIndicator, inputElement);

        fetch(`/api/inventario/upload-cliente-file/${empresaId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                uploadIndicator.remove();

                if (data.success) {
                    const row = inputElement.closest('tr');
                    const filesList = ensureFilesList(container, inputElement);
                    const filename = data.filename || (file && file.name) || 'arquivo';
                    appendClienteFileItem(filesList, empresaId, data.file_index, filename);
                    filesList.dataset.loaded = '1';
                    setRowFileCountByType(row, 'cliente', parseRowFileCount(row, 'clienteCount') + 1);
                    updateRowStatus(row, data.status);
                    inputElement.value = '';
                } else {
                    alert('Erro ao fazer upload: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                uploadIndicator.remove();
                console.error('Erro:', error);
                alert('Erro ao fazer upload. Tente novamente.');
            });
    }

    function deleteClienteFileV2(empresaId, fileIndex, fileItem) {
        const csrfToken = window.csrfToken || '';

        fetch(`/api/inventario/delete-cliente-file-v2/${empresaId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ file_index: fileIndex })
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'Erro ao remover arquivo');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    if (fileItem) {
                        const row = fileItem.closest('tr');
                        const filesList = fileItem.closest('.files-list');
                        fileItem.remove();
                        if (filesList) {
                            updateFileListIndices(filesList, empresaId, 'cliente');
                            const currentCount = filesList.querySelectorAll('.file-item').length;
                            setRowFileCountByType(row, 'cliente', currentCount);
                            if (currentCount === 0) {
                                filesList.innerHTML = '<small class="text-muted">Nenhum arquivo</small>';
                            }
                        }
                        if (row) {
                            if (data.status) {
                                updateRowStatus(row, data.status);
                            }
                        }
                    }
                } else {
                    alert('Erro ao remover arquivo: ' + (data.error || 'Erro desconhecido'));
                }
            })
            .catch(error => {
                console.error('Erro ao deletar arquivo cliente:', error);
                alert('Erro ao remover arquivo: ' + (error.message || 'Tente novamente.'));
            });
    }
});

// ============================================
// COLUMN CUSTOMIZATION MODULE
// ============================================
(function() {
    'use strict';

    const API_ENDPOINTS = {
        GET: '/api/inventario/preferences',
        SAVE: '/api/inventario/preferences',
        RESET: '/api/inventario/preferences/reset'
    };

    let currentPreferences = {};
    let defaultPreferences = {};
    let columnMetadata = {};

    // FASE 1: Inicialização
    function initColumnCustomization() {
        loadColumnMetadata();
        loadPreferences()
            .then(() => {
                applyPreferences();
                initializeUI();

                // Reaplicar larguras após um pequeno delay para garantir que a tabela foi renderizada
                setTimeout(() => {
                    applyColumnWidths();
                    console.log('Larguras reaplicadas após carregamento da tabela');
                }, 100);
            })
            .catch(err => {
                console.error('Falha ao carregar preferências:', err);
            });
    }

    // Extrai metadados das colunas do DOM
    function loadColumnMetadata() {
        const headers = document.querySelectorAll('#inventarioTable thead th');
        headers.forEach((th, index) => {
            const colId = th.dataset.columnId;
            if (!colId) return;

            columnMetadata[colId] = {
                label: th.textContent.trim(),
                index: index,
                hideable: th.dataset.hideable !== 'false',
                resizable: th.dataset.resizable !== 'false',
                element: th
            };
        });
    }

    // Carrega preferências do servidor
    async function loadPreferences() {
        const response = await fetch(API_ENDPOINTS.GET);
        const data = await response.json();
        if (data.success) {
            currentPreferences = data.preferences || {};
            defaultPreferences = data.defaults || {};

            console.log('Preferências carregadas do banco:', {
                larguras: Object.fromEntries(
                    Object.entries(currentPreferences)
                        .filter(([_, prefs]) => prefs.width)
                        .map(([id, prefs]) => [id, prefs.width])
                )
            });
        }
    }

    // FASE 2: Aplicar Preferências
    function applyPreferences() {
        applyColumnVisibility();
        applyColumnOrder();
        applyColumnWidths();
        updateTableWidth();
    }

    function applyColumnVisibility() {
        Object.entries(currentPreferences).forEach(([colId, prefs]) => {
            const meta = columnMetadata[colId];
            if (!meta) return;

            const th = meta.element;
            const colIndex = meta.index;

            if (prefs.visible === false) {
                th.classList.add('column-hidden');
                document.querySelectorAll('#inventarioTable tbody tr').forEach(row => {
                    const td = row.children[colIndex];
                    if (td) td.classList.add('column-hidden');
                });
            } else {
                th.classList.remove('column-hidden');
                document.querySelectorAll('#inventarioTable tbody tr').forEach(row => {
                    const td = row.children[colIndex];
                    if (td) td.classList.remove('column-hidden');
                });
            }
        });
        updateTableWidth();
    }

    function applyColumnOrder() {
        const table = document.getElementById('inventarioTable');
        const thead = table.querySelector('thead tr');
        const tbody = table.querySelector('tbody');

        const orderedCols = Object.entries(currentPreferences)
            .sort((a, b) => (a[1].order || 0) - (b[1].order || 0))
            .map(([colId]) => colId);

        orderedCols.forEach((colId, targetIndex) => {
            const meta = columnMetadata[colId];
            if (!meta) return;

            const th = meta.element;
            const currentIndex = Array.from(thead.children).indexOf(th);

            if (currentIndex !== targetIndex && targetIndex < thead.children.length) {
                thead.insertBefore(th, thead.children[targetIndex]);

                Array.from(tbody.children).forEach(row => {
                    const td = row.children[currentIndex];
                    if (td && targetIndex < row.children.length) {
                        row.insertBefore(td, row.children[targetIndex]);
                    }
                });
            }
        });
    }

    function applyColumnWidths() {
        Object.entries(currentPreferences).forEach(([colId, prefs]) => {
            const meta = columnMetadata[colId];
            if (!meta) return;

            // Se não houver largura definida nas preferências, usar a largura padrão do elemento
            const width = prefs.width || parseInt(getComputedStyle(meta.element).width);
            if (!width) return;

            const th = meta.element;
            const colIndex = meta.index;

            th.style.width = width + 'px';
            th.style.minWidth = width + 'px';

            document.querySelectorAll('#inventarioTable tbody tr').forEach(row => {
                const td = row.children[colIndex];
                if (td) {
                    td.style.width = width + 'px';
                    td.style.minWidth = width + 'px';
                }
            });
        });

        console.log('Larguras aplicadas:', Object.fromEntries(
            Object.entries(currentPreferences)
                .filter(([_, prefs]) => prefs.width)
                .map(([id, prefs]) => [id, prefs.width])
        ));
        updateTableWidth();
    }

    function updateTableWidth() {
        const table = document.getElementById('inventarioTable');
        if (!table) return;

        let totalWidth = 0;
        Object.entries(columnMetadata).forEach(([colId, meta]) => {
            const prefs = currentPreferences[colId] || {};
            if (prefs.visible === false) return;
            const width = parseInt(meta.element.style.width) || Math.round(meta.element.getBoundingClientRect().width);
            if (width) {
                totalWidth += width;
            }
        });

        if (totalWidth > 0) {
            table.style.width = totalWidth + 'px';
            table.style.minWidth = totalWidth + 'px';
        } else {
            table.style.width = '';
            table.style.minWidth = '';
        }
    }

    // FASE 3: UI do Modal
    function initializeUI() {
        initializeVisibilityPanel();
        initializeOrderPanel();
        initializeWidthPanel();
        initializeModalEvents();
        initializeColumnResizing();
    }

    function initializeVisibilityPanel() {
        const container = document.getElementById('column-visibility-list');
        container.innerHTML = '';

        Object.entries(columnMetadata)
            .sort((a, b) => (currentPreferences[a[0]]?.order || 0) - (currentPreferences[b[0]]?.order || 0))
            .forEach(([colId, meta]) => {
                if (!meta.hideable) return;

                const prefs = currentPreferences[colId] || {};
                const isVisible = prefs.visible !== false;

                const item = document.createElement('div');
                item.className = 'column-setting-item';
                item.innerHTML = `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               id="vis_${colId}" data-column-id="${colId}"
                               ${isVisible ?'checked' : ''}>
                        <label class="form-check-label" for="vis_${colId}">
                            ${meta.label}
                        </label>
                    </div>
                `;
                container.appendChild(item);
            });
    }

    function initializeOrderPanel() {
        const container = document.getElementById('column-order-list');
        container.innerHTML = '';

        const sorted = Object.entries(currentPreferences)
            .sort((a, b) => (a[1].order || 0) - (b[1].order || 0));

        sorted.forEach(([colId], index) => {
            const meta = columnMetadata[colId];
            if (!meta) return;

            const item = document.createElement('div');
            item.className = 'column-setting-item';
            item.draggable = true;
            item.dataset.columnId = colId;
            item.dataset.order = index;
            item.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-grip-vertical drag-handle"></i>
                    <span>${meta.label}</span>
                </div>
            `;
            container.appendChild(item);
        });

        initializeDragAndDrop();
    }

    function initializeWidthPanel() {
        const container = document.getElementById('column-width-list');
        container.innerHTML = '';

        Object.entries(columnMetadata)
            .sort((a, b) => (currentPreferences[a[0]]?.order || 0) - (currentPreferences[b[0]]?.order || 0))
            .forEach(([colId, meta]) => {
                if (!meta.resizable) return;

                const prefs = currentPreferences[colId] || {};
                const width = prefs.width || 100;

                const item = document.createElement('div');
                item.className = 'column-setting-item';
                item.innerHTML = `
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <label class="form-label mb-0">${meta.label}</label>
                        <span class="width-value" id="width_val_${colId}">${width}px</span>
                    </div>
                    <input type="range" class="form-range width-slider"
                           min="40" max="500" step="5" value="${width}"
                           data-column-id="${colId}">
                `;

                const slider = item.querySelector('.width-slider');
                slider.addEventListener('input', (e) => {
                    document.getElementById(`width_val_${colId}`).textContent = e.target.value + 'px';
                });

                container.appendChild(item);
            });
    }

    // Drag & Drop HTML5 API
    function initializeDragAndDrop() {
        const container = document.getElementById('column-order-list');
        let draggedItem = null;

        container.addEventListener('dragstart', (e) => {
            draggedItem = e.target.closest('.column-setting-item');
            if (draggedItem) {
                draggedItem.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            }
        });

        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const dragging = document.querySelector('.dragging');
            if (afterElement == null) {
                container.appendChild(dragging);
            } else {
                container.insertBefore(dragging, afterElement);
            }
        });

        container.addEventListener('dragend', () => {
            if (draggedItem) {
                draggedItem.classList.remove('dragging');
                updateOrderIndices();
                draggedItem = null;
            }
        });
    }

    function getDragAfterElement(container, y) {
        const items = [...container.querySelectorAll('.column-setting-item:not(.dragging)')];

        return items.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;

            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function updateOrderIndices() {
        const items = document.querySelectorAll('#column-order-list .column-setting-item');
        items.forEach((item, index) => {
            item.dataset.order = index;
        });
    }

    // Resize de colunas arrastando bordas
    function initializeColumnResizing() {
        const headers = document.querySelectorAll('#inventarioTable thead th[data-resizable="true"]');

        headers.forEach(th => {
            const resizer = document.createElement('div');
            resizer.className = 'column-resizer';
            th.appendChild(resizer);
            th.classList.add('resizable');

            let startX, startWidth;

            const onMouseDown = (e) => {
                e.preventDefault();
                e.stopPropagation();
                startX = e.pageX;
                startWidth = th.offsetWidth;
                resizer.classList.add('resizing');

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            };

            const onMouseMove = (e) => {
                const diff = e.pageX - startX;
                const newWidth = Math.max(40, Math.min(500, startWidth + diff));
                th.style.width = newWidth + 'px';
                th.style.minWidth = newWidth + 'px';

                const colIndex = Array.from(th.parentElement.children).indexOf(th);
                document.querySelectorAll('#inventarioTable tbody tr').forEach(row => {
                    const td = row.children[colIndex];
                    if (td) {
                        td.style.width = newWidth + 'px';
                        td.style.minWidth = newWidth + 'px';
                    }
                });
                updateTableWidth();
            };

            const onMouseUp = () => {
                resizer.classList.remove('resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);

                debouncedSaveWidths();
            };

            resizer.addEventListener('mousedown', onMouseDown);
        });
    }

    let widthSaveTimer;
    function debouncedSaveWidths() {
        clearTimeout(widthSaveTimer);
        widthSaveTimer = setTimeout(() => {
            Object.keys(columnMetadata).forEach(colId => {
                const meta = columnMetadata[colId];
                if (meta.element.style.width) {
                    const width = parseInt(meta.element.style.width);
                    if (!currentPreferences[colId]) currentPreferences[colId] = {};
                    currentPreferences[colId].width = width;

                    // Sincronizar com o slider no painel de configuração
                    const slider = document.querySelector(`.width-slider[data-column-id="${colId}"]`);
                    const valueDisplay = document.getElementById(`width_val_${colId}`);
                    if (slider) {
                        slider.value = width;
                    }
                    if (valueDisplay) {
                        valueDisplay.textContent = width + 'px';
                    }
                }
            });

            console.log('Salvando larguras após redimensionamento:', Object.fromEntries(
                Object.entries(currentPreferences)
                    .filter(([_, prefs]) => prefs.width)
                    .map(([id, prefs]) => [id, prefs.width])
            ));

            savePreferences(true);
        }, 1000);
    }

    // Eventos do Modal
    function initializeModalEvents() {
        document.getElementById('saveColumnsBtn').addEventListener('click', () => savePreferences(false));
        document.getElementById('resetColumnsBtn').addEventListener('click', resetPreferences);
    }

    // Salvar Preferências
    async function savePreferences(silent = false) {
        const btn = document.getElementById('saveColumnsBtn');

        if (!silent) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Salvando...';
        }

        try {
            document.querySelectorAll('#column-visibility-list input[type="checkbox"]').forEach(cb => {
                const colId = cb.dataset.columnId;
                if (!currentPreferences[colId]) currentPreferences[colId] = {};
                currentPreferences[colId].visible = cb.checked;
            });

            document.querySelectorAll('#column-order-list .column-setting-item').forEach((item, index) => {
                const colId = item.dataset.columnId;
                if (!currentPreferences[colId]) currentPreferences[colId] = {};
                currentPreferences[colId].order = index;
            });

            document.querySelectorAll('#column-width-list .width-slider').forEach(slider => {
                const colId = slider.dataset.columnId;
                if (!currentPreferences[colId]) currentPreferences[colId] = {};
                currentPreferences[colId].width = parseInt(slider.value);
            });

            if (!silent) {
                console.log('Salvando preferências:', {
                    larguras: Object.fromEntries(
                        Object.entries(currentPreferences)
                            .filter(([_, prefs]) => prefs.width)
                            .map(([id, prefs]) => [id, prefs.width])
                    )
                });
            }

            const response = await fetch(API_ENDPOINTS.SAVE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrfToken || ''
                },
                body: JSON.stringify({ preferences: currentPreferences })
            });

            const data = await response.json();

            if (data.success) {
                if (!silent) {
                    applyPreferences();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('columnSettingsModal'));
                    modal.hide();
                    console.log('Preferências salvas com sucesso!');
                }
            } else {
                throw new Error(data.error || 'Erro ao salvar');
            }
        } catch (error) {
            console.error('Erro ao salvar:', error);
            if (!silent) {
                alert('Erro ao salvar preferências: ' + error.message);
            }
        } finally {
            if (!silent) {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-lg me-1"></i>Salvar';
            }
        }
    }

    // Resetar Preferências
    async function resetPreferences() {
        if (!confirm('Resetar todas as configurações de colunas para o padrão?')) {
            return;
        }

        try {
            const response = await fetch(API_ENDPOINTS.RESET, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrfToken || ''
                }
            });

            const data = await response.json();

            if (data.success) {
                currentPreferences = data.defaults || {};
                applyPreferences();

                initializeVisibilityPanel();
                initializeOrderPanel();
                initializeWidthPanel();

                console.log('Configurações resetadas!');
            }
        } catch (error) {
            console.error('Erro ao resetar:', error);
            alert('Erro ao resetar preferências: ' + error.message);
        }
    }

    // Inicializar quando DOM estiver pronto
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initColumnCustomization);
    } else {
        initColumnCustomization();
    }
})();
</script>

<!-- Modal de Configuração de Colunas -->
<div class="modal fade" id="columnSettingsModal" tabindex="-1" aria-labelledby="columnSettingsLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnSettingsLabel">
                    <i class="bi bi-gear me-2"></i>Configurações de Colunas
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs de Navegação -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="visibility-tab" data-bs-toggle="tab"
                                data-bs-target="#visibility-panel" type="button" role="tab">
                            <i class="bi bi-eye me-1"></i>Visibilidade
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="order-tab" data-bs-toggle="tab"
                                data-bs-target="#order-panel" type="button" role="tab">
                            <i class="bi bi-arrow-down-up me-1"></i>Ordem
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="width-tab" data-bs-toggle="tab"
                                data-bs-target="#width-panel" type="button" role="tab">
                            <i class="bi bi-arrows-expand me-1"></i>Largura
                        </button>
                    </li>
                </ul>

                <!-- Conteúdo das Tabs -->
                <div class="tab-content">
                    <!-- Painel de Visibilidade -->
                    <div class="tab-pane fade show active" id="visibility-panel" role="tabpanel">
                        <p class="text-muted small mb-3">Selecione quais colunas deseja exibir:</p>
                        <div id="column-visibility-list" class="column-settings-list">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>

                    <!-- Painel de Ordem -->
                    <div class="tab-pane fade" id="order-panel" role="tabpanel">
                        <p class="text-muted small mb-3">Arraste as colunas para reordená-las:</p>
                        <div id="column-order-list" class="column-settings-list sortable-list">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>

                    <!-- Painel de Largura -->
                    <div class="tab-pane fade" id="width-panel" role="tabpanel">
                        <p class="text-muted small mb-3">Ajuste a largura de cada coluna:</p>
                        <div id="column-width-list" class="column-settings-list">
                            <!-- Preenchido via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-outline-danger" id="resetColumnsBtn">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Resetar Padrão
                </button>
                <div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveColumnsBtn">
                        <i class="bi bi-check-lg me-1"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
