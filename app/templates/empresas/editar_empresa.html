{% extends "base.html" %}

{% block title %}Editar Empresa{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 1200px;">
    <!-- Cabeçalho da Página -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center">
                <h1 class="text-primary mb-2">
                    <i class="bi bi-building-gear me-3"></i>Editar Empresa
                </h1>
                <h2 class="h4 text-muted mb-3">{{ empresa.NomeEmpresa }}</h2>
                <p class="text-muted">Edite os dados da empresa</p>
            </div>
        </div>
    </div>

    <!-- Dados do Cliente -->
    <div class="card shadow-lg mb-5" id="dados-cliente">
        <div class="card-header bg-primary text-white py-3">
            <h3 class="mb-0 fw-semibold">
                <i class="bi bi-building me-2"></i>Dados do Cliente
            </h3>
        </div>
        <div class="card-body p-4">
            <form method="POST">
                {{ empresa_form.hidden_tag() }}
                
                <!-- Informações Básicas -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-info-circle me-2"></i>Informações Básicas
                        </h5>
                    </div>
                </div>
                
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.codigo_empresa(class="form-control", placeholder="Código") }}
                            {{ empresa_form.codigo_empresa.label(class="form-label") }}
                            {% if empresa_form.codigo_empresa.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.codigo_empresa.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.nome_empresa(class="form-control", placeholder="Nome") }}
                            {{ empresa_form.nome_empresa.label(class="form-label") }}
                            {% if empresa_form.nome_empresa.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.nome_empresa.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.cnpj(class="form-control", placeholder="CNPJ", id="cnpj") }}
                            {{ empresa_form.cnpj.label(class="form-label") }}
                            {% if empresa_form.cnpj.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.cnpj.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.data_abertura(class="form-control", type="date", placeholder="Data de Abertura") }}
                            {{ empresa_form.data_abertura.label(class="form-label") }}
                            {% if empresa_form.data_abertura.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.data_abertura.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{{ empresa_form.tipo_empresa.label.text }}</label>
                        <div class="border rounded p-3 bg-light radio-group-container" data-field-name="tipo_empresa">
                            {% for subfield in empresa_form.tipo_empresa %}
                            <div class="form-check mb-2">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                            {% endfor %}
                        </div>
                        {% if empresa_form.tipo_empresa.errors %}
                            <div class="text-danger mt-1">
                                {% for error in empresa_form.tipo_empresa.errors %}
                                    <small>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Informações Empresariais -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-briefcase me-2"></i>Informações Empresariais
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.socio_administrador(class="form-control", placeholder="Sócio Administrador") }}
                            {{ empresa_form.socio_administrador.label(class="form-label") }}
                            {% if empresa_form.socio_administrador.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.socio_administrador.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.atividade_principal(class="form-control", placeholder="Atividade") }}
                            {{ empresa_form.atividade_principal.label(class="form-label") }}
                            {% if empresa_form.atividade_principal.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.atividade_principal.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Configurações Fiscais -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-calculator me-2"></i>Configurações Fiscais
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{{ empresa_form.tributacao.label.text }}</label>
                        <div class="border rounded p-3 bg-light radio-group-container" data-field-name="tributacao">
                            {# Este loop simples resolve tudo! #}
                            {% for subfield in empresa_form.tributacao %}
                            <div class="form-check mb-2">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{{ empresa_form.regime_lancamento.label.text }}</label>
                        <div class="border rounded p-3 bg-light radio-group-container checkbox-group-container" data-field-name="regime_lancamento">
                            {% for value, label in empresa_form.regime_lancamento.choices %}
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="regime_lancamento" value="{{ value }}" id="regime-{{ loop.index }}" {% if value in (empresa_form.regime_lancamento.data or []) %}checked{% endif %}>
                                <label class="form-check-label" for="regime-{{ loop.index }}">{{ label }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-person-lines-fill me-2"></i>Contatos do Cliente
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div id="contatos-container"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-contato">
                            <i class="bi bi-plus-circle"></i> Adicionar Contato
                        </button>
                        {{ empresa_form.contatos_json(id='contatos_json') }}
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-building me-2"></i>Acessos do Cliente
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div id="acessos-container"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-acesso">
                            <i class="bi bi-plus-circle"></i> Adicionar Acesso
                        </button>
                        {{ empresa_form.acessos_json(id='acessos_json') }}
                    </div>
                </div>

                <!-- Sistemas e Consultorias -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-gear me-2"></i>Sistemas e Consultorias
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <label class="form-label fw-semibold">{{ empresa_form.sistemas_consultorias.label.text }}</label>
                        <div class="border rounded p-3 bg-light checkbox-group-container">
                            <div class="row">
                                {% for value, label in empresa_form.sistemas_consultorias.choices %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="{{ empresa_form.sistemas_consultorias.name }}"
                                               value="{{ value }}" id="sis-{{ loop.index }}"
                                               {% if value in (empresa_form.sistemas_consultorias.data or []) %}checked{% endif %}
                                               aria-label="{{ label }}">
                                        <label class="form-check-label" for="sis-{{ loop.index }}">{{ label }}</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if empresa_form.sistemas_consultorias.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.sistemas_consultorias.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="form-floating">
                            {{ empresa_form.sistema_utilizado(class="form-control", placeholder="Sistema atualmente utilizado") }}
                            {{ empresa_form.sistema_utilizado.label(class="form-label") }}
                            {% if empresa_form.sistema_utilizado.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.sistema_utilizado.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Status -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-toggle-on me-2"></i>Status
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-lg-4 col-md-6">
                        <div class="form-check form-switch">
                            {{ empresa_form.ativo(class="form-check-input", role="switch") }}
                            {{ empresa_form.ativo.label(class="form-check-label") }}
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-primary px-5" id="empresa-submit-btn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <i class="bi bi-building-check me-2"></i>Salvar Dados do Cliente
                    </button>
                    <button type="reset" class="btn btn-outline-secondary px-4 ms-3">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Restaurar
                    </button>
                </div>
            </form>
        </div>
    </div>
  
    <div class="row">
        <div class="col-12">
            <div class="text-center">
                <a href="{{ url_for('listar_empresas') }}" class="btn btn-outline-secondary px-4">
                    <i class="bi bi-arrow-left me-2"></i>Voltar para Lista
                </a>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="{{ url_for('static', filename='javascript/acessos.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/contatos.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/observacao.js') }}"></script>
<script src="https://unpkg.com/imask"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    setupAcessos('acessos-container', 'add-acesso', 'acessos_json');
    setupContatos('contatos-container', 'add-contato', 'contatos_json');
    // Máscara para CNPJ
    const cnpjField = document.querySelector('#cnpj');
    if (cnpjField) {
        IMask(cnpjField, {
            mask: '00.000.000/0000-00',
            lazy: false  // Aplica a máscara imediatamente ao valor existente
        });
    }



    // Feedback visual para radio buttons
    document.querySelectorAll('.radio-group-container input[type="radio"]').forEach(function(radio) {
        const updateRadioContainerStyle = (r) => {
            const container = r.closest('.radio-group-container');
            if (container) {
                document.querySelectorAll(`input[name="${r.name}"]`).forEach(otherRadio => {
                    const otherContainer = otherRadio.closest('.radio-group-container');
                    if (otherContainer) {
                        otherContainer.classList.remove('border-primary', 'bg-info-subtle', 'text-primary');
                    }
                });

                if (r.checked) {
                    container.classList.add('border-primary', 'bg-info-subtle', 'text-primary');
                }
            }
        };
        radio.addEventListener('change', () => updateRadioContainerStyle(radio));
        if (radio.checked) {
            updateRadioContainerStyle(radio);
        }
    });

    // Feedback visual para checkboxes
    document.querySelectorAll('.checkbox-group-container input[type="checkbox"]').forEach(function(checkbox) {
        const updateCheckboxStyle = (chk) => {
            const formCheckDiv = chk.closest('.form-check');
            if (formCheckDiv) {
                if (chk.checked) {
                    formCheckDiv.classList.add('text-primary', 'fw-semibold');
                } else {
                    formCheckDiv.classList.remove('text-primary', 'fw-semibold');
                }
            }
        };
        checkbox.addEventListener('change', () => updateCheckboxStyle(checkbox));
        updateCheckboxStyle(checkbox);
    });

    // Toggle para senhas
    const senhaFields = document.querySelectorAll('input[type="password"]');
    senhaFields.forEach(function(field) {
        const container = field.closest('.form-floating');
        if (container) {
            const toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2';
            toggleBtn.style.zIndex = '10';
            toggleBtn.innerHTML = '<i class="bi bi-eye"></i>';
            
            container.style.position = 'relative';
            container.appendChild(toggleBtn);
            
            toggleBtn.addEventListener('click', function() {
            const isPassword = field.type === 'password';
            field.type = isPassword ? 'text' : 'password';
            this.querySelector('i').classList.toggle('bi-eye');
            this.querySelector('i').classList.toggle('bi-eye-slash');
            });
        }
    });

    // Loading spinner para botões de submit
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                const spinner = submitBtn.querySelector('.spinner-border');
                if (spinner) {
                    spinner.classList.remove('d-none');
                    submitBtn.disabled = true;
                }
            }
        });
    });

    // Auto-dismiss alerts
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            if (alert && typeof bootstrap !== 'undefined' && bootstrap.Alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            } else {
                alert.remove();
            }
        }, 5000);
    });
});
</script>
{% endblock %}
{% endblock %}
