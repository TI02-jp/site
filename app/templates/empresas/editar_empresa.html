{% extends "base.html" %}

{% block title %}Editar Empresa{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 1200px;">
    <!-- Cabeçalho da Página -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="text-center">
                <h1 class="text-primary mb-2">
                    <i class="bi bi-building-gear me-3"></i>Editar Empresa
                </h1>
                <h2 class="h4 text-muted mb-3">{{ empresa.NomeEmpresa }}</h2>
                <p class="text-muted">Edite os dados da empresa</p>
            </div>
        </div>
    </div>

    <!-- Dados da Empresa -->
    <div class="card shadow-lg mb-5" id="dados-empresa">
        <div class="card-header bg-primary text-white py-3">
            <h3 class="mb-0 fw-semibold">
                <i class="bi bi-building me-2"></i>Dados da Empresa
            </h3>
        </div>
        <div class="card-body p-4">
            <form method="POST">
                {{ empresa_form.hidden_tag() }}
                
                <!-- Informações Básicas -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-info-circle me-2"></i>Informações Básicas
                        </h5>
                    </div>
                </div>
                
                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.codigo_empresa(class="form-control", placeholder="Código") }}
                            {{ empresa_form.codigo_empresa.label(class="form-label") }}
                            {% if empresa_form.codigo_empresa.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.codigo_empresa.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.nome_empresa(class="form-control", placeholder="Nome") }}
                            {{ empresa_form.nome_empresa.label(class="form-label") }}
                            {% if empresa_form.nome_empresa.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.nome_empresa.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.cnpj(class="form-control", placeholder="CNPJ", id="cnpj") }}
                            {{ empresa_form.cnpj.label(class="form-label") }}
                            {% if empresa_form.cnpj.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.cnpj.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{{ empresa_form.data_abertura.label.text }}</label>
                        {{ empresa_form.data_abertura(class="form-control", type="date") }}
                        {% if empresa_form.data_abertura.errors %}
                            <div class="text-danger mt-1">
                                {% for error in empresa_form.data_abertura.errors %}
                                    <small>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Informações Empresariais -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-briefcase me-2"></i>Informações Empresariais
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.socio_administrador(class="form-control", placeholder="Sócio Administrador") }}
                            {{ empresa_form.socio_administrador.label(class="form-label") }}
                            {% if empresa_form.socio_administrador.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.socio_administrador.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-floating">
                            {{ empresa_form.atividade_principal(class="form-control", placeholder="Atividade") }}
                            {{ empresa_form.atividade_principal.label(class="form-label") }}
                            {% if empresa_form.atividade_principal.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.atividade_principal.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Configurações Fiscais -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-calculator me-2"></i>Configurações Fiscais
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{{ empresa_form.tributacao.label.text }}</label>
                        <div class="border rounded p-3 bg-light">
                            {# Este loop simples resolve tudo! #}
                            {% for subfield in empresa_form.tributacao %}
                            <div class="form-check mb-2">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="form-label fw-semibold">{{ empresa_form.regime_lancamento.label.text }}</label>
                        <div class="border rounded p-3 bg-light">
                            {# O mesmo loop para o outro campo #}
                            {% for subfield in empresa_form.regime_lancamento %}
                            <div class="form-check mb-2">
                                {{ subfield(class="form-check-input") }}
                                {{ subfield.label(class="form-check-label") }}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-building me-2"></i>Acessos do Cliente
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div id="acessos-container"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-acesso">
                            <i class="bi bi-plus-circle"></i> Adicionar Acesso
                        </button>
                        {{ empresa_form.acessos_json(id='acessos_json') }}
                    </div>
                </div>

                <!-- Sistemas e Consultorias -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-primary border-bottom pb-2 mb-3">
                            <i class="bi bi-gear me-2"></i>Sistemas e Consultorias
                        </h5>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <label class="form-label fw-semibold">{{ empresa_form.sistemas_consultorias.label.text }}</label>
                        <div class="border rounded p-3 bg-light">
                            <div class="row">
                                {% for value, label in empresa_form.sistemas_consultorias.choices %}
                                <div class="col-md-4 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="{{ empresa_form.sistemas_consultorias.name }}"
                                               value="{{ value }}" id="sis-{{ loop.index }}"
                                               {% if value in (empresa_form.sistemas_consultorias.data or []) %}checked{% endif %}
                                               aria-label="{{ label }}">
                                        <label class="form-check-label" for="sis-{{ loop.index }}">{{ label }}</label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if empresa_form.sistemas_consultorias.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.sistemas_consultorias.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-12">
                        <div class="form-floating">
                            {{ empresa_form.sistema_utilizado(class="form-control", placeholder="Sistema atualmente utilizado") }}
                            {{ empresa_form.sistema_utilizado.label(class="form-label") }}
                            {% if empresa_form.sistema_utilizado.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in empresa_form.sistema_utilizado.errors %}
                                        <small>{{ error }}</small><br>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-center mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-primary px-5" id="empresa-submit-btn">
                        <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        <i class="bi bi-building-check me-2"></i>Salvar Dados da Empresa
                    </button>
                    <button type="reset" class="btn btn-outline-secondary px-4 ms-3">
                        <i class="bi bi-arrow-counterclockwise me-2"></i>Restaurar
                    </button>
                </div>
            </form>
        </div>
    </div>
  
    <div class="row">
        <div class="col-12">
            <div class="text-center">
                <a href="{{ url_for('listar_empresas') }}" class="btn btn-outline-secondary px-4">
                    <i class="bi bi-arrow-left me-2"></i>Voltar para Lista
                </a>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script src="{{ url_for('static', filename='javascript/acessos.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/observacao.js') }}"></script>
<script src="https://unpkg.com/imask"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    setupAcessos('acessos-container', 'add-acesso', 'acessos_json');
    // Máscara para CNPJ
    const cnpjField = document.querySelector('#cnpj');
    if (cnpjField) {
        IMask(cnpjField, {
            mask: '00.000.000/0000-00'
        });
    }



    // Feedback visual para checkboxes e radio buttons
    document.querySelectorAll('input[type="checkbox"], input[type="radio"]').forEach(function(input) {
        input.addEventListener('change', function() {
            if (this.checked) {
                this.closest('.form-check').style.fontWeight = '600';
                this.closest('.form-check').style.color = '#0558c5';
            } else {
                this.closest('.form-check').style.fontWeight = 'normal';
                this.closest('.form-check').style.color = '';
            }
        });
        
        if (input.checked) {
            input.closest('.form-check').style.fontWeight = '600';
            input.closest('.form-check').style.color = '#0558c5';
        }
    });

    // Toggle para senhas
    const senhaFields = document.querySelectorAll('input[type="password"]');
    senhaFields.forEach(function(field) {
        const container = field.closest('.form-floating');
        if (container) {
            const toggleBtn = document.createElement('button');
            toggleBtn.type = 'button';
            toggleBtn.className = 'btn btn-outline-secondary position-absolute top-50 end-0 translate-middle-y me-2';
            toggleBtn.style.zIndex = '10';
            toggleBtn.innerHTML = '<i class="bi bi-eye"></i>';
            
            container.style.position = 'relative';
            container.appendChild(toggleBtn);
            
            toggleBtn.addEventListener('click', function() {
            const isPassword = field.type === 'password';
            field.type = isPassword ? 'text' : 'password';
            this.querySelector('i').classList.toggle('bi-eye');
            this.querySelector('i').classList.toggle('bi-eye-slash');
            });
        }
    });

    // Loading spinner para botões de submit
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                const spinner = submitBtn.querySelector('.spinner-border');
                if (spinner) {
                    spinner.classList.remove('d-none');
                    submitBtn.disabled = true;
                }
            }
        });
    });

    // Auto-dismiss alerts
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(function(alert) {
        setTimeout(function() {
            if (alert && typeof bootstrap !== 'undefined' && bootstrap.Alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            } else {
                alert.remove();
            }
        }, 5000);
    });
});
</script>
{% endblock %}
{% endblock %}
