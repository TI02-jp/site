{% extends "base.html" %}

{% block title %}{{ empresa.nome_empresa|upper }} - DETALHES COMPLETOS{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item text-uppercase"><a class="text-uppercase" href="{{ url_for('listar_empresas') }}">Empresas</a></li>
<li class="breadcrumb-item active text-uppercase">{{ empresa.nome_empresa }}</li>
{% endblock %}

{% block content %}
{% macro render_badge_list(items, badge_class, icon_class, placeholder_html) %}
    {% if items %}
        <div class="d-flex flex-wrap gap-2">
            {% set processed_items = [] %}
            {% if items is iterable and items is not string %}
                {% set processed_items = items %}
            {% elif items is string and items.strip() %}
                {% set temp_str = items.strip() %}
                {% if temp_str.startswith('[') and temp_str.endswith(']') %}
                    {% set temp_str = temp_str[1:-1]|replace('"', '')|replace("'", '') %}
                {% endif %}
                {% set processed_items = temp_str.split(',') %}
            {% elif items %}
                {% set processed_items = [items|string] %}
            {% endif %}

            {% for item in processed_items if item and item.strip() %}
                <span class="badge {{ badge_class }} fs-6 px-3 py-2">
                    <i class="bi {{ icon_class }} me-1"></i>{{ item.strip() }}
                </span>
            {% endfor %}
        </div>
    {% else %}
        {{ placeholder_html|sanitize }}
    {% endif %}
{% endmacro %}


<div class="container-fluid text-uppercase" style="max-width: 1400px;">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="text-dept-blue mb-2">
                        <i class="bi bi-building-gear me-3"></i>{{ empresa.nome_empresa }}
                    </h1>
                    <p class="text-muted mb-0">Visualização completa de todos os dados cadastrados</p>
                </div>
                <div class="text-end">
                    <div class="badge bg-dept-blue-subtle px-3 py-2 mb-2">
                        Código: {{ empresa.codigo_empresa or 'N/A' }}
                    </div>
                    <div class="d-block">
                        <a href="{{ url_for('editar_empresa', id=empresa.id) }}" class="btn btn-custom btn-sm">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4 sticky-top" style="top: 4.5rem; z-index: 1020;">
        <div class="col-12">
            <div class="card border-0 shadow-sm bg-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-center flex-wrap gap-2">
                        <a href="#dados-empresa" class="btn btn-outline-dept-blue btn-sm"><i class="bi bi-building me-1"></i>Dados da Empresa</a>
                        <a href="#fiscal" class="btn btn-outline-dept-blue btn-sm"><i class="bi bi-receipt me-1"></i>Fiscal</a>
                        <a href="#contabil" class="btn btn-outline-dept-orange btn-sm"><i class="bi bi-calculator me-1"></i>Contábil</a>
                        <a href="#pessoal" class="btn btn-outline-dept-blue btn-sm"><i class="bi bi-people me-1"></i>Pessoal</a>
                        <a href="#administrativo" class="btn btn-outline-dept-orange btn-sm"><i class="bi bi-gear me-1"></i>Administrativo</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-lg mb-5" id="dados-empresa">
        <div class="card-header bg-dept-blue text-white py-3">
            <h3 class="mb-0 fw-semibold"><i class="bi bi-building me-2"></i>Dados da Empresa</h3>
        </div>
        <div class="card-body p-4">
            <div class="row g-4">
                 <div class="col-lg-4 col-md-6">
                    <div class="info-group">
                        <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-card-text me-2"></i>Identificação</h6>
                        <div class="info-item">
                            <label class="info-label">Código da Empresa</label>
                            <div class="info-value"><span class="badge bg-dept-blue-subtle fs-6">{{ empresa.codigo_empresa or 'Não informado' }}</span></div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Nome da Empresa</label>
                            <div class="info-value fw-semibold text-dept-blue">{{ empresa.nome_empresa or 'Não informado' }}</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">CNPJ</label>
                            <div class="info-value font-monospace clickable-copy">
                                {% if empresa.cnpj %}{% set cnpj = empresa.cnpj|string %}{% if cnpj|length == 14 %}{{ cnpj[:2] }}.{{ cnpj[2:5] }}.{{ cnpj[5:8] }}/{{ cnpj[8:12] }}-{{ cnpj[12:] }}{% else %}{{ empresa.cnpj }}{% endif %}{% else %}<span class="text-muted">Não informado</span>{% endif %}
                            </div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Data de Abertura</label>
                            <div class="info-value">
                                {% if empresa.data_abertura %}<span class="badge bg-dept-blue-subtle">{{ empresa.data_abertura.strftime('%d/%m/%Y') }}</span>{% else %}<span class="text-muted">Não informada</span>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="col-lg-4 col-md-6">
                    <div class="info-group">
                        <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-briefcase me-2"></i>Informações Empresariais</h6>
                        <div class="info-item">
                            <label class="info-label">Sócio Administrador</label>
                            <div class="info-value">{% if empresa.socio_administrador %}<i class="bi bi-person-check me-2 text-dept-blue"></i>{{ empresa.socio_administrador }}{% else %}<span class="text-muted">Não informado</span>{% endif %}</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Atividade Principal</label>
                            <div class="info-value">{% if empresa.atividade_principal %}</i>{{ empresa.atividade_principal }}{% else %}<span class="text-muted">Não informada</span>{% endif %}</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Tributação</label>
                            <div class="info-value">{% if empresa.tributacao %}<span class="badge bg-dept-orange-subtle fs-6"><i class="bi bi-calculator me-1"></i>{{ empresa.tributacao }}</span>{% else %}<span class="text-muted">Não informada</span>{% endif %}</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Regime de Lançamento</label>
                            <div class="info-value">
                                {% if empresa.regime_lancamento_display %}
                                    {% for regime in empresa.regime_lancamento_display %}
                                        <span class="badge bg-dept-orange-subtle fs-6"><i class="bi bi-journal-text me-1"></i>{{ regime }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted">Não informado</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-12">
                    <div class="info-group">
                        <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-pc-display me-2"></i>Sistemas e Tecnologia</h6>
                        <div class="info-item">
                            <label class="info-label">Sistema Utilizado</label>
                            <div class="info-value">{% if empresa.sistema_utilizado %}<div class="d-flex align-items-center"><i class="bi bi-laptop me-2 text-dept-blue"></i><span class="badge bg-dept-blue-subtle">{{ empresa.sistema_utilizado }}</span></div>{% else %}<span class="text-muted">Não informado</span>{% endif %}</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Sistemas/Consultorias</label>
                            <div class="info-value">
                                {% set placeholder_sistemas %}<span class="text-muted">Nenhum sistema adicional</span>{% endset %}
                                {{ render_badge_list(empresa.sistemas_consultorias, 'badge bg-secondary', 'bi-tools', placeholder_sistemas) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="info-group">
                        <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-building me-2"></i>Acessos do Cliente</h6>
                        {% if empresa.acessos %}
                            <div class="row g-2 fw-semibold mb-1">
                                <div class="col-md-3">Portal</div>
                                <div class="col-md-3">Link</div>
                                <div class="col-md-3">Usuário</div>
                                <div class="col-md-3">Senha</div>
                            </div>
                            {% for acesso in empresa.acessos %}
                                <div class="row g-2 mb-2">
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" value="{{ acesso.acesso or '' }}" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        {% if acesso.link %}
                                            <a href="{{ acesso.link }}" target="_blank" rel="noopener noreferrer" class="form-control d-block text-dept-blue text-decoration-underline text-truncate" title="{{ acesso.link }}">{{ acesso.link }}</a>
                                        {% else %}
                                            <input type="text" class="form-control" value="" readonly>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" value="{{ acesso.usuario or '' }}" readonly>
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" value="{{ acesso.senha or '' }}" readonly>
                                    </div>
                                    {% if acesso.observacao %}
                                    <div class="col-12 mt-2">
                                        <textarea class="form-control form-control-sm" readonly style="height:80px">{{ acesso.observacao }}</textarea>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="info-item"><span class="text-muted">Não informado</span></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="fiscal">
    {% if fiscal %}
        <div class="card shadow-lg mb-5">
            <div class="card-header bg-dept-blue text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0 fw-semibold"><i class="bi bi-receipt me-2"></i>Departamento Fiscal</h3>
                    <div class="d-flex align-items-center gap-2">
                        {% if fiscal.updated_at %}<small class="opacity-75"><i class="bi bi-clock me-1"></i>Atualizado: {{ fiscal.updated_at.strftime('%d/%m/%Y às %H:%M') }}</small>{% endif %}
                        <a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}#fiscal" class="btn btn-outline-light btn-sm text-white"><i class="bi bi-pencil me-1"></i>Editar</a>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="info-group">
                            <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-cloud-upload me-2"></i>Envio de Documento</h6>
                            <div class="info-item">
                                <label class="info-label">Envio de Documento</label>
                                <div class="info-value">{% if fiscal.forma_movimento %}<span class="badge bg-dept-blue-subtle fs-6"><i class="bi bi-arrow-left-right me-1 text-dept-blue"></i>{{ fiscal.forma_movimento }}</span>{% else %}<span class="text-muted">Não informada</span>{% endif %}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Envio Digital</label>
                                <div class="info-value">
                                    {% set placeholder_env_digital %}<div class="text-center text-muted py-3 border rounded bg-light"><i class="bi bi-cloud-slash fs-3 mb-2"></i><p class="mb-0 small">Não configurado</p></div>{% endset %}
                                    {{ render_badge_list(fiscal.envio_digital, 'bg-dept-blue-subtle', 'bi-cloud-check', placeholder_env_digital) }}
                                </div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Envio Físico</label>
                                <div class="info-value">
                                    {% set placeholder_env_fisico %}<div class="text-center text-muted py-3 border rounded bg-light"><i class="bi bi-inbox fs-3 mb-2"></i><p class="mb-0 small">Não configurado</p></div>{% endset %}
                                    {% set fisico_list = fiscal.envio_fisico %}
                                    {% if fisico_list is string %}
                                        {% set fisico_list = [fisico_list] %}
                                    {% elif not fisico_list %}
                                        {% set fisico_list = [] %}
                                    {% endif %}
                                    {% set fisico_ns = namespace(items=[]) %}
                                    {% for item in fisico_list %}
                                        {% if item == 'malote' and fiscal.malote_coleta %}
                                            {% set fisico_ns.items = fisico_ns.items + ['Malote - ' ~ fiscal.malote_coleta] %}
                                        {% else %}
                                            {% set fisico_ns.items = fisico_ns.items + [item] %}
                                        {% endif %}
                                    {% endfor %}
                                    {{ render_badge_list(fisico_ns.items, 'bg-dept-blue-subtle', 'bi-inbox', placeholder_env_fisico) }}
                                </div>
                            </div>
                            {% if fiscal.observacao_movimento %}
                            <div class="info-item">
                                <label class="info-label">Observação</label>
                                <div class="info-value">
                                    <textarea class="form-control form-control-sm" readonly style="height:80px">{{ fiscal.observacao_movimento }}</textarea>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>


                <div class="row g-4 mt-2">
                    <div class="col-12">
                        <div class="info-group">
                            <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-download me-2"></i>Formas de Importação</h6>
                            <div class="info-value" style="grid-column: 1 / -1;">
                                {% set placeholder_importacao %}<div class="text-center text-muted py-3 border rounded bg-light"><i class="bi bi-inbox fs-2 mb-2"></i><p class="mb-0">Nenhuma forma de importação configurada</p></div>{% endset %}
                                {% set fi_raw = fiscal.formas_importacao %}
                                {% set fi_items = [] %}
                                {% if fi_raw is iterable and fi_raw is not string %}
                                    {% set fi_items = fi_raw %}
                                {% elif fi_raw is string and fi_raw.strip() %}
                                    {% set temp_str = fi_raw.strip() %}
                                    {% if temp_str.startswith('[') and temp_str.endswith(']') %}
                                        {% set temp_str = temp_str[1:-1]|replace('"', '')|replace("'", '') %}
                                    {% endif %}
                                    {% set fi_items = temp_str.split(',') %}
                                {% elif fi_raw %}
                                    {% set fi_items = [fi_raw|string] %}
                                {% endif %}
                                {% set fi_map = {
                                    'entradas_sped': 'Entradas por Sped',
                                    'entradas_xml': 'Entradas por XML',
                                    'entradas_sat': 'Entradas pelo SAT',
                                    'entradas_sieg': 'Entradas pelo Sieg',
                                    'entradas_webservice': 'Entradas pelo Web Service',
                                    'saidas_sped': 'Saídas por Sped',
                                    'saidas_xml': 'Saídas por XML',
                                    'saidas_sieg': 'Saídas pelo SIEG',
                                    'nfce_sped': 'NFCe por Sped',
                                    'nfce_xml_sieg': 'NFCe por XML - Sieg',
                                    'nfce_xml_cliente': 'NFCe por XML - Copiado do cliente',
                                    'nenhum': 'Não importa nada'
                                } %}
                                {% set fi_ns = namespace(items=[]) %}
                                {% for item in fi_items if item and item.strip() %}
                                    {% set trimmed = item.strip() %}
                                    {% set fi_ns.items = fi_ns.items + [fi_map.get(trimmed, trimmed)] %}
                                {% endfor %}
                                {{ render_badge_list(fi_ns.items, 'bg-dept-blue-subtle', 'bi-check-circle', placeholder_importacao) }}
                            </div>
                            {% if fiscal.observacao_importacao %}
                            <div class="info-item mt-2" style="grid-column: 1 / -1;">
                                <label class="info-label">Observação</label>
                                <div class="info-value">
                                    <textarea class="form-control form-control-sm" readonly style="height:80px;">{{ fiscal.observacao_importacao }}</textarea>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        <div class="info-group mt-4">
                            <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-person-lines-fill me-2"></i>Contato</h6>
                            <div class="info-value">
                                {% if fiscal.contatos_list %}
                                    <ul class="list-unstyled mb-0">
                                        {% for contato in fiscal.contatos_list %}
                                            <li class="mb-3">
                                                {% if contato.nome %}<div class="fw-semibold text-center">{{ contato.nome }}</div>{% endif %}
                                                {% for meio in contato.meios %}
                                                    <div class="text-start text-nowrap"><span class="fw-semibold">{{ meio.tipo|capitalize }}</span> - {{ meio.endereco }}</div>
                                                {% endfor %}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <span class="text-muted">Não informado</span>
                                {% endif %}
                            </div>
                            {% if fiscal.observacao_contato %}
                            <div class="info-item mt-2">
                                <label class="info-label">Observação</label>
                                <div class="info-value">
                                    <textarea class="form-control form-control-sm" readonly style="height:80px">{{ fiscal.observacao_contato }}</textarea>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% if fiscal.particularidades_texto and fiscal.particularidades_texto.strip() %}
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="info-group">
                            <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-pencil-square me-2"></i>Particularidades</h6>
                            <div class="border rounded p-4 bg-white editor-content">{{ fiscal.particularidades_texto|sanitize }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="card shadow-lg mb-5" style="border-color:var(--primary-dark);">
            <div class="card-header bg-dept-blue text-white py-3"><h3 class="mb-0 fw-semibold"><i class="bi bi-receipt me-2"></i>Departamento Fiscal</h3></div>
            <div class="card-body p-4 text-center"><div class="py-5"><i class="bi bi-exclamation-triangle-fill fs-1 text-dept-blue mb-3"></i><h5 class="text-muted">Departamento Fiscal não configurado</h5><p class="text-muted mb-4">Este departamento ainda não foi configurado.</p><a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}#fiscal" class="btn btn-dept-blue"><i class="bi bi-plus-circle me-2"></i>Configurar</a></div></div>
        </div>
    {% endif %}
    </div>

    <div id="contabil">
    {% if contabil %}
        <div class="card shadow-lg mb-5">
            <div class="card-header bg-dept-orange text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0 fw-semibold"><i class="bi bi-calculator me-2"></i>Departamento Contábil</h3>
                    <div class="d-flex align-items-center gap-2">
                        {% if contabil.updated_at %}<small class="opacity-75"><i class="bi bi-clock me-1"></i>Atualizado: {{ contabil.updated_at.strftime('%d/%m/%Y às %H:%M') }}</small>{% endif %}
                        <a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}#contabil" class="btn btn-outline-light btn-sm text-white"><i class="bi bi-pencil me-1"></i>Editar</a>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    <div class="col-12">
                        <div class="info-group">
                            <h6 class="text-dept-orange mb-3 border-bottom pb-2"><i class="bi bi-info-circle me-2"></i>Informações Básicas</h6>
                            <div class="info-item">
                                <label class="info-label">Método de Importação</label>
                                {% set placeholder_metodo %}<span class="text-muted">Não informado</span>{% endset %}
                                {% set mi_map = {'importado': 'Importado', 'digitado': 'Digitado'} %}
                                {% set mi_items = [] %}
                                {% if contabil.metodo_importacao is iterable and contabil.metodo_importacao is not string %}
                                    {% set mi_items = contabil.metodo_importacao %}
                                {% elif contabil.metodo_importacao %}
                                    {% set mi_items = [contabil.metodo_importacao] %}
                                {% endif %}
                                {% set mi_ns = namespace(items=[]) %}
                                {% for item in mi_items %}
                                    {% set mi_ns.items = mi_ns.items + [mi_map.get(item, item)] %}
                                {% endfor %}
                                <div class="info-value">{{ render_badge_list(mi_ns.items, 'badge bg-dept-orange-subtle text-dept-orange fs-6', 'bi-download', placeholder_metodo) }}</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-12">
                        <div class="info-group">
                            <h6 class="text-dept-orange mb-3 border-bottom pb-2"><i class="bi bi-cloud-upload me-2"></i>Envio de Documento</h6>
                            <div class="info-item">
                                <label class="info-label">Envio de Documento</label>
                                <div class="info-value">{% if contabil.forma_movimento %}<span class="badge bg-dept-orange-subtle fs-6"><i class="bi bi-arrow-left-right me-1 text-dept-orange"></i>{{ contabil.forma_movimento }}</span>{% else %}<span class="text-muted">Não informada</span>{% endif %}</div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Envio Digital</label>
                                <div class="info-value">
                                    {% set placeholder_cont_digital %}<div class="text-center text-muted py-3 border rounded bg-light"><i class="bi bi-cloud-slash fs-3 mb-2"></i><p class="mb-0 small">Não configurado</p></div>{% endset %}
                                    {{ render_badge_list(contabil.envio_digital, 'bg-dept-orange-subtle', 'bi-cloud-check', placeholder_cont_digital) }}
                                </div>
                            </div>
                            <div class="info-item">
                                <label class="info-label">Envio Físico</label>
                                <div class="info-value">
                                    {% set placeholder_cont_fisico %}<div class="text-center text-muted py-3 border rounded bg-light"><i class="bi bi-inbox fs-3 mb-2"></i><p class="mb-0 small">Não configurado</p></div>{% endset %}
                                    {% set cont_fisico = contabil.envio_fisico %}
                                    {% if cont_fisico is string %}
                                        {% set cont_fisico = [cont_fisico] %}
                                    {% elif not cont_fisico %}
                                        {% set cont_fisico = [] %}
                                    {% endif %}
                                    {% set cont_ns = namespace(items=[]) %}
                                    {% for item in cont_fisico %}
                                        {% if item == 'malote' and contabil.malote_coleta %}
                                            {% set cont_ns.items = cont_ns.items + ['Malote - ' ~ contabil.malote_coleta] %}
                                        {% else %}
                                            {% set cont_ns.items = cont_ns.items + [item] %}
                                        {% endif %}
                                    {% endfor %}
                                    {{ render_badge_list(cont_ns.items, 'bg-dept-orange-subtle', 'bi-inbox', placeholder_cont_fisico) }}
                                </div>
                            </div>
                            {% if contabil.observacao_movimento %}
                            <div class="info-item">
                                <label class="info-label">Observação</label>
                                <div class="info-value">
                                    <textarea class="form-control form-control-sm" readonly style="height:80px">{{ contabil.observacao_movimento }}</textarea>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="row g-4 mt-2">
                    <div class="col-12">
                        <div class="info-group">
                             <h6 class="text-dept-orange mb-3 border-bottom pb-2"><i class="bi bi-file-earmark-text me-2"></i>Controle de Relatórios</h6>
                             <div class="info-value" style="grid-column: 1 / -1;">
                                {% set placeholder_relatorios %}<div class="text-center text-muted py-4 border rounded bg-light"><i class="bi bi-file-earmark-x fs-2 mb-2"></i><p class="mb-0">Nenhum controle de relatório configurado</p></div>{% endset %}
                                {% set cr_raw = contabil.controle_relatorios %}
                                {% set cr_items = [] %}
                                {% if cr_raw is iterable and cr_raw is not string %}
                                    {% set cr_items = cr_raw %}
                                {% elif cr_raw is string and cr_raw.strip() %}
                                    {% set temp_str = cr_raw.strip() %}
                                    {% if temp_str.startswith('[') and temp_str.endswith(']') %}
                                        {% set temp_str = temp_str[1:-1]|replace('"', '')|replace("'", '') %}
                                    {% endif %}
                                    {% set cr_items = temp_str.split(',') %}
                                {% elif cr_raw %}
                                    {% set cr_items = [cr_raw|string] %}
                                {% endif %}
                                {% set cr_map = {
                                    'forn_cli_cota_unica': 'Fornecedor e clientes conta única',
                                    'saldo_final_mes': 'Relatório com saldo final do mês',
                                    'adiantamentos': 'Relatório de adiantamentos',
                                    'contas_pagas': 'Relatório de contas pagas',
                                    'contas_recebidas': 'Relatório de contas recebidas',
                                    'conferir_aplicacao': 'Conferir aplicação'
                                } %}
                                {% set cr_ns = namespace(items=[]) %}
                                {% for item in cr_items if item and item.strip() %}
                                    {% set trimmed = item.strip() %}
                                    {% set cr_ns.items = cr_ns.items + [cr_map.get(trimmed, trimmed)] %}
                                {% endfor %}
                                {{ render_badge_list(cr_ns.items, 'bg-dept-orange-subtle', 'bi-check-square', placeholder_relatorios) }}
                            </div>
                            {% if contabil.observacao_controle_relatorios %}
                            <div class="info-item mt-2" style="grid-column: 1 / -1;">
                                <label class="info-label">Observação</label>
                                <div class="info-value">
                                    <textarea class="form-control form-control-sm" readonly style="height:80px">{{ contabil.observacao_controle_relatorios }}</textarea>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if contabil.particularidades_texto and contabil.particularidades_texto.strip() %}
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="info-group">
                            <h6 class="text-dept-orange mb-3 border-bottom pb-2"><i class="bi bi-pencil-square me-2"></i>Particularidades</h6>
                              <div class="border rounded p-4 bg-white editor-content">{{ contabil.particularidades_texto|sanitize }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="card shadow-lg mb-5" style="border-color:var(--primary-color);">
            <div class="card-header bg-dept-orange text-white py-3"><h3 class="mb-0 fw-semibold"><i class="bi bi-calculator me-2"></i>Departamento Contábil</h3></div>
            <div class="card-body p-4 text-center"><div class="py-5"><i class="bi bi-exclamation-triangle-fill fs-1 text-dept-orange mb-3"></i><h5 class="text-muted">Departamento Contábil não configurado</h5><p class="text-muted mb-4">Este departamento ainda não foi configurado.</p><a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}#contabil" class="btn btn-dept-orange"><i class="bi bi-plus-circle me-2"></i>Configurar</a></div></div>
        </div>
    {% endif %}
    </div>

    <div id="pessoal">
        {% if pessoal %}
            <div class="card shadow-lg mb-5">
                <div class="card-header bg-dept-blue text-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3 class="mb-0 fw-semibold"><i class="bi bi-people me-2"></i>Departamento Pessoal</h3>
                        <div class="d-flex align-items-center gap-2">
                            {% if pessoal.updated_at %}<small class="opacity-75"><i class="bi bi-clock me-1"></i>Atualizado: {{ pessoal.updated_at.strftime('%d/%m/%Y às %H:%M') }}</small>{% endif %}
                            <a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}#pessoal" class="btn btn-outline-light btn-sm text-white"><i class="bi bi-pencil me-1"></i>Editar</a>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row g-4">
                        <div class="col-lg-6 col-md-12">
                            <div class="info-group">
                                <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-info-circle me-2"></i>Informações Básicas</h6>
                                <div class="info-item">
                                    <label class="info-label">Data de Envio</label>
                                    <div class="info-value">{% if pessoal.data_envio %}<span class="badge bg-dept-blue-subtle fs-6"><i class="bi bi-calendar-event me-1 text-dept-blue"></i>{{ pessoal.data_envio }}</span>{% else %}<span class="text-muted">Não informada</span>{% endif %}</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-md-12">
                            <div class="info-group">
                                <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-gear me-2"></i>Controles e Sistemas</h6>
                                <div class="row">
                                    <div class="col-md-4 text-center info-item">
                                        <label class="info-label">Registro de Funcionários</label>
                                        <div class="info-value mt-2">
                                            {% if pessoal.registro_funcionarios %}
                                                <span class="badge bg-dept-blue-subtle fs-6 px-3 py-2"><i class="bi bi-person-lines-fill me-2 text-dept-blue"></i>{{ pessoal.registro_funcionarios }}</span>
                                            {% else %}
                                                <span class="badge bg-light text-muted fs-6 px-3 py-2"><i class="bi bi-x-circle me-2"></i>Não tem</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center info-item">
                                        <label class="info-label">Ponto Eletrônico</label>
                                        <div class="info-value mt-2">
                                            {% if pessoal.ponto_eletronico %}
                                                <span class="badge bg-dept-blue-subtle fs-6 px-3 py-2"><i class="bi bi-clock me-2 text-dept-blue"></i>{{ pessoal.ponto_eletronico }}</span>
                                            {% else %}
                                                <span class="badge bg-light text-muted fs-6 px-3 py-2"><i class="bi bi-x-circle me-2"></i>Não informado</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-center info-item">
                                        <label class="info-label">Sistema de Pagamento</label>
                                        <div class="info-value mt-2">
                                            {% if pessoal.pagamento_funcionario %}
                                                <span class="badge bg-dept-blue-subtle fs-6 px-3 py-2"><i class="bi bi-currency-dollar me-2 text-dept-blue"></i>{{ pessoal.pagamento_funcionario }}</span>
                                            {% else %}
                                                <span class="badge bg-light text-muted fs-6 px-3 py-2"><i class="bi bi-x-circle me-2"></i>Não informado</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    {% if pessoal.particularidades_texto and pessoal.particularidades_texto.strip() %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="info-group">
                                <h6 class="text-dept-blue mb-3 border-bottom pb-2"><i class="bi bi-pencil-square me-2"></i>Particularidades</h6>
                                  <div class="border rounded p-4 bg-white editor-content">{{ pessoal.particularidades_texto|sanitize }}</div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% else %}
            <div class="card shadow-lg mb-5" style="border-color:var(--primary-dark);">
                <div class="card-header bg-dept-blue text-white py-3"><h3 class="mb-0 fw-semibold"><i class="bi bi-people me-2"></i>Departamento Pessoal</h3></div>
                <div class="card-body p-4 text-center"><div class="py-5"><i class="bi bi-exclamation-triangle-fill fs-1 text-dept-blue mb-3"></i><h5 class="text-muted">Departamento Pessoal não configurado</h5><p class="text-muted mb-4">Este departamento ainda não foi configurado.</p><a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}#pessoal" class="btn btn-dept-blue"><i class="bi bi-plus-circle me-2"></i>Configurar</a></div></div>
            </div>
        {% endif %}
        </div>

    <div id="administrativo">
    {% if administrativo %}
        <div class="card shadow-lg mb-5">
            <div class="card-header bg-dept-orange text-white py-3">
                 <div class="d-flex justify-content-between align-items-center">
                    <h3 class="mb-0 fw-semibold"><i class="bi bi-gear me-2"></i>Departamento Administrativo</h3>
                    <div class="d-flex align-items-center gap-2">
                        {% if administrativo.updated_at %}<small class="opacity-75"><i class="bi bi-clock me-1"></i>Atualizado: {{ administrativo.updated_at.strftime('%d/%m/%Y às %H:%M') }}</small>{% endif %}
                        <a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}#administrativo" class="btn btn-outline-light btn-sm text-white"><i class="bi bi-pencil me-1"></i>Editar</a>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">
                {% if administrativo.particularidades_texto and administrativo.particularidades_texto.strip() %}
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="info-group">
                            <h6 class="text-dept-orange mb-3 border-bottom pb-2"><i class="bi bi-pencil-square me-2"></i>Particularidades</h6>
                              <div class="border rounded p-4 bg-white editor-content">{{ administrativo.particularidades_texto|sanitize }}</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    {% else %}
        <div class="card shadow-lg mb-5" style="border-color:var(--primary-color);">
            <div class="card-header bg-dept-orange text-white py-3"><h3 class="mb-0 fw-semibold"><i class="bi bi-gear me-2"></i>Departamento Administrativo</h3></div>
            <div class="card-body p-4 text-center"><div class="py-5"><i class="bi bi-exclamation-triangle-fill fs-1 text-dept-orange mb-3"></i><h5 class="text-muted">Departamento Administrativo não configurado</h5><p class="text-muted mb-4">Este departamento ainda não foi configurado.</p><a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}#administrativo" class="btn btn-dept-orange"><i class="bi bi-plus-circle me-2"></i>Configurar</a></div></div>
        </div>
    {% endif %}
    </div>

    <div class="row my-5">
        <div class="col-12">
            <div class="d-flex justify-content-center gap-3 flex-wrap">
                <a href="{{ url_for('listar_empresas') }}" class="btn btn-outline-secondary px-4"><i class="bi bi-arrow-left me-2"></i>Voltar para Lista</a>
                <a href="{{ url_for('editar_empresa', id=empresa.id) }}" class="btn btn-custom px-4"><i class="bi bi-pencil me-2"></i>Editar Empresa</a>
                <a href="{{ url_for('gerenciar_departamentos', empresa_id=empresa.id) }}" class="btn btn-outline-info px-4"><i class="bi bi-diagram-3 me-2"></i>Gerenciar Departamentos</a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para exibição ampliada de imagens -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img src="" id="modalImage" class="img-fluid w-100" alt="Imagem ampliada">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    // Smooth scroll para navegação com offset para o cabeçalho
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                const offset = 80; 
                const elementPosition = targetElement.getBoundingClientRect().top;
                const offsetPosition = elementPosition + window.pageYOffset - offset;

                window.scrollTo({ top: offsetPosition, behavior: 'smooth' });
            }
        });
    });

    // Toggle para mostrar/ocultar senhas
    document.querySelectorAll('.toggle-password').forEach(btn => {
        btn.addEventListener('click', function() {
            const passwordField = this.closest('.password-field');
            const hiddenSpan = passwordField.querySelector('.password-hidden');
            const password = passwordField.getAttribute('data-password');
            const icon = this.querySelector('i');
            
            if (hiddenSpan.textContent === '••••••••') {
                hiddenSpan.textContent = password;
                icon.classList.replace('bi-eye', 'bi-eye-slash');
                this.setAttribute('title', 'Ocultar senha');
            } else {
                hiddenSpan.textContent = '••••••••';
                icon.classList.replace('bi-eye-slash', 'bi-eye');
                this.setAttribute('title', 'Mostrar senha');
            }
        });
    });

    // Funcionalidade de copiar para a área de transferência
    document.querySelectorAll('.clickable-copy').forEach(element => {
        const textToCopy = element.textContent.trim();
        if (textToCopy && textToCopy !== '-' && textToCopy !== 'Não informado') {
            element.addEventListener('click', function() {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    const icon = this.querySelector('.bi-clipboard');
                    if (icon) icon.classList.replace('bi-clipboard', 'bi-clipboard-check-fill');

                    setTimeout(() => {
                        if (icon) icon.classList.replace('bi-clipboard-check-fill', 'bi-clipboard');
                    }, 1500);
                }).catch(err => console.error('Erro ao copiar: ', err));
            });
        }
    });

    // Clique em imagens das particularidades para ampliar
    document.querySelectorAll('.editor-content img').forEach(img => {
        img.classList.add('img-fluid');
        img.addEventListener('click', function() {
            const modalImg = document.getElementById('modalImage');
            modalImg.src = this.src;
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        });
    });

    // Highlighting da seção ativa durante scroll
    const observerOptions = { root: null, rootMargin: '-20% 0px -70% 0px', threshold: 0.1 };
    const observer = new IntersectionObserver((entries) => {
        let lastIntersectingId = null;
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                 lastIntersectingId = entry.target.getAttribute('id');
            }
        });

        if (lastIntersectingId) {
            document.querySelectorAll('.card-body .btn-sm').forEach(link => link.classList.remove('active'));
            const activeLink = document.querySelector(`a[href="#${lastIntersectingId}"]`);
            if (activeLink) activeLink.classList.add('active');
        }
    }, observerOptions);

    document.querySelectorAll('div[id]').forEach(section => {
        if (section.id) observer.observe(section);
    });

    // Otimização para impressão
    window.addEventListener('beforeprint', () => {
        document.querySelectorAll('.password-field .password-hidden').forEach(field => {
            if (field.textContent === '••••••••') {
                const password = field.closest('.password-field').getAttribute('data-password');
                if (password) field.textContent = password;
            }
        });
    });

    window.addEventListener('afterprint', () => {
        document.querySelectorAll('.password-field .password-hidden').forEach(field => {
             const password = field.closest('.password-field').getAttribute('data-password');
             if (password) field.textContent = '••••••••';
        });
    });

    // Função de exportar para PDF (usa a funcionalidade de impressão do navegador)
    window.exportToPDF = function() { window.print(); };

    // Inicialização de Tooltips do Bootstrap, se disponível
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        document.querySelectorAll('[title]').forEach(element => new bootstrap.Tooltip(element));
    }
});
</script>
{% endblock %}
