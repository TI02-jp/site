{% extends "base.html" %}

{% block title %}Relatorio de Empresas{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-2">Empresas por Regime de Tributacao</h1>
    <p class="text-muted small mb-3">Total de empresas: {{ tributacao_chart.total }}</p>
    <div class="rounded border bg-white" style="height: 260px;">
        <canvas id="empresa-tributacao-chart" class="p-3"></canvas>
    </div>
    <div id="tributacao-list" class="mt-3" style="display:none;">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0" id="tributacao-list-title"></h5>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" id="tributacao-list-print" disabled>
                    <i class="bi bi-printer me-1"></i>Imprimir lista
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" id="tributacao-list-clear">
                    <i class="bi bi-x-circle me-1"></i>Fechar lista
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm align-middle mb-0">
                <thead>
                    <tr>
                        <th style="width: 90px;">Código</th>
                        <th>Nome</th>
                        <th style="width: 170px;">CNPJ</th>
                        <th style="width: 110px;">Ações</th>
                    </tr>
                </thead>
                <tbody id="tributacao-list-body"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para visualizar empresa -->
<div class="modal fade" id="empresaViewModal" tabindex="-1" aria-labelledby="empresaViewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-md-down modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="empresaViewModalLabel">Visualizar Empresa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="empresaViewBody">
                <div class="text-center py-5" id="empresaViewLoading" style="display:none;">
                    <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div>
                </div>
                <div id="empresaViewContent"></div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-5">
    <h1 class="mb-2">Empresas por Sistema Utilizado</h1>
    <p class="text-muted small mb-3">Total de empresas: {{ sistema_chart.total }}</p>
    <div class="rounded border bg-white" style="height: 260px;">
        <canvas id="empresa-sistema-chart" class="p-3"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
    const chartPalette = ['#2563eb','#22c55e','#f97316','#a855f7','#facc15','#38bdf8','#ef4444','#14b8a6','#f472b6','#8b5cf6','#0ea5e9','#65a30d'];

    function shadeColor(color, percent) {
        const num = parseInt(color.slice(1), 16);
        const amt = Math.round(2.55 * percent);
        let r = (num >> 16) + amt;
        let g = (num >> 8 & 0x00ff) + amt;
        let b = (num & 0x0000ff) + amt;
        r = Math.max(Math.min(r, 255), 0);
        g = Math.max(Math.min(g, 255), 0);
        b = Math.max(Math.min(b, 255), 0);
        return `#${(1 << 24 | (r << 16) | (g << 8) | b).toString(16).slice(1)}`;
    }

    function buildPalette(size) {
        const colors = [];
        for (let i = 0; i < size; i++) {
            colors.push(chartPalette[i % chartPalette.length]);
        }
        return colors;
    }

    function createBarChart(canvasId, config, onClick) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !config) {
            return;
        }
        const colors = buildPalette(config.labels?.length || 0);
        const chart = new Chart(canvas, {
            type: config.type || 'bar',
            data: {
                labels: config.labels || [],
                datasets: [{
                    label: config.datasetLabel || '',
                    data: config.values || [],
                    backgroundColor: colors,
                    hoverBackgroundColor: colors.map(color => shadeColor(color, 12)),
                    borderRadius: 12,
                    maxBarThickness: 48,
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 320, easing: 'easeOutQuart' },
                plugins: {
                    legend: { display: false },
                    title: {
                        display: Boolean(config.title),
                        text: config.title,
                        font: { size: 16, weight: '600' },
                    },
                    tooltip: {
                        backgroundColor: '#111827',
                        titleFont: { size: 12, weight: '600' },
                        bodyFont: { size: 11 },
                        padding: 10,
                    },
                },
                scales: {
                    x: {
                        title: config.xTitle ? { display: true, text: config.xTitle } : undefined,
                        ticks: { font: { size: 10 } },
                        grid: { display: false },
                    },
                    y: {
                        title: config.yTitle ? { display: true, text: config.yTitle } : undefined,
                        beginAtZero: true,
                        ticks: { stepSize: 1, precision: 0, font: { size: 10 } },
                        grid: { color: '#e5e7eb' },
                    },
                },
            },
        });
        if (onClick) {
            canvas.onclick = (event) => {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (points.length) {
                    const idx = points[0].index;
                    const label = chart.data.labels[idx];
                    onClick(label);
                }
            };
        }
        return chart;
    }

    const tributacaoCompanies = {{ tributacao_companies|tojson }};
    let currentTributacaoLabel = null;

    function formatCNPJ(cnpj) {
        if (!cnpj) return '';
        const digits = cnpj.replace(/\D/g, '');
        if (digits.length !== 14) return cnpj;
        return digits.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
    }

    function renderTributacaoList(label) {
        const container = document.getElementById('tributacao-list');
        const title = document.getElementById('tributacao-list-title');
        const body = document.getElementById('tributacao-list-body');
        const printBtn = document.getElementById('tributacao-list-print');
        if (!container || !title || !body) return;

        const companies = tributacaoCompanies[label] || [];
        currentTributacaoLabel = companies.length ? label : null;
        title.textContent = companies.length ? `Empresas em ${label} (${companies.length})` : `Sem empresas em ${label}`;
        body.innerHTML = '';

        companies.forEach((company) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><span class="badge bg-primary-subtle text-primary fw-semibold">${company.codigo || ''}</span></td>
                <td>${company.nome || ''}</td>
                <td class="font-monospace">${formatCNPJ(company.cnpj || '')}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary company-view-btn" data-view-url="/empresa/visualizar/${company.token}?hide_actions=1" title="Visualizar empresa">
                        <i class="bi bi-eye"></i>
                    </button>
                </td>
            `;
            body.appendChild(tr);
        });

        if (printBtn) {
            printBtn.disabled = !companies.length;
        }

        container.style.display = companies.length ? 'block' : 'none';
    }

    document.getElementById('tributacao-list-clear')?.addEventListener('click', function () {
        const container = document.getElementById('tributacao-list');
        const body = document.getElementById('tributacao-list-body');
        const title = document.getElementById('tributacao-list-title');
        const printBtn = document.getElementById('tributacao-list-print');
        if (body) body.innerHTML = '';
        if (title) title.textContent = '';
        if (container) container.style.display = 'none';
        if (printBtn) printBtn.disabled = true;
        currentTributacaoLabel = null;
    });

    function buildPrintableRows(companies) {
        return companies.map((company) => `
            <tr>
                <td style="width: 90px;">${company.codigo || ''}</td>
                <td>${company.nome || ''}</td>
                <td style="width: 170px;">${formatCNPJ(company.cnpj || '')}</td>
            </tr>
        `).join('');
    }

    function printTributacaoList() {
        if (!currentTributacaoLabel) return;
        const companies = tributacaoCompanies[currentTributacaoLabel] || [];
        if (!companies.length) return;
        const printableRows = buildPrintableRows(companies);
        const titulo = `Empresas em ${currentTributacaoLabel}`;
        const stamp = new Date().toLocaleString('pt-BR');
        const printWindow = window.open('', '_blank', 'width=900,height=700');
        if (!printWindow) return;
        printWindow.document.write(`
            <!doctype html>
            <html>
            <head>
                <meta charset="utf-8">
                <title>${titulo}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    body { padding: 24px; }
                    h4 { font-weight: 600; }
                    th { background: #f8fafc; }
                </style>
            </head>
            <body>
                <header class="mb-3">
                    <h4 class="mb-1">${titulo}</h4>
                    <div class="text-muted small">Lista impressa em ${stamp}</div>
                </header>
                <table class="table table-sm table-bordered align-middle">
                    <thead>
                        <tr>
                            <th style="width: 90px;">Código</th>
                            <th>Nome</th>
                            <th style="width: 170px;">CNPJ</th>
                        </tr>
                    </thead>
                    <tbody>${printableRows}</tbody>
                </table>
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }

    document.getElementById('tributacao-list-print')?.addEventListener('click', printTributacaoList);

    // Modal para visualizar empresa sem sair da página (fetch e injeta HTML)
    const empresaViewModalEl = document.getElementById('empresaViewModal');
    const empresaViewBody = document.getElementById('empresaViewBody');
    const empresaViewContent = document.getElementById('empresaViewContent');
    const empresaViewLoading = document.getElementById('empresaViewLoading');
    const empresaViewModal = empresaViewModalEl ? new bootstrap.Modal(empresaViewModalEl) : null;

    async function loadEmpresaIntoModal(url) {
        if (!empresaViewModal || !empresaViewContent || !empresaViewLoading) return;
        empresaViewContent.innerHTML = '';
        empresaViewLoading.style.display = 'block';
        empresaViewModal.show();
        try {
            const resp = await fetch(url, { credentials: 'same-origin' });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const html = await resp.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const container = doc.querySelector('.container-fluid') || doc.body;
            empresaViewContent.innerHTML = container.innerHTML;
        } catch (err) {
            empresaViewContent.innerHTML = `<div class="alert alert-danger mb-0">Não foi possível carregar a empresa (${err}).</div>`;
        } finally {
            empresaViewLoading.style.display = 'none';
        }
    }

    document.getElementById('tributacao-list-body')?.addEventListener('click', function (event) {
        const btn = event.target.closest('.company-view-btn');
        if (!btn || !empresaViewModal) return;
        const url = btn.getAttribute('data-view-url');
        if (!url) return;
        loadEmpresaIntoModal(url);
    });

    empresaViewModalEl?.addEventListener('hidden.bs.modal', function () {
        if (empresaViewContent) {
            empresaViewContent.innerHTML = '';
        }
    });

    createBarChart('empresa-tributacao-chart', {{ tributacao_chart|tojson }}, renderTributacaoList);
    createBarChart('empresa-sistema-chart', {{ sistema_chart|tojson }});
</script>
{% endblock %}
