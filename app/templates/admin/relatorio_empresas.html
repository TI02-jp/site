{% extends "base.html" %}

{% block title %}Relatório de Empresas{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Empresas por Regime de Tributação</h1>
    <div id="chart-container">
        {{ chart_div|safe }}
    </div>
    <div id="empresa-list" class="mt-4 d-flex justify-content-center"></div>
</div>
<div class="container mt-5">
    <h1 class="mb-4">Empresas por Sistema Utilizado</h1>
    <div id="sistema-chart-container">
        {{ sistemas_chart_div|safe }}
    </div>
    <div id="empresa-sistema-list" class="mt-4 d-flex justify-content-center"></div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const empresasBySlice = {{ empresas_por_slice|tojson }};
        const empresasBySistema = {{ empresas_por_sistema|tojson }};

        function renderTable(containerId, empresas) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }
            if (!empresas.length) {
                container.innerHTML = '<p class="text-center">Nenhuma empresa encontrada.</p>';
                return;
            }
            let html = '<div class="table-responsive"><table class="table table-striped w-auto text-start"><thead><tr><th>Código</th><th>Nome</th><th>CNPJ</th></tr></thead><tbody>';
            empresas.forEach(e => {
                const nome = e.nome ? e.nome.toUpperCase() : '';
                const cnpj = e.cnpj || '';
                const codigo = e.codigo || '';
                html += `<tr><td>${codigo}</td><td>${nome}</td><td>${cnpj}</td></tr>`;
            });
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        const chartTrib = document.getElementById('empresa-tributacao-chart');
        if (chartTrib && chartTrib.on) {
            chartTrib.on('plotly_click', function (data) {
                const label = data.points[0].x || data.points[0].label;
                renderTable('empresa-list', empresasBySlice[label] || []);
            });
        }

        const chartSistema = document.getElementById('empresa-sistemas-chart');
        if (chartSistema && chartSistema.on) {
            chartSistema.on('plotly_click', function (data) {
                const label = data.points[0].x || data.points[0].label;
                renderTable('empresa-sistema-list', empresasBySistema[label] || []);
            });
        }
    });
</script>
{% endblock %}
