{% extends "base.html" %}

{% block title %}Relatorio Contabil{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Relatorio Contabil</h1>

    <h3 class="mt-4">Metodos de Importacao</h3>
    <p class="text-muted small mb-3">Total de empresas: {{ importacao_chart.total }}</p>
    <div class="rounded border bg-white" style="height: 260px;">
        <canvas id="contabil-importacao-chart" class="p-3"></canvas>
    </div>

    <h3 class="mt-5">Envio de Documentos</h3>
    <p class="text-muted small mb-3">Total de empresas: {{ envio_chart.total }}</p>
    <div class="rounded border bg-white" style="height: 260px;">
        <canvas id="contabil-envio-chart" class="p-3"></canvas>
    </div>

    <h4 class="mt-5">Coleta do Malote</h4>
    <p class="text-muted small mb-3">Total de empresas: {{ malote_chart.total }}</p>
    <div class="rounded border bg-white" style="height: 260px;">
        <canvas id="contabil-malote-chart" class="p-3"></canvas>
    </div>

    <h3 class="mt-5">Controle de Relatorios</h3>
    <p class="text-muted small mb-3">Total de empresas: {{ relatorios_chart.total }}</p>
    <div class="rounded border bg-white" style="height: 260px;">
        <canvas id="contabil-relatorios-chart" class="p-3"></canvas>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
    const chartPalette = ['#2563eb','#22c55e','#f97316','#a855f7','#facc15','#38bdf8','#ef4444','#14b8a6','#f472b6','#8b5cf6','#0ea5e9','#65a30d'];

    function shadeColor(color, percent) {
        const num = parseInt(color.slice(1), 16);
        const amt = Math.round(2.55 * percent);
        let r = (num >> 16) + amt;
        let g = (num >> 8 & 0x00ff) + amt;
        let b = (num & 0x0000ff) + amt;
        r = Math.max(Math.min(r, 255), 0);
        g = Math.max(Math.min(g, 255), 0);
        b = Math.max(Math.min(b, 255), 0);
        return `#${(1 << 24 | (r << 16) | (g << 8) | b).toString(16).slice(1)}`;
    }

    function buildPalette(size) {
        const colors = [];
        for (let i = 0; i < size; i++) {
            colors.push(chartPalette[i % chartPalette.length]);
        }
        return colors;
    }

    function createChart(canvasId, config) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || !config) {
            return;
        }
        const isBar = (config.type || 'bar') === 'bar';
        const colors = buildPalette(config.labels?.length || 0);
        new Chart(canvas, {
            type: config.type || 'bar',
            data: {
                labels: config.labels || [],
                datasets: [{
                    label: config.datasetLabel || '',
                    data: config.values || [],
                    backgroundColor: colors,
                    hoverBackgroundColor: colors.map(color => shadeColor(color, 12)),
                    borderRadius: isBar ? 12 : undefined,
                    maxBarThickness: isBar ? 48 : undefined,
                    borderWidth: isBar ? 0 : 2,
                    borderColor: isBar ? undefined : '#ffffff',
                }],
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 320, easing: 'easeOutQuart' },
                plugins: {
                    legend: {
                        display: !isBar,
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 12, font: { size: 11 } },
                    },
                    title: {
                        display: Boolean(config.title),
                        text: config.title,
                        font: { size: 16, weight: '600' },
                    },
                    tooltip: {
                        backgroundColor: '#111827',
                        titleFont: { size: 12, weight: '600' },
                        bodyFont: { size: 11 },
                        padding: 10,
                    },
                },
                scales: isBar ? {
                    x: {
                        title: config.xTitle ? { display: true, text: config.xTitle } : undefined,
                        ticks: { font: { size: 10 } },
                        grid: { display: false },
                    },
                    y: {
                        title: config.yTitle ? { display: true, text: config.yTitle } : undefined,
                        beginAtZero: true,
                        ticks: { stepSize: 1, precision: 0, font: { size: 10 } },
                        grid: { color: '#e5e7eb' },
                    },
                } : undefined,
                cutout: isBar ? undefined : '60%',
            },
        });
    }

    createChart('contabil-importacao-chart', {{ importacao_chart|tojson }});
    createChart('contabil-envio-chart', {{ envio_chart|tojson }});
    createChart('contabil-malote-chart', {{ malote_chart|tojson }});
    createChart('contabil-relatorios-chart', {{ relatorios_chart|tojson }});
</script>
{% endblock %}
