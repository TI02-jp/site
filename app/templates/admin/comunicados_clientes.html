{% extends "base.html" %}

{% block title %}Comunicados a Clientes{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block extra_css %}
<style>
.client-announcements-table th,
.client-announcements-table td {
    text-align: left;
}
.client-announcements-table tbody tr {
    transition: transform 0.12s ease, box-shadow 0.12s ease;
}
.client-announcements-table tbody tr:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
}
.status-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    border-radius: 999px;
    padding: 0.35rem 0.65rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    text-transform: uppercase;
}
.status-pill .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}
.trib-pill {
    border-radius: 999px;
    padding: 0.25rem 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}
.trib-pill.real { background: #f3f1ff; color: #5b4bff; }
.trib-pill.presumido { background: #ecf7ff; color: #0b7cc1; }
.trib-pill.simples { background: #eef8f1; color: #1b8c55; }
.trib-pill.mei { background: #fff6e7; color: #c07a04; }
.trib-pill.todos { background: #f5f5f5; color: #444; }
.filter-chip {
    background: #eef2ff;
    color: #3247c4;
    border-radius: 999px;
    padding: 0.2rem 0.75rem;
    font-weight: 600;
    border: 1px solid #d9defa;
}
.stat-card {
    border: 1px solid #eef0f7;
    border-radius: 14px;
    padding: 0.85rem 1rem;
    background: linear-gradient(135deg, #f9fbff 0%, #ffffff 100%);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.04);
}
.stat-card h6 {
    text-transform: uppercase;
    letter-spacing: 0.04em;
    font-size: 0.72rem;
    color: #60708c;
    margin-bottom: 0.25rem;
}
.stat-card .value {
    font-size: 1.4rem;
    font-weight: 700;
    color: #1c2a4a;
}
.stat-card .hint {
    color: #7083a0;
    font-size: 0.9rem;
}
.filter-surface {
    border: 1px solid #e7eaf3;
    background: linear-gradient(135deg, #f8faff 0%, #ffffff 100%);
    border-radius: 14px;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
}
.filter-label {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-weight: 700;
    color: #1c2a4a;
    text-transform: uppercase;
    letter-spacing: 0.04em;
}
.filter-label i {
    color: #3247c4;
}
.chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: #eef2ff;
    color: #1c2a4a;
    font-weight: 600;
    border: 1px solid #d9defa;
}
.chip i {
    color: #3247c4;
}
.filter-surface.compact {
    padding: 0.75rem 0.9rem;
}
.filter-surface .form-control,
.filter-surface .form-select {
    padding: 0.35rem 0.65rem;
    font-size: 0.9rem;
}
.filter-actions .btn {
    min-width: 110px;
}
</style>
{% endblock %}

{% block content %}
{% set enviados = entries|selectattr("status", "equalto", "Enviado")|list|length %}
{% set pendentes = entries|rejectattr("status", "equalto", "Enviado")|list|length %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 d-flex flex-wrap justify-content-between align-items-center gap-3">
            <div>
                <h1 class="text-primary mb-1">
                    <i class="bi bi-envelope-paper me-2"></i>Comunicados a Clientes
                </h1>
                <p class="text-muted mb-0">Acompanhamento de envio de comunicados aos clientes</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clientAnnouncementModal">
                    <i class="bi bi-plus-lg me-1"></i>Incluir comunicado
                </button>
            </div>
        </div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-sm-6 col-lg-3">
            <div class="stat-card h-100">
                <h6>Total</h6>
                <div class="value">{{ entries|length }}</div>
                <div class="hint">Comunicados listados</div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="stat-card h-100">
                <h6>Aguardando envio</h6>
                <div class="value text-warning">{{ pendentes }}</div>
                <div class="hint">Em fila de envio</div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3">
            <div class="stat-card h-100">
                <h6>Enviados</h6>
                <div class="value text-success">{{ enviados }}</div>
                <div class="hint">Já compartilhados</div>
            </div>
        </div>
        <div class="col-sm-12 col-lg-3">
            <div class="filter-surface compact h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="filter-label"><i class="bi bi-funnel"></i>Filtros</div>
                    <a class="btn btn-link btn-sm text-decoration-none px-0" href="{{ url_for('comunicados_clientes') }}">Limpar</a>
                </div>
                <form method="get" class="row g-2 align-items-end">
                    <div class="col-6">
                        <label class="form-label mb-1" for="startDateFilter">Início</label>
                        <input type="date" class="form-control form-control-sm" id="startDateFilter" name="start_date" value="{{ start_date }}">
                    </div>
                    <div class="col-6">
                        <label class="form-label mb-1" for="endDateFilter">Fim</label>
                        <input type="date" class="form-control form-control-sm" id="endDateFilter" name="end_date" value="{{ end_date }}">
                    </div>
                    {% for value in tributacao_filters %}
                        <input type="hidden" name="tributacao" value="{{ value }}">
                    {% endfor %}
                    <div class="col-12 d-flex gap-2 filter-actions">
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="bi bi-sliders me-1"></i>Aplicar
                        </button>
                    </div>
                    {% if start_date or end_date or tributacao_filters %}
                        <div class="col-12 d-flex flex-wrap gap-2 mt-1">
                            {% if start_date or end_date %}
                                <span class="chip"><i class="bi bi-calendar-event"></i>{{ start_date or 'início' }} → {{ end_date or 'hoje' }}</span>
                            {% endif %}
                            {% for trib in tributacao_filters %}
                                <span class="chip"><i class="bi bi-tag"></i>{{ trib }}</span>
                            {% endfor %}
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <span class="fw-semibold">Historico</span>
            <span class="badge bg-primary">{{ entries|length }}</span>
        </div>
        <div class="table-responsive">
            <table class="table table-striped align-middle mb-0 client-announcements-table">
                <thead class="table-light">
                    <tr>
                        <th style="width: 140px;">Codigo</th>
                        <th>Assunto</th>
                        <th style="width: 170px;">
                            <div class="d-flex align-items-center justify-content-between">
                                <span>Tributacao</span>
                                <div class="dropdown" data-bs-auto-close="outside">
                                    <button class="btn btn-icon-xs {% if tributacao_filters %}btn-primary{% else %}btn-outline-secondary{% endif %}"
                                            type="button"
                                            id="taxRegimeFilterDropdown"
                                            data-bs-toggle="dropdown"
                                            aria-expanded="false"
                                            aria-label="Filtrar por tributacao">
                                        <i class="bi {% if tributacao_filters %}bi-funnel-fill{% else %}bi-funnel{% endif %}"></i>
                                        {% if tributacao_filters %}
                                            <span class="badge bg-light text-dark ms-1">{{ tributacao_filters|length }}</span>
                                        {% endif %}
                                    </button>
                                    <div class="dropdown-menu dropdown-menu-end p-3 shadow-sm" aria-labelledby="taxRegimeFilterDropdown" style="min-width: 240px;">
                                        <form method="GET" class="tributacao-filter-form">
                                            <p class="text-uppercase text-muted fw-semibold small mb-2">Filtrar por tributacao</p>
                                            <input type="hidden" name="start_date" value="{{ start_date }}">
                                            <input type="hidden" name="end_date" value="{{ end_date }}">
                                            <div class="d-flex flex-column gap-1 mb-3">
                                                {% for value, label in form.tax_regime.choices %}
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="tributacao" id="tribFilter{{ loop.index }}" value="{{ value }}" {% if value in tributacao_filters %}checked{% endif %}>
                                                    <label class="form-check-label" for="tribFilter{{ loop.index }}">{{ label }}</label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <a class="btn btn-link btn-sm text-decoration-none px-0 tributacao-filter-clear" href="{{ url_for('comunicados_clientes', clear_tributacao=1, start_date=start_date, end_date=end_date) }}">Limpar</a>
                                                <button type="submit" class="btn btn-primary btn-sm tributacao-filter-apply">Aplicar</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </th>
                        <th style="width: 150px;">Data de envio</th>
                        <th style="width: 160px;">Status</th>
                        <th>Resumo do comunicado</th>
                        <th style="width: 200px;">Anexos</th>
                        <th style="width: 110px;">Acoes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in entries %}
                    <tr>
                        <td class="fw-semibold">{{ item.code or "-" }}</td>
                        <td>{{ item.subject }}</td>
                        <td>
                            {% set trib_class = item.tax_regime.lower() %}
                            <span class="trib-pill {{ 'real' if 'real' in trib_class else 'presumido' if 'presumido' in trib_class else 'simples' if 'simp' in trib_class else 'mei' if 'mei' in trib_class else 'todos' }}">
                                {{ item.tax_regime }}
                            </span>
                        </td>
                        <td>
                            {% if item.send_date %}
                                <span class="badge bg-light text-body border">{{ item.send_date.strftime("%d/%m/%Y") }}</span>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if item.status == "Enviado" %}
                                <span class="status-pill bg-success-subtle text-success"><span class="dot bg-success"></span>Enviado</span>
                            {% else %}
                                <span class="status-pill bg-warning-subtle text-warning"><span class="dot bg-warning"></span>{{ item.status or "Aguardando Envio" }}</span>
                            {% endif %}
                        </td>
                        <td style="white-space: pre-wrap;">{{ item.summary }}</td>
                        <td>
                            {% if item.attachments %}
                                <div class="d-grid gap-1">
                                    {% for attachment in item.attachments %}
                                        <a class="text-decoration-none" href="{{ url_for('static', filename=attachment.file_path) }}" target="_blank" rel="noopener">
                                            <i class="bi {{ attachment.file_type_icon }} me-1"></i>{{ attachment.display_name }}
                                        </a>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#clientAnnouncementEditModal-{{ item.id }}">
                                    Editar
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#clientAnnouncementCloneModal-{{ item.id }}">
                                    Clonar
                                </button>
                                <form method="post" action="{{ url_for('comunicados_clientes_delete', announcement_id=item.id) }}" data-confirm-message="Deseja realmente excluir o comunicado {{ item.code ~ ' - ' ~ item.subject if item.code else item.subject }}?" data-confirm-variant="danger">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        Excluir
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted py-4">
                            <i class="bi bi-inbox fs-3 d-block mb-2"></i>
                            {% if tributacao_filters %}
                                Nenhum comunicado encontrado para a tributacao selecionada.
                            {% else %}
                                Nenhum comunicado registrado.
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="clientAnnouncementModal" tabindex="-1" aria-labelledby="clientAnnouncementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title fs-5" id="clientAnnouncementModalLabel">Registrar comunicado</h2>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="post" class="row g-3" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}
                    <div class="col-lg-3 col-md-6">
                        {{ form.code.label(class="form-label") }}
                        {{ form.code(class="form-control" + (" is-invalid" if form.code.errors else ""), placeholder="Ex: 2025-001") }}
                        {% if form.code.errors %}
                            <div class="invalid-feedback">{{ form.code.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-lg-3 col-md-6">
                        {{ form.status.label(class="form-label") }}
                        {{ form.status(class="form-select" + (" is-invalid" if form.status.errors else "")) }}
                        {% if form.status.errors %}
                            <div class="invalid-feedback">{{ form.status.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-lg-3 col-md-6">
                        {{ form.tax_regime.label(class="form-label") }}
                        {{ form.tax_regime(class="form-select" + (" is-invalid" if form.tax_regime.errors else "")) }}
                        {% if form.tax_regime.errors %}
                            <div class="invalid-feedback">{{ form.tax_regime.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-lg-3 col-md-6">
                        {{ form.send_date.label(class="form-label") }}
                        {{ form.send_date(class="form-control" + (" is-invalid" if form.send_date.errors else "")) }}
                        {% if form.send_date.errors %}
                            <div class="invalid-feedback">{{ form.send_date.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        {{ form.subject.label(class="form-label") }}
                        {{ form.subject(class="form-control" + (" is-invalid" if form.subject.errors else ""), placeholder="Assunto do comunicado") }}
                        {% if form.subject.errors %}
                            <div class="invalid-feedback">{{ form.subject.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        {{ form.summary.label(class="form-label") }}
                        {{ form.summary(class="form-control" + (" is-invalid" if form.summary.errors else ""), placeholder="Resumo do comunicado") }}
                        {% if form.summary.errors %}
                            <div class="invalid-feedback">{{ form.summary.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        {{ form.attachments.label(class="form-label") }}
                        {{ form.attachments(class="form-control" + (" is-invalid" if form.attachments.errors else "")) }}
                        {% if form.attachments.errors %}
                            <div class="invalid-feedback">{{ form.attachments.errors[0] }}</div>
                        {% endif %}
                        <div class="form-text">Formatos aceitos: imagens, PDF, Word, Excel e PowerPoint.</div>
                    </div>
                    <div class="col-12 d-flex justify-content-end">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% for item in entries %}
{% set edit_form = edit_forms.get(item.id) %}
{% if edit_form %}
<div class="modal fade" id="clientAnnouncementEditModal-{{ item.id }}" tabindex="-1" aria-labelledby="clientAnnouncementEditModalLabel-{{ item.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title fs-5" id="clientAnnouncementEditModalLabel-{{ item.id }}">Editar comunicado</h2>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="post" class="row g-3" enctype="multipart/form-data" action="{{ url_for('comunicados_clientes_update', announcement_id=item.id) }}">
                    {{ edit_form.hidden_tag() }}
                    <div class="col-lg-3 col-md-6">
                        {{ edit_form.code.label(class="form-label") }}
                        {{ edit_form.code(class="form-control" + (" is-invalid" if edit_form.code.errors else ""), placeholder="Ex: 2025-001") }}
                        {% if edit_form.code.errors %}
                            <div class="invalid-feedback">{{ edit_form.code.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-lg-3 col-md-6">
                        {{ edit_form.status.label(class="form-label") }}
                        {{ edit_form.status(class="form-select" + (" is-invalid" if edit_form.status.errors else "")) }}
                        {% if edit_form.status.errors %}
                            <div class="invalid-feedback">{{ edit_form.status.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-lg-3 col-md-6">
                        {{ edit_form.tax_regime.label(class="form-label") }}
                        {{ edit_form.tax_regime(class="form-select" + (" is-invalid" if edit_form.tax_regime.errors else "")) }}
                        {% if edit_form.tax_regime.errors %}
                            <div class="invalid-feedback">{{ edit_form.tax_regime.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-lg-3 col-md-6">
                        {{ edit_form.send_date.label(class="form-label") }}
                        {{ edit_form.send_date(class="form-control" + (" is-invalid" if edit_form.send_date.errors else "")) }}
                        {% if edit_form.send_date.errors %}
                            <div class="invalid-feedback">{{ edit_form.send_date.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        {{ edit_form.subject.label(class="form-label") }}
                        {{ edit_form.subject(class="form-control" + (" is-invalid" if edit_form.subject.errors else ""), placeholder="Assunto do comunicado") }}
                        {% if edit_form.subject.errors %}
                            <div class="invalid-feedback">{{ edit_form.subject.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        {{ edit_form.summary.label(class="form-label") }}
                        {{ edit_form.summary(class="form-control" + (" is-invalid" if edit_form.summary.errors else ""), placeholder="Resumo do comunicado") }}
                        {% if edit_form.summary.errors %}
                            <div class="invalid-feedback">{{ edit_form.summary.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        {{ edit_form.attachments.label(class="form-label") }}
                        {{ edit_form.attachments(class="form-control" + (" is-invalid" if edit_form.attachments.errors else "")) }}
                        {% if edit_form.attachments.errors %}
                            <div class="invalid-feedback">{{ edit_form.attachments.errors[0] }}</div>
                        {% endif %}
                        <div class="form-text">Formatos aceitos: imagens, PDF, Word, Excel e PowerPoint.</div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Anexos atuais</label>
                        {% if item.attachments %}
                            <div class="d-grid gap-2">
                                {% for attachment in item.attachments %}
                                    <div class="d-flex align-items-center justify-content-between gap-2 border rounded px-2 py-1">
                                        <a class="text-decoration-none" href="{{ url_for('static', filename=attachment.file_path) }}" target="_blank" rel="noopener">
                                            <i class="bi {{ attachment.file_type_icon }} me-1"></i>{{ attachment.display_name }}
                                        </a>
                                        <div class="form-check mb-0">
                                            <input class="form-check-input" type="checkbox" name="remove_attachment_ids" value="{{ attachment.id }}" id="removeAttachment-{{ item.id }}-{{ loop.index }}">
                                            <label class="form-check-label" for="removeAttachment-{{ item.id }}-{{ loop.index }}">Remover</label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-muted small">Nenhum anexo cadastrado.</div>
                        {% endif %}
                    </div>
                    <div class="col-12 d-flex justify-content-end">
                        {{ edit_form.submit(class="btn btn-primary", value="Salvar alteracoes") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
<div class="modal fade" id="clientAnnouncementCloneModal-{{ item.id }}" tabindex="-1" aria-labelledby="clientAnnouncementCloneModalLabel-{{ item.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title fs-5" id="clientAnnouncementCloneModalLabel-{{ item.id }}">Clonar comunicado</h2>
                    <p class="text-muted mb-0 small">O codigo nao sera copiado.</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="post" class="row g-3" action="{{ url_for('comunicados_clientes_clone', announcement_id=item.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="col-12">
                        <label class="form-label" for="cloneSendDate-{{ item.id }}">Nova data de envio</label>
                        <input type="date" class="form-control" id="cloneSendDate-{{ item.id }}" name="send_date" value="{{ item.send_date.isoformat() if item.send_date else '' }}" required>
                    </div>
                    <div class="col-12 d-flex justify-content-end">
                        <button type="submit" class="btn btn-primary">Clonar comunicado</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block scripts %}
{% if form.errors %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const modalEl = document.getElementById("clientAnnouncementModal");
    if (modalEl && window.bootstrap?.Modal) {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }
});
</script>
{% endif %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("taxRegimeFilterDropdown");
    if (!toggle) return;

    let activeDropdown = null;

    const positionDetachedMenu = (toggleEl, menu) => {
        if (!toggleEl || !menu) return;
        const rect = toggleEl.getBoundingClientRect();
        const menuWidth = menu.offsetWidth || 0;
        const padding = 8;
        let left = rect.left;
        if (menu.classList.contains("dropdown-menu-end")) {
            left = rect.right - menuWidth;
        }
        const maxLeft = Math.max(padding, window.innerWidth - menuWidth - padding);
        left = Math.min(Math.max(left, padding), maxLeft);
        menu.style.position = "fixed";
        menu.style.top = `${rect.bottom + 4}px`;
        menu.style.left = `${left}px`;
        menu.style.zIndex = "2000";
    };

    const detachDropdownMenu = (toggleEl) => {
        const menu = toggleEl?.parentElement?.querySelector(".dropdown-menu");
        if (!menu || menu.dataset.detached === "1") return;
        menu.dataset.detached = "1";
        menu._originalParent = menu.parentNode;
        menu._originalNextSibling = menu.nextSibling;
        document.body.appendChild(menu);
        positionDetachedMenu(toggleEl, menu);
        toggleEl._detachedMenu = menu;
        activeDropdown = toggleEl;
    };

    const restoreDropdownMenu = (toggleEl) => {
        const menu = toggleEl?._detachedMenu;
        if (!menu || menu.dataset.detached !== "1") return;
        if (menu._originalParent) {
            if (menu._originalNextSibling) {
                menu._originalParent.insertBefore(menu, menu._originalNextSibling);
            } else {
                menu._originalParent.appendChild(menu);
            }
        }
        delete menu._originalParent;
        delete menu._originalNextSibling;
        menu.dataset.detached = "";
        menu.style.position = "";
        menu.style.top = "";
        menu.style.left = "";
        menu.style.zIndex = "";
        toggleEl._detachedMenu = null;
        if (activeDropdown === toggleEl) {
            activeDropdown = null;
        }
    };

    if (window.bootstrap?.Dropdown) {
        bootstrap.Dropdown.getOrCreateInstance(toggle, { autoClose: "outside" });
        const dropdownParent = toggle.closest(".dropdown");
        if (dropdownParent) {
            dropdownParent.addEventListener("hide.bs.dropdown", function (event) {
                const clickTarget = event?.clickEvent?.target;
                if (!clickTarget) return;
                const insideForm = clickTarget.closest(".tributacao-filter-form");
                const isApply = clickTarget.closest(".tributacao-filter-apply");
                const isClear = clickTarget.closest(".tributacao-filter-clear");
                if (insideForm && !isApply && !isClear) {
                    event.preventDefault();
                }
            });
        }
        document.querySelectorAll(".tributacao-filter-form .form-check-input").forEach((input) => {
            input.addEventListener("click", (event) => {
                event.stopPropagation();
            });
        });
    }

    toggle.addEventListener("shown.bs.dropdown", () => detachDropdownMenu(toggle));
    toggle.addEventListener("hide.bs.dropdown", () => restoreDropdownMenu(toggle));

    window.addEventListener("resize", () => {
        if (activeDropdown && activeDropdown._detachedMenu) {
            positionDetachedMenu(activeDropdown, activeDropdown._detachedMenu);
        }
    });
    window.addEventListener(
        "scroll",
        () => {
            if (activeDropdown && activeDropdown._detachedMenu) {
                positionDetachedMenu(activeDropdown, activeDropdown._detachedMenu);
            }
        },
        true
    );
});
</script>
{% endblock %}
