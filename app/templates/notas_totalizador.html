{% extends "base.html" %}

{% macro totalizador_accordion(section_id, titulo, dados, pode_ver_pagamento, pagamento_choices, descricao="", filter_value_key="titulo") -%}
<div class="card border-0 shadow-sm mb-3 totalizador-card">
    <div class="card-body d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
        <div>
            <h2 class="h4 mb-0 text-primary">{{ titulo }}</h2>
            {% if descricao %}
            <p class="text-muted small mb-0">{{ descricao }}</p>
            {% endif %}
        </div>
        <span class="badge bg-primary" data-counter-for="#{{ section_id }}">{{ dados|length }}</span>
    </div>
</div>
{% if dados %}
<div class="accordion shadow-sm mb-5 totalizador-accordion" id="{{ section_id }}">
    {% for grupo in dados %}
            <div class="accordion-item"
                 data-totalizador-value="{{ grupo[filter_value_key]|default('') }}"
                 data-totalizador-registros="{{ grupo.qtd_registros }}">
        <h2 class="accordion-header" id="{{ section_id }}Heading{{ loop.index }}">
            <button class="accordion-button collapsed d-flex flex-wrap gap-3" type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#{{ section_id }}Collapse{{ loop.index }}"
                    aria-expanded="false"
                    aria-controls="{{ section_id }}Collapse{{ loop.index }}">
                <span class="fw-semibold text-uppercase flex-grow-1">{{ grupo.titulo }}</span>
                <div class="d-flex align-items-center gap-2 text-muted small totalizador-valor">
                    <span class="text-uppercase">Valor</span>
                    <span class="fw-semibold totalizador-valor-num">{{ grupo.valor_total_formatado }}</span>
                </div>
            </button>
        </h2>
        <div id="{{ section_id }}Collapse{{ loop.index }}" class="accordion-collapse collapse"
             aria-labelledby="{{ section_id }}Heading{{ loop.index }}"
             data-bs-parent="#{{ section_id }}">
            <div class="accordion-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped mb-0 text-start text-nowrap">
                        <thead class="table-light">
                            <tr>
                                <th class="text-start">Data Emissao</th>
                                <th class="text-start">Empresa</th>
                                <th class="text-start">Notas</th>
                                <th class="text-start">Itens</th>
                                <th class="text-start">Valor UN</th>
                                <th class="text-start">Valor Total</th>
                                <th class="text-start">Acordo</th>
                                {% if pode_ver_pagamento %}
                                <th class="text-start">Pagamento</th>
                                {% endif %}
                                <th class="text-start">Observacao</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for nota in grupo.notas %}
                            <tr>
                                <td class="text-start">{{ nota.data_emissao_formatada }}</td>
                                <td class="text-start">{{ nota.empresa }}</td>
                                <td class="text-start">{{ nota.notas }}</td>
                                <td class="text-start">{{ nota.qtde_itens }}</td>
                                <td class="text-start">{{ nota.valor_un_formatado }}</td>
                                <td class="text-start">{{ nota.valor_total_formatado }}</td>
                                <td class="text-start">{{ nota.acordo }}</td>
                                {% if pode_ver_pagamento %}
                                <td class="text-start">
                                    <select
                                        class="form-select form-select-sm nota-forma-pagamento-select"
                                        data-nota-id="{{ nota.id }}"
                                        data-update-url="{{ url_for('notas_debito_update_forma_pagamento', nota_id=nota.id) }}"
                                        data-original-value="{{ nota.forma_pagamento_choice_value }}">
                                        {% for value, label in pagamento_choices %}
                                        <option value="{{ value }}" {% if (nota.forma_pagamento_choice_value or '') == (value or '') %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </td>
                                {% endif %}
                                <td class="text-start">{{ nota.observacao or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="card shadow-sm mb-5">
    <div class="card-body p-4 text-center text-muted">
        Nenhum registro encontrado para o periodo selecionado.
    </div>
</div>
{% endif %}
{%- endmacro %}

{% block title %}Totalizador de Notas{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
.totalizador-tabs .nav-link {
    border-radius: 999px;
    font-weight: 600;
    padding: 0.45rem 1rem;
    color: var(--text-color);
}

.totalizador-tabs .nav-link.active {
    background: var(--primary);
    color: #fff !important;
}

.totalizador-filters {
    background: linear-gradient(120deg, #0f1625, #0c121f);
    border: 1px solid var(--card-border-color);
    border-radius: 14px;
    padding: 1rem 1.25rem;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
}

:root:not([data-theme="dark"]) .totalizador-filters {
    background: #f8f9ff;
    border-color: #e4e7f0;
    box-shadow: 0 16px 30px rgba(15, 34, 75, 0.12);
}

.totalizador-filters .btn {
    border-radius: 10px;
}

.totalizador-card {
    border-radius: 14px;
    box-shadow: 0 18px 42px rgba(0, 0, 0, 0.3);
    border: 1px solid var(--card-border-color);
}

.totalizador-card .card-body {
    background: var(--card-bg);
}

:root[data-theme="dark"] .totalizador-card {
    background: var(--card-bg);
    border-color: var(--card-border-color);
}

.totalizador-accordion.accordion .accordion-item {
    border: none;
    margin-bottom: 0.4rem;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 12px 26px rgba(0, 0, 0, 0.28);
    background: var(--card-bg);
    border: 1px solid var(--card-border-color);
}

.totalizador-accordion .accordion-button {
    background: #ffffff;
    color: #101828;
    border: none;
    padding: 0.85rem 1rem;
    gap: 1rem;
    box-shadow: inset 0 1px 0 rgba(0, 0, 0, 0.02);
}

:root[data-theme="dark"] .totalizador-accordion .accordion-button {
    background: linear-gradient(180deg, #0f1625, #0b1018);
    color: #e8ecf5;
}

.totalizador-accordion .accordion-button.collapsed {
    border-bottom: 1px solid rgba(0, 0, 0, 0.04);
}

:root[data-theme="dark"] .totalizador-accordion .accordion-button.collapsed {
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.totalizador-accordion .accordion-button:focus {
    box-shadow: 0 0 0 0.15rem rgba(5, 88, 197, 0.25);
}

.totalizador-accordion .accordion-button:not(.collapsed) {
    box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.06);
}

.totalizador-accordion .accordion-body {
    background: #ffffff;
}

:root[data-theme="dark"] .totalizador-accordion .accordion-body {
    background: #0b1018;
    border-top: 1px solid rgba(255, 255, 255, 0.04);
}

.totalizador-accordion .table thead th {
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.totalizador-accordion .table-striped > tbody > tr:nth-of-type(odd) {
    --bs-table-accent-bg: rgba(5, 88, 197, 0.04);
}

:root[data-theme="dark"] .totalizador-accordion .table thead th {
    background: #111a2c;
    color: #cfd5e2;
}

:root[data-theme="dark"] .totalizador-accordion .table tbody tr {
    background: #0f1625;
    color: #e8ecf5;
}

:root[data-theme="dark"] .totalizador-accordion .table-striped > tbody > tr:nth-of-type(odd) {
    --bs-table-accent-bg: rgba(92, 124, 250, 0.08);
}

:root[data-theme="dark"] .totalizador-accordion .table-hover > tbody > tr:hover {
    background-color: rgba(92, 124, 250, 0.12);
}

.totalizador-section .card-body label {
    color: #9aa6b5;
}

.totalizador-section select.form-select {
    border-radius: 10px;
}

.totalizador-valor {
    color: #9aa6b5 !important;
}

.totalizador-valor-num {
    color: var(--accent);
}

:root[data-theme="dark"] .totalizador-valor-num {
    color: #ffb066;
}

.totalizador-accordion .accordion-button::after {
    filter: none;
}

:root[data-theme="dark"] .totalizador-accordion .accordion-button::after {
    filter: brightness(1.4);
}
</style>
{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 1400px;">
        <ul class="nav nav-tabs mb-4 totalizador-tabs">
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('cadastro_notas') }}">Cadastros</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('notas_recorrentes') }}">Notas Recorrentes</a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="{{ url_for('notas_totalizador') }}">Totalizador</a>
        </li>
    </ul>

    <div class="mb-4">
            <div class="d-flex flex-column gap-3 totalizador-filters">
                <div class="d-flex flex-column gap-3">
                <div class="d-flex flex-column flex-xl-row gap-3 align-items-xl-center justify-content-between w-100">
                    <div class="d-flex flex-wrap gap-2">
                        <input class="btn-check totalizador-filter-input" type="radio" name="totalizadorFiltro" id="filtroEmpresa" value="empresa" checked>
                        <label class="btn btn-outline-primary btn-sm" for="filtroEmpresa">
                            <i class="bi bi-building me-1"></i>Por empresa
                        </label>

                        <input class="btn-check totalizador-filter-input" type="radio" name="totalizadorFiltro" id="filtroAcordo" value="acordo">
                        <label class="btn btn-outline-primary btn-sm" for="filtroAcordo">
                            <i class="bi bi-diagram-2 me-1"></i>Por tipo de acordo
                        </label>

                        {% if pode_ver_forma_pagamento %}
                        <input class="btn-check totalizador-filter-input" type="radio" name="totalizadorFiltro" id="filtroPagamento" value="pagamento">
                        <label class="btn btn-outline-primary btn-sm" for="filtroPagamento">
                            <i class="bi bi-cash-coin me-1"></i>Por tipo de pagamento
                        </label>
                        {% endif %}
                    </div>
                    <form class="row g-2 align-items-end flex-nowrap ms-xl-auto" method="get" action="{{ url_for('notas_totalizador') }}">
                        <div class="col-auto">
                            <label for="dataInicial" class="form-label mb-0 small text-muted text-uppercase">Data inicial</label>
                            <input type="date" id="dataInicial" name="data_inicial" class="form-control" value="{{ data_inicial }}">
                        </div>
                        <div class="col-auto">
                            <label for="dataFinal" class="form-label mb-0 small text-muted text-uppercase">Data final</label>
                            <input type="date" id="dataFinal" name="data_final" class="form-control" value="{{ data_final }}">
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-funnel me-1"></i>Filtrar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="totalizador-section" data-totalizador-mode="empresa">
        {% if tipos_empresa %}
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <label class="form-label small text-uppercase text-muted mb-2">Empresa</label>
                <select class="form-select form-select-sm totalizador-type-filter" data-target="#totalizadorEmpresaAccordion">
                    <option value="">Todas as empresas</option>
                    {% for tipo in tipos_empresa %}
                    <option value="{{ tipo }}">{{ tipo }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% endif %}
        {{ totalizador_accordion(
            "totalizadorEmpresaAccordion",
            "Totalizador por Empresa",
            dados_totalizador,
            pode_ver_forma_pagamento,
            pagamento_choices
        ) }}
    </div>

    <div class="totalizador-section" data-totalizador-mode="acordo">
        {% if tipos_acordo %}
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <label class="form-label small text-uppercase text-muted mb-2">Tipo de acordo</label>
                <select class="form-select form-select-sm totalizador-type-filter" data-target="#totalizadorAcordoAccordion">
                    <option value="">Todos os acordos</option>
                    {% for tipo in tipos_acordo %}
                    <option value="{{ tipo }}">{{ tipo }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% endif %}
        {{ totalizador_accordion(
            "totalizadorAcordoAccordion",
            "Totalizador por Tipo de Acordo",
            dados_totalizador_acordo,
            pode_ver_forma_pagamento,
            pagamento_choices
        ) }}
    </div>

    {% if pode_ver_forma_pagamento %}
    <div class="totalizador-section" data-totalizador-mode="pagamento">
        {% if tipos_pagamento %}
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body">
                <label class="form-label small text-uppercase text-muted mb-2">Tipo de pagamento</label>
                <select class="form-select form-select-sm totalizador-type-filter" data-target="#totalizadorPagamentoAccordion">
                    <option value="">Todos os pagamentos</option>
                    {% for tipo in tipos_pagamento %}
                    <option value="{{ tipo.value }}">{{ tipo.label or tipo.value }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        {% endif %}
        {{ totalizador_accordion(
            "totalizadorPagamentoAccordion",
            "Totalizador por Tipo de Pagamento",
            dados_totalizador_pagamento,
            pode_ver_forma_pagamento,
            pagamento_choices,
        ) }}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
const csrfToken = "{{ csrf_token() }}";

document.addEventListener('DOMContentLoaded', function() {
    const sections = document.querySelectorAll('.totalizador-section');
    const radios = document.querySelectorAll('.totalizador-filter-input');
    const typeFilters = document.querySelectorAll('.totalizador-type-filter');
    const pagamentoSelects = document.querySelectorAll('.nota-forma-pagamento-select');
    const STORAGE_PREFIX = 'notas_totalizador_';
    const STORAGE_KEYS = {
        mode: `${STORAGE_PREFIX}mode`,
        '#totalizadorEmpresaAccordion': `${STORAGE_PREFIX}empresa_filter`,
        '#totalizadorAcordoAccordion': `${STORAGE_PREFIX}acordo_filter`,
        '#totalizadorPagamentoAccordion': `${STORAGE_PREFIX}pagamento_filter`,
        dataInicial: `${STORAGE_PREFIX}data_inicial`,
        dataFinal: `${STORAGE_PREFIX}data_final`
    };
    const dataInicialInput = document.getElementById('dataInicial');
    const dataFinalInput = document.getElementById('dataFinal');

    const storageAvailable = (() => {
        try {
            const testKey = `${STORAGE_PREFIX}test`;
            localStorage.setItem(testKey, '1');
            localStorage.removeItem(testKey);
            return true;
        } catch (error) {
            console.warn('LocalStorage unavailable, filters will not persist.', error);
            return false;
        }
    })();

    function storageSet(key, value) {
        if (!storageAvailable || !key) {
            return;
        }
        try {
            if (value === null || value === undefined || value === '') {
                localStorage.removeItem(key);
            } else {
                localStorage.setItem(key, value);
            }
        } catch (error) {
            console.warn('Failed to persist totalizador filter.', error);
        }
    }

    function storageGet(key) {
        if (!storageAvailable || !key) {
            return null;
        }
        try {
            const value = localStorage.getItem(key);
            return value === null ? null : value;
        } catch (error) {
            console.warn('Failed to read totalizador filter.', error);
            return null;
        }
    }

    function toggleSavingState(element, isSaving) {
        if (!element) {
            return;
        }
        if (isSaving) {
            element.classList.add('is-saving');
            element.disabled = true;
        } else {
            element.classList.remove('is-saving');
            element.disabled = false;
        }
    }

    function bindPagamentoSelect(select) {
        if (!select) {
            return;
        }
        const initialValue = select.dataset.originalValue || select.value || '';
        select.dataset.originalValue = initialValue;

        select.addEventListener('change', function(event) {
            const target = event.currentTarget;
            const previousValue = target.dataset.originalValue || '';
            const updateUrl = target.dataset.updateUrl;

            if (!updateUrl) {
                return;
            }

            toggleSavingState(target, true);

            fetch(updateUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ forma_pagamento: target.value })
            }).then(function(response) {
                return response.json().catch(function() {
                    return {};
                }).then(function(payload) {
                    if (!response.ok || !payload.success) {
                        const errorMessage = payload && payload.message
                            ? payload.message
                            : 'Nao foi possivel atualizar a forma de pagamento.';
                        const error = new Error(errorMessage);
                        error.payload = payload;
                        throw error;
                    }
                    return payload;
                });
            }).then(function() {
                target.dataset.originalValue = target.value;
                target.classList.add('is-valid');
                setTimeout(function() {
                    target.classList.remove('is-valid');
                }, 1600);
            }).catch(function(error) {
                target.value = previousValue;
                target.dataset.originalValue = previousValue;
                target.classList.add('is-invalid');
                setTimeout(function() {
                    target.classList.remove('is-invalid');
                }, 2000);
                console.error('Falha ao atualizar forma de pagamento', error);
                if (error && error.message) {
                    alert(error.message);
                } else {
                    alert('Falha ao atualizar forma de pagamento.');
                }
            }).finally(function() {
                toggleSavingState(target, false);
            });
        });
    }

    pagamentoSelects.forEach(bindPagamentoSelect);

    function showSection(mode) {
        sections.forEach(section => {
            section.style.display = section.dataset.totalizadorMode === mode ? '' : 'none';
        });
    }

    function getStorageKeyForSelect(select) {
        return STORAGE_KEYS[select.dataset.target] || null;
    }

    function updateCounterForSelector(targetSelector) {
        const target = document.querySelector(targetSelector);
        if (!target) {
            return;
        }
        const counter = document.querySelector(`[data-counter-for="${targetSelector}"]`);
        if (!counter) {
            return;
        }
        const visibleItems = Array.from(target.querySelectorAll('.accordion-item')).filter(item => item.style.display !== 'none');
        const totalRegistros = visibleItems.reduce((sum, item) => {
            const value = Number(item.dataset.totalizadorRegistros || 0);
            return sum + (Number.isFinite(value) ? value : 0);
        }, 0);
        counter.textContent = totalRegistros;
    }

    function applyTypeFilter(select) {
        const targetSelector = select.dataset.target;
        const target = document.querySelector(targetSelector);
        if (!target) {
            return;
        }
        const selectedValue = (select.value || '').toUpperCase();
        target.querySelectorAll('.accordion-item').forEach(item => {
            const itemValue = (item.dataset.totalizadorValue || '').toUpperCase();
            const matches = !selectedValue || itemValue === selectedValue;
            item.style.display = matches ? '' : 'none';
        });

        updateCounterForSelector(targetSelector);
    }

    function updateAllCounters() {
        document.querySelectorAll('[data-counter-for]').forEach(counter => {
            const targetSelector = counter.getAttribute('data-counter-for');
            updateCounterForSelector(targetSelector);
        });
    }

    typeFilters.forEach(select => {
        const storageKey = getStorageKeyForSelect(select);
        const storedValue = storageGet(storageKey);
        if (storedValue !== null) {
            select.value = storedValue;
        }

        select.addEventListener('change', function() {
            storageSet(storageKey, this.value || '');
            applyTypeFilter(this);
        });
        applyTypeFilter(select);
    });

    radios.forEach(radio => {
        if (radio.checked) {
            storageSet(STORAGE_KEYS.mode, radio.value);
        }
        radio.addEventListener('change', function() {
            if (this.checked) {
                showSection(this.value);
                storageSet(STORAGE_KEYS.mode, this.value);
            }
        });
    });

    const savedMode = storageGet(STORAGE_KEYS.mode);
    if (savedMode) {
        const savedRadio = document.querySelector(`.totalizador-filter-input[value="${savedMode}"]`);
        if (savedRadio) {
            savedRadio.checked = true;
            showSection(savedMode);
        }
    } else {
        const initiallyChecked = document.querySelector('.totalizador-filter-input:checked');
        if (initiallyChecked) {
            showSection(initiallyChecked.value);
        }
    }

    function restoreDateFilter(input, storageKey) {
        if (!input) {
            return;
        }
        const storedValue = storageGet(storageKey);
        if (storedValue !== null) {
            input.value = storedValue;
        }
        input.addEventListener('change', function() {
            storageSet(storageKey, this.value || '');
        });
    }

    restoreDateFilter(dataInicialInput, STORAGE_KEYS.dataInicial);
    restoreDateFilter(dataFinalInput, STORAGE_KEYS.dataFinal);

    updateAllCounters();
});
</script>
{% endblock %}
