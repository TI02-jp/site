{% extends "base.html" %}
{% block title %}SALA DE REUNIÕES{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
    .content-breadcrumb { display: none; }
    .content-wrapper { padding: 0; }
    .modal-body { max-height: none; overflow-y: visible; }
    .participant-list { max-height: 160px; overflow-y: auto; }
    #calendar { height: 70vh; }
    .meeting-modal-dialog { max-width: 1200px; }
    .event-details-modal { max-width: 960px; width: calc(100% - 2rem); }
    .event-details-modal .modal-header,
    .event-details-modal .modal-body,
    .event-details-modal .modal-footer { padding-left: 1.25rem; padding-right: 1.25rem; }
    .event-details-modal .modal-header { padding-top: 0.85rem; padding-bottom: 0.7rem; }
    .event-details-modal .modal-title { font-size: 1.1rem; }
    .event-details-modal .modal-body {
        padding-top: 0.9rem;
        padding-bottom: 0.9rem;
        font-size: 0.92rem;
        line-height: 1.4;
    }
    .event-details-modal .modal-footer { padding-top: 0.7rem; padding-bottom: 0.75rem; }
    .event-details-modal .detail-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.6rem;
        margin-bottom: 0.6rem;
    }
    .event-details-modal .detail-item {
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        padding: 0.5rem 0.7rem;
        background-color: #fff;
        min-height: 0;
    }
    .event-details-modal .detail-item.detail-full { grid-column: 1 / -1; }
    .event-details-modal .detail-label {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #6c757d;
        margin-bottom: 0.2rem;
    }
    .event-details-modal .detail-value {
        font-size: 0.9rem;
        color: #212529;
        word-break: break-word;
    }
    .event-details-modal #detailParticipants { white-space: normal; }
    .event-details-modal #meetLinkContainer,
    .event-details-modal #meetConfigSummary,
    .event-details-modal #statusControls {
        margin-top: 0.65rem;
        border-radius: 0.55rem;
        padding: 0.7rem 0.85rem;
        font-size: 0.9rem;
    }
    .event-details-modal #meetLinkContainer {
        gap: 0.45rem;
        font-size: 0.9rem;
    }
    .event-details-modal #meetLinkContainer i { font-size: 1rem; color: #0d6efd; }
    .event-details-modal #meetLinkContainer .btn,
    .event-details-modal #statusControls .btn {
        padding: 0.45rem 0.85rem;
        font-size: 0.9rem;
    }
    .event-details-modal #meetConfigSummary .fw-semibold {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 0.35rem;
    }
    .event-details-modal #meetConfigSummaryList li { margin-bottom: 0.25rem; }
    .event-details-modal #statusControls label {
        font-size: 0.82rem;
        margin-bottom: 0.35rem;
    }
    .event-details-modal #postponeNotifyWrapper {
        margin-top: 0.35rem;
    }
    .event-details-modal #statusControls .row { margin-left: -0.35rem; margin-right: -0.35rem; }
    .event-details-modal #statusControls .row > [class*='col-'] {
        padding-left: 0.35rem;
        padding-right: 0.35rem;
    }
    .event-details-modal #statusControls .form-select,
    .event-details-modal #statusControls .form-control {
        font-size: 0.9rem;
        padding: 0.4rem 0.65rem;
    }
    .event-details-modal #statusControls .form-label { margin-bottom: 0.3rem; }
    .event-details-modal #statusControls #statusError { margin-top: 0.5rem; }
    .meeting-modal-dialog .modal-header,
    .meeting-modal-dialog .modal-body,
    .meeting-modal-dialog .modal-footer { padding-left: 1.25rem; padding-right: 1.25rem; }
    .meeting-modal-dialog .modal-header { padding-top: 1.1rem; padding-bottom: 0.9rem; }
    .meeting-modal-dialog .modal-body { font-size: var(--font-base); padding-top: 1.1rem; padding-bottom: 1rem; }
    .meeting-modal-dialog .modal-footer { padding-top: 0.9rem; padding-bottom: 0.9rem; }
    .meeting-modal-dialog label,
    .meeting-modal-dialog .form-check-label,
    .meeting-modal-dialog .form-control,
    .meeting-modal-dialog .form-select,
    .meeting-modal-dialog .form-check-input,
    .meeting-modal-dialog .btn,
    .meeting-modal-dialog .input-group-text { font-size: var(--font-base); }
    .meeting-modal-dialog .modal-title { font-size: var(--font-xl); }
    .meeting-modal-dialog .form-control,
    .meeting-modal-dialog .form-select,
    .meeting-modal-dialog .input-group-text { padding: 0.35rem 0.6rem; }
    .meeting-modal-dialog textarea.form-control { min-height: 5rem; }
    .meeting-modal-dialog .form-check { margin-bottom: 0.25rem; }
    .meeting-modal-dialog .form-check .form-check-label { line-height: 1.2; }
    .meeting-modal-dialog .modal-body .row { margin-left: -0.35rem; margin-right: -0.35rem; }
    .meeting-modal-dialog .modal-body .col-md-6,
    .meeting-modal-dialog .modal-body .mb-3 { padding-left: 0.35rem; padding-right: 0.35rem; }
    .meeting-modal-dialog .meeting-options { gap: 1.25rem; flex-wrap: wrap; }
    .meeting-modal-dialog .meeting-options .form-check {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 0;
    }
    .meeting-modal-dialog .meeting-options .form-check-input { margin-top: 0; }
    .meeting-modal-dialog .additional-dates-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .meeting-modal-dialog .additional-date-item {
        flex: 0 0 auto;
    }
    .meeting-modal-dialog .additional-date-group {
        min-width: 190px;
    }
    .meeting-modal-dialog .modal-content {
        position: relative;
        overflow: hidden;
    }
    .meeting-modal-overlay {
        position: absolute;
        inset: 0;
        background: rgba(33, 37, 41, 0.58);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        z-index: 30;
        backdrop-filter: blur(1.5px);
        cursor: wait;
    }
    .meeting-modal-overlay.d-none {
        display: none !important;
    }
    .meeting-modal-overlay__alert {
        width: min(420px, 100%);
        box-shadow: 0 0.75rem 2rem rgba(15, 23, 42, 0.35);
    }
    .meeting-modal-overlay__alert .spinner-border {
        width: 2.5rem;
        height: 2.5rem;
    }
    .meeting-modal-overlay__message {
        font-size: 0.95rem;
        margin-bottom: 0;
    }
    </style>
{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}
{% block content %}
    <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Calendário de Agendamentos</h2>
                <div>
                    <button id="openMeetingModal" class="btn btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#meetingModal">Agendar Reunião</button>
                </div>
            </div>
            <div class="mb-3">
                <span class="badge bg-primary me-2">Agendada</span>
                <span class="badge bg-warning text-dark me-2">Em Andamento</span>
                <span class="badge bg-success me-2">Realizada</span>
                <span class="badge bg-secondary me-2">Adiada</span>
                <span class="badge bg-danger">Cancelada</span>
            </div>
            <div id="calendar"></div>
            <div class="modal fade" id="meetingModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-xl meeting-modal-dialog">
                    <div class="modal-content">
                        <div
                            class="meeting-modal-overlay d-none"
                            id="meetingCreationOverlay"
                            aria-hidden="true"
                            role="status"
                            aria-live="polite"
                        >
                            <div class="meeting-modal-overlay__alert alert alert-info mb-0">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="spinner-border text-info" role="presentation" aria-hidden="true"></div>
                                    <div>
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <i class="bi bi-info-circle-fill fs-5" aria-hidden="true"></i>
                                            <span class="fw-semibold">Estamos criando sua reunião</span>
                                        </div>
                                        <p class="meeting-modal-overlay__message mb-0">
                                            Aguarde alguns instantes enquanto finalizamos o agendamento.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-header align-items-start">
                            <h5 class="modal-title">Agendar Reunião</h5>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <form method="post">
                            <div class="modal-body text-start">
                                {{ form.csrf_token }}
                                {{ form.meeting_id(id='meeting_id') }}
                                {{ form.course_id(id='meeting_course_id') }}
                                <div class="row">
                                    <div class="mb-3 col-md-6">
                                        {{ form.participants.label(class="form-label") }}
                                        <div class="participant-list border rounded p-2">
                                            {% for subfield in form.participants %}
                                                <div class="form-check">
                                                    {{ subfield(class="form-check-input", id=subfield.id) }}
                                                    <label class="form-check-label" for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        {% if form.participants.errors %}<div class="text-danger">{{ form.participants.errors[0] }}</div>{% endif %}
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.date.label(class="form-label") }}
                                            {{ form.date(class="form-control", type="date", id="meeting_date", min=today_date) }}
                                            <div class="form-text">Data não pode ser no passado</div>
                                        </div>
                                        <div class="mb-3">
                                            {{ form.start_time.label(class="form-label") }}
                                            {{ form.start_time(class="form-control", type="time", id="meeting_start_time") }}
                                        </div>
                                        <div class="mb-3">
                                            {{ form.end_time.label(class="form-label") }}
                                            {{ form.end_time(class="form-control", type="time", id="meeting_end_time") }}
                                            <div class="form-text">Término deve ser após o início</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3 mb-1">
                                    <div class="col-lg-6">
                                        {{ form.subject.label(class="form-label mb-1") }}
                                        {{ form.subject(class="form-control") }}
                                    </div>
                                    <div class="col-lg-6">
                                        {{ form.description.label(class="form-label mb-1") }}
                                        {{ form.description(class="form-control", rows=2) }}
                                    </div>
                                </div>
                                <div class="meeting-options d-flex flex-wrap align-items-center mb-3">
                                    <div class="form-check form-check-inline">
                                        {{ form.create_meet(class="form-check-input", id="create_meet") }}
                                        <label class="form-check-label" for="create_meet">{{ form.create_meet.label.text }}</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        {{ form.notify_attendees(class="form-check-input", id="notify_attendees") }}
                                        <label class="form-check-label" for="notify_attendees">{{ form.notify_attendees.label.text }}</label>
                                    </div>
                                </div>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        {{ form.recorrencia_tipo.label(class="form-label") }}
                                        {{ form.recorrencia_tipo(class="form-select", id="recorrencia_tipo") }}
                                        {% if form.recorrencia_tipo.errors %}
                                            <div class="text-danger small mt-1">{{ form.recorrencia_tipo.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 d-none" id="recorrenciaFimWrapper">
                                        {{ form.recorrencia_fim.label(class="form-label") }}
                                        {{ form.recorrencia_fim(class="form-control", type="date", id="recorrencia_fim", min=today_date) }}
                                        {% if form.recorrencia_fim.errors %}
                                            <div class="text-danger small mt-1">{{ form.recorrencia_fim.errors[0] }}</div>
                                        {% endif %}
                                        <div class="form-text">Data final da recorrência</div>
                                    </div>
                                </div>
                                <div class="mb-3 d-none" id="recorrenciaDiasWrapper">
                                    {{ form.recorrencia_dias_semana.label(class="form-label") }}
                                    <div class="border rounded p-2" style="max-height: 140px; overflow-y: auto;">
                                        {% for subfield in form.recorrencia_dias_semana %}
                                            <div class="form-check">
                                                {{ subfield(class="form-check-input", id=subfield.id) }}
                                                <label class="form-check-label" for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    {% if form.recorrencia_dias_semana.errors %}
                                        <div class="text-danger small mt-1">{{ form.recorrencia_dias_semana.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                {{ form.submit(class="btn btn-primary", id="meetingSubmitButton") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal fade"
                 id="eventDetailsModal"
                 tabindex="-1"
                 aria-hidden="true">
                <div class="modal-dialog event-details-modal">
                    <div class="modal-content">
                        <div class="modal-header align-items-start">
                            <div class="flex-grow-1">
                                <div id="detailCreator" class="text-muted small d-none mb-1"></div>
                                <h5 class="modal-title mb-0" id="detailTitle"></h5>
                            </div>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-start">
                            <div class="detail-summary">
                                <div class="detail-item">
                                    <div class="detail-label">Data</div>
                                    <div class="detail-value" id="detailDate"></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Hora</div>
                                    <div class="detail-value"><span id="detailStart"></span> - <span id="detailEnd"></span></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Status</div>
                                    <div class="detail-value" id="detailStatus"></div>
                                </div>
                                <div class="detail-item detail-full d-none" id="detailMeetHostRow">
                                    <div class="detail-label">Proprietário do Meet</div>
                                    <div class="detail-value" id="detailMeetHost"></div>
                                </div>
                                <div class="detail-item detail-full">
                                    <div class="detail-label">Participantes</div>
                                    <div class="detail-value" id="detailParticipants"></div>
                                </div>
                            </div>
                            <div id="meetLinkContainer" class="bg-light border rounded p-2 d-flex align-items-center gap-2 mt-3 d-none">
                                <i class="bi bi-camera-video"></i>
                                <a id="detailMeetLink" href="#" target="_blank" class="text-decoration-none flex-grow-1"></a>
                                <button type="button" id="copyMeetLink" class="btn btn-sm btn-outline-secondary" title="Copiar convite formatado"><i class="bi bi-envelope"></i> Copiar convite</button>
                            </div>
                            <div id="meetConfigSummary" class="bg-light border rounded p-3 mt-3 d-none">
                                <div class="fw-semibold mb-2">Configurações do Meet</div>
                                <ul class="list-unstyled mb-0 small" id="meetConfigSummaryList"></ul>
                            </div>
                            <div id="pautasSection" class="mt-3 d-none">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">Pautas</h6>
                                    <div class="d-flex align-items-center gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary d-none" id="cancelPautasBtn">Cancelar</button>
                                        <button type="button" class="btn btn-sm btn-primary d-none" id="savePautasBtn">
                                            <span id="pautasSpinner" class="spinner-border spinner-border-sm align-middle me-1 d-none" role="status" aria-hidden="true"></span>
                                            <span class="align-middle">Salvar</span>
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary d-none" id="editPautasBtn">Adicionar pautas</button>
                                    </div>
                                </div>
                                <div id="pautasDisplay" class="border rounded p-3 bg-light text-break small"></div>
                                <textarea id="pautasTextarea" class="form-control d-none mt-2" rows="5" placeholder="Registre os principais pontos discutidos."></textarea>
                                <div class="text-danger small mt-2 d-none" id="pautasError"></div>
                            </div>
                            <div id="statusControls" class="bg-light border rounded mt-3 d-none">
                                <div class="row g-2 align-items-end">
                                    <div class="col-sm-6 col-lg-4">
                                        <label for="statusSelect" class="form-label">Atualizar status</label>
                                        <select id="statusSelect" class="form-select"></select>
                                    </div>
                                    <div class="col-sm-6 col-lg-6 d-none" id="postponeFields">
                                        <div class="row g-2">
                                            <div class="col-12 col-md-4">
                                                <label for="postponeDate" class="form-label">Nova data</label>
                                                <input type="date" class="form-control" id="postponeDate" min="{{ today_date }}">
                                            </div>
                                            <div class="col-6 col-md-4">
                                                <label for="postponeStart" class="form-label">Início</label>
                                                <input type="time" class="form-control" id="postponeStart">
                                            </div>
                                            <div class="col-6 col-md-4">
                                                <label for="postponeEnd" class="form-label">Fim</label>
                                                <input type="time" class="form-control" id="postponeEnd">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 col-lg-2 text-sm-end d-flex justify-content-sm-end">
                                        <button type="button" class="btn btn-primary w-100 w-sm-auto" id="saveStatusBtn">
                                            <span id="statusSpinner" class="spinner-border spinner-border-sm align-middle me-2 d-none" role="status" aria-hidden="true"></span>
                                            <span class="align-middle">Salvar status</span>
                                        </button>
                                    </div>
                                </div>
                                <div id="postponeNotifyWrapper" class="d-none">
                                    <div class="form-check mb-0">
                                        <input class="form-check-input" type="checkbox" id="postponeNotifyAttendees">
                                        <label class="form-check-label" for="postponeNotifyAttendees">
                                            Enviar e-mail aos participantes com o novo status da reunião.
                                        </label>
                                    </div>
                                </div>
                                <div class="text-danger small d-none" id="statusError"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <form id="deleteMeetingForm" method="post" class="d-none">
                                {{ form.csrf_token(id='csrf_token_delete') }}
                            </form>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            <button type="button" class="btn btn-outline-primary d-none" id="configureMeetBtn"><i class="bi bi-sliders me-1"></i>Configurar Meet</button>
                            <button type="button" class="btn btn-primary d-none" id="editEventBtn">Editar</button>
                            <button type="button" class="btn btn-danger d-none" id="deleteEventBtn">Excluir</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal fade" id="meetConfigModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <div>
                                <h5 class="modal-title">Configurar sala do Google Meet</h5>
                                <div class="text-muted small" id="meetConfigSubtitle"></div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <form id="meetConfigForm" method="post" data-action-template="{{ url_for('configure_meet_call', meeting_id=0) }}">
                            <div class="modal-body text-start">
                                {{ meet_config_form.csrf_token }}
                                {{ meet_config_form.meeting_id(id='meet_config_meeting_id') }}
                                <div class="alert alert-danger d-none" id="meetConfigError"></div>
                                <div class="mb-3">
                                    {{ meet_config_form.host_id.label(class="form-label") }}
                                    {{ meet_config_form.host_id(class="form-select", id='meetConfigHost') }}
                                    <div class="invalid-feedback" id="meetConfigHostError"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" for="meetConfigLink">Link da reunião</label>
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="bi bi-camera-video"></i></span>
                                        <input type="text" class="form-control" id="meetConfigLink" readonly>
                                        <button type="button" class="btn btn-outline-secondary" id="copyMeetConfigLink"><i class="bi bi-clipboard"></i></button>
                                        <a class="btn btn-success" id="openMeetConfigLink" href="#" target="_blank" rel="noopener">
                                            <i class="bi bi-camera-video-fill me-1"></i>Abrir Meet
                                        </a>
                                    </div>
                                </div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            {{ meet_config_form.quick_access_enabled(class="form-check-input", id='quick_access_enabled') }}
                                            <label class="form-check-label" for="quick_access_enabled">{{ meet_config_form.quick_access_enabled.label.text }}</label>
                                            <div class="form-text">Permite que os convidados entrem sem solicitar acesso.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            {{ meet_config_form.mute_on_join(class="form-check-input", id='mute_on_join') }}
                                            <label class="form-check-label" for="mute_on_join">{{ meet_config_form.mute_on_join.label.text }}</label>
                                            <div class="form-text">Os participantes entram com o microfone desligado.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            {{ meet_config_form.allow_chat(class="form-check-input", id='allow_chat') }}
                                            <label class="form-check-label" for="allow_chat">{{ meet_config_form.allow_chat.label.text }}</label>
                                            <div class="form-text">Define se o chat da reunião fica disponível.</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check form-switch">
                                            {{ meet_config_form.allow_screen_share(class="form-check-input", id='allow_screen_share') }}
                                            <label class="form-check-label" for="allow_screen_share">{{ meet_config_form.allow_screen_share.label.text }}</label>
                                            <div class="form-text">Controla se convidados podem compartilhar a tela.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                {{ meet_config_form.submit(class="btn btn-primary", id='meetConfigSubmit') }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
    </div>
    <style>
@import url('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/main.min.css');
.tooltip-primary .tooltip-inner{background-color:#0d6efd;color:#fff;}
.tooltip-warning .tooltip-inner{background-color:#ffc107;color:#000;}
.tooltip-success .tooltip-inner{background-color:#198754;color:#fff;}
.tooltip-secondary .tooltip-inner{background-color:#6c757d;color:#fff;}
.tooltip-danger .tooltip-inner{background-color:#dc3545;color:#fff;}
.tooltip-primary .tooltip-arrow::before{border-top-color:#0d6efd;border-bottom-color:#0d6efd;border-left-color:#0d6efd;border-right-color:#0d6efd;}
.tooltip-warning .tooltip-arrow::before{border-top-color:#ffc107;border-bottom-color:#ffc107;border-left-color:#ffc107;border-right-color:#ffc107;}
.tooltip-success .tooltip-arrow::before{border-top-color:#198754;border-bottom-color:#198754;border-left-color:#198754;border-right-color:#198754;}
.tooltip-secondary .tooltip-arrow::before{border-top-color:#6c757d;border-bottom-color:#6c757d;border-left-color:#6c757d;border-right-color:#6c757d;}
.tooltip-danger .tooltip-arrow::before{border-top-color:#dc3545;border-bottom-color:#dc3545;border-left-color:#dc3545;border-right-color:#dc3545;}
.fc-daygrid-dot-event{display:flex;align-items:center;padding:0;border:none;background:none;}
.fc-daygrid-dot-event .fc-event-dot{width:14px;height:14px;border-radius:50%;margin-right:4px;border:none;}
    </style>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/multimonth/index.global.min.js"></script>
    <script>
    function showFlashMessage(message, category = 'success') {
        let container = document.querySelector('.flash-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'flash-container';
            document.body.appendChild(container);
        }
        const icon = category === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${category} alert-dismissible fade show`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `<i class="bi bi-${icon} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>`;
        container.appendChild(alertDiv);
        setTimeout(() => {
            bootstrap.Alert.getOrCreateInstance(alertDiv).close();
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
    var currentEvent;
    var currentMeetConfig;
    var calendarEl = document.getElementById('calendar');
    var recorrenciaTipoSelect = document.getElementById('recorrencia_tipo');
    var recorrenciaFimWrapper = document.getElementById('recorrenciaFimWrapper');
    var recorrenciaDiasWrapper = document.getElementById('recorrenciaDiasWrapper');

    // Controlar visibilidade dos campos de recorrência
    function toggleRecurrenceFields() {
        if (!recorrenciaTipoSelect || !recorrenciaFimWrapper) {
            return;
        }
        var tipoValue = recorrenciaTipoSelect.value;

        // Mostrar campo "Repetir até" se não for NENHUMA
        if (tipoValue && tipoValue !== 'NENHUMA') {
            recorrenciaFimWrapper.classList.remove('d-none');
        } else {
            recorrenciaFimWrapper.classList.add('d-none');
        }

        // Mostrar seleção de dias da semana apenas para recorrência semanal
        if (recorrenciaDiasWrapper) {
            if (tipoValue === 'SEMANAL') {
                recorrenciaDiasWrapper.classList.remove('d-none');
            } else {
                recorrenciaDiasWrapper.classList.add('d-none');
            }
        }
    }

    // Adicionar listener para mudanças no select de recorrência
    if (recorrenciaTipoSelect) {
        recorrenciaTipoSelect.addEventListener('change', toggleRecurrenceFields);
        toggleRecurrenceFields(); // Inicializar no carregamento
    }

    // Validação de horários: término deve ser após início
    var meetingStartTime = document.getElementById('meeting_start_time');
    var meetingEndTime = document.getElementById('meeting_end_time');

    function validateMeetingTimes() {
        if (!meetingStartTime || !meetingEndTime) return true;

        var start = meetingStartTime.value;
        var end = meetingEndTime.value;

        if (start && end && end <= start) {
            meetingEndTime.setCustomValidity('O horário de término deve ser posterior ao de início');
            return false;
        } else {
            meetingEndTime.setCustomValidity('');
            return true;
        }
    }

    if (meetingStartTime && meetingEndTime) {
        meetingStartTime.addEventListener('change', validateMeetingTimes);
        meetingEndTime.addEventListener('change', validateMeetingTimes);
    }

    var applyMoreDaysCheckbox = document.getElementById('apply_more_days');
    var additionalDatesWrapper = document.getElementById('additionalDatesWrapper');
    var additionalDatesContainer = document.getElementById('additionalDatesContainer');
    var addAdditionalDateBtn = document.getElementById('addAdditionalDateBtn');
    var meetConfigModalEl = document.getElementById('meetConfigModal');
    var meetConfigForm = document.getElementById('meetConfigForm');
    var meetConfigMeetingIdInput = document.getElementById('meet_config_meeting_id');
    var meetConfigHostSelect = document.getElementById('meetConfigHost');
    var meetConfigHostError = document.getElementById('meetConfigHostError');
    var meetConfigError = document.getElementById('meetConfigError');
    var meetConfigLinkInput = document.getElementById('meetConfigLink');
    var meetConfigCopyBtn = document.getElementById('copyMeetConfigLink');
    var meetConfigOpenBtn = document.getElementById('openMeetConfigLink');
    var meetConfigSubtitle = document.getElementById('meetConfigSubtitle');
    var meetConfigSubmitBtn = document.getElementById('meetConfigSubmit');
    var configureMeetBtn = document.getElementById('configureMeetBtn');
    var detailMeetHostRow = document.getElementById('detailMeetHostRow');
    var detailMeetHost = document.getElementById('detailMeetHost');
    var meetConfigSummary = document.getElementById('meetConfigSummary');
    var meetConfigSummaryList = document.getElementById('meetConfigSummaryList');
    var meetPopupData = {{ meet_popup_data|tojson|safe if meet_popup_data else 'null' }};
    var meetingStatusOptions = {{ meeting_status_options|tojson|safe }} || [];
    var rescheduleStatuses = {{ reschedule_statuses|tojson|safe }} || [];
    var statusOptionsPopulated = false;
    var detailTitle = document.getElementById('detailTitle');
    var detailCreator = document.getElementById('detailCreator');
    var detailDate = document.getElementById('detailDate');
    var detailStart = document.getElementById('detailStart');
    var detailEnd = document.getElementById('detailEnd');
    var detailParticipants = document.getElementById('detailParticipants');
    var detailStatus = document.getElementById('detailStatus');
    var meetLinkContainer = document.getElementById('meetLinkContainer');
    var detailMeetLink = document.getElementById('detailMeetLink');
    var pautasSection = document.getElementById('pautasSection');
    var pautasDisplay = document.getElementById('pautasDisplay');
    var pautasTextarea = document.getElementById('pautasTextarea');
    var pautasError = document.getElementById('pautasError');
    var editPautasBtn = document.getElementById('editPautasBtn');
    var savePautasBtn = document.getElementById('savePautasBtn');
    var cancelPautasBtn = document.getElementById('cancelPautasBtn');
    var pautasSpinner = document.getElementById('pautasSpinner');
    var copyMeetLink = document.getElementById('copyMeetLink');
    var statusesDisablingMeetLink = ['REALIZADA', 'CANCELADA'];
    var statusControls = document.getElementById('statusControls');
    var statusSelect = document.getElementById('statusSelect');
    var postponeFields = document.getElementById('postponeFields');
    var postponeDateInput = document.getElementById('postponeDate');
    var postponeStartInput = document.getElementById('postponeStart');
    var postponeEndInput = document.getElementById('postponeEnd');
    var postponeNotifyWrapper = document.getElementById('postponeNotifyWrapper');
    var postponeNotifyCheckbox = document.getElementById('postponeNotifyAttendees');
    var statusError = document.getElementById('statusError');
    var saveStatusBtn = document.getElementById('saveStatusBtn');
    var statusSpinner = document.getElementById('statusSpinner');
    var isStatusEditing = false;
    var isEditingPautas = false;
    var editEventBtn = document.getElementById('editEventBtn');
    var deleteEventBtn = document.getElementById('deleteEventBtn');
    var deleteMeetingForm = document.getElementById('deleteMeetingForm');
    var eventDetailsModalEl = document.getElementById('eventDetailsModal');
    var eventDetailsModalInstance = null;
    var meetingModalEl = document.getElementById('meetingModal');
    var meetingFormEl = meetingModalEl ? meetingModalEl.querySelector('form') : null;
    var meetingOverlayEl = document.getElementById('meetingCreationOverlay');
    var meetingSubmitButton = document.getElementById('meetingSubmitButton');
    var meetingIdInput = document.getElementById('meeting_id');

    function hideMeetingCreationOverlay() {
        if (meetingOverlayEl) {
            meetingOverlayEl.classList.add('d-none');
            meetingOverlayEl.setAttribute('aria-hidden', 'true');
        }
        if (meetingSubmitButton) {
            meetingSubmitButton.disabled = false;
            if (meetingSubmitButton.dataset.originalLabel !== undefined) {
                meetingSubmitButton.value = meetingSubmitButton.dataset.originalLabel;
                delete meetingSubmitButton.dataset.originalLabel;
            }
        }
    }

    function showMeetingCreationOverlay() {
        if (meetingOverlayEl) {
            meetingOverlayEl.classList.remove('d-none');
            meetingOverlayEl.setAttribute('aria-hidden', 'false');
        }
        if (meetingSubmitButton) {
            meetingSubmitButton.dataset.originalLabel = meetingSubmitButton.value || '';
            meetingSubmitButton.value = 'Agendando...';
            meetingSubmitButton.disabled = true;
        }
    }

    if (meetingModalEl) {
        meetingModalEl.addEventListener('show.bs.modal', function() {
            hideMeetingCreationOverlay();
        });
        meetingModalEl.addEventListener('hidden.bs.modal', function() {
            hideMeetingCreationOverlay();
        });
    }

    if (meetingFormEl) {
        meetingFormEl.addEventListener('submit', function() {
            if (meetingIdInput && meetingIdInput.value) {
                return;
            }
            showMeetingCreationOverlay();
        });
    }

    function getMeetConfigModal() {
        if (!meetConfigModalEl) {
            return null;
        }
        return bootstrap.Modal.getOrCreateInstance(meetConfigModalEl);
    }

    function resetMeetConfigFeedback() {
        if (meetConfigHostSelect) {
            meetConfigHostSelect.classList.remove('is-invalid');
        }
        if (meetConfigHostError) {
            meetConfigHostError.textContent = '';
        }
        if (meetConfigError) {
            meetConfigError.classList.add('d-none');
            meetConfigError.textContent = '';
        }
    }

    function populateMeetConfigForm(config) {
        if (!meetConfigForm || !config) {
            return;
        }
        currentMeetConfig = config;
        resetMeetConfigFeedback();
        if (meetConfigSubtitle) {
            meetConfigSubtitle.textContent = config.subject ? `Reunião: ${config.subject}` : '';
        }
        if (meetConfigMeetingIdInput) {
            meetConfigMeetingIdInput.value = config.meeting_id || '';
        }
        var actionTemplate = meetConfigForm.dataset.actionTemplate || '';
        if (actionTemplate) {
            if (actionTemplate.includes('/0/')) {
                meetConfigForm.action = actionTemplate.replace('/0/', '/' + config.meeting_id + '/');
            } else {
                meetConfigForm.action = actionTemplate.replace(/0$/, String(config.meeting_id));
            }
        }
        if (meetConfigHostSelect) {
            meetConfigHostSelect.innerHTML = '';
            var placeholderOption = document.createElement('option');
            placeholderOption.value = '';
            placeholderOption.textContent = 'Selecione um participante';
            placeholderOption.disabled = true;
            if (config.current_host_id === null || typeof config.current_host_id === 'undefined') {
                placeholderOption.selected = true;
            }
            meetConfigHostSelect.appendChild(placeholderOption);
            (config.host_candidates || []).forEach(function(entry) {
                var option = document.createElement('option');
                option.value = String(entry.id);
                option.textContent = entry.name || entry.username || entry.email || `ID ${entry.id}`;
                meetConfigHostSelect.appendChild(option);
            });
            if (config.current_host_id !== null && typeof config.current_host_id !== 'undefined') {
                meetConfigHostSelect.value = String(config.current_host_id);
            }
            meetConfigHostSelect.disabled = config.can_configure === false;
        }
        var settings = config.meet_settings || {};
        if (meetConfigForm.quick_access_enabled) {
            meetConfigForm.quick_access_enabled.checked = !!settings.quick_access_enabled;
            meetConfigForm.quick_access_enabled.disabled = config.can_configure === false;
        }
        if (meetConfigForm.mute_on_join) {
            meetConfigForm.mute_on_join.checked = !!settings.mute_on_join;
            meetConfigForm.mute_on_join.disabled = config.can_configure === false;
        }
        if (meetConfigForm.allow_chat) {
            meetConfigForm.allow_chat.checked = !!settings.allow_chat;
            meetConfigForm.allow_chat.disabled = config.can_configure === false;
        }
        if (meetConfigForm.allow_screen_share) {
            meetConfigForm.allow_screen_share.checked = !!settings.allow_screen_share;
            meetConfigForm.allow_screen_share.disabled = config.can_configure === false;
        }
        if (meetConfigLinkInput) {
            meetConfigLinkInput.value = config.meet_link || '';
        }
        if (meetConfigOpenBtn) {
            if (config.meet_link) {
                meetConfigOpenBtn.href = config.meet_link;
                meetConfigOpenBtn.classList.remove('disabled');
            } else {
                meetConfigOpenBtn.href = '#';
                meetConfigOpenBtn.classList.add('disabled');
            }
        }
        if (meetConfigSubmitBtn) {
            meetConfigSubmitBtn.disabled = config.can_configure === false;
        }
    }

    function openMeetConfiguration(config) {
        if (!config) {
            return;
        }
        populateMeetConfigForm(config);
        var modalInstance = getMeetConfigModal();
        if (modalInstance) {
            modalInstance.show();
        }
    }

    function updateMeetDetails(event) {
        if (!event) {
            return;
        }
        if (detailMeetHost && detailMeetHostRow) {
            var hostName = event.extendedProps.meet_host_name || event.extendedProps.creator || '';
            if (hostName && event.extendedProps.meet_link) {
                detailMeetHost.textContent = hostName;
                detailMeetHostRow.classList.remove('d-none');
            } else {
                detailMeetHost.textContent = '';
                detailMeetHostRow.classList.add('d-none');
            }
        }
        if (meetConfigSummary && meetConfigSummaryList) {
            meetConfigSummaryList.innerHTML = '';
            if (event.extendedProps.meet_link) {
                var settings = event.extendedProps.meet_settings || {};
                var summaryItems = describeMeetSettings(settings);
                summaryItems.forEach(function(text) {
                    var li = document.createElement('li');
                    li.textContent = text;
                    meetConfigSummaryList.appendChild(li);
                });
                meetConfigSummary.classList.remove('d-none');
            } else {
                meetConfigSummary.classList.add('d-none');
            }
        }
    }

    function refreshPostponeSummary(event, selectedValue) {
        if (!postponeNotifyWrapper) {
            return;
        }
        var requiresReschedule = rescheduleStatuses.indexOf(selectedValue) !== -1;
        postponeNotifyWrapper.classList.toggle('d-none', !requiresReschedule);
        if (!requiresReschedule && postponeNotifyCheckbox) {
            postponeNotifyCheckbox.checked = false;
        }
    }

    function addMinutesToTime(timeStr, minutes) {
        if (!timeStr) {
            return '';
        }
        var parts = timeStr.split(':');
        var hours = parseInt(parts[0], 10);
        var mins = parseInt(parts[1], 10);
        if (Number.isNaN(hours) || Number.isNaN(mins)) {
            return '';
        }
        var total = hours * 60 + mins + minutes;
        if (total < 0) {
            total = 0;
        }
        var newHours = Math.floor(total / 60) % 24;
        var newMinutes = total % 60;
        return String(newHours).padStart(2, '0') + ':' + String(newMinutes).padStart(2, '0');
    }

    function describeMeetSettings(settings) {
        var opts = settings || {};
        return [
            opts.quick_access_enabled ? 'Acesso rápido habilitado' : 'Acesso rápido desativado',
            opts.mute_on_join ? 'Participantes entram silenciados' : 'Participantes podem ativar o áudio ao entrar',
            opts.allow_chat ? 'Chat habilitado' : 'Chat desativado',
            opts.allow_screen_share ? 'Compartilhamento de tela permitido' : 'Compartilhamento de tela bloqueado',
        ];
    }

    function getStatusLabelByValue(value) {
        if (!value) {
            return '';
        }
        for (var i = 0; i < meetingStatusOptions.length; i += 1) {
            var option = meetingStatusOptions[i];
            if (option && option.value === value) {
                return option.label || '';
            }
        }
        return '';
    }

    function markStatusEditing() {
        isStatusEditing = true;
    }

    function populateStatusSelect() {
        if (!statusSelect || statusOptionsPopulated) {
            return;
        }
        meetingStatusOptions.forEach(function(option) {
            var opt = document.createElement('option');
            opt.value = option.value;
            opt.textContent = option.label;
            statusSelect.appendChild(opt);
        });
        statusOptionsPopulated = true;
    }

    function togglePostponeFields(selectedValue) {
        var requiresReschedule = rescheduleStatuses.indexOf(selectedValue) !== -1;
        if (postponeFields) {
            postponeFields.classList.toggle('d-none', !requiresReschedule);
        }
        refreshPostponeSummary(currentEvent, selectedValue);
    }

    function prefillPostponeInputs(event) {
        if (!event) {
            return;
        }
        if (postponeDateInput && event.startStr) {
            postponeDateInput.value = event.startStr.slice(0, 10);
        }
        if (postponeStartInput && event.startStr && event.startStr.length >= 16) {
            postponeStartInput.value = event.startStr.slice(11, 16);
        }
        if (postponeEndInput) {
            if (event.endStr && event.endStr.length >= 16) {
                postponeEndInput.value = event.endStr.slice(11, 16);
            } else if (postponeStartInput && postponeStartInput.value) {
                postponeEndInput.value = addMinutesToTime(postponeStartInput.value, 30);
            } else {
                postponeEndInput.value = '';
            }
        }
    }

    function resetStatusError() {
        if (!statusError) {
            return;
        }
        statusError.textContent = '';
        statusError.classList.add('d-none');
    }

    function showStatusError(message) {
        if (!statusError) {
            return;
        }
        statusError.textContent = message;
        statusError.classList.remove('d-none');
    }

    function setStatusLoading(isLoading) {
        if (!saveStatusBtn) {
            return;
        }
        saveStatusBtn.disabled = !!isLoading;
        if (statusSpinner) {
            statusSpinner.classList.toggle('d-none', !isLoading);
        }
    }

    function updateMeetLink(event) {
        if (!meetLinkContainer || !detailMeetLink || !copyMeetLink) {
            return;
        }
        var link = event.extendedProps ? event.extendedProps.meet_link : null;
        if (link) {
            meetLinkContainer.classList.remove('d-none');
            detailMeetLink.textContent = link;
            var statusCode = event.extendedProps.status_code || '';
            var disableLink = statusesDisablingMeetLink.indexOf(statusCode) !== -1;
            if (disableLink) {
                detailMeetLink.removeAttribute('href');
                detailMeetLink.classList.add('text-muted', 'user-select-none');
                detailMeetLink.style.pointerEvents = 'none';
                copyMeetLink.classList.add('d-none');
                copyMeetLink.onclick = null;
            } else {
                detailMeetLink.href = link;
                detailMeetLink.classList.remove('text-muted', 'user-select-none');
                detailMeetLink.style.pointerEvents = '';
                copyMeetLink.classList.remove('d-none');
                copyMeetLink.onclick = function() {
                    var title = event.title || 'Reunião';
                    var dateFormatted = '';
                    if (event.startStr && event.startStr.length >= 10) {
                        var dateParts = event.startStr.slice(0, 10).split('-');
                        dateFormatted = dateParts.reverse().join('/');
                    }
                    var startTime = event.startStr && event.startStr.length >= 16 ? event.startStr.slice(11, 16) : '';
                    var endTime = event.endStr && event.endStr.length >= 16 ? event.endStr.slice(11, 16) : '';
                    var timeRange = startTime && endTime ? startTime + ' às ' + endTime : startTime;
                    var description = event.extendedProps.description || '';

                    var formattedMessage = 'JP Contábil\n\n';
                    formattedMessage += 'Título: ' + title + '\n';
                    if (dateFormatted) {
                        formattedMessage += 'Data: ' + dateFormatted + '\n';
                    }
                    if (timeRange) {
                        formattedMessage += 'Horário: ' + timeRange + '\n';
                    }
                    if (description) {
                        formattedMessage += '\nDescrição: ' + description + '\n';
                    }
                    formattedMessage += '\nLink do Google Meet: ' + link;

                    navigator.clipboard.writeText(formattedMessage).then(function() {
                        showFlashMessage('Convite copiado!', 'success');
                    });
                };
            }
        } else {
            meetLinkContainer.classList.add('d-none');
            detailMeetLink.textContent = '';
            detailMeetLink.removeAttribute('href');
            detailMeetLink.classList.remove('text-muted', 'user-select-none');
            detailMeetLink.style.pointerEvents = '';
            copyMeetLink.classList.add('d-none');
            copyMeetLink.onclick = null;
        }
    }

    function escapeHtml(value) {
        if (!value) {
            return '';
        }
        return value.replace(/[&<>"']/g, function(ch) {
            switch (ch) {
                case '&':
                    return '&amp;';
                case '<':
                    return '&lt;';
                case '>':
                    return '&gt;';
                case '"':
                    return '&quot;';
                case "'":
                    return '&#39;';
                default:
                    return ch;
            }
        });
    }

    function formatPautasHtml(text) {
        if (!text) {
            return '';
        }
        return escapeHtml(text).replace(/\r?\n/g, '<br>');
    }

    function resetPautasError() {
        if (!pautasError) {
            return;
        }
        pautasError.textContent = '';
        pautasError.classList.add('d-none');
    }

    function showPautasError(message) {
        if (!pautasError) {
            return;
        }
        pautasError.textContent = message;
        pautasError.classList.remove('d-none');
    }

    function renderPautasDisplay(text) {
        if (!pautasDisplay) {
            return;
        }
        var hasText = !!(text && text.trim());
        if (hasText) {
            pautasDisplay.innerHTML = formatPautasHtml(text);
            pautasDisplay.classList.remove('text-muted');
            pautasDisplay.classList.remove('fst-italic');
        } else {
            pautasDisplay.textContent = 'Nenhuma pauta registrada.';
            pautasDisplay.classList.add('text-muted');
            pautasDisplay.classList.add('fst-italic');
        }
    }

    function updatePautasEditControls(event) {
        if (!editPautasBtn || !savePautasBtn || !cancelPautasBtn) {
            return;
        }
        var canEdit = !!(event && event.extendedProps && event.extendedProps.can_edit_pautas);
        if (isEditingPautas) {
            editPautasBtn.classList.add('d-none');
            savePautasBtn.classList.remove('d-none');
            cancelPautasBtn.classList.remove('d-none');
            savePautasBtn.disabled = false;
            cancelPautasBtn.disabled = false;
        } else {
            savePautasBtn.classList.add('d-none');
            cancelPautasBtn.classList.add('d-none');
            if (canEdit) {
                var hasText = !!(event && event.extendedProps && event.extendedProps.pautas && event.extendedProps.pautas.trim());
                editPautasBtn.textContent = hasText ? 'Editar pautas' : 'Adicionar pautas';
                editPautasBtn.classList.remove('d-none');
                editPautasBtn.disabled = false;
            } else {
                editPautasBtn.classList.add('d-none');
            }
        }
    }

    function exitPautasEdit(event) {
        if (!pautasSection) {
            return;
        }
        isEditingPautas = false;
        if (pautasTextarea) {
            pautasTextarea.classList.add('d-none');
            pautasTextarea.disabled = false;
        }
        if (pautasDisplay) {
        pautasDisplay.classList.remove('d-none');
    }
    if (pautasSpinner) {
        pautasSpinner.classList.add('d-none');
    }
    resetPautasError();
    if (event && event.extendedProps) {
        if (pautasTextarea) {
            pautasTextarea.value = event.extendedProps.pautas || '';
        }
        renderPautasDisplay(event.extendedProps.pautas || '');
    }
    updatePautasEditControls(event);
}

    function enterPautasEdit(event) {
        if (!pautasSection || !event || !event.extendedProps || !event.extendedProps.can_edit_pautas) {
            return;
        }
        isEditingPautas = true;
        if (pautasTextarea) {
            pautasTextarea.value = event.extendedProps.pautas || '';
            pautasTextarea.classList.remove('d-none');
            pautasTextarea.disabled = false;
            pautasTextarea.focus();
        }
        if (pautasDisplay) {
            pautasDisplay.classList.add('d-none');
        }
        resetPautasError();
        updatePautasEditControls(event);
    }

    function setPautasLoading(isLoading) {
        if (savePautasBtn) {
            savePautasBtn.disabled = !!isLoading;
        }
        if (cancelPautasBtn) {
            cancelPautasBtn.disabled = !!isLoading;
        }
        if (pautasTextarea) {
            pautasTextarea.disabled = !!isLoading;
        }
        if (pautasSpinner) {
            pautasSpinner.classList.toggle('d-none', !isLoading);
        }
    }

    function updatePautasSection(event) {
        if (!pautasSection) {
            return;
        }
        if (!event || !event.extendedProps) {
            pautasSection.classList.add('d-none');
            return;
        }
        var content = event.extendedProps.pautas || '';
        var hasContent = !!(content && content.trim());
        var canEdit = !!event.extendedProps.can_edit_pautas;
        var shouldShow = hasContent || canEdit;
        pautasSection.classList.toggle('d-none', !shouldShow);
        if (!shouldShow) {
            isEditingPautas = false;
            resetPautasError();
            return;
        }
        if (!isEditingPautas && pautasTextarea) {
            pautasTextarea.value = content;
            pautasTextarea.classList.add('d-none');
            pautasTextarea.disabled = false;
        }
        if (isEditingPautas) {
            if (pautasTextarea) {
                pautasTextarea.classList.remove('d-none');
                pautasTextarea.disabled = false;
            }
            if (pautasDisplay) {
                pautasDisplay.classList.add('d-none');
            }
        } else {
            if (pautasDisplay) {
                pautasDisplay.classList.remove('d-none');
            }
            if (pautasTextarea) {
                pautasTextarea.classList.add('d-none');
            }
        }
        renderPautasDisplay(content);
        resetPautasError();
        if (pautasSpinner) {
            pautasSpinner.classList.add('d-none');
        }
        updatePautasEditControls(event);
    }

    function savePautas() {
        if (!currentEvent) {
            showPautasError('Nenhuma reuniao selecionada.');
            return;
        }
        var meetingId = currentEvent.extendedProps ? (currentEvent.extendedProps.meeting_id || currentEvent.id) : currentEvent.id;
        if (!meetingId) {
            showPautasError('Reuniao invalida.');
            return;
        }
        if (!pautasTextarea) {
            return;
        }
        setPautasLoading(true);
        resetPautasError();
        var payload = { pautas: pautasTextarea.value || '' };
        fetch('/reuniao/' + meetingId + '/pautas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrfToken || '',
                'X-Requested-With': 'XMLHttpRequest',
            },
            body: JSON.stringify(payload),
        })
            .then(function(response) {
                return response
                    .json()
                    .then(function(data) {
                        return { ok: response.ok, data: data };
                    })
                    .catch(function() {
                        return { ok: response.ok, data: null };
                    });
            })
            .then(function(result) {
                setPautasLoading(false);
                if (!result.ok || !result.data || result.data.success === false) {
                    var errorMessage = (result.data && result.data.error) || 'Nao foi possivel salvar as pautas.';
                    showPautasError(errorMessage);
                    return;
                }
                var updatedEvent = result.data.event;
                if (updatedEvent) {
                    var calendarEventId = updatedEvent.id || (currentEvent && currentEvent.id);
                    var matchingEvent = calendarEventId ? calendar.getEventById(String(calendarEventId)) : null;
                    if (matchingEvent) {
                        currentEvent = matchingEvent;
                    }
                    syncEventWithPayload(currentEvent, updatedEvent);
                } else if (result.data.pautas !== undefined && currentEvent) {
                    currentEvent.setExtendedProp('pautas', result.data.pautas);
                }
                if (currentEvent) {
                    exitPautasEdit(currentEvent);
                    updatePautasSection(currentEvent);
                } else {
                    exitPautasEdit(null);
                }
                showFlashMessage('Pautas salvas com sucesso!', 'success');
                refreshStatuses();
            })
            .catch(function(error) {
                console.error('Falha ao salvar pautas.', error);
                setPautasLoading(false);
                showPautasError('Nao foi possivel salvar as pautas.');
            });
    }

    function renderEventDetails(event) {
        if (!event) {
            return;
        }
        if (detailTitle) {
            detailTitle.textContent = event.title || '';
        }
        if (detailCreator) {
            var creator = event.extendedProps.creator || '';
            if (creator) {
                detailCreator.textContent = 'Criado por: ' + creator;
                detailCreator.classList.remove('d-none');
            } else {
                detailCreator.textContent = '';
                detailCreator.classList.add('d-none');
            }
        }
        if (detailDate) {
            if (event.startStr && event.startStr.length >= 10) {
                var dateParts = event.startStr.slice(0, 10).split('-');
                detailDate.textContent = dateParts.reverse().join('/');
            } else {
                detailDate.textContent = '';
            }
        }
        if (detailStart) {
            detailStart.textContent = event.startStr && event.startStr.length >= 16 ? event.startStr.slice(11, 16) : '';
        }
        if (detailEnd) {
            detailEnd.textContent = event.endStr && event.endStr.length >= 16 ? event.endStr.slice(11, 16) : '';
        }
        if (detailParticipants) {
            var participants = event.extendedProps.participants || [];
            detailParticipants.textContent = participants.join(', ');
        }
        if (detailStatus) {
            detailStatus.textContent = event.extendedProps.status || '';
        }
        updatePautasSection(event);
        updateMeetLink(event);
    }

    function updateStatusControls(event) {
        if (!statusControls || !statusSelect || !saveStatusBtn) {
            return;
        }
        populateStatusSelect();
        if (!isStatusEditing) {
            resetStatusError();
        }
        if (!event || !event.extendedProps || !event.extendedProps.can_update_status) {
            statusControls.classList.add('d-none');
            saveStatusBtn.dataset.meetingId = '';
            return;
        }
        statusControls.classList.remove('d-none');
        var meetingId = event.extendedProps.meeting_id || event.id;
        saveStatusBtn.dataset.meetingId = meetingId ? String(meetingId) : '';
        if (!isStatusEditing) {
            var currentStatusCode = event.extendedProps.status_code || '';
            if (currentStatusCode) {
                statusSelect.value = currentStatusCode;
            } else if (meetingStatusOptions.length) {
                statusSelect.value = meetingStatusOptions[0].value;
            } else {
                statusSelect.value = '';
            }
            if (postponeDateInput && event.startStr) {
                postponeDateInput.value = event.startStr.slice(0, 10);
            }
            if (postponeStartInput && event.startStr && event.startStr.length >= 16) {
                postponeStartInput.value = event.startStr.slice(11, 16);
            }
            if (postponeEndInput) {
                if (event.endStr && event.endStr.length >= 16) {
                    postponeEndInput.value = event.endStr.slice(11, 16);
                } else if (postponeStartInput && postponeStartInput.value) {
                    postponeEndInput.value = addMinutesToTime(postponeStartInput.value, 30);
                } else {
                    postponeEndInput.value = '';
                }
            }
            if (rescheduleStatuses.indexOf(statusSelect.value) !== -1) {
                prefillPostponeInputs(event);
            }
        }
        togglePostponeFields(statusSelect.value);
    }

    function updateActionButtons(event) {
        if (!editEventBtn || !deleteEventBtn || !deleteMeetingForm) {
            return;
        }
        if (event && event.extendedProps.can_edit) {
            editEventBtn.classList.remove('d-none');
        } else {
            editEventBtn.classList.add('d-none');
        }
        if (event && event.extendedProps.can_delete) {
            deleteEventBtn.classList.remove('d-none');
            deleteMeetingForm.action = '/reuniao/' + event.id + '/delete';
        } else {
            deleteEventBtn.classList.add('d-none');
            deleteMeetingForm.action = '';
        }
    }

    function updateConfigureButton(event) {
        if (!configureMeetBtn) {
            return;
        }
        if (event.extendedProps.meet_link && event.extendedProps.can_configure) {
            configureMeetBtn.classList.remove('d-none');
            var currentHostId = event.extendedProps.meet_host_id;
            if (typeof currentHostId === 'undefined') {
                currentHostId = null;
            }
            var configPayload = {
                meeting_id: event.extendedProps.meeting_id,
                meet_link: event.extendedProps.meet_link,
                host_candidates: event.extendedProps.host_candidates || [],
                current_host_id: currentHostId,
                meet_settings: event.extendedProps.meet_settings || {},
                creator_name: event.extendedProps.creator,
                subject: event.title,
                can_configure: true,
            };
            configureMeetBtn.dataset.config = JSON.stringify(configPayload);
        } else {
            configureMeetBtn.classList.add('d-none');
            configureMeetBtn.dataset.config = '';
        }
    }

    function syncEventWithPayload(event, payload) {
        if (!event || !payload) {
            return;
        }
        if (payload.start) {
            if (payload.end) {
                event.setDates(payload.start, payload.end);
            } else {
                event.setStart(payload.start);
            }
        }
        if (payload.title) {
            event.setProp('title', payload.title);
        }
        if (payload.color) {
            event.setProp('backgroundColor', payload.color);
            event.setProp('borderColor', payload.color);
        }
        var mapping = [
            ['status', 'status'],
            ['status_code', 'status_code'],
            ['can_edit', 'can_edit'],
            ['can_delete', 'can_delete'],
            ['can_configure', 'can_configure'],
            ['can_update_status', 'can_update_status'],
            ['meet_link', 'meet_link'],
            ['meet_host_name', 'meet_host_name'],
            ['meet_host_id', 'meet_host_id'],
            ['meet_settings', 'meet_settings'],
            ['participants', 'participants'],
            ['participant_ids', 'participant_ids'],
            ['participant_details', 'participant_details'],
            ['course_id', 'course_id'],
            ['creator', 'creator'],
            ['creator_username', 'creator_username'],
            ['host_candidates', 'host_candidates'],
            ['pautas', 'pautas'],
            ['can_edit_pautas', 'can_edit_pautas'],
        ];
        mapping.forEach(function(pair) {
            var propKey = pair[0];
            var payloadKey = pair[1];
            if (Object.prototype.hasOwnProperty.call(payload, payloadKey)) {
                event.setExtendedProp(propKey, payload[payloadKey]);
            }
        });
    }

    if (meetConfigCopyBtn && meetConfigLinkInput) {
        meetConfigCopyBtn.addEventListener('click', function() {
            if (!meetConfigLinkInput.value) {
                return;
            }
            navigator.clipboard.writeText(meetConfigLinkInput.value).then(function() {
                showFlashMessage('Link copiado!', 'success');
            });
        });
    }

    if (configureMeetBtn) {
        configureMeetBtn.addEventListener('click', function() {
            if (!configureMeetBtn.dataset.config) {
                return;
            }
            try {
                var parsed = JSON.parse(configureMeetBtn.dataset.config);
                openMeetConfiguration(parsed);
            } catch (err) {
                console.error('Não foi possível abrir as configurações do Meet.', err);
            }
        });
    }

    populateStatusSelect();

    if (statusSelect) {
        statusSelect.addEventListener('change', function() {
            markStatusEditing();
            resetStatusError();
            togglePostponeFields(statusSelect.value);
            if (rescheduleStatuses.indexOf(statusSelect.value) !== -1 && currentEvent) {
                prefillPostponeInputs(currentEvent);
                refreshPostponeSummary(currentEvent, statusSelect.value);
            } else {
                refreshPostponeSummary(currentEvent, statusSelect.value);
            }
        });
    }

    [postponeDateInput, postponeStartInput, postponeEndInput].forEach(function(input) {
        if (!input) {
            return;
        }
        var handler = function() {
            markStatusEditing();
            var selected = statusSelect ? statusSelect.value : '';
            refreshPostponeSummary(currentEvent, selected);
        };
        input.addEventListener('input', handler);
        input.addEventListener('change', handler);
    });

    if (editPautasBtn) {
        editPautasBtn.addEventListener('click', function() {
            if (!currentEvent) {
                showPautasError('Nenhuma reuniao selecionada.');
                return;
            }
            enterPautasEdit(currentEvent);
        });
    }

    if (cancelPautasBtn) {
        cancelPautasBtn.addEventListener('click', function() {
            if (currentEvent) {
                if (pautasTextarea) {
                    pautasTextarea.value = currentEvent.extendedProps ? (currentEvent.extendedProps.pautas || '') : '';
                }
                exitPautasEdit(currentEvent);
                updatePautasSection(currentEvent);
            } else {
                exitPautasEdit(null);
            }
        });
    }

    if (savePautasBtn) {
        savePautasBtn.addEventListener('click', function() {
            savePautas();
        });
    }

    if (saveStatusBtn) {
        saveStatusBtn.addEventListener('click', function() {
            if (!currentEvent) {
                showStatusError('Nenhuma reunião selecionada.');
                return;
            }
            if (!statusSelect) {
                showStatusError('Selecione um status.');
                return;
            }
            var selectedStatus = statusSelect.value;
            if (!selectedStatus) {
                showStatusError('Selecione um status.');
                return;
            }
            var payload = { status: selectedStatus };
            if (rescheduleStatuses.indexOf(selectedStatus) !== -1) {
                var dateVal = postponeDateInput ? postponeDateInput.value : '';
                var startVal = postponeStartInput ? postponeStartInput.value : '';
                var endVal = postponeEndInput ? postponeEndInput.value : '';
                if (!(dateVal && startVal && endVal)) {
                    showStatusError('Informe a nova data e horários para adiar a reunião.');
                    return;
                }
                payload.date = dateVal;
                payload.start_time = startVal;
                payload.end_time = endVal;
            }
            if (postponeNotifyCheckbox) {
                payload.notify_attendees = !!postponeNotifyCheckbox.checked;
            }
            resetStatusError();
            setStatusLoading(true);
            var meetingId = saveStatusBtn.dataset.meetingId || currentEvent.extendedProps.meeting_id || currentEvent.id;
            fetch('/reuniao/' + meetingId + '/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': window.csrfToken || '',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                body: JSON.stringify(payload),
            })
                .then(function(response) {
                    return response.json().then(function(data) {
                        return { ok: response.ok, data: data };
                    });
                })
                .then(function(result) {
                    setStatusLoading(false);
                    if (!result.ok || !result.data || result.data.success === false) {
                        var errorMessage = (result.data && (result.data.error || result.data.message)) || 'Não foi possível atualizar o status da reunião.';
                        showStatusError(errorMessage);
                        return;
                    }
                    var updatedEvent = result.data.event;
                    isStatusEditing = false;
                    if (updatedEvent) {
                        var calendarEventId = updatedEvent.id || (currentEvent && currentEvent.id);
                        var matchingEvent = calendarEventId ? calendar.getEventById(String(calendarEventId)) : null;
                        if (matchingEvent) {
                            currentEvent = matchingEvent;
                        }
                        syncEventWithPayload(currentEvent, updatedEvent);
                        renderEventDetails(currentEvent);
                        updateMeetDetails(currentEvent);
                        updateStatusControls(currentEvent);
                        updateConfigureButton(currentEvent);
                        updateActionButtons(currentEvent);
                    }
                    showFlashMessage(result.data.message || 'Status atualizado com sucesso!', 'success');
                    refreshStatuses();
                    var modalRef = eventDetailsModalInstance;
                    if (!modalRef && eventDetailsModalEl) {
                        modalRef =
                            bootstrap.Modal.getInstance(eventDetailsModalEl) ||
                            (bootstrap.Modal.getOrCreateInstance
                                ? bootstrap.Modal.getOrCreateInstance(eventDetailsModalEl)
                                : null);
                    }
                    if (modalRef) {
                        modalRef.hide();
                    }
                })
                .catch(function(err) {
                    console.error('Não foi possível atualizar o status da reunião.', err);
                    setStatusLoading(false);
                    showStatusError('Não foi possível atualizar o status da reunião.');
                });
        });
    }

    if (meetConfigForm) {
        meetConfigForm.addEventListener('submit', function(event) {
            event.preventDefault();
            if (!meetConfigForm.action) {
                return;
            }
            resetMeetConfigFeedback();
            var formData = new FormData(meetConfigForm);
            fetch(meetConfigForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
                .then(function(response) {
                    if (!response.ok) {
                        return response.json().then(function(data) {
                            throw data;
                        });
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (!data.success) {
                        throw data;
                    }
                    showFlashMessage(data.message || 'Configurações atualizadas com sucesso!', 'success');
                    var modalInstance = getMeetConfigModal();
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                    if (currentEvent) {
                        if (data.meet_settings) {
                            currentEvent.setExtendedProp('meet_settings', data.meet_settings);
                        }
                        if (data.meet_host) {
                            currentEvent.setExtendedProp('meet_host_name', data.meet_host.name || '');
                            currentEvent.setExtendedProp('meet_host_id', data.meet_host.id || null);
                        } else {
                            currentEvent.setExtendedProp('meet_host_name', '');
                            currentEvent.setExtendedProp('meet_host_id', null);
                        }
                        updateMeetDetails(currentEvent);
                    }
                })
                .catch(function(errorData) {
                    if (errorData && errorData.errors) {
                        if (errorData.errors.host_id && meetConfigHostSelect) {
                            meetConfigHostSelect.classList.add('is-invalid');
                            meetConfigHostError.textContent = errorData.errors.host_id[0];
                        }
                        if (errorData.errors.meeting_id && meetConfigError) {
                            meetConfigError.classList.remove('d-none');
                            meetConfigError.textContent = errorData.errors.meeting_id[0];
                        }
                    } else if (meetConfigError) {
                        meetConfigError.classList.remove('d-none');
                        meetConfigError.textContent = 'Não foi possível salvar as configurações do Meet.';
                    }
                });
        });
    }

    if (meetPopupData) {
        openMeetConfiguration(meetPopupData);
    }

    function renumberAdditionalDates() {
        if (!additionalDatesContainer) {
            return;
        }
        var items = additionalDatesContainer.querySelectorAll('.additional-date-item');
        items.forEach(function(item, index) {
            var input = item.querySelector('.additional-date-input');
            if (input) {
                input.name = 'additional_dates-' + index;
                input.id = 'additional_dates-' + index;
            }
        });
        additionalDatesContainer.dataset.nextIndex = String(items.length);
    }

    function updateRemoveButtons() {
        if (!additionalDatesContainer) {
            return;
        }
        var items = additionalDatesContainer.querySelectorAll('.additional-date-item');
        items.forEach(function(item) {
            var removeBtn = item.querySelector('.remove-additional-date');
            if (!removeBtn) {
                return;
            }
            if (items.length > 1) {
                removeBtn.classList.remove('d-none');
            } else {
                removeBtn.classList.add('d-none');
            }
        });
    }

    function attachRemoveHandler(button) {
        if (!button) {
            return;
        }
        button.addEventListener('click', function() {
            if (!additionalDatesContainer) {
                return;
            }
            var item = button.closest('.additional-date-item');
            if (!item) {
                return;
            }
            var items = additionalDatesContainer.querySelectorAll('.additional-date-item');
            if (items.length === 1) {
                var input = item.querySelector('.additional-date-input');
                if (input) {
                    input.value = '';
                }
                item.querySelectorAll('.additional-date-error').forEach(function(err) {
                    err.remove();
                });
                return;
            }
            item.remove();
            renumberAdditionalDates();
            updateRemoveButtons();
        });
    }

    function clearAdditionalDates() {
        if (!additionalDatesContainer) {
            return;
        }
        var items = additionalDatesContainer.querySelectorAll('.additional-date-item');
        items.forEach(function(item, index) {
            if (index === 0) {
                var input = item.querySelector('.additional-date-input');
                if (input) {
                    input.value = '';
                }
                item.querySelectorAll('.additional-date-error').forEach(function(err) {
                    err.remove();
                });
            } else {
                item.remove();
            }
        });
        if (additionalDatesWrapper) {
            additionalDatesWrapper.querySelectorAll('.additional-dates-error').forEach(function(err) {
                err.remove();
            });
        }
        renumberAdditionalDates();
        updateRemoveButtons();
    }

    function addAdditionalDateField(value) {
        if (!additionalDatesContainer) {
            return;
        }
        var item = document.createElement('div');
        item.className = 'additional-date-item';
        var group = document.createElement('div');
        group.className = 'input-group additional-date-group';
        var input = document.createElement('input');
        input.type = 'date';
        input.className = 'form-control additional-date-input';
        if (value) {
            input.value = value;
        }
        var removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-outline-danger remove-additional-date';
        removeBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
        group.appendChild(input);
        group.appendChild(removeBtn);
        item.appendChild(group);
        additionalDatesContainer.appendChild(item);
        attachRemoveHandler(removeBtn);
        renumberAdditionalDates();
        updateRemoveButtons();
    }

    function toggleAdditionalDates() {
        if (!applyMoreDaysCheckbox || !additionalDatesWrapper) {
            return;
        }
        if (applyMoreDaysCheckbox.checked) {
            additionalDatesWrapper.classList.remove('d-none');
            if (
                additionalDatesContainer &&
                additionalDatesContainer.querySelectorAll('.additional-date-item').length === 0
            ) {
                addAdditionalDateField('');
            }
            updateRemoveButtons();
        } else {
            additionalDatesWrapper.classList.add('d-none');
            clearAdditionalDates();
        }
    }

    if (additionalDatesContainer) {
        renumberAdditionalDates();
        additionalDatesContainer.querySelectorAll('.remove-additional-date').forEach(attachRemoveHandler);
        updateRemoveButtons();
    }

    if (addAdditionalDateBtn) {
        addAdditionalDateBtn.addEventListener('click', function() {
            addAdditionalDateField('');
        });
    }

    if (applyMoreDaysCheckbox) {
        applyMoreDaysCheckbox.addEventListener('change', toggleAdditionalDates);
        toggleAdditionalDates();
    }
    function openNewMeeting(dateStr) {
        var form = document.querySelector('#meetingModal form');
        hideMeetingCreationOverlay();
        form.reset();
        if (applyMoreDaysCheckbox) {
            applyMoreDaysCheckbox.checked = false;
        }
        clearAdditionalDates();
        toggleAdditionalDates();
        document.getElementById('meeting_id').value = '';
        var courseInput = document.getElementById('meeting_course_id');
        if (courseInput) {
            courseInput.value = '';
        }
        if (dateStr) { form.date.value = dateStr; }
        document.querySelector('#meetingModal .modal-title').textContent = 'Agendar Reunião';
        document.querySelector('#meetingModal input[type="submit"]').value = 'Agendar';
        var meetingModal = new bootstrap.Modal(document.getElementById('meetingModal'));
        meetingModal.show();
    }
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        fixedWeekCount: false,
        timeZone: '{{ calendar_timezone }}',
        locale: 'pt-br',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridDay,timeGridWeek,dayGridMonth,multiMonthYear'
        },
        navLinks: true,
        buttonText: {
            today: 'Hoje',
            dayGridDay: 'Dia',
            timeGridWeek: 'Semana',
            dayGridMonth: 'Mês',
            multiMonthYear: 'Ano'
        },
        views: {
            multiMonthYear: {
                type: 'multiMonth',
                duration: { years: 1 },
                multiMonthMaxColumns: 3,
                multiMonthMinWidth: 220,
                titleFormat: { year: 'numeric' }
            }
        },
        dateClick: function(info) {
            openNewMeeting(info.dateStr);
        },
        eventDidMount: function(info) {
            var time = info.event.allDay ? '' : info.event.startStr.substring(11,16);
            var color = info.event.backgroundColor || info.event.borderColor;
            var cls = '';
            if(color === '#0d6efd'){cls='tooltip-primary';}
            else if(color === '#ffc107'){cls='tooltip-warning';}
            else if(color === '#198754'){cls='tooltip-success';}
            else if(color === '#6c757d'){cls='tooltip-secondary';}
            else if(color === '#dc3545'){cls='tooltip-danger';}
            info.el.setAttribute('data-bs-toggle', 'tooltip');
            info.el.setAttribute('data-bs-html', 'true');
            info.el.setAttribute('data-bs-custom-class', cls);
            info.el.setAttribute('title', time + ' ' + info.event.title);
            new bootstrap.Tooltip(info.el);
        },
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            var e = info.event;
            currentEvent = e;
            isStatusEditing = false;
            renderEventDetails(e);
            updateMeetDetails(e);
            updateStatusControls(e);
            updateConfigureButton(e);
            updateActionButtons(e);
            if (eventDetailsModalEl) {
                eventDetailsModalInstance =
                    bootstrap.Modal.getInstance(eventDetailsModalEl) ||
                    (bootstrap.Modal.getOrCreateInstance
                        ? bootstrap.Modal.getOrCreateInstance(eventDetailsModalEl)
                        : new bootstrap.Modal(eventDetailsModalEl));
                eventDetailsModalInstance.show();
            }
        }
    });
    calendar.render();
    if (eventDetailsModalEl) {
        eventDetailsModalEl.addEventListener('hidden.bs.modal', function() {
            isStatusEditing = false;
            resetStatusError();
            isEditingPautas = false;
            exitPautasEdit(currentEvent || null);
            if (currentEvent) {
                updatePautasSection(currentEvent);
            } else {
                resetPautasError();
            }
            eventDetailsModalInstance = bootstrap.Modal.getInstance(eventDetailsModalEl) || null;
        });
    }
    function refreshStatuses() {
        fetch('/api/reunioes')
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                var newIds = new Set();
                data.forEach(function(evData) {
                    var id = String(evData.id);
                    newIds.add(id);
                    var existing = calendar.getEventById(id);
                    if (existing) {
                        if (existing.startStr !== evData.start || existing.endStr !== evData.end) {
                            existing.setDates(evData.start, evData.end);
                        }
                        if (existing.title !== evData.title) {
                            existing.setProp('title', evData.title);
                        }
                        if (existing.extendedProps.status !== evData.status) {
                            existing.setExtendedProp('status', evData.status);
                        }
                        if (existing.extendedProps.status_code !== evData.status_code) {
                            existing.setExtendedProp('status_code', evData.status_code);
                        }
                        if (existing.extendedProps.can_edit !== evData.can_edit) {
                            existing.setExtendedProp('can_edit', evData.can_edit);
                        }
                        if (existing.extendedProps.can_delete !== evData.can_delete) {
                            existing.setExtendedProp('can_delete', evData.can_delete);
                        }
                        if (existing.extendedProps.can_configure !== evData.can_configure) {
                            existing.setExtendedProp('can_configure', evData.can_configure);
                        }
                        if (existing.extendedProps.can_update_status !== evData.can_update_status) {
                            existing.setExtendedProp('can_update_status', evData.can_update_status);
                        }
                        if (existing.extendedProps.course_id !== evData.course_id) {
                            existing.setExtendedProp('course_id', evData.course_id);
                        }
                        if (existing.extendedProps.meet_link !== evData.meet_link) {
                            existing.setExtendedProp('meet_link', evData.meet_link);
                        }
                        if (existing.extendedProps.creator !== evData.creator) {
                            existing.setExtendedProp('creator', evData.creator);
                        }
                        if (existing.extendedProps.creator_username !== evData.creator_username) {
                            existing.setExtendedProp('creator_username', evData.creator_username);
                        }
                        existing.setExtendedProp('participants', evData.participants || []);
                        existing.setExtendedProp('participant_ids', evData.participant_ids || []);
                        existing.setExtendedProp('participant_details', evData.participant_details || []);
                        existing.setExtendedProp('host_candidates', evData.host_candidates || []);
                        existing.setExtendedProp('meet_settings', evData.meet_settings || {});
                        var updatedHostId = Object.prototype.hasOwnProperty.call(evData, 'meet_host_id') ? evData.meet_host_id : null;
                        existing.setExtendedProp('meet_host_id', updatedHostId);
                        existing.setExtendedProp('meet_host_name', evData.meet_host_name || '');
                        existing.setExtendedProp('pautas', evData.pautas || '');
                        existing.setExtendedProp('can_edit_pautas', !!evData.can_edit_pautas);
                        if (existing.backgroundColor !== evData.color) {
                            existing.setProp('backgroundColor', evData.color);
                            existing.setProp('borderColor', evData.color);
                        }
                        if (currentEvent && currentEvent.id === existing.id) {
                            renderEventDetails(currentEvent);
                            updateMeetDetails(currentEvent);
                            updateStatusControls(currentEvent);
                            updateConfigureButton(currentEvent);
                            updateActionButtons(currentEvent);
                        }
                        var el = existing.el;
                        if (el) {
                            var tip = bootstrap.Tooltip.getInstance(el);
                            if (tip) { tip.dispose(); }
                            var time = existing.allDay ? '' : existing.startStr.substring(11,16);
                            var color = existing.backgroundColor || existing.borderColor;
                            var cls = '';
                            if (color === '#ffc107') { cls = 'tooltip-warning'; }
                            else if (color === '#198754') { cls = 'tooltip-success'; }
                            else if (color === '#dc3545') { cls = 'tooltip-danger'; }
                            el.setAttribute('data-bs-custom-class', cls);
                            el.setAttribute('title', time + ' ' + existing.title);
                            new bootstrap.Tooltip(el);
                        }
                    } else {
                        calendar.addEvent(evData);
                    }
                });
                calendar.getEvents().forEach(function(ev) {
                    if (!newIds.has(ev.id)) {
                        ev.remove();
                    }
                });
            });
    }
    refreshStatuses();
    setInterval(refreshStatuses, 15000);

    document.getElementById('editEventBtn').addEventListener('click', function() {
        var detailModal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
        detailModal.hide();
        var form = document.querySelector('#meetingModal form');
        hideMeetingCreationOverlay();
        document.getElementById('meeting_id').value = currentEvent.id || '';
        var courseInput = document.getElementById('meeting_course_id');
        if (courseInput) {
            courseInput.value = currentEvent.extendedProps.course_id || '';
        }
        form.subject.value = currentEvent.title;
        var start = currentEvent.startStr;
        var end = currentEvent.endStr;
        form.date.value = start.slice(0,10);
        form.start_time.value = start.slice(11,16);
        form.end_time.value = end ? end.slice(11,16) : '';
        form.description.value = currentEvent.extendedProps.description || '';
        if (form.create_meet) {
            form.create_meet.checked = !!currentEvent.extendedProps.meet_link;
        }
        if (form.notify_attendees) {
            form.notify_attendees.checked = false;
        }
        if (form.apply_more_days) {
            form.apply_more_days.checked = false;
        }
        clearAdditionalDates();
        toggleAdditionalDates();
        var ids = currentEvent.extendedProps.participant_ids || [];
        document.querySelectorAll('#meetingModal input[name="participants"]').forEach(function(cb){
            cb.checked = ids.includes(parseInt(cb.value));
        });
        document.querySelector('#meetingModal .modal-title').textContent = 'Editar Reunião';
        document.querySelector('#meetingModal input[type="submit"]').value = 'Salvar';
        var meetingModal = new bootstrap.Modal(document.getElementById('meetingModal'));
        meetingModal.show();
    });

    document.getElementById('deleteEventBtn').addEventListener('click', function() {
        if (!currentEvent || !currentEvent.id) {
            return;
        }
        if (confirm('Deseja excluir esta reunião?')) {
            var meetingId = currentEvent.id;
            var deleteUrl = '/reuniao/' + meetingId + '/delete';
            var csrfToken = document.querySelector('#csrf_token_delete').value;

            fetch(deleteUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': csrfToken
                },
                body: 'csrf_token=' + encodeURIComponent(csrfToken)
            })
            .then(function(response) {
                return response.json().then(function(data) {
                    return { status: response.status, data: data };
                });
            })
            .then(function(result) {
                if (result.data.success) {
                    // Remover evento do calendário
                    var eventToRemove = calendar.getEventById(String(meetingId));
                    if (eventToRemove) {
                        eventToRemove.remove();
                    }

                    // Fechar modal
                    if (eventDetailsModalInstance) {
                        eventDetailsModalInstance.hide();
                    }

                    // Exibir mensagem de sucesso
                    showToast(result.data.message || 'Reunião excluída com sucesso!', 'success');
                } else {
                    showToast(result.data.error || 'Erro ao excluir reunião.', 'danger');
                }
            })
            .catch(function(error) {
                console.error('Erro ao excluir reunião:', error);
                showToast('Erro ao excluir reunião. Tente novamente.', 'danger');
            });
        }
    });

    document.getElementById('openMeetingModal').addEventListener('click', function() {
        openNewMeeting('');
    });
    });
    </script>
    {% if show_modal %}
        <script>
document.addEventListener('DOMContentLoaded', function() {
    var modal = new bootstrap.Modal(document.getElementById('meetingModal'));
    modal.show();
});
        </script>
    {% endif %}
{% endblock %}
