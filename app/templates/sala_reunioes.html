{% extends "base.html" %}
{% block title %}SALA DE REUNIÕES{% endblock %}
{% block sidebar_nav %}
    <div class="nav-section">
        <div class="nav-section-title">PRINCIPAL</div>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for("dashboard") }}">
                    <i class="bi bi-list-task"></i>
                    PARTICULARIDADES
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://app.acessorias.com/sysmain.php" target="_blank" rel="noopener">
                    <i class="bi bi-box-arrow-up-right"></i>
                    ACESSÓRIAS
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://auth.sieg.com/login" target="_blank" rel="noopener">
                    <i class="bi bi-box-arrow-up-right"></i>
                    SIEG
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for("consultorias") }}">
                    <i class="bi bi-buildings"></i>
                    CONSULTORIAS
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="{{ url_for("sala_reunioes") }}">
                    <i class="bi bi-calendar-event"></i>
                    SALA DE REUNIÕES
                </a>
            </li>
        </ul>
    </div>
    <style>
    .content-breadcrumb { display: none; }
    .content-wrapper { padding: 0; }
    .modal-body { max-height: none; overflow-y: visible; }
    .participant-list { max-height: 150px; overflow-y: auto; }
    </style>
{% endblock %}
{% block content %}
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>Próximas Reuniões</h2>
            <button id="openMeetingModal" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#meetingModal">Agendar Reunião</button>
        </div>
        <div class="mb-3">
            <span class="badge bg-warning text-dark me-2">Agendada</span>
            <span class="badge bg-success me-2">Em Andamento</span>
            <span class="badge bg-danger">Realizada</span>
        </div>
        {% for ev in events %}
            <div class="card border-{{ ev.status_class }} mb-3">
                <div class="card-body d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title mb-1">{{ ev.title }}</h5>
                        <div class="text-muted small mb-2">
                            {{ ev.start_dt.strftime('%d/%m/%Y %H:%M') }} - {{ ev.end_dt.strftime('%H:%M') }} • {{ ev.status }}
                        </div>
                        {% if ev.participants %}
                            <div class="small mb-2">Participantes: {{ ev.participants|join(', ') }}</div>
                        {% endif %}
                        {% if ev.description %}
                            <p class="mb-0">{{ ev.description }}</p>
                        {% endif %}
                    </div>
                    <div class="ms-2 text-nowrap">
                        {% if ev.meet_link %}
                            <a href="{{ ev.meet_link }}" target="_blank" class="btn btn-sm btn-outline-primary mb-1">Meet</a>
                        {% endif %}
                        {% if ev.can_edit %}
                            <button class="btn btn-sm btn-primary mb-1 edit-event-btn" data-bs-toggle="modal" data-bs-target="#meetingModal" data-meeting='{{ {"id":ev.id,"title":ev.title,"start":ev.start,"end":ev.end,"description":ev.description,"participant_ids":ev.participant_ids,"meet_link":ev.meet_link}|tojson|e }}'>Editar</button>
                        {% endif %}
                        {% if ev.can_delete %}
                            <form method="post" action="{{ url_for('delete_reuniao', meeting_id=ev.id) }}" class="d-inline">
                                {{ form.csrf_token }}
                                <button type="submit" class="btn btn-sm btn-danger mb-1">Excluir</button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% else %}
            <p>Nenhuma reunião encontrada.</p>
        {% endfor %}
    </div>

    <div class="modal fade" id="meetingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agendar Reunião</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post">
                    <div class="modal-body text-start">
                        {{ form.csrf_token }}
                        {{ form.meeting_id(id='meeting_id') }}
                        <div class="row">
                            <div class="mb-3 col-md-6">
                                {{ form.participants.label(class="form-label") }}
                                <div class="participant-list border rounded p-2">
                                    {% for subfield in form.participants %}
                                        <div class="form-check">
                                            {{ subfield(class="form-check-input", id=subfield.id) }}
                                            <label class="form-check-label" for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if form.participants.errors %}<div class="text-danger">{{ form.participants.errors[0] }}</div>{% endif %}
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    {{ form.date.label(class="form-label") }}
                                    {{ form.date(class="form-control", type="date") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.start_time.label(class="form-label") }}
                                    {{ form.start_time(class="form-control", type="time") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.end_time.label(class="form-label") }}
                                    {{ form.end_time(class="form-control", type="time") }}
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form.subject.label(class="form-label") }}
                            {{ form.subject(class="form-control") }}
                        </div>
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control", rows=3) }}
                        </div>
                        <div class="form-check mb-3">
                            {{ form.create_meet(class="form-check-input", id="create_meet") }}
                            <label class="form-check-label" for="create_meet">{{ form.create_meet.label.text }}</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var tz = '{{ tz_name }}';
        document.querySelectorAll('.edit-event-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var data = JSON.parse(this.dataset.meeting);
                var form = document.querySelector('#meetingModal form');
                form.meeting_id.value = data.id || '';
                form.subject.value = data.title || '';
                var start = new Date(data.start);
                var end = data.end ? new Date(data.end) : null;
                form.date.value = start.toLocaleDateString('en-CA', {timeZone: tz});
                form.start_time.value = start.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit', hour12: false, timeZone: tz});
                form.end_time.value = end ? end.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit', hour12: false, timeZone: tz}) : '';
                form.description.value = data.description || '';
                if (form.create_meet) { form.create_meet.checked = !!data.meet_link; }
                var ids = data.participant_ids || [];
                document.querySelectorAll('#meetingModal input[name="participants"]').forEach(function(cb){
                    cb.checked = ids.includes(parseInt(cb.value));
                });
                document.querySelector('#meetingModal .modal-title').textContent = 'Editar Reunião';
                document.querySelector('#meetingModal input[type="submit"]').value = 'Salvar';
            });
        });
        document.getElementById('openMeetingModal').addEventListener('click', function() {
            var form = document.querySelector('#meetingModal form');
            form.reset();
            form.meeting_id.value = '';
            document.querySelector('#meetingModal .modal-title').textContent = 'Agendar Reunião';
            document.querySelector('#meetingModal input[type="submit"]').value = 'Agendar';
        });
    });
    </script>
    {% if show_modal %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var modal = new bootstrap.Modal(document.getElementById('meetingModal'));
        modal.show();
    });
    </script>
    {% endif %}
{% endblock %}
