{% extends "base.html" %}
{% block title %}SALA DE REUNIÕES{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
    .content-breadcrumb { display: none; }
    .content-wrapper { padding: 0; }
    .modal-body { max-height: none; overflow-y: visible; }
    .participant-list { max-height: 160px; overflow-y: auto; }
    #calendar { height: 70vh; }
    .meeting-modal-dialog { max-width: 1200px; }
    .meeting-modal-dialog .modal-header,
    .meeting-modal-dialog .modal-body,
    .meeting-modal-dialog .modal-footer { padding-left: 1.25rem; padding-right: 1.25rem; }
    .meeting-modal-dialog .modal-header { padding-top: 1.1rem; padding-bottom: 0.9rem; }
    .meeting-modal-dialog .modal-body { font-size: var(--font-base); padding-top: 1.1rem; padding-bottom: 1rem; }
    .meeting-modal-dialog .modal-footer { padding-top: 0.9rem; padding-bottom: 0.9rem; }
    .meeting-modal-dialog label,
    .meeting-modal-dialog .form-check-label,
    .meeting-modal-dialog .form-control,
    .meeting-modal-dialog .form-select,
    .meeting-modal-dialog .form-check-input,
    .meeting-modal-dialog .btn,
    .meeting-modal-dialog .input-group-text { font-size: var(--font-base); }
    .meeting-modal-dialog .modal-title { font-size: var(--font-xl); }
    .meeting-modal-dialog .form-control,
    .meeting-modal-dialog .form-select,
    .meeting-modal-dialog .input-group-text { padding: 0.35rem 0.6rem; }
    .meeting-modal-dialog textarea.form-control { min-height: 5rem; }
    .meeting-modal-dialog .form-check { margin-bottom: 0.25rem; }
    .meeting-modal-dialog .form-check .form-check-label { line-height: 1.2; }
    .meeting-modal-dialog .modal-body .row { margin-left: -0.35rem; margin-right: -0.35rem; }
    .meeting-modal-dialog .modal-body .col-md-6,
    .meeting-modal-dialog .modal-body .mb-3 { padding-left: 0.35rem; padding-right: 0.35rem; }
    .meeting-modal-dialog .meeting-options { gap: 1.25rem; flex-wrap: wrap; }
    .meeting-modal-dialog .meeting-options .form-check {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 0;
    }
    .meeting-modal-dialog .meeting-options .form-check-input { margin-top: 0; }
    .meeting-modal-dialog .additional-dates-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
    }
    .meeting-modal-dialog .additional-date-item {
        flex: 0 0 auto;
    }
    .meeting-modal-dialog .additional-date-group {
        min-width: 190px;
    }
    .meet-link-modal-dialog { max-width: 520px; }
    @media (max-width: 576px) {
        .meet-link-modal-dialog { margin: 1rem; }
    }
    .meet-link-modal { border: none; border-radius: 1rem; box-shadow: 0 20px 45px -28px rgba(18, 38, 63, 0.4); }
    .meet-link-modal .modal-body { padding: 1.75rem; }
    .meet-link-icon { width: 48px; height: 48px; background: #e8f0fe; color: #1a73e8; font-size: 1.4rem; }
    .btn-quiet-primary {
        background: #e8f0fe;
        color: #1a73e8;
        border: none;
        font-weight: 600;
        border-radius: 0.75rem;
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-quiet-primary:hover,
    .btn-quiet-primary:focus {
        background: #d2e3fc;
        color: #174ea6;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
    }
    .btn-quiet-secondary {
        background: #f3f6fc;
        color: #3c4043;
        border: none;
        font-weight: 600;
        border-radius: 0.75rem;
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-quiet-secondary:hover,
    .btn-quiet-secondary:focus {
        background: #e8eaed;
        color: #202124;
        box-shadow: 0 0 0 3px rgba(60, 64, 67, 0.1);
    }
    .meet-link-card { background: linear-gradient(135deg, #f7f9ff 0%, #ffffff 100%); }
    .meet-link-badge { width: 40px; height: 40px; background: #ecf3fe; color: #1a73e8; font-size: 1.2rem; }
    .btn-icon {
        border: none;
        background: #ecf3fe;
        color: #1a73e8;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        outline: none;
        font-size: 1.1rem;
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-icon:hover,
    .btn-icon:focus {
        background: #d2e3fc;
        color: #174ea6;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.15);
    }
    </style>
{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}
{% block content %}
    <div class="container-fluid px-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2>Calendário de Agendamentos</h2>
                <div>
                    <button id="openMeetingModal" class="btn btn-primary"
                            data-bs-toggle="modal"
                            data-bs-target="#meetingModal">Agendar Reunião</button>
                </div>
            </div>
            <div class="mb-3">
                {% for badge in meeting_status_badges %}
                    <span class="badge {{ badge.badge_class }} me-2">{{ badge.label }}</span>
                {% endfor %}
            </div>
            <div id="calendar"></div>
            <div class="modal fade" id="meetingModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-xl meeting-modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header align-items-start">
                            <h5 class="modal-title">Agendar Reunião</h5>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <form method="post">
                            <div class="modal-body text-start">
                                {{ form.csrf_token }}
                                {{ form.meeting_id(id='meeting_id') }}
                                {{ form.course_id(id='meeting_course_id') }}
                                <div class="row">
                                    <div class="mb-3 col-md-6">
                                        {{ form.participants.label(class="form-label") }}
                                        <div class="participant-list border rounded p-2">
                                            {% for subfield in form.participants %}
                                                <div class="form-check">
                                                    {{ subfield(class="form-check-input", id=subfield.id) }}
                                                    <label class="form-check-label" for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                        {% if form.participants.errors %}<div class="text-danger">{{ form.participants.errors[0] }}</div>{% endif %}
                                        <div class="mt-3" id="ownerFieldWrapper">
                                            {{ form.owner_id.label(class="form-label") }}
                                            {{ form.owner_id(class="form-select") }}
                                            {% if form.owner_id.errors %}<div class="text-danger">{{ form.owner_id.errors[0] }}</div>{% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.date.label(class="form-label") }}
                                            {{ form.date(class="form-control", type="date") }}
                                        </div>
                                        <div class="mb-3">
                                            {{ form.start_time.label(class="form-label") }}
                                            {{ form.start_time(class="form-control", type="time") }}
                                        </div>
                                        <div class="mb-3">
                                            {{ form.end_time.label(class="form-label") }}
                                            {{ form.end_time(class="form-control", type="time") }}
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3 mb-1">
                                    <div class="col-lg-6">
                                        {{ form.subject.label(class="form-label mb-1") }}
                                        {{ form.subject(class="form-control") }}
                                    </div>
                                    <div class="col-lg-6">
                                        {{ form.description.label(class="form-label mb-1") }}
                                        {{ form.description(class="form-control", rows=2) }}
                                    </div>
                                </div>
                                <div class="meeting-options d-flex flex-wrap align-items-center mb-3">
                                    <div class="form-check form-check-inline">
                                        {{ form.create_meet(class="form-check-input", id="create_meet") }}
                                        <label class="form-check-label" for="create_meet">{{ form.create_meet.label.text }}</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        {{ form.notify_attendees(class="form-check-input", id="notify_attendees") }}
                                        <label class="form-check-label" for="notify_attendees">{{ form.notify_attendees.label.text }}</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        {{ form.apply_more_days(class="form-check-input", id="apply_more_days") }}
                                        <label class="form-check-label" for="apply_more_days">{{ form.apply_more_days.label.text }}</label>
                                    </div>
                                </div>
                                <div class="mb-3 d-none" id="additionalDatesWrapper">
                                    <label class="form-label" for="additional_dates-0">Aplicar também em</label>
                                    <div class="additional-dates-grid" id="additionalDatesContainer" data-next-index="{{ form.additional_dates|length }}">
                                        {% for date_field in form.additional_dates %}
                                            <div class="additional-date-item">
                                                <div class="input-group additional-date-group">
                                                    {{ date_field(class="form-control additional-date-input", type="date", id=date_field.id) }}
                                                    <button type="button" class="btn btn-outline-danger remove-additional-date">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </div>
                                                {% if date_field.errors %}
                                                    <div class="text-danger small mt-1 additional-date-error">{{ date_field.errors[0] }}</div>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addAdditionalDateBtn">
                                        <i class="bi bi-plus-lg me-1"></i>Adicionar outro dia
                                    </button>
                                    {% if form.additional_dates.errors %}
                                        <div class="text-danger mt-2 additional-dates-error">{{ form.additional_dates.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                {{ form.submit(class="btn btn-primary") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal fade"
                 id="eventDetailsModal"
                 tabindex="-1"
                 aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header align-items-start">
                            <div class="flex-grow-1">
                                <div id="detailCreator" class="text-muted small d-none mb-1"></div>
                                <h5 class="modal-title mb-0" id="detailTitle"></h5>
                            </div>
                            <button type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-start">
                            <ul class="list-group text-start">
                                <li class="list-group-item text-start"><strong>Data:</strong> <span id="detailDate"></span></li>
                                <li class="list-group-item text-start">
                                    <strong>Hora:</strong>
                                    <span id="detailStart"></span>
                                    <span id="detailEndWrapper" class="d-none"> - <span id="detailEnd"></span></span>
                                </li>
                                <li class="list-group-item text-start"><strong>Participantes:</strong> <span id="detailParticipants"></span></li>
                                <li class="list-group-item text-start d-none" id="detailOwnerItem"><strong>Proprietário:</strong> <span id="detailOwner"></span></li>
                                <li class="list-group-item text-start"><strong>Status:</strong> <span id="detailStatus"></span></li>
                            </ul>
                            <div id="meetLinkContainer" class="bg-light border rounded p-2 d-flex align-items-center gap-2 mt-3 d-none">
                                <i class="bi bi-camera-video"></i>
                                <a id="detailMeetLink" href="#" target="_blank" class="text-decoration-none flex-grow-1"></a>
                                <button type="button" id="copyMeetLink" class="btn btn-sm btn-outline-secondary" aria-label="Copiar link do Meet">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <form id="deleteMeetingForm" method="post" class="d-none">
                                {{ form.csrf_token(id='csrf_token_delete') }}
                            </form>
                            <div class="me-auto d-flex flex-column flex-sm-row align-items-sm-center gap-2 w-100 d-none" id="statusActionWrapper">
                                <div class="d-flex flex-column">
                                    <label for="statusUpdateSelect" class="form-label mb-0">Status</label>
                                </div>
                                <div class="d-flex flex-column flex-sm-row gap-2 w-100 w-sm-auto">
                                    <select id="statusUpdateSelect" class="form-select form-select-sm">
                                        {% for value, label in meeting_status_options %}
                                            <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="updateStatusBtn">Aplicar</button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                            <button type="button" class="btn btn-primary d-none" id="editEventBtn">Editar</button>
                            <button type="submit"
                                    class="btn btn-danger d-none"
                                    id="deleteEventBtn"
                                    form="deleteMeetingForm">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% if meet_popup_link %}
            <div class="modal fade" id="meetLinkModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered meet-link-modal-dialog">
                    <div class="modal-content meet-link-modal">
                        <div class="modal-header border-0 pb-0">
                            <div class="d-flex align-items-center gap-2">
                                <div class="meet-link-icon rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="bi bi-camera-video-fill"></i>
                                </div>
                                <div>
                                    <h5 class="modal-title mb-0">Sala do Google Meet</h5>
                                    <p class="text-muted small mb-0">Gerencie rapidamente a sua videochamada</p>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-start pt-3">
                            <a id="openMeetLink"
                               href="{{ meet_popup_link }}"
                               target="_blank"
                               class="btn btn-quiet-primary w-100 d-flex align-items-center justify-content-center mb-3">
                                <i class="bi bi-play-circle me-2"></i>Entrar na reunião
                            </a>
                            {% if meet_popup_config_url %}
                            <button type="button"
                                    class="btn btn-quiet-secondary w-100 d-flex align-items-center justify-content-center mb-3"
                                    id="configureMeetBtn"
                                    data-config-url="{{ meet_popup_config_url }}"
                                    data-bs-target="#meetConfigModal"
                                    data-bs-toggle="modal">
                                <i class="bi bi-sliders me-2"></i>Configurar sala do Meet
                            </button>
                            <p class="small text-muted mb-4">
                                Ajuste proprietário, permissões e demais preferências diretamente nas opções da videochamada.
                            </p>
                            {% endif %}
                            <div class="meet-link-card border rounded-3 p-3 d-flex align-items-center gap-2">
                                <div class="meet-link-badge rounded-circle d-flex align-items-center justify-content-center">
                                    <i class="bi bi-link-45deg"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <label for="meetLinkInput" class="form-label small text-uppercase text-muted fw-semibold mb-1">Link do Meet</label>
                                    <input type="text" id="meetLinkInput" class="form-control form-control-sm border-0 p-0 bg-transparent" value="{{ meet_popup_link }}" readonly>
                                </div>
                                <button class="btn btn-icon" id="copyMeetLinkPopup" type="button" aria-label="Copiar link do Meet">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% if meet_popup_config_url %}
            <div class="modal fade" id="meetConfigModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-centered meet-config-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Opções da videochamada</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0 position-relative">
                            <div class="d-flex align-items-center justify-content-center py-5" id="meetConfigSpinner">
                                <div class="spinner-border text-primary" role="status" aria-label="Carregando opções do Meet"></div>
                            </div>
                            <iframe id="meetConfigFrame"
                                    class="w-100 border-0 d-none meet-config-frame"
                                    title="Configurações do Google Meet"
                                    allow="camera; microphone; display-capture;"
                                    referrerpolicy="strict-origin-when-cross-origin"></iframe>
                            <div id="meetConfigFallback" class="d-none text-center py-5 px-4">
                                <i class="bi bi-shield-lock text-primary display-5 d-block mb-3"></i>
                                <h6 class="mb-2">Não foi possível exibir as opções do Meet aqui.</h6>
                                <p class="text-muted mb-4">
                                    Para manter a segurança da videochamada, o Google solicita que essas configurações sejam abertas diretamente em uma página deles.
                                </p>
                                <a id="meetConfigExternalLink" class="btn btn-primary" target="_blank" rel="noopener">
                                    Abrir opções da videochamada
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endif %}
    </div>
    <style>
@import url('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/main.min.css');
.tooltip-warning .tooltip-inner{background-color:#ffc107;color:#000;}
.tooltip-success .tooltip-inner{background-color:#198754;color:#fff;}
.tooltip-danger .tooltip-inner{background-color:#dc3545;color:#fff;}
.tooltip-warning .tooltip-arrow::before{border-top-color:#ffc107;border-bottom-color:#ffc107;border-left-color:#ffc107;border-right-color:#ffc107;}
.tooltip-success .tooltip-arrow::before{border-top-color:#198754;border-bottom-color:#198754;border-left-color:#198754;border-right-color:#198754;}
.tooltip-danger .tooltip-arrow::before{border-top-color:#dc3545;border-bottom-color:#dc3545;border-left-color:#dc3545;border-right-color:#dc3545;}
.fc-daygrid-dot-event{display:flex;align-items:center;padding:0;border:none;background:none;}
.fc-daygrid-dot-event .fc-event-dot{width:14px;height:14px;border-radius:50%;margin-right:4px;border:none;}
.meet-config-modal .modal-content{min-height:70vh;}
.meet-config-frame{min-height:70vh;}
    </style>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/multimonth/index.global.min.js"></script>
    <script>
    function showFlashMessage(message, category = 'success') {
        let container = document.querySelector('.flash-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'flash-container';
            document.body.appendChild(container);
        }
        const iconMap = {
            success: 'check-circle-fill',
            info: 'info-circle-fill',
            warning: 'exclamation-triangle-fill',
            danger: 'exclamation-octagon-fill'
        };
        const icon = iconMap[category] || 'info-circle-fill';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${category} alert-dismissible fade show`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `<i class="bi bi-${icon} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>`;
        container.appendChild(alertDiv);
        setTimeout(() => {
            bootstrap.Alert.getOrCreateInstance(alertDiv).close();
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
    var currentEvent;
    var calendarEl = document.getElementById('calendar');
    var applyMoreDaysCheckbox = document.getElementById('apply_more_days');
    var additionalDatesWrapper = document.getElementById('additionalDatesWrapper');
    var additionalDatesContainer = document.getElementById('additionalDatesContainer');
    var addAdditionalDateBtn = document.getElementById('addAdditionalDateBtn');
    var ownerWrapper = document.getElementById('ownerFieldWrapper');
    var ownerSelect = document.getElementById('owner_id');
    var participantCheckboxes = Array.from(document.querySelectorAll('#meetingModal input[name="participants"]'));
    var statusWrapper = document.getElementById('statusActionWrapper');
    var statusSelect = document.getElementById('statusUpdateSelect');
    var updateStatusBtn = document.getElementById('updateStatusBtn');
    var csrfTokenField = document.getElementById('csrf_token_delete');

    function applyStatusToEvent(event, meta) {
        if (!event || !meta) {
            return;
        }
        if (meta.label) {
            event.setExtendedProp('status', meta.label);
        }
        if (meta.value) {
            event.setExtendedProp('status_value', meta.value);
        }
        if (typeof meta.disable_meet_link !== 'undefined') {
            event.setExtendedProp('disable_meet_link', !!meta.disable_meet_link);
        }
        if (typeof meta.tooltip_class !== 'undefined') {
            event.setExtendedProp('tooltip_class', meta.tooltip_class || '');
        }
        if (typeof meta.can_update_status !== 'undefined') {
            event.setExtendedProp('can_update_status', !!meta.can_update_status);
        }
        if (meta.color) {
            event.setProp('backgroundColor', meta.color);
            event.setProp('borderColor', meta.color);
        }
        if (meta.text_color) {
            event.setProp('textColor', meta.text_color);
        }
        var el = event.el;
        if (el) {
            var tip = bootstrap.Tooltip.getInstance(el);
            if (tip) { tip.dispose(); }
            var time = event.allDay ? '' : event.startStr.substring(11,16);
            if (meta.tooltip_class) {
                el.setAttribute('data-bs-custom-class', meta.tooltip_class);
            } else {
                el.removeAttribute('data-bs-custom-class');
            }
            el.setAttribute('title', time + ' ' + event.title);
            new bootstrap.Tooltip(el);
        }
    }

    function updateMeetLinkControls(event) {
        var linkContainer = document.getElementById('meetLinkContainer');
        var linkEl = document.getElementById('detailMeetLink');
        var copyBtn = document.getElementById('copyMeetLink');
        if (!linkContainer || !linkEl || !copyBtn) {
            return;
        }
        var meetLink = event && event.extendedProps ? event.extendedProps.meet_link : null;
        if (meetLink) {
            linkEl.textContent = meetLink;
            linkContainer.classList.remove('d-none');
            var disableLink = !!event.extendedProps.disable_meet_link;
            if (disableLink) {
                linkEl.removeAttribute('href');
                linkEl.classList.add('text-muted', 'user-select-none');
                linkEl.style.pointerEvents = 'none';
                copyBtn.classList.add('d-none');
                copyBtn.onclick = null;
            } else {
                linkEl.href = meetLink;
                linkEl.classList.remove('text-muted', 'user-select-none');
                linkEl.style.pointerEvents = '';
                copyBtn.classList.remove('d-none');
                copyBtn.onclick = function() {
                    navigator.clipboard.writeText(meetLink).then(function(){
                        showFlashMessage('Link copiado!', 'success');
                    });
                };
            }
        } else {
            linkContainer.classList.add('d-none');
            linkEl.textContent = '';
            linkEl.removeAttribute('href');
            linkEl.classList.remove('text-muted', 'user-select-none');
            linkEl.style.pointerEvents = '';
            copyBtn.classList.add('d-none');
            copyBtn.onclick = null;
        }
    }

    function updateOwnerFieldVisibility() {
        if (!ownerSelect || !ownerWrapper) {
            return;
        }
        var selectedIds = participantCheckboxes
            .filter(function(cb) { return cb.checked; })
            .map(function(cb) { return cb.value; });
        var ownerValueBefore = ownerSelect.value;
        Array.from(ownerSelect.options).forEach(function(option) {
            if (option.value === '') {
                option.disabled = selectedIds.length <= 1;
                option.hidden = selectedIds.length <= 1;
                return;
            }
            var isParticipant = selectedIds.includes(option.value);
            option.disabled = !isParticipant;
            option.hidden = !isParticipant;
        });
        if (selectedIds.length <= 1) {
            ownerWrapper.classList.add('d-none');
            if (selectedIds.length === 1) {
                ownerSelect.value = selectedIds[0];
            } else {
                ownerSelect.value = '';
            }
        } else {
            ownerWrapper.classList.remove('d-none');
            if (!selectedIds.includes(ownerValueBefore)) {
                ownerSelect.value = '';
            }
        }
    }

    participantCheckboxes.forEach(function(cb) {
        cb.addEventListener('change', updateOwnerFieldVisibility);
    });
    updateOwnerFieldVisibility();

    function renumberAdditionalDates() {
        if (!additionalDatesContainer) {
            return;
        }
        var items = additionalDatesContainer.querySelectorAll('.additional-date-item');
        items.forEach(function(item, index) {
            var input = item.querySelector('.additional-date-input');
            if (input) {
                input.name = 'additional_dates-' + index;
                input.id = 'additional_dates-' + index;
            }
        });
        additionalDatesContainer.dataset.nextIndex = String(items.length);
    }

    function updateRemoveButtons() {
        if (!additionalDatesContainer) {
            return;
        }
        var items = additionalDatesContainer.querySelectorAll('.additional-date-item');
        items.forEach(function(item) {
            var removeBtn = item.querySelector('.remove-additional-date');
            if (!removeBtn) {
                return;
            }
            if (items.length > 1) {
                removeBtn.classList.remove('d-none');
            } else {
                removeBtn.classList.add('d-none');
            }
        });
    }

    function attachRemoveHandler(button) {
        if (!button) {
            return;
        }
        button.addEventListener('click', function() {
            if (!additionalDatesContainer) {
                return;
            }
            var item = button.closest('.additional-date-item');
            if (!item) {
                return;
            }
            var items = additionalDatesContainer.querySelectorAll('.additional-date-item');
            if (items.length === 1) {
                var input = item.querySelector('.additional-date-input');
                if (input) {
                    input.value = '';
                }
                item.querySelectorAll('.additional-date-error').forEach(function(err) {
                    err.remove();
                });
                return;
            }
            item.remove();
            renumberAdditionalDates();
            updateRemoveButtons();
        });
    }

    function clearAdditionalDates() {
        if (!additionalDatesContainer) {
            return;
        }
        var items = additionalDatesContainer.querySelectorAll('.additional-date-item');
        items.forEach(function(item, index) {
            if (index === 0) {
                var input = item.querySelector('.additional-date-input');
                if (input) {
                    input.value = '';
                }
                item.querySelectorAll('.additional-date-error').forEach(function(err) {
                    err.remove();
                });
            } else {
                item.remove();
            }
        });
        if (additionalDatesWrapper) {
            additionalDatesWrapper.querySelectorAll('.additional-dates-error').forEach(function(err) {
                err.remove();
            });
        }
        renumberAdditionalDates();
        updateRemoveButtons();
    }

    function addAdditionalDateField(value) {
        if (!additionalDatesContainer) {
            return;
        }
        var item = document.createElement('div');
        item.className = 'additional-date-item';
        var group = document.createElement('div');
        group.className = 'input-group additional-date-group';
        var input = document.createElement('input');
        input.type = 'date';
        input.className = 'form-control additional-date-input';
        if (value) {
            input.value = value;
        }
        var removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-outline-danger remove-additional-date';
        removeBtn.innerHTML = '<i class="bi bi-x-lg"></i>';
        group.appendChild(input);
        group.appendChild(removeBtn);
        item.appendChild(group);
        additionalDatesContainer.appendChild(item);
        attachRemoveHandler(removeBtn);
        renumberAdditionalDates();
        updateRemoveButtons();
    }

    function toggleAdditionalDates() {
        if (!applyMoreDaysCheckbox || !additionalDatesWrapper) {
            return;
        }
        if (applyMoreDaysCheckbox.checked) {
            additionalDatesWrapper.classList.remove('d-none');
            if (
                additionalDatesContainer &&
                additionalDatesContainer.querySelectorAll('.additional-date-item').length === 0
            ) {
                addAdditionalDateField('');
            }
            updateRemoveButtons();
        } else {
            additionalDatesWrapper.classList.add('d-none');
            clearAdditionalDates();
        }
    }

    if (additionalDatesContainer) {
        renumberAdditionalDates();
        additionalDatesContainer.querySelectorAll('.remove-additional-date').forEach(attachRemoveHandler);
        updateRemoveButtons();
    }

    if (addAdditionalDateBtn) {
        addAdditionalDateBtn.addEventListener('click', function() {
            addAdditionalDateField('');
        });
    }

    if (applyMoreDaysCheckbox) {
        applyMoreDaysCheckbox.addEventListener('change', toggleAdditionalDates);
        toggleAdditionalDates();
    }
    function openNewMeeting(dateStr) {
        var form = document.querySelector('#meetingModal form');
        form.reset();
        if (applyMoreDaysCheckbox) {
            applyMoreDaysCheckbox.checked = false;
        }
        clearAdditionalDates();
        toggleAdditionalDates();
        if (ownerSelect) {
            ownerSelect.value = '';
        }
        updateOwnerFieldVisibility();
        document.getElementById('meeting_id').value = '';
        var courseInput = document.getElementById('meeting_course_id');
        if (courseInput) {
            courseInput.value = '';
        }
        if (dateStr) { form.date.value = dateStr; }
        document.querySelector('#meetingModal .modal-title').textContent = 'Agendar Reunião';
        document.querySelector('#meetingModal input[type="submit"]').value = 'Agendar';
        var meetingModal = new bootstrap.Modal(document.getElementById('meetingModal'));
        meetingModal.show();
    }
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        fixedWeekCount: false,
        timeZone: '{{ calendar_timezone }}',
        locale: 'pt-br',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridDay,timeGridWeek,dayGridMonth,multiMonthYear'
        },
        navLinks: true,
        buttonText: {
            today: 'Hoje',
            dayGridDay: 'Dia',
            timeGridWeek: 'Semana',
            dayGridMonth: 'Mês',
            multiMonthYear: 'Ano'
        },
        views: {
            multiMonthYear: {
                type: 'multiMonth',
                duration: { years: 1 },
                multiMonthMaxColumns: 3,
                multiMonthMinWidth: 220,
                titleFormat: { year: 'numeric' }
            }
        },
        dateClick: function(info) {
            openNewMeeting(info.dateStr);
        },
        eventDidMount: function(info) {
            var time = info.event.allDay ? '' : info.event.startStr.substring(11,16);
            var cls = info.event.extendedProps.tooltip_class || '';
            info.el.setAttribute('data-bs-toggle', 'tooltip');
            info.el.setAttribute('data-bs-html', 'true');
            if (cls) {
                info.el.setAttribute('data-bs-custom-class', cls);
            } else {
                info.el.removeAttribute('data-bs-custom-class');
            }
            info.el.setAttribute('title', time + ' ' + info.event.title);
            new bootstrap.Tooltip(info.el);
        },
        eventClick: function(info) {
            info.jsEvent.preventDefault();
            var e = info.event;
            currentEvent = e;
            document.getElementById('detailTitle').textContent = e.title;
            var creatorEl = document.getElementById('detailCreator');
            if (e.extendedProps.creator) {
                creatorEl.textContent = 'Criado por: ' + e.extendedProps.creator;
                creatorEl.classList.remove('d-none');
            } else {
                creatorEl.textContent = '';
                creatorEl.classList.add('d-none');
            }
            var dateParts = e.startStr.slice(0,10).split('-');
            document.getElementById('detailDate').textContent = dateParts.reverse().join('/');
            document.getElementById('detailStart').textContent = e.startStr.slice(11,16);
            var endWrapper = document.getElementById('detailEndWrapper');
            var endEl = document.getElementById('detailEnd');
            if (endEl && endWrapper) {
                if (e.endStr) {
                    endEl.textContent = e.endStr.slice(11,16);
                    endWrapper.classList.remove('d-none');
                } else {
                    endEl.textContent = '';
                    endWrapper.classList.add('d-none');
                }
            }
            var statusText = e.extendedProps.status || '';
            var statusEl = document.getElementById('detailStatus');
            if (statusEl) {
                statusEl.textContent = statusText;
            }
            if (statusWrapper && statusSelect) {
                if (e.extendedProps.can_update_status && e.extendedProps.status_value) {
                    statusWrapper.classList.remove('d-none');
                    statusSelect.value = e.extendedProps.status_value;
                    if (statusSelect.value !== e.extendedProps.status_value) {
                        statusSelect.value = '';
                    }
                    if (updateStatusBtn) {
                        updateStatusBtn.disabled = false;
                        updateStatusBtn.classList.remove('disabled');
                    }
                } else {
                    statusWrapper.classList.add('d-none');
                }
            }
            var participants = e.extendedProps.participants;
            document.getElementById('detailParticipants').textContent = participants ? participants.join(', ') : '';
            var ownerItem = document.getElementById('detailOwnerItem');
            var ownerEl = document.getElementById('detailOwner');
            if (ownerEl && ownerItem) {
                var ownerName = e.extendedProps.owner_name;
                if (ownerName) {
                    ownerEl.textContent = ownerName;
                    ownerItem.classList.remove('d-none');
                } else {
                    ownerEl.textContent = '';
                    ownerItem.classList.add('d-none');
                }
            }
            updateMeetLinkControls(e);
            var editBtn = document.getElementById('editEventBtn');
            var deleteBtn = document.getElementById('deleteEventBtn');
            var deleteForm = document.getElementById('deleteMeetingForm');
            if (e.extendedProps.can_edit) {
                editBtn.classList.remove('d-none');
            } else {
                editBtn.classList.add('d-none');
            }
            if (deleteBtn && deleteForm) {
                if (e.extendedProps.can_delete) {
                    deleteBtn.classList.remove('d-none');
                    deleteForm.action = '/reuniao/' + encodeURIComponent(e.id) + '/delete';
                    deleteForm.dataset.eventTitle = e.title || '';
                } else {
                    deleteBtn.classList.add('d-none');
                    deleteForm.removeAttribute('action');
                    deleteForm.removeAttribute('data-event-title');
                }
            }
            var modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
            modal.show();
        }
    });
    calendar.render();
    function refreshStatuses() {
        fetch('/api/reunioes')
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                var newIds = new Set();
                data.forEach(function(evData) {
                    var id = String(evData.id);
                    newIds.add(id);
                    var existing = calendar.getEventById(id);
                    if (existing) {
                        if (existing.startStr !== evData.start || existing.endStr !== evData.end) {
                            existing.setDates(evData.start, evData.end);
                        }
                        if (existing.title !== evData.title) {
                            existing.setProp('title', evData.title);
                        }
                        if (existing.extendedProps.status !== evData.status) {
                            existing.setExtendedProp('status', evData.status);
                        }
                        if (existing.extendedProps.status_value !== evData.status_value) {
                            existing.setExtendedProp('status_value', evData.status_value);
                        }
                        if (existing.extendedProps.can_edit !== evData.can_edit) {
                            existing.setExtendedProp('can_edit', evData.can_edit);
                        }
                        if (existing.extendedProps.can_delete !== evData.can_delete) {
                            existing.setExtendedProp('can_delete', evData.can_delete);
                        }
                        if (existing.extendedProps.can_update_status !== evData.can_update_status) {
                            existing.setExtendedProp('can_update_status', evData.can_update_status);
                        }
                        if (existing.extendedProps.course_id !== evData.course_id) {
                            existing.setExtendedProp('course_id', evData.course_id);
                        }
                        if (existing.extendedProps.owner_id !== evData.owner_id) {
                            existing.setExtendedProp('owner_id', evData.owner_id);
                        }
                        if (existing.extendedProps.owner_name !== evData.owner_name) {
                            existing.setExtendedProp('owner_name', evData.owner_name);
                        }
                        if (existing.extendedProps.meet_link !== evData.meet_link) {
                            existing.setExtendedProp('meet_link', evData.meet_link);
                        }
                        if (existing.extendedProps.tooltip_class !== evData.tooltip_class) {
                            existing.setExtendedProp('tooltip_class', evData.tooltip_class);
                        }
                        if (!!existing.extendedProps.disable_meet_link !== !!evData.disable_meet_link) {
                            existing.setExtendedProp('disable_meet_link', !!evData.disable_meet_link);
                        }
                        if (existing.extendedProps.participants !== evData.participants) {
                            existing.setExtendedProp('participants', evData.participants);
                        }
                        if (existing.extendedProps.participant_ids !== evData.participant_ids) {
                            existing.setExtendedProp('participant_ids', evData.participant_ids);
                        }
                        if (existing.extendedProps.description !== evData.description) {
                            existing.setExtendedProp('description', evData.description);
                        }
                        if (existing.extendedProps.creator !== evData.creator) {
                            existing.setExtendedProp('creator', evData.creator);
                        }
                        if (existing.backgroundColor !== evData.color) {
                            existing.setProp('backgroundColor', evData.color);
                            existing.setProp('borderColor', evData.color);
                        }
                        if (existing.textColor !== evData.textColor) {
                            existing.setProp('textColor', evData.textColor);
                        }
                        var el = existing.el;
                        if (el) {
                            var tip = bootstrap.Tooltip.getInstance(el);
                            if (tip) { tip.dispose(); }
                            var time = existing.allDay ? '' : existing.startStr.substring(11,16);
                            var cls = existing.extendedProps.tooltip_class || '';
                            el.setAttribute('data-bs-custom-class', cls);
                            el.setAttribute('title', time + ' ' + existing.title);
                            new bootstrap.Tooltip(el);
                        }
                        if (currentEvent && currentEvent.id === existing.id) {
                            updateMeetLinkControls(currentEvent);
                            if (statusWrapper && !statusWrapper.classList.contains('d-none') && statusSelect) {
                                var updatedStatusValue = currentEvent.extendedProps.status_value || '';
                                statusSelect.value = updatedStatusValue;
                                if (statusSelect.value !== updatedStatusValue) {
                                    statusSelect.value = '';
                                }
                            }
                            var detailStatusEl = document.getElementById('detailStatus');
                            if (detailStatusEl && currentEvent.extendedProps.status) {
                                detailStatusEl.textContent = currentEvent.extendedProps.status;
                            }
                        }
                    } else {
                        var newEvent = Object.assign({}, evData, { id: String(evData.id) });
                        calendar.addEvent(newEvent);
                    }
                });
                calendar.getEvents().forEach(function(ev) {
                    if (!newIds.has(ev.id)) {
                        ev.remove();
                    }
                });
            });
    }
    refreshStatuses();
    setInterval(refreshStatuses, 5000);

    if (updateStatusBtn && statusSelect) {
        updateStatusBtn.addEventListener('click', function() {
            if (!currentEvent || !currentEvent.extendedProps) {
                return;
            }
            if (!currentEvent.extendedProps.can_update_status) {
                showFlashMessage('Você não tem permissão para alterar o status desta reunião.', 'warning');
                return;
            }
            var selectedStatus = statusSelect.value;
            if (!selectedStatus) {
                showFlashMessage('Selecione um status para atualizar.', 'warning');
                return;
            }
            var meetingId = currentEvent.extendedProps.meeting_id || currentEvent.id;
            if (!meetingId) {
                showFlashMessage('Não foi possível identificar a reunião selecionada.', 'danger');
                return;
            }
            var headers = { 'Content-Type': 'application/json' };
            var csrfToken = csrfTokenField ? csrfTokenField.value : null;
            if (csrfToken) {
                headers['X-CSRFToken'] = csrfToken;
                headers['X-CSRF-Token'] = csrfToken;
            }
            updateStatusBtn.disabled = true;
            updateStatusBtn.classList.add('disabled');
            fetch('/reuniao/' + encodeURIComponent(meetingId) + '/status', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ status: selectedStatus })
            })
                .then(function(resp) {
                    if (!resp.ok) {
                        return resp.json().then(function(data) { throw data; }).catch(function() {
                            throw { success: false, message: 'Erro ao atualizar o status.' };
                        });
                    }
                    return resp.json();
                })
                .then(function(data) {
                    if (!data.success) {
                        throw data;
                    }
                    var meta = data.status || {};
                    applyStatusToEvent(currentEvent, meta);
                    var statusEl = document.getElementById('detailStatus');
                    if (statusEl && meta.label) {
                        statusEl.textContent = meta.label;
                    }
                    if (meta.value && statusSelect.value !== meta.value) {
                        statusSelect.value = meta.value;
                    }
                    updateMeetLinkControls(currentEvent);
                    showFlashMessage(data.message || 'Status atualizado com sucesso.', 'success');
                })
                .catch(function(err) {
                    var message = 'Não foi possível atualizar o status.';
                    if (err && typeof err.message === 'string') {
                        message = err.message;
                    }
                    showFlashMessage(message, 'danger');
                })
                .finally(function() {
                    updateStatusBtn.disabled = false;
                    updateStatusBtn.classList.remove('disabled');
                });
        });
    }

    var eventDetailsModalEl = document.getElementById('eventDetailsModal');
    if (eventDetailsModalEl) {
        eventDetailsModalEl.addEventListener('hidden.bs.modal', function() {
            if (statusWrapper) {
                statusWrapper.classList.add('d-none');
            }
            if (updateStatusBtn) {
                updateStatusBtn.disabled = false;
                updateStatusBtn.classList.remove('disabled');
            }
        });
    }

    document.getElementById('editEventBtn').addEventListener('click', function() {
        var detailModal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
        detailModal.hide();
        var form = document.querySelector('#meetingModal form');
        document.getElementById('meeting_id').value = currentEvent.id || '';
        var courseInput = document.getElementById('meeting_course_id');
        if (courseInput) {
            courseInput.value = currentEvent.extendedProps.course_id || '';
        }
        form.subject.value = currentEvent.title;
        var start = currentEvent.startStr;
        var end = currentEvent.endStr;
        form.date.value = start.slice(0,10);
        form.start_time.value = start.slice(11,16);
        form.end_time.value = end ? end.slice(11,16) : '';
        form.description.value = currentEvent.extendedProps.description || '';
        if (form.create_meet) {
            form.create_meet.checked = !!currentEvent.extendedProps.meet_link;
        }
        if (form.notify_attendees) {
            form.notify_attendees.checked = false;
        }
        if (form.apply_more_days) {
            form.apply_more_days.checked = false;
        }
        clearAdditionalDates();
        toggleAdditionalDates();
        var ids = currentEvent.extendedProps.participant_ids || [];
        participantCheckboxes.forEach(function(cb){
            cb.checked = ids.includes(parseInt(cb.value));
        });
        updateOwnerFieldVisibility();
        if (ownerSelect) {
            var ownerId = currentEvent.extendedProps.owner_id;
            if (ownerId) {
                ownerSelect.value = String(ownerId);
                if (ownerSelect.value !== String(ownerId)) {
                    ownerSelect.value = '';
                }
            } else {
                ownerSelect.value = '';
            }
        }
        document.querySelector('#meetingModal .modal-title').textContent = 'Editar Reunião';
        document.querySelector('#meetingModal input[type="submit"]').value = 'Salvar';
        var meetingModal = new bootstrap.Modal(document.getElementById('meetingModal'));
        meetingModal.show();
        hasShownSubmissionMessage = false;
        if (meetingForm) {
            var submitButton = meetingForm.querySelector('input[type="submit"], button[type="submit"]');
            if (submitButton) {
                submitButton.removeAttribute('disabled');
                submitButton.classList.remove('disabled');
            }
        }
    });

    var deleteMeetingForm = document.getElementById('deleteMeetingForm');
    if (deleteMeetingForm) {
        deleteMeetingForm.addEventListener('submit', function(event) {
            var title = deleteMeetingForm.dataset.eventTitle || '';
            var promptMessage = title ?
                'Deseja excluir a reunião "' + title + '"?' :
                'Deseja excluir esta reunião?';
            if (!confirm(promptMessage)) {
                event.preventDefault();
            }
        });
    }

    var meetingForm = document.querySelector('#meetingModal form');
    var hasShownSubmissionMessage = false;
    if (meetingForm) {
        meetingForm.addEventListener('submit', function(event) {
            if (!hasShownSubmissionMessage) {
                hasShownSubmissionMessage = true;
                var submitButton = meetingForm.querySelector('input[type="submit"], button[type="submit"]');
                if (submitButton) {
                    submitButton.setAttribute('disabled', 'disabled');
                    submitButton.classList.add('disabled');
                }
                showFlashMessage('Por gentileza, aguarde enquanto finalizamos o agendamento da reunião.', 'info');
            }
        });
    }

    document.getElementById('openMeetingModal').addEventListener('click', function() {
        openNewMeeting('');
        hasShownSubmissionMessage = false;
        if (meetingForm) {
            var submitButton = meetingForm.querySelector('input[type="submit"], button[type="submit"]');
            if (submitButton) {
                submitButton.removeAttribute('disabled');
                submitButton.classList.remove('disabled');
            }
        }
    });
    });
    </script>
    {% if meet_popup_link %}
        <script>
    document.addEventListener('DOMContentLoaded', function() {
        var popup = new bootstrap.Modal(document.getElementById('meetLinkModal'));
        document.getElementById('copyMeetLinkPopup').addEventListener('click', function() {
            navigator.clipboard.writeText(document.getElementById('meetLinkInput').value).then(function(){
                showFlashMessage('Link copiado!', 'success');
            });
        });
        var configureBtn = document.getElementById('configureMeetBtn');
        var configModalEl = document.getElementById('meetConfigModal');
        var configFrame = document.getElementById('meetConfigFrame');
        var configSpinner = document.getElementById('meetConfigSpinner');
        var configFallback = document.getElementById('meetConfigFallback');
        var configExternalLink = document.getElementById('meetConfigExternalLink');
        var configModal = configModalEl ? new bootstrap.Modal(configModalEl, {focus: true}) : null;
        var fallbackTimer = null;
        if (configureBtn && configModal && configFrame && configSpinner) {
            configureBtn.addEventListener('click', function() {
                var url = configureBtn.getAttribute('data-config-url');
                if (!url) {
                    return;
                }
                if (configExternalLink) {
                    configExternalLink.href = url;
                }
                if (configFallback) {
                    configFallback.classList.add('d-none');
                }
                configSpinner.classList.remove('d-none');
                configFrame.classList.add('d-none');
                if (configFrame.src !== url) {
                    configFrame.src = url;
                }
                if (fallbackTimer) {
                    clearTimeout(fallbackTimer);
                }
                fallbackTimer = setTimeout(function() {
                    if (!configFrame.classList.contains('d-none')) {
                        return;
                    }
                    configSpinner.classList.add('d-none');
                    if (configFallback) {
                        configFallback.classList.remove('d-none');
                    }
                }, 4000);
            });
            configFrame.addEventListener('load', function() {
                if (fallbackTimer) {
                    clearTimeout(fallbackTimer);
                    fallbackTimer = null;
                }
                configSpinner.classList.add('d-none');
                var shouldFallback = false;
                try {
                    var doc = configFrame.contentDocument;
                    if (!doc || !doc.body) {
                        shouldFallback = true;
                    } else {
                        var text = doc.body.innerText || '';
                        shouldFallback = text.trim().startsWith('403');
                    }
                } catch (err) {
                    shouldFallback = true;
                }
                if (shouldFallback) {
                    configFrame.classList.add('d-none');
                    if (configFallback) {
                        configFallback.classList.remove('d-none');
                    }
                } else {
                    configFrame.classList.remove('d-none');
                    if (configFallback) {
                        configFallback.classList.add('d-none');
                    }
                }
            });
            configModalEl.addEventListener('hidden.bs.modal', function() {
                if (fallbackTimer) {
                    clearTimeout(fallbackTimer);
                    fallbackTimer = null;
                }
                configFrame.src = 'about:blank';
                configSpinner.classList.remove('d-none');
                configFrame.classList.add('d-none');
                if (configFallback) {
                    configFallback.classList.add('d-none');
                }
            });
        }
        popup.show();
    });
        </script>
    {% endif %}
    {% if show_modal %}
        <script>
document.addEventListener('DOMContentLoaded', function() {
    var modal = new bootstrap.Modal(document.getElementById('meetingModal'));
    modal.show();
});
        </script>
    {% endif %}
{% endblock %}
