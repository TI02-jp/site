{% extends "base.html" %}

{% block title %}SALA DE REUNIÕES{% endblock %}

{% block sidebar_nav %}
<div class="nav-section">
    <div class="nav-section-title">PRINCIPAL</div>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('dashboard') }}">
                <i class="bi bi-list-task"></i>
                PARTICULARIDADES
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="https://app.acessorias.com/sysmain.php" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right"></i>
                ACESSÓRIAS
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="https://auth.sieg.com/login" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right"></i>
                SIEG
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('consultorias') }}">
                <i class="bi bi-buildings"></i>
                CONSULTORIAS
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" href="{{ url_for('sala_reunioes') }}">
                <i class="bi bi-calendar-event"></i>
                SALA DE REUNIÕES
            </a>
        </li>
    </ul>
</div>
<style>
    .content-breadcrumb { display: none; }
</style>
{% endblock %}

{% block content %}
<header class="py-5 text-white text-center" style="background-color: var(--primary);">
    <h1 class="display-4 mb-0"><i class="bi bi-calendar-event me-3"></i>AGENDA DA SALA DE REUNIÕES</h1>
</header>
<div class="container my-4">
    <p class="text-muted">Aqui você poderá consultar a agenda da sala de reuniões.</p>
    {% if current_user.role == 'admin' %}
    <div class="text-end mb-3">
        <a href="{{ url_for('novo_evento') }}" class="btn btn-primary">Criar Evento</a>
    </div>
    {% endif %}
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a class="btn btn-outline-primary" href="{{ url_for('sala_reunioes', year=prev_month.year, month=prev_month.month) }}">&lt;</a>
        <h3 class="mb-0">{{ display_date.strftime('%B %Y')|title }}</h3>
        <a class="btn btn-outline-primary" href="{{ url_for('sala_reunioes', year=next_month.year, month=next_month.month) }}">&gt;</a>
    </div>
    <table class="table text-center" id="calendar">
        <thead>
            <tr>
                <th>Dom</th>
                <th>Seg</th>
                <th>Ter</th>
                <th>Qua</th>
                <th>Qui</th>
                <th>Sex</th>
                <th>Sáb</th>
            </tr>
        </thead>
        <tbody>
            {% for week in weeks %}
            <tr>
                {% for day in week %}
                {% set iso = day.isoformat() %}
                <td class="day{% if day.month != display_date.month %} text-muted{% endif %}{% if iso in events_by_date %} has-event{% endif %}{% if day == today %} today{% endif %}" data-date="{{ iso }}">{{ day.day }}</td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="event-list" class="mt-4"></div>
    <style>
        #calendar {
            border-collapse: collapse;
            width: 100%;
        }
        #calendar th, #calendar td {
            width: 14.285%;
            height: 80px;
        }
        #calendar td {
            cursor: pointer;
            position: relative;
            border-radius: 6px;
            vertical-align: top;
            padding-top: 8px;
        }
        #calendar td:hover {
            background-color: #f0f0f0;
        }
        #calendar td.today, #calendar td.selected {
            border: 2px solid var(--primary);
        }
        #calendar td.has-event::after {
            content: '';
            width: 6px;
            height: 6px;
            background-color: var(--primary);
            border-radius: 50%;
            position: absolute;
            bottom: 4px;
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
    <script>
    const events = {{ events_by_date|tojson }};
    let selected = null;
    function showEvents(td) {
        const iso = td.dataset.date;
        const list = events[iso] || [];
        let html = `<h4>Eventos em ${new Date(iso).toLocaleDateString('pt-BR')}</h4>`;
        if (list.length === 0) {
            html += '<p>Nenhum evento.</p>';
        } else {
            html += '<ul class="list-unstyled">';
            list.forEach(ev => {
                html += `<li><strong>${ev.inicio} - ${ev.fim}</strong> ${ev.evento} (${ev.usuario})</li>`;
            });
            html += '</ul>';
        }
        document.getElementById('event-list').innerHTML = html;
    }
    document.querySelectorAll('#calendar td').forEach(td => {
        td.addEventListener('click', () => {
            if (selected) selected.classList.remove('selected');
            selected = td;
            td.classList.add('selected');
            showEvents(td);
        });
    });
    const todayCell = document.querySelector('#calendar td.today');
    if (todayCell) {
        todayCell.classList.add('selected');
        showEvents(todayCell);
    }
    </script>
</div>
{% endblock %}
