{% set raw_report_links = [
    ("relatorio_empresas", "Empresas", "bi-building", "empresas"),
    ("relatorio_fiscal", "Fiscal", "bi-receipt-cutoff", "fiscal"),
    ("relatorio_contabil", "Contábil", "bi-calculator", "contabil"),
    ("relatorio_tarefas", "Tarefas", "bi-list-check", "tarefas"),
    ("relatorio_cursos", "Cursos", "bi-mortarboard", "cursos"),
    ("relatorio_usuarios", "Usuários", "bi-person-gear", "usuarios"),
    ("relatorios_consultorias", "Consultorias", "bi-bar-chart", "consultorias"),
] %}
{% if current_user.is_master or current_user.role == 'admin' %}
    {% set raw_report_links = [("report_permissions", "Permissões", "bi-shield-check", None)] + raw_report_links %}
{% endif %}
{% set ns = namespace(visible_links=[]) %}
{% for endpoint, label, icon, code in raw_report_links %}
    {% if code %}
        {% set allowed = has_report_access(code) %}
    {% else %}
        {% set allowed = has_report_access() %}
    {% endif %}
    {% if allowed %}
        {% set _ = ns.visible_links.append((endpoint, label, icon)) %}
    {% endif %}
{% endfor %}
{% set active_endpoint = request.endpoint or "" %}
{% set report_endpoints = ns.visible_links | map(attribute=0) | list %}
{% set is_reports_section_active = active_endpoint in report_endpoints %}
{% set collapse_target = collapse_id or "reportsMenu" %}
{% set show_reports = ns.visible_links | length > 0 %}
{% if show_reports %}
<li class="nav-item nav-item--reports">
    <a
        class="nav-link nav-link-toggle{% if is_reports_section_active %} active{% endif %}"
        data-bs-toggle="collapse"
        data-sidebar-toggle="{{ collapse_target }}"
        href="#{{ collapse_target }}"
        role="button"
        aria-expanded="{{ 'true' if is_reports_section_active else 'false' }}"
        aria-controls="{{ collapse_target }}"
    >
        <i class="bi bi-graph-up"></i>
        <span>Relatórios</span>
        <i class="bi bi-chevron-down toggle-icon ms-auto"></i>
    </a>
    <div class="collapse nav-submenu-container{% if is_reports_section_active %} show{% endif %}" id="{{ collapse_target }}">
        <ul class="nav flex-column nav-submenu">
            {% for endpoint, label, icon in ns.visible_links %}
            <li class="nav-subitem">
                <a
                    class="nav-sublink{% if active_endpoint == endpoint %} active{% endif %}"
                    href="{{ url_for(endpoint) }}"
                >
                    <i class="bi {{ icon }}"></i>
                    <span>{{ label }}</span>
                </a>
            </li>
            {% endfor %}
        </ul>
    </div>
</li>
{% endif %}
