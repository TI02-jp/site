{% extends "base.html" %}

{% block title %}Visualizar Tarefa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename=asset('tasks.css')) }}">
{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="new-task-container">
  <section class="kanban" style="gap: 1rem;">
    <div class="kanban-form">
      {% if task.parent %}
      <div class="form-group form-group-full">
        <label>Tarefa Pai</label>
        <input type="text" value="{{ task.parent.title }}" disabled>
      </div>
      {% endif %}

      <div class="form-group form-group-setor">
        <label>Setor</label>
        {% set tag_label = 'Para Mim' if task.is_private and task.created_by == current_user.id else task.tag.nome %}
        <input type="text" value="{{ tag_label }}" disabled>
      </div>

      <div class="form-group form-group-usuario">
        <label>Usuário</label>
        <input type="text" value="{{ task.assignee.name if task.assignee else 'Sem responsável' }}" disabled>
      </div>

      <div class="form-group form-group-usuario">
        <label>Criada por</label>
        <input type="text" value="{{ task.creator.name if task.creator else 'Não informado' }}" disabled>
      </div>

      <div class="form-group form-group-titulo">
        <label>Título</label>
        <input type="text" value="{{ task.title }}" disabled>
      </div>

      <div class="form-group form-group-descricao">
        <label>Descrição</label>
        <textarea rows="4" disabled>{{ task.description or '' }}</textarea>
      </div>

      {% if task.attachments %}
      <div class="form-group form-group-full">
        <label>Anexos</label>
        <div class="d-grid gap-2">
          {% for attachment in task.attachments %}
          <div class="announcement-modal-attachment border rounded p-2">
            <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
              <div class="d-flex align-items-center gap-2 flex-grow-1">
                <span class="attachment-icon">
                  <i class="bi {% if attachment.is_image %}bi-image{% elif attachment.is_pdf %}bi-file-earmark-pdf{% elif attachment.is_text %}bi-filetype-txt{% else %}bi-paperclip{% endif %}"></i>
                </span>
                <div class="flex-grow-1">
                  <div class="fw-semibold text-truncate">{{ attachment.display_name }}</div>
                  <div class="text-muted small">{{ attachment.extension and attachment.extension[1:]|upper or 'ARQ' }}</div>
                </div>
              </div>
              <a class="btn btn-outline-primary btn-xs" href="{{ url_for('static', filename=attachment.file_path) }}" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right me-1"></i>Abrir
              </a>
            </div>
            {% if attachment.is_image %}
            <div class="announcement-modal-attachment-media mt-2">
              <img src="{{ url_for('static', filename=attachment.file_path) }}" alt="Anexo da tarefa {{ task.title }}" class="img-fluid rounded">
            </div>
            {% elif attachment.is_pdf or attachment.is_text %}
            <div class="announcement-modal-attachment-media mt-2">
              <div class="ratio ratio-4x3">
                <iframe src="{{ url_for('static', filename=attachment.file_path) }}" title="Pré-visualização do anexo" class="w-100 h-100 border" allowfullscreen></iframe>
              </div>
            </div>
            {% else %}
            <div class="alert alert-light border mt-2 mb-0 text-muted small">
              Pré-visualização indisponível para este formato.
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="form-group form-group-prazo">
        <label>Prazo</label>
        <input type="date" value="{{ task.due_date.isoformat() if task.due_date else '' }}" disabled>
      </div>

      <div class="form-group form-group-prioridade">
        <label>Prioridade</label>
        <select disabled>
          {% for value in priority_order %}
          <option value="{{ value }}" {% if task.priority.value == value %}selected{% endif %}>
            {{ priority_labels[value] }}
          </option>
          {% endfor %}
        </select>
      </div>

      {% if current_user.role == 'admin' %}
      <div class="form-group form-group-inicio">
        <label>Iniciada em</label>
        <input type="text" value="{{ task.started_at.strftime('%d/%m/%Y às %H:%M') if task.started_at else 'Não iniciada' }}" disabled>
      </div>

      <div class="form-group form-group-conclusao">
        <label>Concluída em</label>
        <input type="text" value="{{ task.finished_at.strftime('%d/%m/%Y às %H:%M') if task.finished_at else 'Não concluída' }}" disabled>
      </div>
      {% endif %}

      {% if history_entries %}
      <div class="form-group form-group-full">
        <label><i class="bi bi-clock-history"></i> Histórico de Alterações</label>
        <div class="task-history-container" style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; background: #f9f9f9;">
          {% for entry in history_entries %}
          <div class="history-entry" style="padding: 0.75rem; margin-bottom: 0.5rem; background: white; border-left: 3px solid #007bff; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
              <span style="font-weight: 600; color: #333;">{{ entry.get_display_message() }}</span>
              <span style="font-size: 0.875rem; color: #666;">
                {{ entry.changed_at_sao_paulo.strftime('%d/%m/%Y %H:%M') if entry.changed_at_sao_paulo else entry.changed_at.strftime('%d/%m/%Y %H:%M') }}
              </span>
            </div>
            {% if entry.user %}
            <div style="font-size: 0.875rem; color: #666;">
              <i class="bi bi-person-fill"></i> {{ entry.user.name }}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="form-actions">
        <a href="{{ cancel_url }}" class="btn-history">Voltar</a>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename=asset('javascript/tasks.js')) }}"></script>
{% endblock %}
