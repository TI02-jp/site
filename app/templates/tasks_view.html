{% extends "base.html" %}

{% block title %}Visualizar Tarefa{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}">
{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="new-task-container">
  <section class="kanban" style="gap: 1rem;">
    <div class="kanban-form">
      {% if task.parent %}
      <div class="form-group form-group-full">
        <label>Tarefa Pai</label>
        <input type="text" value="{{ task.parent.title }}" disabled>
      </div>
      {% endif %}

      <div class="form-group form-group-setor">
        <label>Setor</label>
        <input type="text" value="{{ task.tag.nome }}" disabled>
      </div>

      <div class="form-group form-group-usuario">
        <label>Usuário</label>
        <input type="text" value="{{ task.assignee.name if task.assignee else 'Sem responsável' }}" disabled>
      </div>

      <div class="form-group form-group-titulo">
        <label>Título</label>
        <input type="text" value="{{ task.title }}" disabled>
      </div>

      <div class="form-group form-group-descricao">
        <label>Descrição</label>
        <textarea rows="4" disabled>{{ task.description or '' }}</textarea>
      </div>

      {% if task.attachments %}
      <div class="form-group form-group-full">
        <label>Anexos</label>
        <div class="d-grid gap-2">
          {% for attachment in task.attachments %}
          <div class="announcement-modal-attachment border rounded p-2">
            <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
              <div class="d-flex align-items-center gap-2 flex-grow-1">
                <span class="attachment-icon">
                  <i class="bi {% if attachment.is_image %}bi-image{% elif attachment.is_pdf %}bi-file-earmark-pdf{% elif attachment.is_text %}bi-filetype-txt{% else %}bi-paperclip{% endif %}"></i>
                </span>
                <div class="flex-grow-1">
                  <div class="fw-semibold text-truncate">{{ attachment.display_name }}</div>
                  <div class="text-muted small">{{ attachment.extension and attachment.extension[1:]|upper or 'ARQ' }}</div>
                </div>
              </div>
              <a class="btn btn-outline-primary btn-xs" href="{{ url_for('static', filename=attachment.file_path) }}" target="_blank" rel="noopener">
                <i class="bi bi-box-arrow-up-right me-1"></i>Abrir
              </a>
            </div>
            {% if attachment.is_image %}
            <div class="announcement-modal-attachment-media mt-2">
              <img src="{{ url_for('static', filename=attachment.file_path) }}" alt="Anexo da tarefa {{ task.title }}" class="img-fluid rounded">
            </div>
            {% elif attachment.is_pdf or attachment.is_text %}
            <div class="announcement-modal-attachment-media mt-2">
              <div class="ratio ratio-4x3">
                <iframe src="{{ url_for('static', filename=attachment.file_path) }}" title="Pré-visualização do anexo" class="w-100 h-100 border" allowfullscreen></iframe>
              </div>
            </div>
            {% else %}
            <div class="alert alert-light border mt-2 mb-0 text-muted small">
              Pré-visualização indisponível para este formato.
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="form-group form-group-prazo">
        <label>Prazo</label>
        <input type="date" value="{{ task.due_date.isoformat() if task.due_date else '' }}" disabled>
      </div>

      <div class="form-group form-group-prioridade">
        <label>Prioridade</label>
        <select disabled>
          {% for value in priority_order %}
          <option value="{{ value }}" {% if task.priority.value == value %}selected{% endif %}>
            {{ priority_labels[value] }}
          </option>
          {% endfor %}
        </select>
      </div>

      {% if current_user.role == 'admin' %}
      <div class="form-group form-group-inicio">
        <label>Iniciada em</label>
        <input type="text" value="{{ task.started_at.strftime('%d/%m/%Y às %H:%M') if task.started_at else 'Não iniciada' }}" disabled>
      </div>

      <div class="form-group form-group-conclusao">
        <label>Concluída em</label>
        <input type="text" value="{{ task.finished_at.strftime('%d/%m/%Y às %H:%M') if task.finished_at else 'Não concluída' }}" disabled>
      </div>
      {% endif %}

      <div class="form-actions">
        <a href="{{ cancel_url }}" class="btn-history">Voltar</a>
      </div>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='javascript/tasks.js') }}"></script>
{% endblock %}
