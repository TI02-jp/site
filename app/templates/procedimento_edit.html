{% extends "base.html" %}

{% block title %}Editar: {{ procedure.title }}{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid py-2 px-2">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0"><i class="bi bi-pencil-square me-2"></i>Editar procedimento</h1>
    <div>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('procedimentos_operacionais_ver', proc_id=procedure.id) }}">
        <i class="bi bi-eye me-1"></i>Visualizar
      </a>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('procedimentos_operacionais') }}">
        <i class="bi bi-arrow-left me-1"></i>Voltar
      </a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <form method="POST">
        {{ form.hidden_tag() }}
        <div class="mb-3">
          <label class="form-label">{{ form.title.label }}</label>
          {{ form.title(class="form-control") }}
          {% for e in form.title.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
        </div>
        <div class="mb-3">
          <label class="form-label">{{ form.descricao.label }}</label>
          <div id="proc-editor" style="height: 260px;"></div>
          {{ form.descricao(id="proc-descricao", style="display:none;") }}
          <input type="file" id="proc-file-input" accept="image/*,.pdf" style="display:none;">
          <button type="button" id="proc-pdf-btn" class="btn btn-sm btn-outline-secondary mt-2">
            <i class="bi bi-file-pdf me-1"></i>Anexar PDF
          </button>
          <div class="form-text">Cole prints diretamente ou use o botao de imagem; anexos grandes (ate 5 GB por envio) sao suportados.</div>
        </div>
        <div class="d-flex justify-content-between">
          <button type="submit" class="btn btn-primary"><i class="bi bi-save me-1"></i>Salvar</button>
          <form method="post" action="{{ url_for('procedimentos_operacionais_excluir', proc_id=procedure.id) }}" onsubmit="return confirm('Excluir este procedimento?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-outline-danger" type="submit"><i class="bi bi-trash me-1"></i>Excluir</button>
          </form>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  const csrfToken = window.csrfToken;
  function uploadFile(file){
    return new Promise((resolve, reject)=>{
      const data = new FormData();
      data.append('file', file);
      fetch('{{ url_for('upload_file') }}', { method:'POST', headers:{'X-CSRFToken': csrfToken}, body:data })
        .then(r=>r.json()).then(j=>{ if(j.file_url) resolve(j); else reject(j.error||'Falha'); })
        .catch(()=>reject('Erro de rede'));
    });
  }
  function initQuill(editorSel, hiddenSel, fileSel, pdfBtnSel){
    const editor = document.querySelector(editorSel);
    const hidden = document.querySelector(hiddenSel);
    const fileInput = document.querySelector(fileSel);
    const pdfBtn = document.querySelector(pdfBtnSel);
    if(!editor || !hidden || !fileInput) return;
    function selectLocalFile(){ fileInput.click(); }
    const quill = new Quill(editor, {
      theme: 'snow',
      placeholder: 'Descreva o procedimento. VocÃª pode colar prints ou anexar PDFs.',
      modules: { toolbar: { container: [ ['bold','italic','underline'], [{list:'ordered'},{list:'bullet'}], ['link','image'], ['clean'] ], handlers: { image: selectLocalFile } } }
    });
    if(hidden.value){ quill.root.innerHTML = hidden.value; }

    // BotÃ£o para anexar PDF
    if(pdfBtn){
      pdfBtn.addEventListener('click', ()=>{ fileInput.click(); });
    }

    fileInput.addEventListener('change', ()=>{
      if(fileInput.files && fileInput.files[0]){
        const f = fileInput.files[0];
        const range = quill.getSelection(true) || { index: quill.getLength() };
        const isPdf = f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf');

        if(isPdf){
          // Para PDF, inserir um link estilizado
          const tempText = `[Carregando PDF: ${f.name}...]`;
          quill.insertText(range.index, tempText);
          quill.setSelection(range.index + tempText.length);

          uploadFile(f).then(result=>{
            const currentContents = quill.getText();
            const tempIndex = currentContents.indexOf(tempText);
            if(tempIndex !== -1){
              quill.deleteText(tempIndex, tempText.length);
              quill.insertText(tempIndex, `ðŸ“„ ${result.filename}`, 'link', result.file_url);
              quill.insertText(tempIndex + result.filename.length + 2, '\n');
            }
          }).catch(err=>{
            alert('Erro ao enviar PDF: ' + err);
            const currentContents = quill.getText();
            const tempIndex = currentContents.indexOf(tempText);
            if(tempIndex !== -1){
              quill.deleteText(tempIndex, tempText.length);
            }
          });
        } else {
          // Para imagens, usar o mÃ©todo original
          const reader = new FileReader();
          reader.onload = e => {
            const b64 = e.target.result;
            quill.insertEmbed(range.index, 'image', b64);
            quill.setSelection(range.index + 1);
            uploadFile(f).then(result=>{
              const img = quill.root.querySelector(`img[src="${b64}"]`);
              if(img) img.src = result.file_url;
            }).catch(()=>{
              const img = quill.root.querySelector(`img[src="${b64}"]`);
              if(img) img.remove();
            });
          };
          reader.readAsDataURL(f);
        }
        fileInput.value = '';
      }
    });
    editor.closest('form')?.addEventListener('submit', ()=>{ hidden.value = quill.root.innerHTML; });
  }
  initQuill('#proc-editor', '#proc-descricao', '#proc-file-input', '#proc-pdf-btn');
})();
</script>
{% endblock %}
