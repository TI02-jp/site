{% extends "base.html" %}

{% block title %}Visão Geral de Tarefas{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename=asset('tasks.css')) }}">
{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
{% set status_meta = {
  'pending': {'label': 'Pendente', 'icon': 'bi-hourglass'},
  'in_progress': {'label': 'Em andamento', 'icon': 'bi-play-circle'},
  'done': {'label': 'Concluída', 'icon': 'bi-check-circle'}
} %}
{% set priority_labels = {
  'low': 'Baixa',
  'medium': 'Média',
  'high': 'Alta'
} %}
<section class="kanban" data-realtime data-realtime-scopes="tasks" data-current-user="{{ current_user.id }}" data-current-user-role="{{ current_user.role }}">
  <div class="kanban-header">
    <h2><i class="bi bi-kanban"></i>Visão Geral de Tarefas</h2>
    <div class="kanban-actions">
      <form method="get" action="{{ url_for('tasks_overview') }}" class="tasks-filter-form" id="tasks-filter-form">

        <div class="filter-row">

          <div class="filter-field">

            <label for="keyword-filter">Palavra-chave</label>

            <input type="search" id="keyword-filter" name="q" value="{{ keyword }}" placeholder="Título ou descrição">

          </div>

          <div class="filter-field">

            <label for="priority-filter">Prioridade</label>

            <select id="priority-filter" name="priority">

              <option value="">Todas</option>

              {% for priority in priorities %}

              <option value="{{ priority.value }}" {% if selected_priority == priority.value %}selected{% endif %}>{{ priority_labels[priority.value] }}</option>

              {% endfor %}

            </select>

          </div>

          <div class="filter-field">

            <label for="tag-filter">Setor</label>

            <select id="tag-filter" name="tag_id">

              <option value="">Todos</option>

              {% for tag in available_tags %}

              <option value="{{ tag.id }}" {% if selected_tag_id == tag.id %}selected{% endif %}>{{ tag.nome }}</option>

              {% endfor %}

            </select>

          </div>

          <div class="filter-field">

            <label for="user-filter">Usuário (até 2)</label>

            <select id="user-filter" class="form-select">

              <option value="">Todos</option>

              {% for user in users %}

              {% set display_name = (user.name or user.username or '').strip() %}

              <option value="{{ user.id }}">{{ display_name or 'Usuário ' ~ user.id }}</option>

              {% endfor %}

            </select>
            <input type="hidden" name="user_id" id="user-primary" value="{{ selected_user_id or '' }}">
            <input type="hidden" name="user_id_2" id="user-secondary" value="{{ selected_user_id_2 or '' }}">
            <div id="user-selection-chips" class="mt-1 d-flex gap-1 flex-wrap"></div>

          </div>

          <div class="filter-field">

            <label for="due-from-filter">Prazo a partir de</label>

            <input type="date" id="due-from-filter" name="due_from" value="{{ due_from }}">

          </div>

          <div class="filter-field">

            <label for="due-to-filter">Prazo até</label>

            <input type="date" id="due-to-filter" name="due_to" value="{{ due_to }}">

          </div>

          <div class="filter-field actions-field">

            <button type="submit" class="btn btn-primary">Filtrar</button>

            <a href="{{ url_for('tasks_overview') }}" class="btn btn-secondary">Limpar</a>

          </div>

        </div>

      </form>
      {% if current_user.role == 'admin' %}
      <a href="{{ url_for('tasks_new', return_url=request.url) }}" class="btn-new-task">Nova Tarefa</a>
      {% endif %}
      <a href="{{ url_for('tasks_history') }}" class="btn-history">Histórico{% if history_count %} ({{ history_count }}){% endif %}</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div style="margin: 1rem 0;">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" style="margin-bottom: 0.5rem;">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  {% from "tasks_macros.html" import render_task, render_actions_legend with context %}
  {% set allow_delete = current_user.role == 'admin' %}
  {{ render_actions_legend() }}
  <div class="kanban-board">
    {% for status in TaskStatus %}
    <div class="kanban-column">
      <h3><i class="bi {{ status_meta[status.value].icon }}"></i>{{ status_meta[status.value].label }}</h3>
      <ul class="kanban-list" data-status="{{ status.value }}">
        {% for task in tasks_by_status[status] if (not task.is_private or task.created_by == current_user.id) and task.parent_id is none %}
          {{ render_task(task, TaskStatus, show_tag=True, priority_labels=priority_labels, allow_delete=allow_delete) }}
        {% else %}
          <li class="empty">Nenhuma tarefa.</li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
  </div>
{% include "tasks_transfer_modal.html" %}
{% include "tasks_responses_panel.html" %}
</section>
<script>
  const csrfToken = "{{ csrf_token() }}";
  (function setupUserSelect() {
    const selectEl = document.getElementById('user-filter');
    const primaryInput = document.getElementById('user-primary');
    const secondaryInput = document.getElementById('user-secondary');
    const chipsContainer = document.getElementById('user-selection-chips');
    if (!selectEl || !primaryInput || !secondaryInput || !chipsContainer) return;

    const renderChips = () => {
      chipsContainer.innerHTML = '';
      const usersMap = {};
      Array.from(selectEl.options).forEach(opt => {
        usersMap[opt.value] = opt.textContent || opt.innerText || '';
      });
      const ids = [primaryInput.value, secondaryInput.value].filter(Boolean);
      ids.forEach((id, idx) => {
        const chip = document.createElement('span');
        chip.className = 'badge bg-light text-dark border';
        chip.textContent = usersMap[id] || `Usuário ${id}`;
        chip.style.cursor = 'pointer';
        chip.title = 'Clique para remover';
        chip.addEventListener('click', () => {
          if (idx === 0) {
            primaryInput.value = secondaryInput.value;
            secondaryInput.value = '';
          } else {
            secondaryInput.value = '';
          }
          renderChips();
        });
        chipsContainer.appendChild(chip);
      });
    };

    selectEl.addEventListener('change', () => {
      const chosen = selectEl.value;
      if (!chosen) {
        primaryInput.value = '';
        secondaryInput.value = '';
        renderChips();
        return;
      }
      if (!primaryInput.value) {
        primaryInput.value = chosen;
      } else if (!secondaryInput.value && chosen !== primaryInput.value) {
        secondaryInput.value = chosen;
      } else if (chosen !== primaryInput.value && chosen !== secondaryInput.value) {
        // troca o mais antigo (primary)
        primaryInput.value = secondaryInput.value;
        secondaryInput.value = chosen;
      }
      selectEl.value = '';
      renderChips();
    });

    renderChips();
  })();
</script>
<script src="{{ url_for('static', filename=asset('javascript/realtime.js')) }}"></script>
<script src="{{ url_for('static', filename=asset('javascript/tasks.js')) }}"></script>
{% endblock %}

