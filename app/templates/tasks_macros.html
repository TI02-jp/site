{% macro render_task(task, TaskStatus, show_tag=False, priority_labels=None) %}
<li id="task-{{ task.id }}" class="task-card{% if task.children %} has-children{% endif %}">
  <div class="task-header">
    {% if task.children %}
    <button class="toggle-children" title="Alternar subtarefas"><i class="bi bi-chevron-down"></i></button>
    {% endif %}
    <div class="task-info">
      <span class="task-title" id="task-title-{{ task.id }}">{{ task.title }}</span>
      {% if show_tag %}
      <span class="task-tag">{{ task.tag.nome }}</span>
      {% endif %}
      {% if task.due_date %}
      <div class="task-meta">
        <span class="meta-label">Prazo</span>
        <span class="meta-value">{{ task.due_date.strftime('%d/%m/%Y') }}</span>
      </div>
      {% endif %}
      {% if task.children %}
      <div class="progress"><div style="width: {{ task.progress }}%;"></div></div>
      {% endif %}
      {% if task.status == TaskStatus.IN_PROGRESS and task.assignee %}
      <div class="task-meta">
        <span class="meta-label">Em andamento por</span>
        <span class="meta-value">{{ task.assignee.name }}</span>
      </div>
      {% elif task.status == TaskStatus.DONE and task.finisher %}
      <div class="task-meta">
        <span class="meta-label">Finalizado por</span>
        <span class="meta-value">{{ task.finisher.name }}</span>
      </div>
      {% elif task.assignee %}
      <div class="task-meta">
        <span class="meta-label">Responsável</span>
        <span class="meta-value">{{ task.assignee.name }}</span>
      </div>
      {% endif %}
    </div>
    <div class="task-actions">
      <button type="button" class="action view view-task" data-task-id="{{ task.id }}" title="Visualizar detalhes" aria-expanded="false" aria-controls="task-detail-{{ task.id }}" aria-label="Visualizar detalhes da tarefa {{ task.title }}"><i class="bi bi-eye"></i></button>
      {% if task.status == TaskStatus.PENDING %}
      <button class="action start change-status" data-id="{{ task.id }}" data-status="in_progress" title="Iniciar"><i class="bi bi-play-fill"></i></button>
      {% elif task.status == TaskStatus.IN_PROGRESS %}
      <button class="action done change-status" data-id="{{ task.id }}" data-status="done" title="Concluir"><i class="bi bi-check-circle"></i></button>
      {% elif task.status == TaskStatus.DONE and current_user.role == 'admin' %}
      <button class="action reopen change-status" data-id="{{ task.id }}" data-status="in_progress" title="Reabrir"><i class="bi bi-arrow-counterclockwise"></i></button>
      {% endif %}
      {% if current_user.role == 'admin' %}
      <a class="action subtask" href="{{ url_for('tasks_new', parent_id=task.id) }}" title="Subtarefa"><i class="bi bi-node-plus"></i></a>
      {% endif %}
    </div>
  </div>
  {% set labels = priority_labels if priority_labels is not none else {'low': 'Baixa', 'medium': 'Média', 'high': 'Alta'} %}
  <div class="task-detail" id="task-detail-{{ task.id }}" role="region" aria-labelledby="task-title-{{ task.id }}">
    <div class="task-detail-grid">
      {% if task.parent %}
      <div class="detail-field">
        <span class="detail-label">Tarefa Pai</span>
        <span class="detail-value">{{ task.parent.title }}</span>
      </div>
      {% endif %}
      <div class="detail-field">
        <span class="detail-label">Setor</span>
        <span class="detail-value">{{ task.tag.nome }}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Responsável</span>
        <span class="detail-value">{{ task.assignee.name if task.assignee else 'Sem responsável' }}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Prazo</span>
        <span class="detail-value">{{ task.due_date.strftime('%d/%m/%Y') if task.due_date else 'Sem prazo' }}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Prioridade</span>
        <span class="detail-value">{{ labels.get(task.priority.value if task.priority else '', 'Sem prioridade') }}</span>
      </div>
      {% if current_user.role == 'admin' %}
      <div class="detail-field">
        <span class="detail-label">Iniciada em</span>
        <span class="detail-value">{% if task.started_at %}{{ task.started_at.strftime('%d/%m/%Y às %H:%M') }}{% else %}—{% endif %}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Concluída em</span>
        <span class="detail-value">{% if task.finished_at %}{{ task.finished_at.strftime('%d/%m/%Y às %H:%M') }}{% else %}—{% endif %}</span>
      </div>
      {% endif %}
      <div class="detail-field full">
        <span class="detail-label">Descrição</span>
        <span class="detail-value multiline">{{ task.description or 'Sem descrição' }}</span>
      </div>
    </div>
  </div>
  {% if task.children %}
  <ul class="subtasks">
    {% for child in task.children %}
      {{ render_task(child, TaskStatus, show_tag=show_tag, priority_labels=priority_labels) }}
    {% endfor %}
  </ul>
  {% endif %}
</li>
{% endmacro %}
