{% macro render_actions_legend() %}
<div class="task-actions-legend" role="note" aria-label="Legenda de botões de ação das tarefas">
  <span class="legend-heading">Ações disponíveis:</span>
  <div class="legend-items">
    <span class="legend-item">
      <span class="action view legend-icon" aria-hidden="true"><i class="bi bi-eye"></i></span>
      <span class="legend-label">Visualizar</span>
    </span>
    <span class="legend-item">
      <span class="action responses legend-icon" aria-hidden="true"><i class="bi bi-chat-dots"></i></span>
      <span class="legend-label">Respostas</span>
    </span>
    <span class="legend-item">
      <span class="action edit legend-icon" aria-hidden="true"><i class="bi bi-pencil"></i></span>
      <span class="legend-label">Editar</span>
    </span>
    <span class="legend-item">
      <span class="action start legend-icon" aria-hidden="true"><i class="bi bi-play-fill"></i></span>
      <span class="legend-label">Iniciar</span>
    </span>
    <span class="legend-item">
      <span class="action to-pending legend-icon" aria-hidden="true"><i class="bi bi-arrow-return-left"></i></span>
      <span class="legend-label">Voltar p/ pendente</span>
    </span>
    <span class="legend-item">
      <span class="action done legend-icon" aria-hidden="true"><i class="bi bi-check-circle"></i></span>
      <span class="legend-label">Concluir</span>
    </span>
    <span class="legend-item">
      <span class="action reopen legend-icon" aria-hidden="true"><i class="bi bi-arrow-counterclockwise"></i></span>
      <span class="legend-label">Reabrir</span>
    </span>
    <span class="legend-item">
      <span class="action subtask legend-icon" aria-hidden="true"><i class="bi bi-node-plus"></i></span>
      <span class="legend-label">Subtarefa</span>
    </span>
    <span class="legend-item">
      <span class="action delete legend-icon" aria-hidden="true"><i class="bi bi-trash"></i></span>
      <span class="legend-label">Excluir</span>
    </span>
  </div>
</div>
{% endmacro %}

{% macro render_task(task, TaskStatus, show_tag=False, priority_labels=None, allow_delete=False, is_subtask=False) %}
{% if task.is_private and task.created_by != current_user.id %}
{% else %}
{% set status_class = ' task-status-' ~ task.status.value %}
{% set children = task.filtered_children if task.filtered_children is defined else task.children %}
{% set has_children = children is not none and children|length > 0 %}
{% set status_labels = {
  'pending': 'Pendente',
  'in_progress': 'Em andamento',
  'done': 'Concluída'
} %}
{% set show_subtask_status = is_subtask and task.status != TaskStatus.PENDING %}
{% set is_creator = current_user.id == task.created_by %}
{% set is_assignee = task.assigned_to == current_user.id %}
{% set allow_subtask_pending = task.status == TaskStatus.PENDING and task.assigned_to and (is_creator or is_assignee) %}
{% set allow_subtask_in_progress = task.status == TaskStatus.IN_PROGRESS and (is_creator or is_assignee) %}
{% set allow_subtask = allow_subtask_pending or allow_subtask_in_progress %}
<li id="task-{{ task.id }}"
    class="task-card{{ status_class }}{% if has_children %} has-children{% endif %}{% if is_subtask %} subtask-card{% endif %}"
    data-task-id="{{ task.id }}"
    data-is-subtask="{{ 'true' if is_subtask else 'false' }}">
  <div class="task-header">
    {% if has_children %}
    <button class="toggle-children" title="Alternar subtarefas"><i class="bi bi-chevron-down"></i></button>
    {% endif %}
    <div class="task-info">
      {% set tag_label = 'Para Mim' if task.is_private and task.created_by == current_user.id else (task.tag.nome if task.tag else 'Sem setor') %}
      <div class="task-title-row{% if is_subtask %} subtask-title-row{% endif %}">
        <span class="task-title" id="task-title-{{ task.id }}">{{ task.title }}</span>
        {% if show_subtask_status %}
        <span class="subtask-status status-{{ task.status.value }}" data-subtask-status>
          {{ status_labels.get(task.status.value, '') }}
        </span>
        {% endif %}
      </div>
      {% if show_tag %}
      <span class="task-tag">{{ tag_label }}</span>
      {% endif %}
      {% set creator_display = (task.creator.name if task.creator and task.creator.name else (task.creator.username if task.creator else None)) %}
      {% if creator_display %}
      <div class="task-meta">
        <span class="meta-label">Criada por:</span>
        <span class="meta-value">{{ creator_display }}</span>
      </div>
      {% endif %}
      {% if task.due_date %}
      <div class="task-meta">
        <span class="meta-label">Prazo:</span>
        <span class="meta-value">{{ task.due_date.strftime('%d/%m/%Y') }}</span>
      </div>
      {% endif %}
      {% if has_children %}
      <div class="progress"><div style="width: {{ task.progress }}%;"></div></div>
      {% endif %}
      {% if task.attachments %}
      <div class="task-meta">
        <span class="meta-label"><i class="bi bi-paperclip"></i></span>
        <span class="meta-value">{{ task.attachments|length }} anexo{{ 's' if task.attachments|length > 1 else '' }}</span>
      </div>
      {% endif %}
      {% if task.status == TaskStatus.IN_PROGRESS and task.assignee %}
      <div class="task-meta">
        <span class="meta-label">Em andamento por:</span>
        <span class="meta-value">{{ task.assignee.name }}</span>
      </div>
      {% elif task.status == TaskStatus.DONE and task.finisher %}
      <div class="task-meta">
        <span class="meta-label">Finalizado por:</span>
        <span class="meta-value">{{ task.finisher.name }}</span>
      </div>
      {% elif task.assignee %}
      <div class="task-meta">
        <span class="meta-label">Responsável:</span>
        <span class="meta-value">{{ task.assignee.name }}</span>
      </div>
      {% endif %}
    </div>
    {% set conversation = task.conversation_summary if task.conversation_summary is defined else None %}
    {% set show_responses = task.status in [TaskStatus.IN_PROGRESS, TaskStatus.DONE] %}
    <div class="task-actions-container collapsed">
      <button type="button"
              class="task-actions-toggle"
              aria-label="Mostrar ações da tarefa {{ task.title }}"
              aria-controls="task-actions-{{ task.id }}"
              aria-expanded="false"
              title="Mostrar ações"
              data-task-title="{{ task.title }}">
        <i class="bi bi-chevron-left" aria-hidden="true"></i>
      </button>
      <div class="task-actions{% if task.status == TaskStatus.IN_PROGRESS %} compact{% endif %}"
           id="task-actions-{{ task.id }}"
           data-allow-subtask="{{ 'true' if allow_subtask else 'false' }}"
           data-edit-url="{{ url_for('tasks_edit', task_id=task.id) }}"
           data-edit-return-url="{{ request.url }}">
        <button type="button" class="action view view-task" data-task-id="{{ task.id }}" title="Visualizar detalhes" aria-expanded="false" aria-controls="task-detail-{{ task.id }}" aria-label="Visualizar detalhes da tarefa {{ task.title }}"><i class="bi bi-eye"></i></button>
        {% if show_responses %}
        <button type="button"
                class="action responses open-task-responses{% if conversation and (conversation.unread_count or conversation.total_responses) %} has-responses{% endif %}"
                data-task-id="{{ task.id }}"
                data-unread="{{ conversation.unread_count if conversation else 0 }}"
                data-total="{{ conversation.total_responses if conversation else 0 }}"
                title="Abrir respostas da tarefa {{ task.title }}"
                aria-label="Abrir respostas da tarefa {{ task.title }}">
          <span class="icon">
            <i class="bi {% if conversation and conversation.unread_count %}bi-chat-dots-fill{% else %}bi-chat-dots{% endif %}"></i>
          </span>
          {% if conversation and (conversation.unread_count or conversation.total_responses) %}
          <span class="badge{% if conversation.unread_count %} unread{% endif %}">
            {% if conversation.unread_count %}{{ conversation.unread_count }}{% else %}{{ conversation.total_responses }}{% endif %}
          </span>
          {% endif %}
        </button>
        {% endif %}
        {% if task.status in [TaskStatus.PENDING, TaskStatus.IN_PROGRESS] %}
        <a class="action edit edit-task"
           href="{{ url_for('tasks_edit', task_id=task.id, return_url=request.url) }}"
           title="Editar tarefa"
           aria-label="Editar tarefa {{ task.title }}">
          <i class="bi bi-pencil"></i>
        </a>
        {% endif %}
        {% if task.status == TaskStatus.PENDING %}
        <button class="action start change-status" data-id="{{ task.id }}" data-status="in_progress" title="Iniciar"><i class="bi bi-play-fill"></i></button>
        {% elif task.status == TaskStatus.IN_PROGRESS %}
        <button class="action to-pending change-status" data-id="{{ task.id }}" data-status="pending" title="Mover para pendente"><i class="bi bi-arrow-return-left"></i></button>
        <button class="action done change-status" data-id="{{ task.id }}" data-status="done" title="Concluir"><i class="bi bi-check-circle"></i></button>
        {% elif task.status == TaskStatus.DONE and task.created_by == current_user.id %}
        <button class="action reopen change-status" data-id="{{ task.id }}" data-status="in_progress" title="Reabrir"><i class="bi bi-arrow-counterclockwise"></i></button>
        {% endif %}
        {% if allow_subtask %}
        <a class="action subtask" href="{{ url_for('tasks_new', parent_id=task.id, return_url=request.url) }}" title="Subtarefa"><i class="bi bi-node-plus"></i></a>
        {% endif %}
        {% if allow_delete or task.created_by == current_user.id or task.assigned_to == current_user.id %}
        <button class="action delete delete-task" data-id="{{ task.id }}" data-title="{{ task.title }}" title="Excluir tarefa"><i class="bi bi-trash"></i></button>
        {% endif %}
      </div>
    </div>
  </div>
  {% set labels = priority_labels if priority_labels is not none else {'low': 'Baixa', 'medium': 'Média', 'high': 'Alta'} %}
  <div class="task-detail" id="task-detail-{{ task.id }}" role="region" aria-labelledby="task-title-{{ task.id }}">
    <div class="task-detail-grid">
      {% if task.parent %}
      <div class="detail-field">
        <span class="detail-label">Tarefa Pai:</span>
        <span class="detail-value">{{ task.parent.title }}</span>
      </div>
      {% endif %}
      <div class="detail-field">
        <span class="detail-label">Setor:</span>
        <span class="detail-value">{{ tag_label }}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Responsável:</span>
        <span class="detail-value">{{ task.assignee.name if task.assignee else 'Sem responsável' }}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Prazo:</span>
        <span class="detail-value">{{ task.due_date.strftime('%d/%m/%Y') if task.due_date else 'Sem prazo' }}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Prioridade:</span>
        <span class="detail-value">{{ labels.get(task.priority.value if task.priority else '', 'Sem prioridade') }}</span>
      </div>
      {% if current_user.role == 'admin' %}
      <div class="detail-field">
        <span class="detail-label">Iniciada em:</span>
        <span class="detail-value">{% if task.started_at %}{{ task.started_at.strftime('%d/%m/%Y às %H:%M') }}{% else %}–{% endif %}</span>
      </div>
      <div class="detail-field">
        <span class="detail-label">Concluída em:</span>
        <span class="detail-value">{% if task.finished_at %}{{ task.finished_at.strftime('%d/%m/%Y às %H:%M') }}{% else %}–{% endif %}</span>
      </div>
      {% endif %}
      <div class="detail-field full">
        <span class="detail-label">Descrição:</span>
        <span class="detail-value multiline">{{ task.description or 'Sem descrição' }}</span>
      </div>
      {% if task.attachments %}
      <div class="detail-field full">
        <span class="detail-label">Anexos:</span>
        <div class="detail-value" style="display: flex; flex-direction: column; gap: 0.5rem; white-space: normal;">
          {% for attachment in task.attachments %}
          <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
            <i class="bi {% if attachment.is_image %}bi-image text-primary{% elif attachment.is_pdf %}bi-file-earmark-pdf text-danger{% elif attachment.is_text %}bi-filetype-txt text-info{% else %}bi-paperclip{% endif %}" style="font-size: 1.2rem;"></i>
            <span style="flex: 1; font-size: var(--font-sm); overflow: hidden; text-overflow: ellipsis;">{{ attachment.display_name }}</span>
            <a href="{{ url_for('static', filename=attachment.file_path) }}" target="_blank" rel="noopener" class="btn btn-xs btn-outline-primary" style="padding: 0.2rem 0.5rem; font-size: var(--font-xs); white-space: nowrap;">
              <i class="bi bi-box-arrow-up-right"></i>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  {% if has_children %}
  <ul class="subtasks">
    {% for child in children %}
      {{ render_task(child, TaskStatus, show_tag=show_tag, priority_labels=priority_labels, allow_delete=allow_delete, is_subtask=True) }}
    {% endfor %}
  </ul>
  {% endif %}
</li>
{% endif %}
{% endmacro %}
