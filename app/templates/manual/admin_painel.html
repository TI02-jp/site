{% extends "base.html" %}

{% block title %}Admin - Manual{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-4">
    <div>
      <h1 class="h3 mb-1">
        <i class="bi bi-gear me-2"></i>Painel do Manual
      </h1>
      <p class="text-muted mb-0">Gerencie vídeos, categorias e ordem de exibição</p>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{{ url_for('manual.listar_videos') }}">
        <i class="bi bi-arrow-left me-1"></i>Voltar
      </a>
      <a class="btn btn-primary" href="{{ url_for('manual.admin_video_novo') }}">
        <i class="bi bi-plus-lg me-1"></i>Novo vídeo
      </a>
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Total de vídeos</div>
              <div class="fs-4 fw-semibold">{{ total_videos }}</div>
            </div>
            <i class="bi bi-collection-play fs-2 text-primary"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Vídeos ativos</div>
              <div class="fs-4 fw-semibold">{{ active_videos }}</div>
            </div>
            <i class="bi bi-check-circle fs-2 text-success"></i>
          </div>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="text-muted small">Armazenamento</div>
              <div class="fs-4 fw-semibold">{{ total_storage_mb }} MB</div>
            </div>
            <i class="bi bi-hdd fs-2 text-secondary"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold">
              <i class="bi bi-tags me-1"></i>Categorias
            </div>
          </div>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('manual.admin_categorias') }}" class="mb-3">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="form_name" value="category_create">
            <div class="mb-2">
              <label class="form-label">Nome</label>
              <input class="form-control" name="name" maxlength="100" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Descrição</label>
              <input class="form-control" name="description" maxlength="255">
            </div>
            <button class="btn btn-primary w-100" type="submit">
              <i class="bi bi-plus-circle me-1"></i>Criar categoria
            </button>
          </form>

          {% if categories %}
          <div class="list-group">
            {% for cat in categories %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-start gap-2">
                <div>
                  <div class="fw-semibold">{{ cat.name }}</div>
                  {% if cat.description %}
                  <div class="text-muted small">{{ cat.description }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="mt-2 d-flex flex-wrap gap-2">
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#catEdit{{ cat.id }}">
                  <i class="bi bi-pencil me-1"></i>Editar
                </button>
                <form method="post" action="{{ url_for('manual.admin_categorias') }}" data-confirm-message="Excluir a categoria {{ cat.name }}?" data-confirm-variant="danger">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="form_name" value="category_delete">
                  <input type="hidden" name="category_id" value="{{ cat.id }}">
                  <button class="btn btn-sm btn-outline-danger" type="submit">
                    <i class="bi bi-trash me-1"></i>Excluir
                  </button>
                </form>
              </div>

              <div class="collapse mt-3" id="catEdit{{ cat.id }}">
                <form method="post" action="{{ url_for('manual.admin_categorias') }}">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <input type="hidden" name="form_name" value="category_update">
                  <input type="hidden" name="category_id" value="{{ cat.id }}">
                  <div class="mb-2">
                    <label class="form-label">Nome</label>
                    <input class="form-control" name="name" maxlength="100" value="{{ cat.name }}" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Descrição</label>
                    <input class="form-control" name="description" maxlength="255" value="{{ cat.description or '' }}">
                  </div>
                  <button class="btn btn-sm btn-primary w-100" type="submit">
                    Salvar alterações
                  </button>
                </form>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="text-muted small">Nenhuma categoria cadastrada.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="fw-semibold">
              <i class="bi bi-film me-1"></i>Vídeos (arraste para reordenar)
            </div>
            <div class="text-muted small">A ordem é salva automaticamente</div>
          </div>
        </div>
        <div class="card-body">
          {% if videos %}
          <ul id="videosList" class="list-group">
            {% for video in videos %}
            <li class="list-group-item d-flex align-items-center gap-3" draggable="true" data-video-id="{{ video.id }}">
              <div class="text-muted" style="cursor: grab;">
                <i class="bi bi-grip-vertical fs-4"></i>
              </div>
              <img src="{{ video.thumbnail_url }}" alt="" style="width: 64px; height: 36px; object-fit: cover; border-radius: 6px;">
              <div class="flex-grow-1">
                <div class="fw-semibold d-flex align-items-center gap-2">
                  <span>{{ video.title }}</span>
                  {% if not video.is_active %}
                  <span class="badge bg-secondary">inativo</span>
                  {% endif %}
                </div>
                <div class="text-muted small d-flex flex-wrap gap-2">
                  <span class="badge bg-light text-dark border">{{ video.category.name }}</span>
                  {% if video.duration_formatted %}
                  <span><i class="bi bi-clock me-1"></i>{{ video.duration_formatted }}</span>
                  {% endif %}
                  <span><i class="bi bi-hdd me-1"></i>{{ video.file_size_mb }} MB</span>
                </div>
              </div>
              <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-sm btn-outline-primary" href="{{ url_for('manual.assistir_video', video_id=video.id) }}">
                  <i class="bi bi-play me-1"></i>Ver
                </a>
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('manual.admin_video_editar', video_id=video.id) }}">
                  <i class="bi bi-pencil me-1"></i>Editar
                </a>
                <form method="post" action="{{ url_for('manual.admin_video_deletar', video_id=video.id) }}" data-confirm-message="Excluir o video {{ video.title }}?" data-confirm-variant="danger">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button class="btn btn-sm btn-outline-danger" type="submit">
                    <i class="bi bi-trash me-1"></i>Excluir
                  </button>
                </form>
              </div>
            </li>
            {% endfor %}
          </ul>
          <div id="reorderStatus" class="small text-muted mt-2"></div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-film fs-1 text-muted d-block mb-3"></i>
            <h5 class="text-muted">Nenhum vídeo cadastrado</h5>
            <a class="btn btn-primary" href="{{ url_for('manual.admin_video_novo') }}">
              <i class="bi bi-plus-lg me-1"></i>Adicionar primeiro vídeo
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function () {
  const list = document.getElementById('videosList');
  if (!list) return;

  const statusEl = document.getElementById('reorderStatus');
  let dragged = null;

  function setStatus(text) {
    if (statusEl) statusEl.textContent = text || '';
  }

  function getIds() {
    return Array.from(list.querySelectorAll('[data-video-id]')).map(el => parseInt(el.dataset.videoId, 10));
  }

  function saveOrder() {
    setStatus('Salvando ordem...');
    return fetch("{{ url_for('manual.admin_reordenar') }}", {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': (window.csrfToken || '')
      },
      body: JSON.stringify({ video_ids: getIds() })
    }).then(async (resp) => {
      if (!resp.ok) {
        const text = await resp.text();
        throw new Error(text || ('HTTP ' + resp.status));
      }
      setStatus('Ordem salva.');
      setTimeout(() => setStatus(''), 1500);
    }).catch((err) => {
      console.error(err);
      setStatus('Falha ao salvar ordem. Veja o console.');
    });
  }

  list.addEventListener('dragstart', (e) => {
    const item = e.target.closest('li[data-video-id]');
    if (!item) return;
    dragged = item;
    item.classList.add('opacity-50');
    e.dataTransfer.effectAllowed = 'move';
  });

  list.addEventListener('dragend', (e) => {
    const item = e.target.closest('li[data-video-id]');
    if (item) item.classList.remove('opacity-50');
    dragged = null;
  });

  list.addEventListener('dragover', (e) => {
    e.preventDefault();
    const target = e.target.closest('li[data-video-id]');
    if (!target || !dragged || target === dragged) return;
    const rect = target.getBoundingClientRect();
    const before = (e.clientY - rect.top) < rect.height / 2;
    list.insertBefore(dragged, before ? target : target.nextSibling);
  });

  list.addEventListener('drop', (e) => {
    e.preventDefault();
    if (!dragged) return;
    saveOrder();
  });
})();
</script>
{% endblock %}
