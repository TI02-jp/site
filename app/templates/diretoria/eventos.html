{% extends "base.html" %}
{% set is_editing = event_data is defined and event_data %}
{% block title %}Eventos - Diretoria JP{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
        .eventos-form .section-heading {
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }

        .eventos-form .form-label {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: #495057;
            text-align: left;
            padding: 0;
        }

        .eventos-form .form-control,
        .eventos-form .form-select {
            font-size: 0.775rem;
            padding: 0.35rem 0.65rem;
        }

        .eventos-form textarea.form-control {
            min-height: 110px;
        }

        .eventos-form .category-item .form-control {
            font-size: 0.72rem;
        }

        .eventos-form .category-item .form-label {
            font-size: 0.62rem;
            text-align: left;
        }

        .eventos-form .category-item [data-item-total] {
            font-size: 0.65rem;
        }

        .eventos-form .event-category {
            border-left: 2px solid transparent;
            padding-left: 0.25rem;
        }

        .eventos-form .event-category.is-disabled {
            border-color: transparent;
        }

        .eventos-form .event-category.is-active {
            border-color: rgba(13, 110, 253, 0.35);
        }

        .eventos-form .event-category .category-body {
            display: none;
        }

        .eventos-form .event-category.is-active .category-body {
            display: block;
        }

        .eventos-form .event-category .category-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .eventos-form .event-category .category-title {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
        }

        .eventos-form .event-category .toggle-wrapper {
            font-size: 0.68rem;
        }

        .eventos-form .event-category .toggle-wrapper .form-check {
            padding-left: 0;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .eventos-form .event-category .toggle-wrapper .form-check-input {
            width: 2.25em;
            height: 1.25em;
            margin-top: 0;
            margin-left: 0;
            float: none;
        }

        .eventos-form .event-category .toggle-wrapper .form-check-label {
            font-weight: 600;
            color: #495057;
        }

        .eventos-form .category-item button[data-action="remove-item"] {
            font-size: 0.7rem;
            padding: 0.2rem 0.45rem;
        }

        .eventos-form .event-category .category-footer {
            display: flex;
            justify-content: flex-start;
            margin-top: 1rem;
        }

        .eventos-form .event-category .category-footer [data-action="add-item"] {
            flex-shrink: 0;
        }

        .eventos-form .totals-row .form-control {
            font-size: 0.8rem;
        }

        .eventos-form .totals-row .form-label {
            text-align: left;
        }

        .eventos-form .photos-section .event-photo-card {
            background-color: #fff;
            border-radius: 0.75rem;
            border: 1px solid rgba(0, 0, 0, 0.08);
            padding: 0.75rem;
            height: 100%;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.04);
        }

        .eventos-form .photos-section .event-photo-thumb {
            position: relative;
            width: 100%;
            padding-top: 66.6667%;
            border-radius: 0.65rem;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0.02));
        }

        .eventos-form .photos-section .event-photo-thumb img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .eventos-form .photos-section .event-photo-actions {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .eventos-form .photos-section .empty-state {
            border: 1px dashed rgba(13, 110, 253, 0.25);
            border-radius: 0.75rem;
            padding: 1.25rem;
            font-size: 0.8rem;
            background: rgba(13, 110, 253, 0.03);
        }

        @media (min-width: 992px) {
            .eventos-form .metadata .col-lg-3 {
                flex: 0 0 auto;
                width: 25%;
            }

            .eventos-form .metadata .col-lg-6 {
                flex: 0 0 auto;
                width: 50%;
            }

        }
    </style>
{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid eventos-form">
    <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-primary bg-opacity-10 text-primary fw-semibold">
                Diretoria JP
            </span>
            <h1 class="h3 mb-0">{{ 'Editar Evento' if is_editing else 'Criar Evento' }}</h1>
        </div>
        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('diretoria_eventos_lista') }}">
            <i class="bi bi-list-ul me-1"></i>Listar eventos
        </a>
    </div>
    <form id="formEventos" class="needs-validation" novalidate>
        <div class="row g-3 mb-4 metadata">
            <div class="col-12 col-lg-6">
                <label for="nomeEvento" class="form-label">Nome do evento</label>
                <input type="text" class="form-control" id="nomeEvento" required>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="tipoEvento" class="form-label">Tipo de evento</label>
                <select id="tipoEvento" class="form-select" required>
                    <option value="" selected disabled>Selecione uma opção</option>
                    <option value="treinamento">Treinamento</option>
                    <option value="data_comemorativa">Data comemorativa</option>
                    <option value="evento">Evento</option>
                </select>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="dataEvento" class="form-label">Data</label>
                <input type="date" class="form-control" id="dataEvento" required>
            </div>
            <div class="col-12 col-lg-6">
                <label for="descricaoEvento" class="form-label">Descrição <span class="fw-normal text-muted">(opcional)</span></label>
                <textarea id="descricaoEvento" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="publicoEvento" class="form-label">Público participante</label>
                <select id="publicoEvento" class="form-select" required>
                    <option value="" selected disabled>Selecione uma opção</option>
                    <option value="interno">Interno</option>
                    <option value="externo">Externo</option>
                    <option value="ambos">Ambos</option>
                </select>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="numeroParticipantes" class="form-label">Participantes (nº de pessoas)</label>
                <input type="number" min="0" step="1" class="form-control" id="numeroParticipantes" required>
            </div>
        </div>

        <div class="border-top pt-4 mt-4"></div>

        <div class="mb-5">
            <h2 class="h6 text-uppercase text-muted fw-semibold section-heading mb-3">Serviços de alimentação</h2>

            <div class="event-category is-disabled" data-category="cafe">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Café da manhã</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleCafe" data-category-toggle="cafe">
                                <label class="form-check-label" for="toggleCafe">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total café da manhã:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                    <div class="border-bottom mt-4"></div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="almoco">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Almoço</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleAlmoco" data-category-toggle="almoco">
                                <label class="form-check-label" for="toggleAlmoco">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total almoço:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                    <div class="border-bottom mt-4"></div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="lanche">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Lanche</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleLanche" data-category-toggle="lanche">
                                <label class="form-check-label" for="toggleLanche">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total lanche:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="outros">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Outros serviços</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleOutros" data-category-toggle="outros">
                                <label class="form-check-label" for="toggleOutros">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total outros serviços:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="border-top pt-4 mt-4"></div>

        <div class="mb-5 photos-section">
            <h2 class="h6 text-uppercase text-muted fw-semibold section-heading mb-3">Fotos do evento</h2>
            <p class="text-muted small mb-3">Envie imagens para ilustrar o evento planejado. Elas poderão ser consultadas posteriormente na edição.</p>
            <div class="row g-3 align-items-end">
                <div class="col-12 col-lg-6">
                    <label for="fotosEventoInput" class="form-label">Adicionar fotos</label>
                    <input type="file" class="form-control" id="fotosEventoInput" accept="image/*" multiple>
                    <div class="form-text">Formatos permitidos: PNG, JPG, JPEG ou GIF (até 2&nbsp;MB por arquivo).</div>
                </div>
            </div>
            <div id="fotosEventoStatus" class="small mt-2 d-none"></div>
            <div id="fotosEventoEmpty" class="empty-state text-center text-muted mt-3">
                <i class="bi bi-images me-2"></i>Nenhuma foto adicionada até o momento.
            </div>
            <div id="fotosEventoLista" class="row g-3 mt-1 photos-grid"></div>
        </div>

        <div class="border-top pt-4 mt-4"></div>

        <div class="row g-3 align-items-center totals-row">
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalCafe" class="form-label">Total café da manhã</label>
                <input type="text" class="form-control" id="totalCafe" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalAlmoco" class="form-label">Total almoço</label>
                <input type="text" class="form-control" id="totalAlmoco" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalLanche" class="form-label">Total lanche</label>
                <input type="text" class="form-control" id="totalLanche" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalOutros" class="form-label">Total outros serviços</label>
                <input type="text" class="form-control" id="totalOutros" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalEvento" class="form-label">Valor total estimado do evento</label>
                <input type="text" class="form-control fw-semibold" id="totalEvento" value="R$ 0,00" readonly>
            </div>
        </div>

        <div class="d-flex justify-content-start gap-2 mt-4">
            <button type="reset" class="btn btn-outline-secondary">Limpar</button>
            <button type="submit" class="btn btn-primary">{{ 'Atualizar evento' if is_editing else 'Salvar estimativa' }}</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        window.csrfToken = "{{ csrf_token() }}";
        window.diretoriaEventData = {% if is_editing %}{{ event_data | tojson }}{% else %}null{% endif %};
        (() => {
            const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

            const categories = {
                cafe: {
                    input: document.getElementById('totalCafe'),
                },
                almoco: {
                    input: document.getElementById('totalAlmoco'),
                },
                lanche: {
                    input: document.getElementById('totalLanche'),
                },
                outros: {
                    input: document.getElementById('totalOutros'),
                },
            };

            const form = document.getElementById('formEventos');
            const totalEventoInput = document.getElementById('totalEvento');
            const initialEvent = window.diretoriaEventData || null;
            const submitUrl = (initialEvent && initialEvent.submit_url)
                ? initialEvent.submit_url
                : "{{ url_for('diretoria_eventos') }}";
            const listUrl = "{{ url_for('diretoria_eventos_lista') }}";
            const csrfToken = window.csrfToken;
            const categoryControllers = {};
            const uploadUrl = "{{ url_for('upload_image') }}";
            const photosInput = document.getElementById('fotosEventoInput');
            const photosListEl = document.getElementById('fotosEventoLista');
            const photosEmptyState = document.getElementById('fotosEventoEmpty');
            const photosStatusEl = document.getElementById('fotosEventoStatus');
            let photoStatusTimeoutId = null;

            const photosController = (() => {
                let items = [];

                function removeAt(index) {
                    if (index < 0 || index >= items.length) {
                        return;
                    }
                    items = [...items.slice(0, index), ...items.slice(index + 1)];
                    render();
                }

                function render() {
                    if (!photosListEl) {
                        return;
                    }

                    photosListEl.innerHTML = '';

                    if (!items.length) {
                        if (photosEmptyState) {
                            photosEmptyState.classList.remove('d-none');
                        }
                        return;
                    }

                    if (photosEmptyState) {
                        photosEmptyState.classList.add('d-none');
                    }

                    items.forEach((url, index) => {
                        const col = document.createElement('div');
                        col.className = 'col-6 col-md-4 col-lg-3';
                        col.innerHTML = `
                            <div class="event-photo-card">
                                <div class="event-photo-thumb">
                                    <img src="${url}" alt="Foto do evento ${index + 1}">
                                </div>
                                <div class="event-photo-actions">
                                    <a href="${url}" target="_blank" rel="noopener" class="btn btn-outline-secondary btn-sm flex-grow-1">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>Ver
                                    </a>
                                    <button type="button" class="btn btn-link btn-sm text-danger px-0" data-action="remove-photo">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        `;

                        const removeButton = col.querySelector('[data-action="remove-photo"]');
                        if (removeButton) {
                            removeButton.addEventListener('click', () => removeAt(index));
                        }

                        photosListEl.appendChild(col);
                    });
                }

                function setItems(values) {
                    items = Array.isArray(values)
                        ? values
                            .map((value) => (typeof value === 'string' ? value.trim() : ''))
                            .filter((value) => value.length > 0)
                        : [];
                    render();
                }

                function addItem(value) {
                    if (typeof value !== 'string') {
                        return;
                    }
                    const normalized = value.trim();
                    if (!normalized || items.includes(normalized)) {
                        return;
                    }
                    items = [...items, normalized];
                    render();
                }

                function getItems() {
                    return items.slice();
                }

                function clear() {
                    items = [];
                    render();
                }

                render();

                return { setItems, addItem, removeAt, getItems, clear };
            })();

            const setPhotoStatus = (message = '', type = 'muted', timeoutMs = 0) => {
                if (!photosStatusEl) {
                    return;
                }

                if (photoStatusTimeoutId) {
                    clearTimeout(photoStatusTimeoutId);
                    photoStatusTimeoutId = null;
                }

                if (!message) {
                    photosStatusEl.textContent = '';
                    photosStatusEl.classList.add('d-none');
                    photosStatusEl.classList.remove('text-danger', 'text-success', 'text-muted');
                    return;
                }

                photosStatusEl.textContent = message;
                photosStatusEl.classList.remove('d-none', 'text-danger', 'text-success', 'text-muted');

                if (type === 'danger') {
                    photosStatusEl.classList.add('text-danger');
                } else if (type === 'success') {
                    photosStatusEl.classList.add('text-success');
                } else {
                    photosStatusEl.classList.add('text-muted');
                }

                if (timeoutMs > 0) {
                    photoStatusTimeoutId = window.setTimeout(() => {
                        setPhotoStatus('');
                    }, timeoutMs);
                }
            };

            const uploadPhoto = async (file) => {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                    },
                    body: formData,
                });

                const data = await response.json().catch(() => null);

                if (!response.ok || !data || !data.image_url) {
                    const message = (data && (data.error || data.message)) || 'Não foi possível enviar a foto.';
                    throw new Error(message);
                }

                return data.image_url;
            };

            const handlePhotoSelection = async (files) => {
                for (const file of files) {
                    if (!(file instanceof File)) {
                        continue;
                    }

                    if (!file.type || !file.type.startsWith('image/')) {
                        setPhotoStatus(`O arquivo "${file.name}" não parece ser uma imagem válida.`, 'danger', 5000);
                        continue;
                    }

                    try {
                        setPhotoStatus(`Enviando "${file.name}"...`, 'muted');
                        const imageUrl = await uploadPhoto(file);
                        photosController.addItem(imageUrl);
                        setPhotoStatus(`Foto "${file.name}" adicionada com sucesso.`, 'success', 3500);
                    } catch (error) {
                        const message = error instanceof Error ? error.message : 'Não foi possível enviar a foto.';
                        setPhotoStatus(message, 'danger');
                    }
                }
            };

            if (photosInput) {
                photosInput.addEventListener('change', () => {
                    if (!photosInput.files || !photosInput.files.length) {
                        return;
                    }

                    const files = Array.from(photosInput.files);
                    handlePhotoSelection(files);
                    photosInput.value = '';
                });
            }

            const createItemRow = (categoryKey, values = {}) => {
                const row = document.createElement('div');
                row.className = 'row g-3 align-items-end category-item mb-3';
                row.innerHTML = `
                    <div class="col-12 col-md-6 col-lg-5">
                        <label class="form-label">Item</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label">Quantidade</label>
                        <input type="number" class="form-control" min="0" step="1" required>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label">Valor unitário (R$)</label>
                        <input type="number" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                        <button type="button" class="btn btn-link text-danger px-0" data-action="remove-item">
                            <i class="bi bi-trash"></i>
                        </button>
                        <div class="small text-muted" data-item-total>R$ 0,00</div>
                    </div>
                `;

                const inputs = row.querySelectorAll('input');
                const quantityInput = inputs[1];
                const unitInput = inputs[2];
                const itemTotalDisplay = row.querySelector('[data-item-total]');

                const updateItemTotal = () => {
                    const quantity = Number.parseFloat(quantityInput.value.replace(',', '.')) || 0;
                    const unitValue = Number.parseFloat(unitInput.value.replace(',', '.')) || 0;
                    const itemTotal = quantity * unitValue;
                    itemTotalDisplay.textContent = formatter.format(itemTotal);
                    updateCategoryTotals();
                };

                quantityInput.addEventListener('input', updateItemTotal);
                unitInput.addEventListener('input', updateItemTotal);

                row.querySelector('[data-action="remove-item"]').addEventListener('click', () => {
                    row.remove();
                    updateCategoryTotals();
                });

                const nameValue = values.name != null ? values.name : '';
                const quantityValue = Number.isFinite(values.quantity) ? values.quantity : '';
                const unitValue = Number.isFinite(values.unit_value) ? values.unit_value : '';

                inputs[0].value = nameValue;
                if (quantityValue !== '') {
                    quantityInput.value = quantityValue;
                }
                if (unitValue !== '') {
                    unitInput.value = unitValue;
                }

                updateItemTotal();

                return row;
            };

            const updateCategoryTotals = () => {
                let eventTotal = 0;

                document.querySelectorAll('.event-category').forEach((categoryEl) => {
                    const categoryKey = categoryEl.dataset.category;
                    const toggle = categoryEl.querySelector('[data-category-toggle]');
                    const isActive = !!(toggle && toggle.checked);
                    let categoryTotal = 0;

                    if (isActive) {
                        categoryEl.querySelectorAll('.category-item').forEach((itemRow) => {
                            const inputs = itemRow.querySelectorAll('input');
                            const quantityInput = inputs[1];
                            const unitInput = inputs[2];
                            const quantity = Number.parseFloat(quantityInput.value.replace(',', '.')) || 0;
                            const unitValue = Number.parseFloat(unitInput.value.replace(',', '.')) || 0;
                            categoryTotal += quantity * unitValue;
                        });
                    }

                    const totalDisplay = categoryEl.querySelector('[data-category-total]');
                    if (totalDisplay) {
                        totalDisplay.textContent = formatter.format(categoryTotal);
                    }

                    if (categories[categoryKey] && categories[categoryKey].input) {
                        categories[categoryKey].input.value = formatter.format(categoryTotal);
                    }

                    eventTotal += categoryTotal;
                });

                totalEventoInput.value = formatter.format(eventTotal);
            };

            document.querySelectorAll('.event-category').forEach((categoryEl) => {
                const categoryKey = categoryEl.dataset.category;
                const itemsContainer = categoryEl.querySelector('.category-items');
                const addButton = categoryEl.querySelector('[data-action="add-item"]');

                const toggle = categoryEl.querySelector('[data-category-toggle]');
                const categoryBody = categoryEl.querySelector('.category-body');

                const setCategoryState = (active, options = {}) => {
                    categoryEl.classList.toggle('is-active', active);
                    categoryEl.classList.toggle('is-disabled', !active);

                    if (addButton) {
                        addButton.disabled = !active;
                        addButton.classList.toggle('d-none', !active);
                    }

                    categoryBody.style.display = active ? 'block' : 'none';

                     if (toggle) {
                        toggle.checked = active;
                    }

                    if (active && itemsContainer.childElementCount === 0 && !options.prefill) {
                        const row = createItemRow(categoryKey);
                        itemsContainer.appendChild(row);
                    }

                    itemsContainer.querySelectorAll('.category-item').forEach((itemRow) => {
                        itemRow.querySelectorAll('input').forEach((input) => {
                            input.disabled = !active;
                        });

                        const removeButton = itemRow.querySelector('[data-action="remove-item"]');
                        if (removeButton) {
                            removeButton.disabled = !active;
                        }
                    });

                    updateCategoryTotals();
                };

                const addItem = (values = {}) => {
                    const row = createItemRow(categoryKey, values);
                    itemsContainer.appendChild(row);
                    updateCategoryTotals();
                    return row;
                };

                if (addButton) {
                    addButton.addEventListener('click', () => addItem());
                }

                if (toggle) {
                    toggle.addEventListener('change', () => {
                        setCategoryState(toggle.checked);
                    });
                }

                categoryBody.style.display = 'none';
                setCategoryState(false);

                categoryControllers[categoryKey] = {
                    setState: (active, options = {}) => setCategoryState(active, options),
                    addItem,
                    clearItems: () => {
                        itemsContainer.innerHTML = '';
                    },
                    itemsContainer,
                };
            });

            form.addEventListener('reset', () => {
                setTimeout(() => {
                    document.querySelectorAll('.event-category .category-items').forEach((container) => {
                        container.innerHTML = '';
                    });

                    document.querySelectorAll('[data-category-toggle]').forEach((toggle) => {
                        toggle.checked = false;
                        toggle.dispatchEvent(new Event('change'));
                    });

                    photosController.clear();
                    setPhotoStatus('');

                    if (initialEvent) {
                        applyInitialData();
                    } else {
                        updateCategoryTotals();
                    }
                }, 0);
            });

            const applyInitialData = () => {
                const initialPhotos = initialEvent && Array.isArray(initialEvent.photos)
                    ? initialEvent.photos
                    : [];
                photosController.setItems(initialPhotos);
                setPhotoStatus('');

                if (!initialEvent) {
                    updateCategoryTotals();
                    return;
                }

                document.getElementById('nomeEvento').value = initialEvent.name || '';
                document.getElementById('tipoEvento').value = initialEvent.type || '';
                document.getElementById('dataEvento').value = initialEvent.date || '';
                document.getElementById('descricaoEvento').value = initialEvent.description || '';
                document.getElementById('publicoEvento').value = initialEvent.audience || '';
                document.getElementById('numeroParticipantes').value =
                    initialEvent.participants != null ? initialEvent.participants : '';

                const initialCategories = (initialEvent && initialEvent.categories) || {};

                Object.keys(categoryControllers).forEach((key) => {
                    const controller = categoryControllers[key];
                    const categoryData = initialCategories[key] || {};
                    const items = Array.isArray(categoryData.items) ? categoryData.items : [];

                    if (!controller) {
                        return;
                    }

                    if (!items.length) {
                        controller.setState(false, { prefill: true });
                        controller.clearItems();
                        return;
                    }

                    controller.setState(true, { prefill: true });
                    controller.clearItems();

                    items.forEach((item) => {
                        controller.addItem({
                            name: (item && item.name) || '',
                            quantity: Number.isFinite(item && item.quantity)
                                ? item.quantity
                                : parseFloat(item && item.quantity) || 0,
                            unit_value: Number.isFinite(item && item.unit_value)
                                ? item.unit_value
                                : parseFloat(item && item.unit_value) || 0,
                        });
                    });
                });

                updateCategoryTotals();
            };

            applyInitialData();

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                form.classList.add('was-validated');

                if (!form.checkValidity()) {
                    return;
                }

                const submitButton = form.querySelector('button[type="submit"]');
                let shouldUnlockButton = true;
                if (submitButton) {
                    submitButton.disabled = true;
                }

                const payload = {
                    name: document.getElementById('nomeEvento').value.trim(),
                    type: document.getElementById('tipoEvento').value,
                    date: document.getElementById('dataEvento').value,
                    description: document.getElementById('descricaoEvento').value.trim(),
                    audience: document.getElementById('publicoEvento').value,
                    participants: Number.parseInt(document.getElementById('numeroParticipantes').value, 10) || 0,
                    categories: {},
                    photos: photosController.getItems(),
                };

                document.querySelectorAll('.event-category').forEach((categoryEl) => {
                    const toggle = categoryEl.querySelector('[data-category-toggle]');
                    if (!toggle || !toggle.checked) {
                        return;
                    }

                    const categoryKey = categoryEl.dataset.category;
                    const items = [];

                    categoryEl.querySelectorAll('.category-item').forEach((itemRow) => {
                        const inputs = itemRow.querySelectorAll('input');
                        const itemName = inputs[0].value.trim();
                        const quantityValue = Number.parseFloat(inputs[1].value);
                        const unitValue = Number.parseFloat(inputs[2].value);

                        if (!itemName || !Number.isFinite(quantityValue) || !Number.isFinite(unitValue)) {
                            return;
                        }

                        items.push({
                            name: itemName,
                            quantity: quantityValue,
                            unit_value: unitValue,
                        });
                    });

                    payload.categories[categoryKey] = { items };
                });

                try {
                    const response = await fetch(submitUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json().catch(() => null);

                    if (!response.ok) {
                    const message = (
                        data && Array.isArray(data.errors) && data.errors.length
                            ? data.errors.join('\n')
                            : (data && data.error) || 'Não foi possível salvar o evento.'
                    );
                        alert(message);
                        return;
                    }

                    const redirectUrl = (data && data.redirect_url) || listUrl;
                    shouldUnlockButton = false;
                    window.location.href = redirectUrl;
                } catch (error) {
                    alert('Não foi possível salvar o evento. Tente novamente.');
                } finally {
                    if (submitButton && shouldUnlockButton) {
                        submitButton.disabled = false;
                    }
                }
            });
        })();
    </script>
{% endblock %}
