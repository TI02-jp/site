{% extends "base.html" %}
{% set is_editing = event_data is defined and event_data %}
{% block title %}Eventos - Diretoria JP{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
        .eventos-form .section-heading {
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }

        .eventos-form .form-label {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: #495057;
            text-align: left;
            padding: 0;
        }

        .eventos-form .form-control,
        .eventos-form .form-select {
            font-size: 0.775rem;
            padding: 0.35rem 0.65rem;
        }

        .eventos-form textarea.form-control {
            min-height: 110px;
        }

        .eventos-form .category-item .form-control {
            font-size: 0.72rem;
        }

        .eventos-form .category-item .form-label {
            font-size: 0.62rem;
            text-align: left;
        }

        .eventos-form .category-item [data-item-total] {
            font-size: 0.65rem;
        }

        .eventos-form .event-category {
            border-left: 2px solid transparent;
            padding-left: 0.25rem;
        }

        .eventos-form .event-category.is-disabled {
            border-color: transparent;
        }

        .eventos-form .event-category.is-active {
            border-color: rgba(13, 110, 253, 0.35);
        }

        .eventos-form .event-category .category-body {
            display: none;
        }

        .eventos-form .event-category.is-active .category-body {
            display: block;
        }

        .eventos-form .event-category .category-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .eventos-form .event-category .category-title {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
        }

        .eventos-form .event-category .toggle-wrapper {
            font-size: 0.68rem;
        }

        .eventos-form .event-category .toggle-wrapper .form-check {
            padding-left: 0;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .eventos-form .event-category .toggle-wrapper .form-check-input {
            width: 2.25em;
            height: 1.25em;
            margin-top: 0;
            margin-left: 0;
            float: none;
        }

        .eventos-form .event-category .toggle-wrapper .form-check-label {
            font-weight: 600;
            color: #495057;
        }

        .eventos-form .category-item button[data-action="remove-item"] {
            font-size: 0.7rem;
            padding: 0.2rem 0.45rem;
        }

        .eventos-form .event-category .category-footer {
            display: flex;
            justify-content: flex-start;
            margin-top: 1rem;
        }

        .eventos-form .event-category .category-footer [data-action="add-item"] {
            flex-shrink: 0;
        }

        .eventos-form .totals-row .form-control {
            font-size: 0.8rem;
        }

        .eventos-form .totals-row .form-label {
            text-align: left;
        }

        .eventos-form .photos-section .event-photo-card {
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: linear-gradient(165deg, rgba(13, 110, 253, 0.07), rgba(13, 110, 253, 0));
            border-radius: 1rem;
            border: 1px solid rgba(13, 110, 253, 0.12);
            box-shadow: 0 0.25rem 1.25rem rgba(13, 110, 253, 0.08);
            padding: 0.85rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .eventos-form .photos-section .event-photo-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1.5rem rgba(13, 110, 253, 0.12);
        }

        .eventos-form .photos-section .event-photo-media {
            position: relative;
            border-radius: 0.85rem;
            overflow: hidden;
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.03));
        }

        .eventos-form .photos-section .event-photo-thumb {
            position: relative;
            width: 100%;
            padding-top: 66.6667%;
        }

        .eventos-form .photos-section .event-photo-thumb img {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.25s ease;
        }

        .eventos-form .photos-section .event-photo-card:hover .event-photo-thumb img {
            transform: scale(1.03);
        }

        .eventos-form .photos-section .event-photo-quick-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: flex;
            gap: 0.35rem;
            z-index: 1;
        }

        .eventos-form .photos-section .event-photo-quick-actions .btn-icon {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(220, 53, 69, 0.12);
            color: #dc3545;
            box-shadow: 0 0.25rem 0.75rem rgba(220, 53, 69, 0.18);
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }

        .eventos-form .photos-section .event-photo-quick-actions .btn-icon:hover {
            background-color: #dc3545;
            color: #fff;
            transform: translateY(-1px);
        }

        .eventos-form .photos-section .event-photo-body {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            flex: 1 1 auto;
        }

        .eventos-form .photos-section .event-photo-card .photo-url-field .form-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6c757d;
        }

        .eventos-form .photos-section .event-photo-card .photo-url-field .form-control {
            font-size: 0.72rem;
            padding: 0.35rem 0.55rem;
            border-radius: 0.5rem;
            border-color: rgba(13, 110, 253, 0.25);
            box-shadow: none;
        }

        .eventos-form .photos-section .event-photo-card .photo-url-field .form-control:focus {
            border-color: rgba(13, 110, 253, 0.6);
            box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.15);
        }

        .eventos-form .photos-section .event-photo-card .photo-url-field .form-text {
            font-size: 0.6rem;
            color: #a0a6ad;
        }

        .eventos-form .photos-section .event-photo-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: auto;
        }

        .eventos-form .photos-section .event-photo-actions .btn-soft-primary,
        .eventos-form .photos-section .event-photo-actions .btn-soft-secondary {
            flex: 1 1 0;
        }

        .eventos-form .btn-soft-primary,
        .eventos-form .btn-soft-secondary {
            border-radius: 999px;
            border: 1px solid transparent;
            font-weight: 600;
            font-size: 0.72rem;
            padding: 0.35rem 0.75rem;
            transition: all 0.2s ease;
        }

        .eventos-form .btn-soft-primary {
            background-color: rgba(13, 110, 253, 0.12);
            border-color: rgba(13, 110, 253, 0.18);
            color: #0b5ed7;
        }

        .eventos-form .btn-soft-primary:hover,
        .eventos-form .btn-soft-primary:focus {
            background-color: #0d6efd;
            color: #fff;
            border-color: #0d6efd;
            box-shadow: 0 0.25rem 0.75rem rgba(13, 110, 253, 0.25);
        }

        .eventos-form .btn-soft-secondary {
            background-color: rgba(108, 117, 125, 0.1);
            border-color: rgba(108, 117, 125, 0.12);
            color: #495057;
        }

        .eventos-form .btn-soft-secondary:hover,
        .eventos-form .btn-soft-secondary:focus {
            background-color: #495057;
            color: #fff;
            border-color: #495057;
            box-shadow: 0 0.25rem 0.75rem rgba(108, 117, 125, 0.25);
        }

        .eventos-form .photos-section .empty-state {
            border: 1px dashed rgba(13, 110, 253, 0.3);
            border-radius: 1rem;
            padding: 2rem 1.5rem;
            font-size: 0.85rem;
            background: rgba(13, 110, 253, 0.04);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .eventos-form .photos-section .empty-state .bi {
            font-size: 2rem;
            color: rgba(13, 110, 253, 0.6);
        }

        @media (min-width: 992px) {
            .eventos-form .metadata .col-lg-3 {
                flex: 0 0 auto;
                width: 25%;
            }

            .eventos-form .metadata .col-lg-6 {
                flex: 0 0 auto;
                width: 50%;
            }

        }
    </style>
{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid eventos-form">
    <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-primary bg-opacity-10 text-primary fw-semibold">
                Diretoria JP
            </span>
            <h1 class="h3 mb-0">{{ 'Editar Evento' if is_editing else 'Criar Evento' }}</h1>
        </div>
        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('diretoria_eventos_lista') }}">
            <i class="bi bi-list-ul me-1"></i>Listar eventos
        </a>
    </div>
    <form id="formEventos" class="needs-validation" novalidate>
        <div class="row g-3 mb-4 metadata">
            <div class="col-12 col-lg-6">
                <label for="nomeEvento" class="form-label">Nome do evento</label>
                <input type="text" class="form-control" id="nomeEvento" required>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="tipoEvento" class="form-label">Tipo de evento</label>
                <select id="tipoEvento" class="form-select" required>
                    <option value="" selected disabled>Selecione uma opção</option>
                    <option value="treinamento">Treinamento</option>
                    <option value="data_comemorativa">Data comemorativa</option>
                    <option value="evento">Evento</option>
                </select>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="dataEvento" class="form-label">Data</label>
                <input type="date" class="form-control" id="dataEvento" required>
            </div>
            <div class="col-12 col-lg-6">
                <label for="descricaoEvento" class="form-label">Descrição <span class="fw-normal text-muted">(opcional)</span></label>
                <textarea id="descricaoEvento" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="publicoEvento" class="form-label">Público participante</label>
                <select id="publicoEvento" class="form-select" required>
                    <option value="" selected disabled>Selecione uma opção</option>
                    <option value="interno">Interno</option>
                    <option value="externo">Externo</option>
                    <option value="ambos">Ambos</option>
                </select>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="numeroParticipantes" class="form-label">Participantes (nº de pessoas)</label>
                <input type="number" min="0" step="1" class="form-control" id="numeroParticipantes" required>
            </div>
        </div>

        <div class="border-top pt-4 mt-4"></div>

        <div class="mb-5">
            <h2 class="h6 text-uppercase text-muted fw-semibold section-heading mb-3">Serviços de alimentação</h2>

            <div class="event-category is-disabled" data-category="cafe">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Café da manhã</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleCafe" data-category-toggle="cafe">
                                <label class="form-check-label" for="toggleCafe">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total café da manhã:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                    <div class="border-bottom mt-4"></div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="almoco">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Almoço</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleAlmoco" data-category-toggle="almoco">
                                <label class="form-check-label" for="toggleAlmoco">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total almoço:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                    <div class="border-bottom mt-4"></div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="lanche">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Lanche</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleLanche" data-category-toggle="lanche">
                                <label class="form-check-label" for="toggleLanche">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total lanche:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="outros">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Outros serviços</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleOutros" data-category-toggle="outros">
                                <label class="form-check-label" for="toggleOutros">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total outros serviços:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="border-top pt-4 mt-4"></div>

        <div class="mb-5 photos-section">
            <h2 class="h6 text-uppercase text-muted fw-semibold section-heading mb-3">Fotos do evento</h2>
            <p class="text-muted small mb-3">Envie imagens para ilustrar o evento planejado. Elas poderão ser consultadas posteriormente na edição.</p>
            <div class="row g-3 align-items-end">
                <div class="col-12 col-lg-6">
                    <label for="fotosEventoInput" class="form-label">Adicionar fotos</label>
                    <input type="file" class="form-control" id="fotosEventoInput" accept="image/*" multiple>
                    <div class="form-text">Formatos permitidos: PNG, JPG, JPEG ou GIF (até 2&nbsp;MB por arquivo).</div>
                </div>
            </div>
            <input type="file" class="d-none" id="fotosEventoReplaceInput" accept="image/*">
            <div id="fotosEventoStatus" class="small mt-2 d-none"></div>
            <div id="fotosEventoEmpty" class="empty-state text-center text-muted mt-3">
                <i class="bi bi-images"></i>
                <span>Nenhuma foto adicionada até o momento.</span>
            </div>
            <div id="fotosEventoLista" class="row g-3 mt-1 photos-grid"></div>
        </div>

        <div class="border-top pt-4 mt-4"></div>

        <div class="row g-3 align-items-center totals-row">
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalCafe" class="form-label">Total café da manhã</label>
                <input type="text" class="form-control" id="totalCafe" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalAlmoco" class="form-label">Total almoço</label>
                <input type="text" class="form-control" id="totalAlmoco" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalLanche" class="form-label">Total lanche</label>
                <input type="text" class="form-control" id="totalLanche" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalOutros" class="form-label">Total outros serviços</label>
                <input type="text" class="form-control" id="totalOutros" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalEvento" class="form-label">Valor total estimado do evento</label>
                <input type="text" class="form-control fw-semibold" id="totalEvento" value="R$ 0,00" readonly>
            </div>
        </div>

        <div class="d-flex justify-content-start gap-2 mt-4">
            <button type="reset" class="btn btn-outline-secondary">Limpar</button>
            <button type="submit" class="btn btn-primary">{{ 'Atualizar evento' if is_editing else 'Salvar estimativa' }}</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        window.csrfToken = "{{ csrf_token() }}";
        window.diretoriaEventData = {% if is_editing %}{{ event_data | tojson }}{% else %}null{% endif %};
        (() => {
            const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

            const categories = {
                cafe: {
                    input: document.getElementById('totalCafe'),
                },
                almoco: {
                    input: document.getElementById('totalAlmoco'),
                },
                lanche: {
                    input: document.getElementById('totalLanche'),
                },
                outros: {
                    input: document.getElementById('totalOutros'),
                },
            };

            const form = document.getElementById('formEventos');
            const totalEventoInput = document.getElementById('totalEvento');
            const initialEvent = window.diretoriaEventData || null;
            const submitUrl = (initialEvent && initialEvent.submit_url)
                ? initialEvent.submit_url
                : "{{ url_for('diretoria_eventos') }}";
            const listUrl = "{{ url_for('diretoria_eventos_lista') }}";
            const csrfToken = window.csrfToken;
            const categoryControllers = {};
            const uploadUrl = "{{ url_for('upload_image') }}";
            const photosInput = document.getElementById('fotosEventoInput');
            const photosListEl = document.getElementById('fotosEventoLista');
            const photosEmptyState = document.getElementById('fotosEventoEmpty');
            const photosStatusEl = document.getElementById('fotosEventoStatus');
            const photosReplaceInput = document.getElementById('fotosEventoReplaceInput');
            let photoStatusTimeoutId = null;
            let photoReplacementIndex = null;

            const photosController = (() => {
                let items = [];

                const normalizePhotoValue = (value) => {
                    if (typeof value !== 'string') {
                        return '';
                    }

                    const trimmed = value.trim();
                    if (!trimmed) {
                        return '';
                    }

                    try {
                        return new URL(trimmed, window.location.origin).href;
                    } catch (error) {
                        return '';
                    }
                };

                function removeAt(index) {
                    if (index < 0 || index >= items.length) {
                        return false;
                    }
                    items = [...items.slice(0, index), ...items.slice(index + 1)];
                    render();
                    return true;
                }

                function updateAt(index, value) {
                    if (index < 0 || index >= items.length) {
                        return false;
                    }

                    const normalized = normalizePhotoValue(value);
                    if (!normalized) {
                        return false;
                    }

                    const duplicateIndex = items.findIndex(
                        (entry, entryIndex) => entryIndex !== index && entry === normalized,
                    );

                    if (duplicateIndex !== -1) {
                        return false;
                    }

                    if (items[index] === normalized) {
                        return true;
                    }

                    items = [
                        ...items.slice(0, index),
                        normalized,
                        ...items.slice(index + 1),
                    ];
                    render();
                    return true;
                }

                function render() {
                    if (!photosListEl) {
                        return;
                    }

                    photosListEl.innerHTML = '';

                    if (!items.length) {
                        if (photosEmptyState) {
                            photosEmptyState.classList.remove('d-none');
                        }
                        return;
                    }

                    if (photosEmptyState) {
                        photosEmptyState.classList.add('d-none');
                    }

                    items.forEach((url, index) => {
                        const col = document.createElement('div');
                        col.className = 'col-12 col-md-6 col-lg-4 col-xl-3';
                        col.dataset.photoIndex = String(index);

                        const safeUrl = String(url)
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#x27;');
                        const inputId = `fotoEventoUrl${index}`;

                        col.innerHTML = `
                            <div class="event-photo-card">
                                <div class="event-photo-media">
                                    <div class="event-photo-thumb">
                                        <img src="${safeUrl}" alt="Foto do evento ${index + 1}">
                                    </div>
                                    <div class="event-photo-quick-actions">
                                        <button type="button" class="btn btn-icon" data-action="remove-photo" aria-label="Remover foto">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="event-photo-body">
                                    <div class="photo-url-field">
                                        <label class="form-label" for="${inputId}">Link da foto</label>
                                        <input type="url" class="form-control form-control-sm" id="${inputId}" value="${safeUrl}" data-photo-url-input>
                                        <div class="form-text">Edite o link manualmente ou utilize o botão "Substituir".</div>
                                    </div>
                                    <div class="event-photo-actions">
                                        <a href="${safeUrl}" target="_blank" rel="noopener" class="btn btn-soft-secondary btn-sm">
                                            <i class="bi bi-eye me-1"></i>Visualizar
                                        </a>
                                        <button type="button" class="btn btn-soft-primary btn-sm" data-action="replace-photo">
                                            <i class="bi bi-arrow-repeat me-1"></i>Substituir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;

                        const removeButton = col.querySelector('[data-action="remove-photo"]');
                        if (removeButton) {
                            removeButton.addEventListener('click', () => {
                                if (removeAt(index)) {
                                    setPhotoStatus('Foto removida.', 'muted', 3500);
                                }
                            });
                        }

                        const replaceButton = col.querySelector('[data-action="replace-photo"]');
                        if (replaceButton) {
                            replaceButton.addEventListener('click', () => {
                                if (!photosReplaceInput) {
                                    return;
                                }
                                photoReplacementIndex = index;
                                photosReplaceInput.click();
                            });
                        }

                        const urlInput = col.querySelector('[data-photo-url-input]');
                        if (urlInput instanceof HTMLInputElement) {
                            const commitUpdate = () => {
                                const currentItems = getItems();
                                const previousValue = currentItems[index] || '';
                                const nextValue = urlInput.value;
                                const normalizedNextValue = normalizePhotoValue(nextValue);

                                if (!normalizedNextValue) {
                                    setPhotoStatus('Informe um link válido para a foto.', 'danger', 5000);
                                    urlInput.value = previousValue;
                                    return;
                                }

                                if (normalizedNextValue === previousValue) {
                                    urlInput.value = previousValue;
                                    return;
                                }

                                if (
                                    currentItems.some(
                                        (entry, entryIndex) =>
                                            entryIndex !== index && entry === normalizedNextValue,
                                    )
                                ) {
                                    setPhotoStatus('Esta foto já foi adicionada.', 'danger', 5000);
                                    urlInput.value = previousValue;
                                    return;
                                }

                                const updated = updateAt(index, normalizedNextValue);
                                if (updated) {
                                    setPhotoStatus('Link da foto atualizado com sucesso.', 'success', 3500);
                                    window.requestAnimationFrame(() => {
                                        const refreshedInput = photosListEl.querySelector(
                                            `[data-photo-index="${index}"] [data-photo-url-input]`,
                                        );
                                        if (refreshedInput instanceof HTMLInputElement) {
                                            refreshedInput.focus({ preventScroll: true });
                                            refreshedInput.setSelectionRange(
                                                refreshedInput.value.length,
                                                refreshedInput.value.length,
                                            );
                                        }
                                    });
                                } else {
                                    setPhotoStatus('Não foi possível atualizar o link da foto.', 'danger', 5000);
                                    urlInput.value = previousValue;
                                }
                            };

                            urlInput.addEventListener('blur', commitUpdate);
                            urlInput.addEventListener('keydown', (event) => {
                                if (event.key === 'Enter') {
                                    event.preventDefault();
                                    commitUpdate();
                                }
                            });
                        }

                        photosListEl.appendChild(col);
                    });
                }

                function setItems(values) {
                    if (!Array.isArray(values)) {
                        items = [];
                        render();
                        return;
                    }

                    const nextItems = [];
                    values.forEach((value) => {
                        const normalized = normalizePhotoValue(value);
                        if (normalized && !nextItems.includes(normalized)) {
                            nextItems.push(normalized);
                        }
                    });

                    items = nextItems;
                    render();
                }

                function addItem(value) {
                    const normalized = normalizePhotoValue(value);
                    if (!normalized || items.includes(normalized)) {
                        return false;
                    }
                    items = [...items, normalized];
                    render();
                    return true;
                }

                function getItems() {
                    return items.slice();
                }

                function clear() {
                    items = [];
                    render();
                }

                render();

                return { setItems, addItem, removeAt, updateAt, getItems, clear };
            })();

            const setPhotoStatus = (message = '', type = 'muted', timeoutMs = 0) => {
                if (!photosStatusEl) {
                    return;
                }

                if (photoStatusTimeoutId) {
                    clearTimeout(photoStatusTimeoutId);
                    photoStatusTimeoutId = null;
                }

                if (!message) {
                    photosStatusEl.textContent = '';
                    photosStatusEl.classList.add('d-none');
                    photosStatusEl.classList.remove('text-danger', 'text-success', 'text-muted');
                    return;
                }

                photosStatusEl.textContent = message;
                photosStatusEl.classList.remove('d-none', 'text-danger', 'text-success', 'text-muted');

                if (type === 'danger') {
                    photosStatusEl.classList.add('text-danger');
                } else if (type === 'success') {
                    photosStatusEl.classList.add('text-success');
                } else {
                    photosStatusEl.classList.add('text-muted');
                }

                if (timeoutMs > 0) {
                    photoStatusTimeoutId = window.setTimeout(() => {
                        setPhotoStatus('');
                    }, timeoutMs);
                }
            };

            const uploadPhoto = async (file) => {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                    },
                    body: formData,
                });

                const data = await response.json().catch(() => null);

                if (!response.ok || !data || !data.image_url) {
                    const message = (data && (data.error || data.message)) || 'Não foi possível enviar a foto.';
                    throw new Error(message);
                }

                return data.image_url;
            };

            const handlePhotoSelection = async (files, targetIndex = null) => {
                const fileList = Array.from(files).filter((item) => item instanceof File);

                if (!fileList.length) {
                    return;
                }

                if (targetIndex !== null) {
                    fileList.splice(1);
                }

                for (const file of fileList) {
                    if (!(file instanceof File)) {
                        continue;
                    }

                    if (!file.type || !file.type.startsWith('image/')) {
                        setPhotoStatus(`O arquivo "${file.name}" não parece ser uma imagem válida.`, 'danger', 5000);
                        if (targetIndex !== null) {
                            break;
                        }
                        continue;
                    }

                    try {
                        if (targetIndex === null) {
                            setPhotoStatus(`Enviando "${file.name}"...`, 'muted');
                        } else {
                            setPhotoStatus(`Substituindo por "${file.name}"...`, 'muted');
                        }
                        const imageUrl = await uploadPhoto(file);
                        if (targetIndex === null) {
                            const added = photosController.addItem(imageUrl);
                            if (added) {
                                setPhotoStatus(`Foto "${file.name}" adicionada com sucesso.`, 'success', 3500);
                            } else {
                                setPhotoStatus('A foto enviada já está presente na lista.', 'muted', 4000);
                            }
                        } else {
                            const updated = photosController.updateAt(targetIndex, imageUrl);
                            if (updated) {
                                setPhotoStatus('Foto substituída com sucesso.', 'success', 3500);
                            } else {
                                setPhotoStatus('Não foi possível atualizar a foto selecionada.', 'danger', 5000);
                            }
                            break;
                        }
                    } catch (error) {
                        const message = error instanceof Error ? error.message : 'Não foi possível enviar a foto.';
                        setPhotoStatus(message, 'danger');
                        if (targetIndex !== null) {
                            break;
                        }
                    }
                }
            };

            if (photosInput) {
                photosInput.addEventListener('change', () => {
                    if (!photosInput.files || !photosInput.files.length) {
                        return;
                    }

                    const files = Array.from(photosInput.files);
                    handlePhotoSelection(files);
                    photosInput.value = '';
                });
            }

            if (photosReplaceInput) {
                photosReplaceInput.addEventListener('change', () => {
                    const targetIndex = Number.isInteger(photoReplacementIndex) && photoReplacementIndex >= 0
                        ? photoReplacementIndex
                        : null;
                    photoReplacementIndex = null;

                    if (!photosReplaceInput.files || !photosReplaceInput.files.length) {
                        photosReplaceInput.value = '';
                        return;
                    }

                    if (targetIndex === null) {
                        photosReplaceInput.value = '';
                        return;
                    }

                    const file = photosReplaceInput.files[0];
                    handlePhotoSelection([file], targetIndex);
                    photosReplaceInput.value = '';
                });
            }

            const createItemRow = (categoryKey, values = {}) => {
                const row = document.createElement('div');
                row.className = 'row g-3 align-items-end category-item mb-3';
                row.innerHTML = `
                    <div class="col-12 col-md-6 col-lg-5">
                        <label class="form-label">Item</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label">Quantidade</label>
                        <input type="number" class="form-control" min="0" step="1" required>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label">Valor unitário (R$)</label>
                        <input type="number" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                        <button type="button" class="btn btn-link text-danger px-0" data-action="remove-item">
                            <i class="bi bi-trash"></i>
                        </button>
                        <div class="small text-muted" data-item-total>R$ 0,00</div>
                    </div>
                `;

                const inputs = row.querySelectorAll('input');
                const quantityInput = inputs[1];
                const unitInput = inputs[2];
                const itemTotalDisplay = row.querySelector('[data-item-total]');

                const updateItemTotal = () => {
                    const quantity = Number.parseFloat(quantityInput.value.replace(',', '.')) || 0;
                    const unitValue = Number.parseFloat(unitInput.value.replace(',', '.')) || 0;
                    const itemTotal = quantity * unitValue;
                    itemTotalDisplay.textContent = formatter.format(itemTotal);
                    updateCategoryTotals();
                };

                quantityInput.addEventListener('input', updateItemTotal);
                unitInput.addEventListener('input', updateItemTotal);

                row.querySelector('[data-action="remove-item"]').addEventListener('click', () => {
                    row.remove();
                    updateCategoryTotals();
                });

                const nameValue = values.name != null ? values.name : '';
                const quantityValue = Number.isFinite(values.quantity) ? values.quantity : '';
                const unitValue = Number.isFinite(values.unit_value) ? values.unit_value : '';

                inputs[0].value = nameValue;
                if (quantityValue !== '') {
                    quantityInput.value = quantityValue;
                }
                if (unitValue !== '') {
                    unitInput.value = unitValue;
                }

                updateItemTotal();

                return row;
            };

            const updateCategoryTotals = () => {
                let eventTotal = 0;

                document.querySelectorAll('.event-category').forEach((categoryEl) => {
                    const categoryKey = categoryEl.dataset.category;
                    const toggle = categoryEl.querySelector('[data-category-toggle]');
                    const isActive = !!(toggle && toggle.checked);
                    let categoryTotal = 0;

                    if (isActive) {
                        categoryEl.querySelectorAll('.category-item').forEach((itemRow) => {
                            const inputs = itemRow.querySelectorAll('input');
                            const quantityInput = inputs[1];
                            const unitInput = inputs[2];
                            const quantity = Number.parseFloat(quantityInput.value.replace(',', '.')) || 0;
                            const unitValue = Number.parseFloat(unitInput.value.replace(',', '.')) || 0;
                            categoryTotal += quantity * unitValue;
                        });
                    }

                    const totalDisplay = categoryEl.querySelector('[data-category-total]');
                    if (totalDisplay) {
                        totalDisplay.textContent = formatter.format(categoryTotal);
                    }

                    if (categories[categoryKey] && categories[categoryKey].input) {
                        categories[categoryKey].input.value = formatter.format(categoryTotal);
                    }

                    eventTotal += categoryTotal;
                });

                totalEventoInput.value = formatter.format(eventTotal);
            };

            document.querySelectorAll('.event-category').forEach((categoryEl) => {
                const categoryKey = categoryEl.dataset.category;
                const itemsContainer = categoryEl.querySelector('.category-items');
                const addButton = categoryEl.querySelector('[data-action="add-item"]');

                const toggle = categoryEl.querySelector('[data-category-toggle]');
                const categoryBody = categoryEl.querySelector('.category-body');

                const setCategoryState = (active, options = {}) => {
                    categoryEl.classList.toggle('is-active', active);
                    categoryEl.classList.toggle('is-disabled', !active);

                    if (addButton) {
                        addButton.disabled = !active;
                        addButton.classList.toggle('d-none', !active);
                    }

                    categoryBody.style.display = active ? 'block' : 'none';

                     if (toggle) {
                        toggle.checked = active;
                    }

                    if (active && itemsContainer.childElementCount === 0 && !options.prefill) {
                        const row = createItemRow(categoryKey);
                        itemsContainer.appendChild(row);
                    }

                    itemsContainer.querySelectorAll('.category-item').forEach((itemRow) => {
                        itemRow.querySelectorAll('input').forEach((input) => {
                            input.disabled = !active;
                        });

                        const removeButton = itemRow.querySelector('[data-action="remove-item"]');
                        if (removeButton) {
                            removeButton.disabled = !active;
                        }
                    });

                    updateCategoryTotals();
                };

                const addItem = (values = {}) => {
                    const row = createItemRow(categoryKey, values);
                    itemsContainer.appendChild(row);
                    updateCategoryTotals();
                    return row;
                };

                if (addButton) {
                    addButton.addEventListener('click', () => addItem());
                }

                if (toggle) {
                    toggle.addEventListener('change', () => {
                        setCategoryState(toggle.checked);
                    });
                }

                categoryBody.style.display = 'none';
                setCategoryState(false);

                categoryControllers[categoryKey] = {
                    setState: (active, options = {}) => setCategoryState(active, options),
                    addItem,
                    clearItems: () => {
                        itemsContainer.innerHTML = '';
                    },
                    itemsContainer,
                };
            });

            form.addEventListener('reset', () => {
                setTimeout(() => {
                    document.querySelectorAll('.event-category .category-items').forEach((container) => {
                        container.innerHTML = '';
                    });

                    document.querySelectorAll('[data-category-toggle]').forEach((toggle) => {
                        toggle.checked = false;
                        toggle.dispatchEvent(new Event('change'));
                    });

                    photosController.clear();
                    setPhotoStatus('');

                    if (initialEvent) {
                        applyInitialData();
                    } else {
                        updateCategoryTotals();
                    }
                }, 0);
            });

            const applyInitialData = () => {
                const initialPhotos = initialEvent && Array.isArray(initialEvent.photos)
                    ? initialEvent.photos
                    : [];
                photosController.setItems(initialPhotos);
                setPhotoStatus('');

                if (!initialEvent) {
                    updateCategoryTotals();
                    return;
                }

                document.getElementById('nomeEvento').value = initialEvent.name || '';
                document.getElementById('tipoEvento').value = initialEvent.type || '';
                document.getElementById('dataEvento').value = initialEvent.date || '';
                document.getElementById('descricaoEvento').value = initialEvent.description || '';
                document.getElementById('publicoEvento').value = initialEvent.audience || '';
                document.getElementById('numeroParticipantes').value =
                    initialEvent.participants != null ? initialEvent.participants : '';

                const initialCategories = (initialEvent && initialEvent.categories) || {};

                Object.keys(categoryControllers).forEach((key) => {
                    const controller = categoryControllers[key];
                    const categoryData = initialCategories[key] || {};
                    const items = Array.isArray(categoryData.items) ? categoryData.items : [];

                    if (!controller) {
                        return;
                    }

                    if (!items.length) {
                        controller.setState(false, { prefill: true });
                        controller.clearItems();
                        return;
                    }

                    controller.setState(true, { prefill: true });
                    controller.clearItems();

                    items.forEach((item) => {
                        controller.addItem({
                            name: (item && item.name) || '',
                            quantity: Number.isFinite(item && item.quantity)
                                ? item.quantity
                                : parseFloat(item && item.quantity) || 0,
                            unit_value: Number.isFinite(item && item.unit_value)
                                ? item.unit_value
                                : parseFloat(item && item.unit_value) || 0,
                        });
                    });
                });

                updateCategoryTotals();
            };

            applyInitialData();

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                form.classList.add('was-validated');

                if (!form.checkValidity()) {
                    return;
                }

                const submitButton = form.querySelector('button[type="submit"]');
                let shouldUnlockButton = true;
                if (submitButton) {
                    submitButton.disabled = true;
                }

                const payload = {
                    name: document.getElementById('nomeEvento').value.trim(),
                    type: document.getElementById('tipoEvento').value,
                    date: document.getElementById('dataEvento').value,
                    description: document.getElementById('descricaoEvento').value.trim(),
                    audience: document.getElementById('publicoEvento').value,
                    participants: Number.parseInt(document.getElementById('numeroParticipantes').value, 10) || 0,
                    categories: {},
                    photos: photosController.getItems(),
                };

                document.querySelectorAll('.event-category').forEach((categoryEl) => {
                    const toggle = categoryEl.querySelector('[data-category-toggle]');
                    if (!toggle || !toggle.checked) {
                        return;
                    }

                    const categoryKey = categoryEl.dataset.category;
                    const items = [];

                    categoryEl.querySelectorAll('.category-item').forEach((itemRow) => {
                        const inputs = itemRow.querySelectorAll('input');
                        const itemName = inputs[0].value.trim();
                        const quantityValue = Number.parseFloat(inputs[1].value);
                        const unitValue = Number.parseFloat(inputs[2].value);

                        if (!itemName || !Number.isFinite(quantityValue) || !Number.isFinite(unitValue)) {
                            return;
                        }

                        items.push({
                            name: itemName,
                            quantity: quantityValue,
                            unit_value: unitValue,
                        });
                    });

                    payload.categories[categoryKey] = { items };
                });

                try {
                    const response = await fetch(submitUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json().catch(() => null);

                    if (!response.ok) {
                    const message = (
                        data && Array.isArray(data.errors) && data.errors.length
                            ? data.errors.join('\n')
                            : (data && data.error) || 'Não foi possível salvar o evento.'
                    );
                        alert(message);
                        return;
                    }

                    const redirectUrl = (data && data.redirect_url) || listUrl;
                    shouldUnlockButton = false;
                    window.location.href = redirectUrl;
                } catch (error) {
                    alert('Não foi possível salvar o evento. Tente novamente.');
                } finally {
                    if (submitButton && shouldUnlockButton) {
                        submitButton.disabled = false;
                    }
                }
            });
        })();
    </script>
{% endblock %}
