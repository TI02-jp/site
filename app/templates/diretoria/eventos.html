{% extends "base.html" %}
{% set is_editing = event_data is defined and event_data %}
{% block title %}Eventos - Diretoria JP{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
        .eventos-form .section-heading {
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }

        .eventos-form .form-label {
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: #495057;
            text-align: left;
            padding: 0;
        }

        .eventos-form .form-control,
        .eventos-form .form-select {
            font-size: 0.775rem;
            padding: 0.35rem 0.65rem;
        }

        .eventos-form textarea.form-control {
            min-height: 110px;
        }

        .eventos-form .category-item .form-control {
            font-size: 0.72rem;
        }

        .eventos-form .category-item .form-label {
            font-size: 0.62rem;
            text-align: left;
        }

        .eventos-form .category-item [data-item-total] {
            font-size: 0.65rem;
        }

        .eventos-form .event-category {
            border-left: 2px solid transparent;
            padding-left: 0.25rem;
        }

        .eventos-form .event-category.is-disabled {
            border-color: transparent;
        }

        .eventos-form .event-category.is-active {
            border-color: rgba(13, 110, 253, 0.35);
        }

        .eventos-form .event-category .category-body {
            display: none;
        }

        .eventos-form .event-category.is-active .category-body {
            display: block;
        }

        .eventos-form .event-category .category-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .eventos-form .event-category .category-title {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: flex-start;
            gap: 0.75rem;
        }

        .eventos-form .event-category .toggle-wrapper {
            font-size: 0.68rem;
        }

        .eventos-form .event-category .toggle-wrapper .form-check {
            padding-left: 0;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .eventos-form .event-category .toggle-wrapper .form-check-input {
            width: 2.25em;
            height: 1.25em;
            margin-top: 0;
            margin-left: 0;
            float: none;
        }

        .eventos-form .event-category .toggle-wrapper .form-check-label {
            font-weight: 600;
            color: #495057;
        }

        .eventos-form .category-item button[data-action="remove-item"] {
            font-size: 0.7rem;
            padding: 0.2rem 0.45rem;
        }

        .eventos-form .event-category .category-footer {
            display: flex;
            justify-content: flex-start;
            margin-top: 1rem;
        }

        .eventos-form .event-category .category-footer [data-action="add-item"] {
            flex-shrink: 0;
        }

        .eventos-form .totals-row .form-control {
            font-size: 0.8rem;
        }

        .eventos-form .totals-row .form-label {
            text-align: left;
        }

        @media (min-width: 992px) {
            .eventos-form .metadata .col-lg-3 {
                flex: 0 0 auto;
                width: 25%;
            }

            .eventos-form .metadata .col-lg-6 {
                flex: 0 0 auto;
                width: 50%;
            }

        }
    </style>
{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid eventos-form">
    <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
        <div class="d-flex align-items-center gap-3">
            <span class="badge bg-primary bg-opacity-10 text-primary fw-semibold">
                Diretoria JP
            </span>
            <h1 class="h3 mb-0">{{ 'Editar Evento' if is_editing else 'Criar Evento' }}</h1>
        </div>
        <a class="btn btn-outline-primary btn-sm" href="{{ url_for('diretoria_eventos_lista') }}">
            <i class="bi bi-list-ul me-1"></i>Listar eventos
        </a>
    </div>
    <form id="formEventos" class="needs-validation" novalidate>
        <div class="row g-3 mb-4 metadata">
            <div class="col-12 col-lg-6">
                <label for="nomeEvento" class="form-label">Nome do evento</label>
                <input type="text" class="form-control" id="nomeEvento" required>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="tipoEvento" class="form-label">Tipo de evento</label>
                <select id="tipoEvento" class="form-select" required>
                    <option value="" selected disabled>Selecione uma opção</option>
                    <option value="treinamento">Treinamento</option>
                    <option value="data_comemorativa">Data comemorativa</option>
                    <option value="evento">Evento</option>
                </select>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="dataEvento" class="form-label">Data</label>
                <input type="date" class="form-control" id="dataEvento" required>
            </div>
            <div class="col-12 col-lg-6">
                <label for="descricaoEvento" class="form-label">Descrição <span class="fw-normal text-muted">(opcional)</span></label>
                <textarea id="descricaoEvento" class="form-control" rows="3"></textarea>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="publicoEvento" class="form-label">Público participante</label>
                <select id="publicoEvento" class="form-select" required>
                    <option value="" selected disabled>Selecione uma opção</option>
                    <option value="interno">Interno</option>
                    <option value="externo">Externo</option>
                    <option value="ambos">Ambos</option>
                </select>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="numeroParticipantes" class="form-label">Participantes (nº de pessoas)</label>
                <input type="number" min="0" step="1" class="form-control" id="numeroParticipantes" required>
            </div>
        </div>

        <div class="border-top pt-4 mt-4"></div>

        <div class="mb-5">
            <h2 class="h6 text-uppercase text-muted fw-semibold section-heading mb-3">Serviços de alimentação</h2>

            <div class="event-category is-disabled" data-category="cafe">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Café da manhã</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleCafe" data-category-toggle="cafe">
                                <label class="form-check-label" for="toggleCafe">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total café da manhã:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                    <div class="border-bottom mt-4"></div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="almoco">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Almoço</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleAlmoco" data-category-toggle="almoco">
                                <label class="form-check-label" for="toggleAlmoco">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total almoço:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                    <div class="border-bottom mt-4"></div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="lanche">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Lanche</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleLanche" data-category-toggle="lanche">
                                <label class="form-check-label" for="toggleLanche">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total lanche:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                </div>
            </div>

            <div class="event-category pt-4 is-disabled" data-category="outros">
                <div class="category-header">
                    <div class="category-title">
                        <h3 class="fs-6 fw-semibold mb-0">Outros serviços</h3>
                        <div class="toggle-wrapper">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="toggleOutros" data-category-toggle="outros">
                                <label class="form-check-label" for="toggleOutros">Incluir serviço</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="category-body">
                    <div class="category-items"></div>
                    <div class="category-footer">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-action="add-item" disabled>
                            <i class="bi bi-plus-lg me-1"></i>Adicionar item
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted me-2">Total outros serviços:</span>
                        <span class="fw-semibold" data-category-total>R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="border-top pt-4 mt-4"></div>

        <div class="row g-3 align-items-center totals-row">
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalCafe" class="form-label">Total café da manhã</label>
                <input type="text" class="form-control" id="totalCafe" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalAlmoco" class="form-label">Total almoço</label>
                <input type="text" class="form-control" id="totalAlmoco" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalLanche" class="form-label">Total lanche</label>
                <input type="text" class="form-control" id="totalLanche" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalOutros" class="form-label">Total outros serviços</label>
                <input type="text" class="form-control" id="totalOutros" value="R$ 0,00" readonly>
            </div>
            <div class="col-12 col-md-6 col-lg-3">
                <label for="totalEvento" class="form-label">Valor total estimado do evento</label>
                <input type="text" class="form-control fw-semibold" id="totalEvento" value="R$ 0,00" readonly>
            </div>
        </div>

        <div class="d-flex justify-content-start gap-2 mt-4">
            <button type="reset" class="btn btn-outline-secondary">Limpar</button>
            <button type="submit" class="btn btn-primary">{{ 'Atualizar evento' if is_editing else 'Salvar estimativa' }}</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        window.csrfToken = "{{ csrf_token() }}";
        window.diretoriaEventData = {% if is_editing %}{{ event_data | tojson }}{% else %}null{% endif %};
        (() => {
            const formatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

            const categories = {
                cafe: {
                    input: document.getElementById('totalCafe'),
                },
                almoco: {
                    input: document.getElementById('totalAlmoco'),
                },
                lanche: {
                    input: document.getElementById('totalLanche'),
                },
                outros: {
                    input: document.getElementById('totalOutros'),
                },
            };

            const form = document.getElementById('formEventos');
            const totalEventoInput = document.getElementById('totalEvento');
            const initialEvent = window.diretoriaEventData || null;
            const submitUrl = (initialEvent && initialEvent.submit_url)
                ? initialEvent.submit_url
                : "{{ url_for('diretoria_eventos') }}";
            const listUrl = "{{ url_for('diretoria_eventos_lista') }}";
            const csrfToken = window.csrfToken;
            const categoryControllers = {};

            const createItemRow = (categoryKey, values = {}) => {
                const row = document.createElement('div');
                row.className = 'row g-3 align-items-end category-item mb-3';
                row.innerHTML = `
                    <div class="col-12 col-md-6 col-lg-5">
                        <label class="form-label">Item</label>
                        <input type="text" class="form-control" required>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label">Quantidade</label>
                        <input type="number" class="form-control" min="0" step="1" required>
                    </div>
                    <div class="col-6 col-md-3 col-lg-2">
                        <label class="form-label">Valor unitário (R$)</label>
                        <input type="number" class="form-control" min="0" step="0.01" required>
                    </div>
                    <div class="col-12 col-md-6 col-lg-3 d-flex flex-column flex-md-row align-items-start align-items-md-center gap-2">
                        <button type="button" class="btn btn-link text-danger px-0" data-action="remove-item">
                            <i class="bi bi-trash"></i>
                        </button>
                        <div class="small text-muted" data-item-total>R$ 0,00</div>
                    </div>
                `;

                const inputs = row.querySelectorAll('input');
                const quantityInput = inputs[1];
                const unitInput = inputs[2];
                const itemTotalDisplay = row.querySelector('[data-item-total]');

                const updateItemTotal = () => {
                    const quantity = Number.parseFloat(quantityInput.value.replace(',', '.')) || 0;
                    const unitValue = Number.parseFloat(unitInput.value.replace(',', '.')) || 0;
                    const itemTotal = quantity * unitValue;
                    itemTotalDisplay.textContent = formatter.format(itemTotal);
                    updateCategoryTotals();
                };

                quantityInput.addEventListener('input', updateItemTotal);
                unitInput.addEventListener('input', updateItemTotal);

                row.querySelector('[data-action="remove-item"]').addEventListener('click', () => {
                    row.remove();
                    updateCategoryTotals();
                });

                const nameValue = values.name != null ? values.name : '';
                const quantityValue = Number.isFinite(values.quantity) ? values.quantity : '';
                const unitValue = Number.isFinite(values.unit_value) ? values.unit_value : '';

                inputs[0].value = nameValue;
                if (quantityValue !== '') {
                    quantityInput.value = quantityValue;
                }
                if (unitValue !== '') {
                    unitInput.value = unitValue;
                }

                updateItemTotal();

                return row;
            };

            const updateCategoryTotals = () => {
                let eventTotal = 0;

                document.querySelectorAll('.event-category').forEach((categoryEl) => {
                    const categoryKey = categoryEl.dataset.category;
                    const toggle = categoryEl.querySelector('[data-category-toggle]');
                    const isActive = !!(toggle && toggle.checked);
                    let categoryTotal = 0;

                    if (isActive) {
                        categoryEl.querySelectorAll('.category-item').forEach((itemRow) => {
                            const inputs = itemRow.querySelectorAll('input');
                            const quantityInput = inputs[1];
                            const unitInput = inputs[2];
                            const quantity = Number.parseFloat(quantityInput.value.replace(',', '.')) || 0;
                            const unitValue = Number.parseFloat(unitInput.value.replace(',', '.')) || 0;
                            categoryTotal += quantity * unitValue;
                        });
                    }

                    const totalDisplay = categoryEl.querySelector('[data-category-total]');
                    if (totalDisplay) {
                        totalDisplay.textContent = formatter.format(categoryTotal);
                    }

                    if (categories[categoryKey] && categories[categoryKey].input) {
                        categories[categoryKey].input.value = formatter.format(categoryTotal);
                    }

                    eventTotal += categoryTotal;
                });

                totalEventoInput.value = formatter.format(eventTotal);
            };

            document.querySelectorAll('.event-category').forEach((categoryEl) => {
                const categoryKey = categoryEl.dataset.category;
                const itemsContainer = categoryEl.querySelector('.category-items');
                const addButton = categoryEl.querySelector('[data-action="add-item"]');

                const toggle = categoryEl.querySelector('[data-category-toggle]');
                const categoryBody = categoryEl.querySelector('.category-body');

                const setCategoryState = (active, options = {}) => {
                    categoryEl.classList.toggle('is-active', active);
                    categoryEl.classList.toggle('is-disabled', !active);

                    if (addButton) {
                        addButton.disabled = !active;
                        addButton.classList.toggle('d-none', !active);
                    }

                    categoryBody.style.display = active ? 'block' : 'none';

                     if (toggle) {
                        toggle.checked = active;
                    }

                    if (active && itemsContainer.childElementCount === 0 && !options.prefill) {
                        const row = createItemRow(categoryKey);
                        itemsContainer.appendChild(row);
                    }

                    itemsContainer.querySelectorAll('.category-item').forEach((itemRow) => {
                        itemRow.querySelectorAll('input').forEach((input) => {
                            input.disabled = !active;
                        });

                        const removeButton = itemRow.querySelector('[data-action="remove-item"]');
                        if (removeButton) {
                            removeButton.disabled = !active;
                        }
                    });

                    updateCategoryTotals();
                };

                const addItem = (values = {}) => {
                    const row = createItemRow(categoryKey, values);
                    itemsContainer.appendChild(row);
                    updateCategoryTotals();
                    return row;
                };

                if (addButton) {
                    addButton.addEventListener('click', () => addItem());
                }

                if (toggle) {
                    toggle.addEventListener('change', () => {
                        setCategoryState(toggle.checked);
                    });
                }

                categoryBody.style.display = 'none';
                setCategoryState(false);

                categoryControllers[categoryKey] = {
                    setState: (active, options = {}) => setCategoryState(active, options),
                    addItem,
                    clearItems: () => {
                        itemsContainer.innerHTML = '';
                    },
                    itemsContainer,
                };
            });

            form.addEventListener('reset', () => {
                setTimeout(() => {
                    document.querySelectorAll('.event-category .category-items').forEach((container) => {
                        container.innerHTML = '';
                    });

                    document.querySelectorAll('[data-category-toggle]').forEach((toggle) => {
                        toggle.checked = false;
                        toggle.dispatchEvent(new Event('change'));
                    });

                    updateCategoryTotals();
                    if (initialEvent) {
                        applyInitialData();
                    }
                }, 0);
            });

            const applyInitialData = () => {
                if (!initialEvent) {
                    updateCategoryTotals();
                    return;
                }

                document.getElementById('nomeEvento').value = initialEvent.name || '';
                document.getElementById('tipoEvento').value = initialEvent.type || '';
                document.getElementById('dataEvento').value = initialEvent.date || '';
                document.getElementById('descricaoEvento').value = initialEvent.description || '';
                document.getElementById('publicoEvento').value = initialEvent.audience || '';
                document.getElementById('numeroParticipantes').value =
                    initialEvent.participants != null ? initialEvent.participants : '';

                const initialCategories = (initialEvent && initialEvent.categories) || {};

                Object.keys(categoryControllers).forEach((key) => {
                    const controller = categoryControllers[key];
                    const categoryData = initialCategories[key] || {};
                    const items = Array.isArray(categoryData.items) ? categoryData.items : [];

                    if (!controller) {
                        return;
                    }

                    if (!items.length) {
                        controller.setState(false, { prefill: true });
                        controller.clearItems();
                        return;
                    }

                    controller.setState(true, { prefill: true });
                    controller.clearItems();

                    items.forEach((item) => {
                        controller.addItem({
                            name: (item && item.name) || '',
                            quantity: Number.isFinite(item && item.quantity)
                                ? item.quantity
                                : parseFloat(item && item.quantity) || 0,
                            unit_value: Number.isFinite(item && item.unit_value)
                                ? item.unit_value
                                : parseFloat(item && item.unit_value) || 0,
                        });
                    });
                });

                updateCategoryTotals();
            };

            applyInitialData();

            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                form.classList.add('was-validated');

                if (!form.checkValidity()) {
                    return;
                }

                const submitButton = form.querySelector('button[type="submit"]');
                let shouldUnlockButton = true;
                if (submitButton) {
                    submitButton.disabled = true;
                }

                const payload = {
                    name: document.getElementById('nomeEvento').value.trim(),
                    type: document.getElementById('tipoEvento').value,
                    date: document.getElementById('dataEvento').value,
                    description: document.getElementById('descricaoEvento').value.trim(),
                    audience: document.getElementById('publicoEvento').value,
                    participants: Number.parseInt(document.getElementById('numeroParticipantes').value, 10) || 0,
                    categories: {},
                };

                document.querySelectorAll('.event-category').forEach((categoryEl) => {
                    const toggle = categoryEl.querySelector('[data-category-toggle]');
                    if (!toggle || !toggle.checked) {
                        return;
                    }

                    const categoryKey = categoryEl.dataset.category;
                    const items = [];

                    categoryEl.querySelectorAll('.category-item').forEach((itemRow) => {
                        const inputs = itemRow.querySelectorAll('input');
                        const itemName = inputs[0].value.trim();
                        const quantityValue = Number.parseFloat(inputs[1].value);
                        const unitValue = Number.parseFloat(inputs[2].value);

                        if (!itemName || !Number.isFinite(quantityValue) || !Number.isFinite(unitValue)) {
                            return;
                        }

                        items.push({
                            name: itemName,
                            quantity: quantityValue,
                            unit_value: unitValue,
                        });
                    });

                    payload.categories[categoryKey] = { items };
                });

                try {
                    const response = await fetch(submitUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json().catch(() => null);

                    if (!response.ok) {
                    const message = (
                        data && Array.isArray(data.errors) && data.errors.length
                            ? data.errors.join('\n')
                            : (data && data.error) || 'Não foi possível salvar o evento.'
                    );
                        alert(message);
                        return;
                    }

                    const redirectUrl = (data && data.redirect_url) || listUrl;
                    shouldUnlockButton = false;
                    window.location.href = redirectUrl;
                } catch (error) {
                    alert('Não foi possível salvar o evento. Tente novamente.');
                } finally {
                    if (submitButton && shouldUnlockButton) {
                        submitButton.disabled = false;
                    }
                }
            });
        })();
    </script>
{% endblock %}
