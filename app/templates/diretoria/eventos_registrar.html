{% extends "base.html" %}
{% block title %}Registrar Evento - Diretoria JP{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
        .management-event-page {
            font-size: 0.78rem;
        }

        .management-event-page h1 {
            font-size: 1rem;
            margin-bottom: 0.2rem;
        }

        .management-event-page .card-body {
            padding: 1rem 1.2rem;
        }

        .management-event-page label,
        .management-event-page .form-label {
            text-align: left;
            margin-bottom: 0.25rem;
        }

        .management-event-page .form-control,
        .management-event-page .form-select,
        .management-event-page .form-check-label {
            font-size: 0.72rem;
        }

        .management-event-page .form-control,
        .management-event-page .form-select {
            padding: 0.32rem 0.45rem;
        }

        .management-event-page .section-title {
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .management-event-page .service-card {
            border: 1px solid var(--bs-border-color);
            border-radius: 0.6rem;
            padding: 0.75rem 0.9rem;
            background: #f4f6fb;
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            min-height: 16rem;
        }

        .management-event-page .service-card.disabled {
            opacity: 0.55;
        }

        .management-event-page .service-header {
            display: flex;
            align-items: flex-end;
            justify-content: space-between;
            gap: 0.75rem;
        }

        .management-event-page .service-total {
            min-width: 6.5rem;
        }

        .management-event-page .service-total-display {
            font-weight: 600;
            background: #eef1f6;
            border-radius: 0.4rem;
            padding: 0.35rem 0.5rem;
            text-align: right;
        }

        .management-event-page .service-details {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .management-event-page .service-entry {
            background: #fff;
            border: 1px dashed rgba(33, 37, 41, 0.35);
            border-radius: 0.5rem;
            padding: 0.6rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .management-event-page .service-entry .form-control {
            font-size: 0.72rem;
            padding: 0.3rem 0.45rem;
        }

        .management-event-page .service-entry .entry-actions {
            display: flex;
            justify-content: flex-end;
        }

        .management-event-page .service-items {
            border: 1px dashed var(--bs-border-color);
            border-radius: 0.5rem;
            padding: 0.45rem 0.55rem;
            min-height: 4.2rem;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 0.45rem;
        }

        .management-event-page .service-item-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .management-event-page .service-item-row .item-meta {
            font-size: 0.68rem;
            color: #6c757d;
        }

        .management-event-page .materials-list {
            border: 1px dashed var(--bs-border-color);
            border-radius: 0.55rem;
            padding: 0.55rem 0.8rem;
            min-height: 2.5rem;
        }

        .management-event-page .materials-list .material-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            padding: 0.35rem 0;
        }

        .management-event-page .materials-list .material-row + .material-row {
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .management-event-page .materials-empty {
            color: #6c757d;
        }

        .management-event-page .event-total {
            font-size: 0.88rem;
            font-weight: 600;
        }

        @media (max-width: 575.98px) {
            .management-event-page .form-check-inline {
                margin-right: 0.75rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container py-3 management-event-page">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
        <div>
            <h1 class="h4 mb-1">Registrar Evento</h1>
            <p class="text-muted mb-0">Preencha os dados do evento da Diretoria JP.</p>
        </div>
        <a class="btn btn-outline-secondary btn-sm align-self-lg-start" href="{{ url_for('diretoria_eventos') }}">
            <i class="bi bi-arrow-left me-2"></i>Voltar para eventos
        </a>
    </div>
    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" novalidate id="managementEventForm">
                {{ form.csrf_token }}
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-lg-3">
                        {{ form.event_type.label(class="form-label section-title") }}
                        {{ form.event_type(class="form-select form-select-sm", id="event_type") }}
                        {% if form.event_type.errors %}
                        <div class="text-danger small mt-1">{{ form.event_type.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-6 col-lg-2">
                        {{ form.event_date.label(class="form-label section-title") }}
                        {{ form.event_date(class="form-control", type="date") }}
                        {% if form.event_date.errors %}
                        <div class="text-danger small mt-1">{{ form.event_date.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-6 col-lg-2">
                        {{ form.participants_count.label(class="form-label section-title") }}
                        {{ form.participants_count(class="form-control", type="number", min="0") }}
                        {% if form.participants_count.errors %}
                        <div class="text-danger small mt-1">{{ form.participants_count.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-lg-3">
                        {{ form.participation_scope.label(class="form-label section-title") }}
                        {{ form.participation_scope(class="form-select form-select-sm", id="participation_scope") }}
                        {% if form.participation_scope.errors %}
                        <div class="text-danger small mt-1">{{ form.participation_scope.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="mt-3">
                    {{ form.description.label(class="form-label section-title") }}
                    {{ form.description(class="form-control", rows="3", placeholder="Descreva o objetivo, local ou observações gerais.") }}
                    {% if form.description.errors %}
                    <div class="text-danger small mt-1">{{ form.description.errors[0] }}</div>
                    {% endif %}
                </div>

                <div class="mt-3">
                    <span class="form-label section-title d-block mb-2">Serviços disponibilizados</span>
                    <div class="row g-2">
                        <div class="col-12 col-md-4">
                            <div class="service-card" data-service-card="breakfast">
                                <div class="service-header">
                                    <div class="flex-grow-1">
                                        {{ form.service_breakfast.label(class="form-label section-title mb-1") }}
                                        {{ form.service_breakfast(class="form-select form-select-sm", id="service_breakfast") }}
                                        {% if form.service_breakfast.errors %}
                                        <div class="text-danger small mt-1">{{ form.service_breakfast.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="service-total text-end">
                                        <span class="form-label text-muted mb-1 d-block">Custo total</span>
                                        <div class="service-total-display" data-service-total="breakfast">R$ 0,00</div>
                                    </div>
                                </div>
                                {{ form.breakfast_details(id="breakfast_details") }}
                                {% if form.breakfast_details.errors %}
                                <div class="text-danger small mt-1">{{ form.breakfast_details.errors[0] }}</div>
                                {% endif %}
                                <div class="service-details d-none" data-service-details>
                                    <div class="service-entry" data-service-entry="breakfast">
                                        <div>
                                            <label class="form-label mb-1">Descrição (opcional)</label>
                                            <input type="text" class="form-control" data-service-input="description">
                                        </div>
                                        <div class="row g-2 align-items-end">
                                            <div class="col-4">
                                                <label class="form-label mb-1">Quantidade</label>
                                                <input type="number" min="1" class="form-control" data-service-input="quantity">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label mb-1">Valor unitário (opcional)</label>
                                                <input type="text" class="form-control" data-service-input="unit">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label mb-1">Custo total</label>
                                                <input type="text" class="form-control" data-service-input="total">
                                            </div>
                                        </div>
                                        <div class="entry-actions">
                                            <button type="button" class="btn btn-outline-primary btn-sm" data-service-add="breakfast">
                                                <i class="bi bi-plus-lg me-1"></i>Adicionar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="service-items" data-service-items="breakfast">
                                        <div class="text-muted small" data-empty-text>Nenhum item adicionado.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="service-card" data-service-card="lunch">
                                <div class="service-header">
                                    <div class="flex-grow-1">
                                        {{ form.service_lunch.label(class="form-label section-title mb-1") }}
                                        {{ form.service_lunch(class="form-select form-select-sm", id="service_lunch") }}
                                        {% if form.service_lunch.errors %}
                                        <div class="text-danger small mt-1">{{ form.service_lunch.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="service-total text-end">
                                        <span class="form-label text-muted mb-1 d-block">Custo total</span>
                                        <div class="service-total-display" data-service-total="lunch">R$ 0,00</div>
                                    </div>
                                </div>
                                {{ form.lunch_details(id="lunch_details") }}
                                {% if form.lunch_details.errors %}
                                <div class="text-danger small mt-1">{{ form.lunch_details.errors[0] }}</div>
                                {% endif %}
                                <div class="service-details d-none" data-service-details>
                                    <div class="service-entry" data-service-entry="lunch">
                                        <div>
                                            <label class="form-label mb-1">Descrição (opcional)</label>
                                            <input type="text" class="form-control" data-service-input="description">
                                        </div>
                                        <div class="row g-2 align-items-end">
                                            <div class="col-4">
                                                <label class="form-label mb-1">Quantidade</label>
                                                <input type="number" min="1" class="form-control" data-service-input="quantity">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label mb-1">Valor unitário (opcional)</label>
                                                <input type="text" class="form-control" data-service-input="unit">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label mb-1">Custo total</label>
                                                <input type="text" class="form-control" data-service-input="total">
                                            </div>
                                        </div>
                                        <div class="entry-actions">
                                            <button type="button" class="btn btn-outline-primary btn-sm" data-service-add="lunch">
                                                <i class="bi bi-plus-lg me-1"></i>Adicionar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="service-items" data-service-items="lunch">
                                        <div class="text-muted small" data-empty-text>Nenhum item adicionado.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="service-card" data-service-card="dinner">
                                <div class="service-header">
                                    <div class="flex-grow-1">
                                        {{ form.service_dinner.label(class="form-label section-title mb-1") }}
                                        {{ form.service_dinner(class="form-select form-select-sm", id="service_dinner") }}
                                        {% if form.service_dinner.errors %}
                                        <div class="text-danger small mt-1">{{ form.service_dinner.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="service-total text-end">
                                        <span class="form-label text-muted mb-1 d-block">Custo total</span>
                                        <div class="service-total-display" data-service-total="dinner">R$ 0,00</div>
                                    </div>
                                </div>
                                {{ form.dinner_details(id="dinner_details") }}
                                {% if form.dinner_details.errors %}
                                <div class="text-danger small mt-1">{{ form.dinner_details.errors[0] }}</div>
                                {% endif %}
                                <div class="service-details d-none" data-service-details>
                                    <div class="service-entry" data-service-entry="dinner">
                                        <div>
                                            <label class="form-label mb-1">Descrição (opcional)</label>
                                            <input type="text" class="form-control" data-service-input="description">
                                        </div>
                                        <div class="row g-2 align-items-end">
                                            <div class="col-4">
                                                <label class="form-label mb-1">Quantidade</label>
                                                <input type="number" min="1" class="form-control" data-service-input="quantity">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label mb-1">Valor unitário (opcional)</label>
                                                <input type="text" class="form-control" data-service-input="unit">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label mb-1">Custo total</label>
                                                <input type="text" class="form-control" data-service-input="total">
                                            </div>
                                        </div>
                                        <div class="entry-actions">
                                            <button type="button" class="btn btn-outline-primary btn-sm" data-service-add="dinner">
                                                <i class="bi bi-plus-lg me-1"></i>Adicionar
                                            </button>
                                        </div>
                                    </div>
                                    <div class="service-items" data-service-items="dinner">
                                        <div class="text-muted small" data-empty-text>Nenhum item adicionado.</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="form-label section-title mb-0">Outros materiais</span>
                        <button type="button" class="btn btn-outline-primary btn-sm" id="addMaterialBtn">
                            <i class="bi bi-plus-lg me-1"></i>Adicionar
                        </button>
                    </div>
                    {{ form.other_materials_raw(id="other_materials_data") }}
                    {% if form.other_materials_raw.errors %}
                    <div class="text-danger small mb-2">{{ form.other_materials_raw.errors[0] }}</div>
                    {% endif %}
                    <div class="materials-list" id="materialsList">
                        <div class="materials-empty" data-empty-text>Nenhum material adicionado.</div>
                    </div>
                </div>

                <div class="d-flex flex-column flex-sm-row justify-content-between align-items-sm-center mt-4 gap-2">
                    <div class="event-total">
                        Total estimado do evento: <span id="eventTotal">R$ 0,00</span>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="bi bi-save me-1"></i>Salvar evento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    {{ super() }}
    
<script>
    (function () {
        const form = document.getElementById('managementEventForm');
        if (!form) {
            return;
        }

        const servicesConfig = [
            {
                slug: 'breakfast',
                selectId: 'service_breakfast',
                fieldId: 'breakfast_details',
                cardSelector: '[data-service-card="breakfast"]',
                totalSelector: '[data-service-total="breakfast"]',
            },
            {
                slug: 'lunch',
                selectId: 'service_lunch',
                fieldId: 'lunch_details',
                cardSelector: '[data-service-card="lunch"]',
                totalSelector: '[data-service-total="lunch"]',
            },
            {
                slug: 'dinner',
                selectId: 'service_dinner',
                fieldId: 'dinner_details',
                cardSelector: '[data-service-card="dinner"]',
                totalSelector: '[data-service-total="dinner"]',
            },
        ];

        const materialsField = document.getElementById('other_materials_data');
        const materialsList = document.getElementById('materialsList');
        const addMaterialBtn = document.getElementById('addMaterialBtn');
        const eventTotalLabel = document.getElementById('eventTotal');

        const servicesState = servicesConfig.reduce((acc, cfg) => {
            acc[cfg.slug] = { items: [] };
            return acc;
        }, {});

        let materials = [];

        function parseDecimal(value) {
            if (value === null || value === undefined) {
                return null;
            }
            let raw = String(value).trim();
            if (!raw) {
                return null;
            }
            raw = raw.replace(/[R$]/gi, '').replace(/\s+/g, '');
            raw = raw.replace(/[^0-9,.-]/g, '');
            if (!raw) {
                return null;
            }
            if (raw.includes(',') && raw.includes('.')) {
                raw = raw.replace(/\./g, '').replace(',', '.');
            } else if (raw.includes(',')) {
                raw = raw.replace(',', '.');
            }
            const parsed = Number(raw);
            return Number.isFinite(parsed) ? parsed : null;
        }

        function formatCurrency(value) {
            if (value === null || value === undefined || !Number.isFinite(value)) {
                return 'R$ 0,00';
            }
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
                minimumFractionDigits: 2,
            }).format(Math.round(value * 100) / 100);
        }

        function getServiceElements(cfg) {
            const select = document.getElementById(cfg.selectId);
            const hiddenField = document.getElementById(cfg.fieldId);
            const card = document.querySelector(cfg.cardSelector);
            const details = card?.querySelector('[data-service-details]') || null;
            const itemsContainer = details?.querySelector(`[data-service-items="${cfg.slug}"]`) || null;
            const totalDisplay = card?.querySelector(cfg.totalSelector || '') || null;
            const entry = details?.querySelector(`[data-service-entry="${cfg.slug}"]`) || null;
            const inputs = entry
                ? {
                      description: entry.querySelector('[data-service-input="description"]'),
                      quantity: entry.querySelector('[data-service-input="quantity"]'),
                      unit: entry.querySelector('[data-service-input="unit"]'),
                      total: entry.querySelector('[data-service-input="total"]'),
                  }
                : {};
            const addBtn = entry?.querySelector(`[data-service-add="${cfg.slug}"]`) || null;
            return { select, hiddenField, card, details, itemsContainer, totalDisplay, entry, inputs, addBtn };
        }

        function clearEntryInputs(cfg) {
            const { inputs } = getServiceElements(cfg);
            if (!inputs) {
                return;
            }
            if (inputs.description) inputs.description.value = '';
            if (inputs.quantity) inputs.quantity.value = '';
            if (inputs.unit) inputs.unit.value = '';
            if (inputs.total) inputs.total.value = '';
        }

        function calculateItemTotal(item) {
            if (!item) {
                return 0;
            }
            if (Number.isFinite(item.totalCost)) {
                return item.totalCost;
            }
            const quantity = Number.isFinite(item.quantity) ? item.quantity : null;
            const unitCost = Number.isFinite(item.unitCost) ? item.unitCost : null;
            if (quantity === null || unitCost === null) {
                return 0;
            }
            const total = quantity * unitCost;
            return Number.isFinite(total) ? total : 0;
        }

        function calculateServiceTotal(cfg) {
            const items = servicesState[cfg.slug].items || [];
            return items.reduce((acc, item) => acc + calculateItemTotal(item), 0);
        }

        function syncServiceField(cfg) {
            const { hiddenField } = getServiceElements(cfg);
            if (!hiddenField) {
                return;
            }
            const payload = servicesState[cfg.slug].items.map(item => ({
                description: item.description || '',
                quantity: Number.isFinite(item.quantity) ? item.quantity : null,
                unit_cost: Number.isFinite(item.unitCost)
                    ? Math.round(item.unitCost * 100) / 100
                    : null,
                total_cost: Number.isFinite(item.totalCost)
                    ? Math.round(item.totalCost * 100) / 100
                    : null,
            }));
            hiddenField.value = JSON.stringify(payload);
        }

        function renderServiceItems(cfg) {
            const { itemsContainer } = getServiceElements(cfg);
            if (!itemsContainer) {
                return;
            }
            const items = servicesState[cfg.slug].items;
            itemsContainer.innerHTML = '';

            if (!items.length) {
                const empty = document.createElement('div');
                empty.className = 'text-muted small';
                empty.dataset.emptyText = '';
                empty.textContent = 'Nenhum item adicionado.';
                itemsContainer.appendChild(empty);
                return;
            }

            items.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'service-item-row';

                const info = document.createElement('div');
                info.className = 'flex-grow-1';
                const description = document.createElement('div');
                description.className = 'fw-semibold text-break';
                description.textContent = item.description || 'Sem descrição';

                const meta = document.createElement('div');
                meta.className = 'item-meta';
                const quantityText = Number.isFinite(item.quantity) ? `Qtd: ${item.quantity}` : null;
                const unitText = Number.isFinite(item.unitCost)
                    ? `Unit: ${formatCurrency(item.unitCost)}`
                    : null;
                const totalText = `Total: ${formatCurrency(calculateItemTotal(item))}`;
                meta.textContent = [quantityText, unitText, totalText].filter(Boolean).join(' • ');

                info.append(description, meta);

                const actions = document.createElement('div');
                actions.className = 'd-flex';
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-outline-danger btn-sm';
                removeBtn.innerHTML = '<i class="bi bi-trash"></i>';
                removeBtn.addEventListener('click', () => {
                    servicesState[cfg.slug].items.splice(index, 1);
                    syncServiceField(cfg);
                    renderServiceItems(cfg);
                    updateServiceTotal(cfg);
                    updateTotals();
                });
                actions.appendChild(removeBtn);

                row.append(info, actions);
                itemsContainer.appendChild(row);
            });
        }

        function updateServiceTotal(cfg) {
            const { totalDisplay, select } = getServiceElements(cfg);
            if (!totalDisplay) {
                return;
            }
            const enabled = select && select.value === 'sim';
            const total = enabled ? calculateServiceTotal(cfg) : 0;
            totalDisplay.textContent = formatCurrency(total);
        }

        function updateServiceVisibility(cfg) {
            const { select, card, details } = getServiceElements(cfg);
            if (!select || !card || !details) {
                return;
            }
            const enabled = select.value === 'sim';
            card.classList.toggle('disabled', !enabled);
            details.classList.toggle('d-none', !enabled);
            if (!enabled) {
                servicesState[cfg.slug].items = [];
                syncServiceField(cfg);
                renderServiceItems(cfg);
                updateServiceTotal(cfg);
                clearEntryInputs(cfg);
            }
        }

        function autoFillTotal(cfg) {
            const { inputs } = getServiceElements(cfg);
            if (!inputs || !inputs.total) {
                return;
            }
            const quantityRaw = inputs.quantity ? parseInt(inputs.quantity.value, 10) : NaN;
            const unitValue = inputs.unit ? parseDecimal(inputs.unit.value) : null;
            if (Number.isFinite(quantityRaw) && quantityRaw > 0 && unitValue !== null && unitValue >= 0) {
                inputs.total.value = formatCurrency(quantityRaw * unitValue);
            }
        }

        function addServiceItem(cfg) {
            const { select, inputs } = getServiceElements(cfg);
            if (!select || select.value !== 'sim' || !inputs) {
                alert('Ative o serviço antes de adicionar itens.');
                return;
            }

            const description = (inputs.description?.value || '').trim();
            const quantityRaw = inputs.quantity?.value ?? '';
            const quantity = quantityRaw !== '' ? parseInt(quantityRaw, 10) : NaN;
            if (!Number.isFinite(quantity) || quantity <= 0) {
                alert('Informe uma quantidade válida (maior que zero).');
                inputs.quantity?.focus();
                return;
            }

            const unitValue = inputs.unit ? parseDecimal(inputs.unit.value) : null;
            if (unitValue !== null && unitValue < 0) {
                alert('Informe um valor unitário positivo.');
                inputs.unit?.focus();
                return;
            }

            const totalValueRaw = inputs.total ? parseDecimal(inputs.total.value) : null;
            let totalValue = totalValueRaw;
            if ((totalValue === null || !Number.isFinite(totalValue)) && unitValue !== null) {
                totalValue = quantity * unitValue;
            }

            if (totalValue === null || !Number.isFinite(totalValue) || totalValue < 0) {
                alert('Informe o custo total do item.');
                inputs.total?.focus();
                return;
            }

            const normalizedUnit = unitValue !== null && Number.isFinite(unitValue)
                ? Math.round(unitValue * 100) / 100
                : null;
            const normalizedTotal = Math.round(totalValue * 100) / 100;

            servicesState[cfg.slug].items.push({
                description,
                quantity,
                unitCost: normalizedUnit,
                totalCost: normalizedTotal,
            });

            syncServiceField(cfg);
            renderServiceItems(cfg);
            updateServiceTotal(cfg);
            updateTotals();
            clearEntryInputs(cfg);
            inputs.description?.focus();
        }

        function renderMaterials() {
            materialsList.innerHTML = '';
            if (!materials.length) {
                const empty = document.createElement('div');
                empty.className = 'materials-empty';
                empty.dataset.emptyText = '';
                empty.textContent = 'Nenhum material adicionado.';
                materialsList.appendChild(empty);
                return;
            }

            materials.forEach((item, index) => {
                const row = document.createElement('div');
                row.className = 'material-row';
                const description = document.createElement('div');
                description.className = 'text-break flex-grow-1';
                description.textContent = item.description || 'Sem descrição';
                const value = document.createElement('div');
                value.className = 'text-nowrap';
                value.textContent = item.value !== null ? formatCurrency(item.value) : '—';
                const removeBtn = document.createElement('button');
                removeBtn.type = 'button';
                removeBtn.className = 'btn btn-outline-danger btn-sm';
                removeBtn.innerHTML = '<i class="bi bi-trash"></i>';
                removeBtn.addEventListener('click', () => {
                    materials.splice(index, 1);
                    syncMaterialsField();
                    renderMaterials();
                    updateTotals();
                });
                row.append(description, value, removeBtn);
                materialsList.appendChild(row);
            });
        }

        function syncMaterialsField() {
            const payload = materials.map(item => ({
                description: item.description,
                value: item.value,
            }));
            materialsField.value = JSON.stringify(payload);
        }

        function updateTotals() {
            let total = 0;

            servicesConfig.forEach(cfg => {
                const { select } = getServiceElements(cfg);
                if (select && select.value === 'sim') {
                    const sum = calculateServiceTotal(cfg);
                    if (Number.isFinite(sum) && sum >= 0) {
                        total += sum;
                    }
                }
            });

            materials.forEach(item => {
                if (item.value !== null && item.value >= 0) {
                    total += item.value;
                }
            });

            eventTotalLabel.textContent = formatCurrency(total);
        }

        function handleMaterialCreation() {
            const description = prompt('Descrição do material:');
            if (description === null) {
                return;
            }
            const valueRaw = prompt('Valor (use vírgula ou ponto para centavos):');
            if (valueRaw === null) {
                materials.push({ description: description.trim(), value: null });
            } else {
                const value = parseDecimal(valueRaw);
                if (value === null || value < 0) {
                    alert('Informe um valor numérico válido.');
                    return;
                }
                materials.push({ description: description.trim(), value: Math.round(value * 100) / 100 });
            }
            syncMaterialsField();
            renderMaterials();
            updateTotals();
        }

        function hydrateMaterials() {
            try {
                const existing = JSON.parse(materialsField.value || '[]');
                if (Array.isArray(existing)) {
                    materials = existing
                        .filter(item => item && typeof item === 'object')
                        .map(item => ({
                            description: (item.description || '').trim(),
                            value: parseDecimal(item.value),
                        }));
                }
            } catch (err) {
                materials = [];
            }
        }

        function hydrateService(cfg) {
            const { hiddenField } = getServiceElements(cfg);
            servicesState[cfg.slug].items = [];
            if (hiddenField) {
                try {
                    const parsed = JSON.parse(hiddenField.value || '[]');
                    if (Array.isArray(parsed)) {
                        servicesState[cfg.slug].items = parsed
                            .filter(item => item && typeof item === 'object')
                            .map(item => {
                                const quantityRaw = item.quantity;
                                let quantityValue = null;
                                if (quantityRaw !== undefined && quantityRaw !== null && quantityRaw !== '') {
                                    const parsedQuantity = Number(quantityRaw);
                                    quantityValue = Number.isFinite(parsedQuantity)
                                        ? Math.trunc(parsedQuantity)
                                        : null;
                                }
                                return {
                                    description: (item.description || '').trim(),
                                    quantity: quantityValue,
                                    unitCost: parseDecimal(item.unit_cost),
                                    totalCost: parseDecimal(item.total_cost),
                                };
                            });
                    }
                } catch (err) {
                    servicesState[cfg.slug].items = [];
                }
            }
            renderServiceItems(cfg);
            updateServiceTotal(cfg);
        }

        servicesConfig.forEach(cfg => {
            const { select, addBtn, inputs } = getServiceElements(cfg);
            if (!select) {
                return;
            }

            select.addEventListener('change', () => {
                updateServiceVisibility(cfg);
                updateServiceTotal(cfg);
                updateTotals();
            });

            addBtn?.addEventListener('click', () => addServiceItem(cfg));

            inputs?.quantity?.addEventListener('input', () => autoFillTotal(cfg));
            inputs?.unit?.addEventListener('input', () => autoFillTotal(cfg));
            inputs?.unit?.addEventListener('blur', () => {
                const value = parseDecimal(inputs.unit.value);
                if (value !== null) {
                    inputs.unit.value = formatCurrency(value);
                }
            });
            inputs?.total?.addEventListener('blur', () => {
                const value = parseDecimal(inputs.total.value);
                if (value !== null) {
                    inputs.total.value = formatCurrency(value);
                }
            });
            inputs?.total?.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    addServiceItem(cfg);
                }
            });
        });

        addMaterialBtn?.addEventListener('click', handleMaterialCreation);

        form.addEventListener('submit', () => {
            servicesConfig.forEach(cfg => {
                syncServiceField(cfg);
            });
            syncMaterialsField();
        });

        hydrateMaterials();
        servicesConfig.forEach(cfg => {
            hydrateService(cfg);
            updateServiceVisibility(cfg);
        });

        renderMaterials();
        updateTotals();
    })();
</script>

{% endblock %}
