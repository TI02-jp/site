{% extends "base.html" %}
{% block title %}Registrar Evento - Diretoria JP{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
        .management-event-page {
            font-size: 0.875rem;
        }

        .management-event-page h1 {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .management-event-page .page-subtitle {
            font-size: 0.8rem;
        }

        .management-event-page .card-body {
            padding: 1.5rem;
        }

        .management-event-page .form-label,
        .management-event-page .form-check-label,
        .management-event-page .text-muted,
        .management-event-page label {
            text-align: left;
        }

        .management-event-page .form-check {
            margin-bottom: 0.25rem;
        }

        .management-event-page .form-control,
        .management-event-page .form-select {
            font-size: 0.85rem;
            padding: 0.4rem 0.6rem;
        }

        .management-event-page .form-check-input {
            width: 1rem;
            height: 1rem;
        }

        .management-event-page .section-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .management-event-page .cost-wrapper label,
        .management-event-page .material-row label {
            font-size: 0.75rem;
        }

        .management-event-page .material-row {
            padding: 0.6rem;
        }

        @media (min-width: 992px) {
            .management-event-page .card-body {
                padding: 1.25rem 1.5rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container py-3 management-event-page">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
        <div>
            <h1 class="h4 mb-1">Registrar Evento</h1>
            <p class="text-muted mb-0 page-subtitle">Informe todos os campos obrigatórios para cadastrar o evento da diretoria.</p>
        </div>
        <a class="btn btn-outline-secondary align-self-lg-start" href="{{ url_for('diretoria_eventos') }}">
            <i class="bi bi-arrow-left me-2"></i>Voltar para eventos
        </a>
    </div>
    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" novalidate id="managementEventForm">
                {{ form.csrf_token }}
                <div class="row g-3">
                    <div class="col-12 col-lg-4">
                        <label class="form-label d-block section-title">Tipo</label>
                        <div class="d-flex flex-column gap-2">
                            {% for subfield in form.event_type %}
                            <div class="form-check">
                                {{ subfield(class="form-check-input", id=subfield.id) }}
                                <label class="form-check-label" for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.event_type.errors %}
                        <div class="text-danger small mt-2">{{ form.event_type.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-lg-4">
                        {{ form.event_date.label(class="form-label section-title") }}
                        {{ form.event_date(class="form-control", type="date") }}
                        {% if form.event_date.errors %}
                        <div class="text-danger small mt-2">{{ form.event_date.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-lg-4">
                        {{ form.participants_count.label(class="form-label section-title") }}
                        {{ form.participants_count(class="form-control", type="number") }}
                        {% if form.participants_count.errors %}
                        <div class="text-danger small mt-2">{{ form.participants_count.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12">
                        {{ form.description.label(class="form-label section-title") }}
                        {{ form.description(class="form-control", placeholder="Descreva o objetivo, local ou observações gerais do evento") }}
                        {% if form.description.errors %}
                        <div class="text-danger small mt-2">{{ form.description.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="form-check">
                            {{ form.attendees_internal(class="form-check-input", id="attendees_internal") }}
                            <label class="form-check-label" for="attendees_internal">Participação Interna</label>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="form-check">
                            {{ form.attendees_external(class="form-check-input", id="attendees_external") }}
                            <label class="form-check-label" for="attendees_external">Participação Externa</label>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label section-title">Serviços Disponibilizados</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="border rounded p-2 h-100">
                                    <div class="form-check mb-1">
                                        {{ form.include_breakfast(class="form-check-input", id="include_breakfast") }}
                                        <label class="form-check-label" for="include_breakfast">Café da manhã</label>
                                    </div>
                                    <div class="cost-wrapper{% if not form.include_breakfast.data %} d-none{% endif %}" id="cost_breakfast_wrapper">
                                        <label class="form-label small text-muted" for="cost_breakfast">Custo</label>
                                        {{ form.cost_breakfast(class="form-control form-control-sm", id="cost_breakfast", placeholder="0,00") }}
                                        {% if form.cost_breakfast.errors %}
                                        <div class="text-danger small mt-1">{{ form.cost_breakfast.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2 h-100">
                                    <div class="form-check mb-1">
                                        {{ form.include_lunch(class="form-check-input", id="include_lunch") }}
                                        <label class="form-check-label" for="include_lunch">Almoço</label>
                                    </div>
                                    <div class="cost-wrapper{% if not form.include_lunch.data %} d-none{% endif %}" id="cost_lunch_wrapper">
                                        <label class="form-label small text-muted" for="cost_lunch">Custo</label>
                                        {{ form.cost_lunch(class="form-control form-control-sm", id="cost_lunch", placeholder="0,00") }}
                                        {% if form.cost_lunch.errors %}
                                        <div class="text-danger small mt-1">{{ form.cost_lunch.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-2 h-100">
                                    <div class="form-check mb-1">
                                        {{ form.include_snack(class="form-check-input", id="include_snack") }}
                                        <label class="form-check-label" for="include_snack">Lanche</label>
                                    </div>
                                    <div class="cost-wrapper{% if not form.include_snack.data %} d-none{% endif %}" id="cost_snack_wrapper">
                                        <label class="form-label small text-muted" for="cost_snack">Custo</label>
                                        {{ form.cost_snack(class="form-control form-control-sm", id="cost_snack", placeholder="0,00") }}
                                        {% if form.cost_snack.errors %}
                                        <div class="text-danger small mt-1">{{ form.cost_snack.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0 section-title">Outros Materiais</label>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="addMaterialBtn">
                                <i class="bi bi-plus-lg me-1"></i>Adicionar
                            </button>
                        </div>
                        {{ form.other_materials_raw(id="other_materials_data") }}
                        <div class="mt-2" id="otherMaterialsContainer" data-empty-message>
                            <div class="text-muted small text-start" id="noMaterialsMessage">Nenhum material adicional informado.</div>
                        </div>
                        {% if form.other_materials_raw.errors %}
                        <div class="text-danger small mt-2">{{ form.other_materials_raw.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-3">
                    <a class="btn btn-outline-secondary" href="{{ url_for('diretoria_eventos') }}">Cancelar</a>
                    {{ form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const cateringOptions = [
            { checkboxId: 'include_breakfast', wrapperId: 'cost_breakfast_wrapper', inputId: 'cost_breakfast' },
            { checkboxId: 'include_lunch', wrapperId: 'cost_lunch_wrapper', inputId: 'cost_lunch' },
            { checkboxId: 'include_snack', wrapperId: 'cost_snack_wrapper', inputId: 'cost_snack' },
        ];

        cateringOptions.forEach(({ checkboxId, wrapperId, inputId }) => {
            const checkbox = document.getElementById(checkboxId);
            const wrapper = document.getElementById(wrapperId);
            const input = document.getElementById(inputId);
            if (!checkbox || !wrapper || !input) {
                return;
            }
            const syncVisibility = () => {
                if (checkbox.checked) {
                    wrapper.classList.remove('d-none');
                    input.disabled = false;
                } else {
                    wrapper.classList.add('d-none');
                    input.disabled = true;
                    input.value = '';
                }
            };
            syncVisibility();
            checkbox.addEventListener('change', syncVisibility);
        });

        const materialsInput = document.getElementById('other_materials_data');
        const materialsContainer = document.getElementById('otherMaterialsContainer');
        const addMaterialBtn = document.getElementById('addMaterialBtn');
        const noMaterialsMessage = document.getElementById('noMaterialsMessage');
        const form = document.getElementById('managementEventForm');

        const parseInitialMaterials = () => {
            try {
                const value = materialsInput.value || '[]';
                const parsed = JSON.parse(value);
                if (Array.isArray(parsed)) {
                    return parsed.map(item => ({
                        description: typeof item.description === 'string' ? item.description : '',
                        value: item.value !== undefined && item.value !== null ? String(item.value) : ''
                    }));
                }
            } catch (error) {
                console.warn('Não foi possível interpretar os materiais adicionais salvos.', error);
            }
            return [];
        };

        const materialsState = parseInitialMaterials();

        const updateEmptyMessage = () => {
            if (!noMaterialsMessage) {
                return;
            }
            const hasItems = materialsContainer.querySelectorAll('.material-row').length > 0;
            noMaterialsMessage.classList.toggle('d-none', hasItems);
        };

        const createMaterialRow = (data = {}) => {
            const row = document.createElement('div');
            row.className = 'material-row border rounded p-2 mb-2';
            row.innerHTML = `
                <div class="row g-2 align-items-end">
                    <div class="col-md-7">
                        <label class="form-label small text-muted">Descrição</label>
                        <input type="text" class="form-control form-control-sm material-description" placeholder="Nome do material">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small text-muted">Valor</label>
                        <input type="number" class="form-control form-control-sm material-value" min="0" step="0.01" placeholder="0,00">
                    </div>
                    <div class="col-md-1 d-flex align-items-center justify-content-end">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-material" title="Remover material">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            const descriptionInput = row.querySelector('.material-description');
            const valueInput = row.querySelector('.material-value');
            descriptionInput.value = data.description || '';
            valueInput.value = data.value || '';
            row.querySelector('.remove-material').addEventListener('click', () => {
                row.remove();
                updateEmptyMessage();
            });
            return row;
        };

        materialsState.forEach(item => {
            const row = createMaterialRow({
                description: item.description || '',
                value: item.value !== undefined && item.value !== null ? item.value : ''
            });
            materialsContainer.appendChild(row);
        });
        updateEmptyMessage();

        addMaterialBtn.addEventListener('click', () => {
            const row = createMaterialRow();
            materialsContainer.appendChild(row);
            updateEmptyMessage();
        });

        form.addEventListener('submit', () => {
            const rows = materialsContainer.querySelectorAll('.material-row');
            const serialized = [];
            rows.forEach(row => {
                const descriptionInput = row.querySelector('.material-description');
                const valueInput = row.querySelector('.material-value');
                const description = descriptionInput.value.trim();
                const value = valueInput.value.trim();
                if (description || value) {
                    serialized.push({ description, value });
                }
            });
            materialsInput.value = JSON.stringify(serialized);
        });
    });
    </script>
{% endblock %}
