{% extends "base.html" %}
{% block title %}Registrar Evento - Diretoria JP{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
        .management-event-page {
            font-size: 0.8125rem;
        }

        .management-event-page h1 {
            font-size: 1.125rem;
            margin-bottom: 0.15rem;
        }

        .management-event-page .page-subtitle {
            font-size: 0.75rem;
        }

        .management-event-page .card-body {
            padding: 1rem 1.25rem;
        }

        .management-event-page .form-label,
        .management-event-page label {
            text-align: left;
            margin-bottom: 0.35rem;
        }

        .management-event-page .form-control,
        .management-event-page .form-select {
            font-size: 0.75rem;
            padding: 0.35rem 0.5rem;
        }

        .management-event-page .section-title {
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .management-event-page .catering-group {
            padding: 0.75rem;
        }

        .management-event-page .catering-group label,
        .management-event-page .cost-wrapper label,
        .management-event-page .service-extra-wrapper label,
        .management-event-page .material-row label {
            font-size: 0.7rem;
            margin-bottom: 0.25rem;
        }

        .management-event-page .material-row {
            padding: 0.5rem 0.65rem;
        }

        .management-event-page .btn-sm {
            padding: 0.3rem 0.75rem;
        }

        .management-event-page .btn-icon {
            width: 1.9rem;
            height: 1.9rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        @media (min-width: 992px) {
            .management-event-page .card-body {
                padding: 1rem 1.25rem;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div class="container py-3 management-event-page">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-2 mb-3">
        <div>
            <h1 class="h4 mb-1">Registrar Evento</h1>
            <p class="text-muted mb-0 page-subtitle">Informe todos os campos obrigatórios para cadastrar o evento da diretoria.</p>
        </div>
        <a class="btn btn-outline-secondary btn-sm align-self-lg-start" href="{{ url_for('diretoria_eventos') }}">
            <i class="bi bi-arrow-left me-2"></i>Voltar para eventos
        </a>
    </div>
    <div class="card shadow-sm">
        <div class="card-body">
            <form method="post" novalidate id="managementEventForm">
                {{ form.csrf_token }}
                <div class="row g-2 align-items-end">
                    <div class="col-12 col-lg-3">
                        {{ form.event_type.label(class="form-label section-title mb-1") }}
                        {{ form.event_type(class="form-select form-select-sm") }}
                        {% if form.event_type.errors %}
                        <div class="text-danger small mt-1">{{ form.event_type.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-sm-6 col-lg-2">
                        {{ form.event_date.label(class="form-label section-title mb-1") }}
                        {{ form.event_date(class="form-control form-control-sm", type="date") }}
                        {% if form.event_date.errors %}
                        <div class="text-danger small mt-1">{{ form.event_date.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-sm-6 col-lg-2">
                        {{ form.participants_count.label(class="form-label section-title mb-1") }}
                        {{ form.participants_count(class="form-control form-control-sm", type="number") }}
                        {% if form.participants_count.errors %}
                        <div class="text-danger small mt-1">{{ form.participants_count.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-sm-6 col-lg-2">
                        {{ form.attendees_internal.label(class="form-label section-title mb-1") }}
                        {{ form.attendees_internal(class="form-select form-select-sm", id="attendees_internal") }}
                        {% if form.attendees_internal.errors %}
                        <div class="text-danger small mt-1">{{ form.attendees_internal.errors[0] }}</div>
                        {% endif %}
                    </div>
                    <div class="col-12 col-sm-6 col-lg-3">
                        {{ form.attendees_external.label(class="form-label section-title mb-1") }}
                        {{ form.attendees_external(class="form-select form-select-sm", id="attendees_external") }}
                        {% if form.attendees_external.errors %}
                        <div class="text-danger small mt-1">{{ form.attendees_external.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-12">
                        {{ form.description.label(class="form-label section-title mb-1") }}
                        {{ form.description(class="form-control", placeholder="Descreva o objetivo, local ou observações gerais do evento") }}
                        {% if form.description.errors %}
                        <div class="text-danger small mt-1">{{ form.description.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-12">
                        <label class="form-label section-title mb-1">Serviços Disponibilizados</label>
                        <div class="row g-2">
                            <div class="col-12 col-md-4">
                                <div class="catering-group border rounded h-100">
                                    <div class="row g-1 align-items-end">
                                        <div class="col-12 col-sm-6">
                                            <label class="form-label text-muted mb-1" for="include_breakfast">Café da manhã</label>
                                            {{ form.include_breakfast(class="form-select form-select-sm", id="include_breakfast") }}
                                        </div>
                                        <div class="col-12 service-extra-wrapper{% if (form.include_breakfast.data or 0)|int != 1 %} d-none{% endif %}" id="breakfast_description_wrapper">
                                            <label class="form-label text-muted mb-1" for="breakfast_description">Descrição (opcional)</label>
                                            {{ form.breakfast_description(class="form-control form-control-sm", id="breakfast_description", placeholder="Detalhes do serviço", disabled='disabled' if (form.include_breakfast.data or 0)|int != 1 else None) }}
                                            {% if form.breakfast_description.errors %}
                                            <div class="text-danger small mt-1">{{ form.breakfast_description.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-12 col-sm-6 cost-wrapper{% if (form.include_breakfast.data or 0)|int != 1 %} d-none{% endif %}" id="cost_breakfast_wrapper">
                                            <label class="form-label text-muted mb-1" for="cost_breakfast">Custo total</label>
                                            {{ form.cost_breakfast(class="form-control form-control-sm", id="cost_breakfast", placeholder="0,00", disabled='disabled' if (form.include_breakfast.data or 0)|int != 1 else None) }}
                                            {% if form.cost_breakfast.errors %}
                                            <div class="text-danger small mt-1">{{ form.cost_breakfast.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-12 col-sm-6 service-extra-wrapper{% if (form.include_breakfast.data or 0)|int != 1 %} d-none{% endif %}" id="cost_breakfast_unit_wrapper">
                                            <label class="form-label text-muted mb-1" for="cost_breakfast_unit">Custo unitário (opcional)</label>
                                            {{ form.cost_breakfast_unit(class="form-control form-control-sm", id="cost_breakfast_unit", placeholder="0,00", disabled='disabled' if (form.include_breakfast.data or 0)|int != 1 else None) }}
                                            {% if form.cost_breakfast_unit.errors %}
                                            <div class="text-danger small mt-1">{{ form.cost_breakfast_unit.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="catering-group border rounded h-100">
                                    <div class="row g-1 align-items-end">
                                        <div class="col-12 col-sm-6">
                                            <label class="form-label text-muted mb-1" for="include_lunch">Almoço</label>
                                            {{ form.include_lunch(class="form-select form-select-sm", id="include_lunch") }}
                                        </div>
                                        <div class="col-12 service-extra-wrapper{% if (form.include_lunch.data or 0)|int != 1 %} d-none{% endif %}" id="lunch_description_wrapper">
                                            <label class="form-label text-muted mb-1" for="lunch_description">Descrição (opcional)</label>
                                            {{ form.lunch_description(class="form-control form-control-sm", id="lunch_description", placeholder="Detalhes do serviço", disabled='disabled' if (form.include_lunch.data or 0)|int != 1 else None) }}
                                            {% if form.lunch_description.errors %}
                                            <div class="text-danger small mt-1">{{ form.lunch_description.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-12 col-sm-6 cost-wrapper{% if (form.include_lunch.data or 0)|int != 1 %} d-none{% endif %}" id="cost_lunch_wrapper">
                                            <label class="form-label text-muted mb-1" for="cost_lunch">Custo total</label>
                                            {{ form.cost_lunch(class="form-control form-control-sm", id="cost_lunch", placeholder="0,00", disabled='disabled' if (form.include_lunch.data or 0)|int != 1 else None) }}
                                            {% if form.cost_lunch.errors %}
                                            <div class="text-danger small mt-1">{{ form.cost_lunch.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-12 col-sm-6 service-extra-wrapper{% if (form.include_lunch.data or 0)|int != 1 %} d-none{% endif %}" id="cost_lunch_unit_wrapper">
                                            <label class="form-label text-muted mb-1" for="cost_lunch_unit">Custo unitário (opcional)</label>
                                            {{ form.cost_lunch_unit(class="form-control form-control-sm", id="cost_lunch_unit", placeholder="0,00", disabled='disabled' if (form.include_lunch.data or 0)|int != 1 else None) }}
                                            {% if form.cost_lunch_unit.errors %}
                                            <div class="text-danger small mt-1">{{ form.cost_lunch_unit.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-4">
                                <div class="catering-group border rounded h-100">
                                    <div class="row g-1 align-items-end">
                                        <div class="col-12 col-sm-6">
                                            <label class="form-label text-muted mb-1" for="include_snack">Lanche</label>
                                            {{ form.include_snack(class="form-select form-select-sm", id="include_snack") }}
                                        </div>
                                        <div class="col-12 service-extra-wrapper{% if (form.include_snack.data or 0)|int != 1 %} d-none{% endif %}" id="snack_description_wrapper">
                                            <label class="form-label text-muted mb-1" for="snack_description">Descrição (opcional)</label>
                                            {{ form.snack_description(class="form-control form-control-sm", id="snack_description", placeholder="Detalhes do serviço", disabled='disabled' if (form.include_snack.data or 0)|int != 1 else None) }}
                                            {% if form.snack_description.errors %}
                                            <div class="text-danger small mt-1">{{ form.snack_description.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-12 col-sm-6 cost-wrapper{% if (form.include_snack.data or 0)|int != 1 %} d-none{% endif %}" id="cost_snack_wrapper">
                                            <label class="form-label text-muted mb-1" for="cost_snack">Custo total</label>
                                            {{ form.cost_snack(class="form-control form-control-sm", id="cost_snack", placeholder="0,00", disabled='disabled' if (form.include_snack.data or 0)|int != 1 else None) }}
                                            {% if form.cost_snack.errors %}
                                            <div class="text-danger small mt-1">{{ form.cost_snack.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                        <div class="col-12 col-sm-6 service-extra-wrapper{% if (form.include_snack.data or 0)|int != 1 %} d-none{% endif %}" id="cost_snack_unit_wrapper">
                                            <label class="form-label text-muted mb-1" for="cost_snack_unit">Custo unitário (opcional)</label>
                                            {{ form.cost_snack_unit(class="form-control form-control-sm", id="cost_snack_unit", placeholder="0,00", disabled='disabled' if (form.include_snack.data or 0)|int != 1 else None) }}
                                            {% if form.cost_snack_unit.errors %}
                                            <div class="text-danger small mt-1">{{ form.cost_snack_unit.errors[0] }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-2 mt-2">
                    <div class="col-12">
                        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                            <label class="form-label mb-0 section-title" for="otherMaterialsContainer">Outros Materiais</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="addMaterialBtn">
                                <i class="bi bi-plus-lg me-1"></i>Adicionar
                            </button>
                        </div>
                        {{ form.other_materials_raw(id="other_materials_data") }}
                        <div class="d-grid gap-2 mt-1" id="otherMaterialsContainer" data-empty-message>
                            <div class="text-muted small text-start" id="noMaterialsMessage">Nenhum material adicional informado.</div>
                        </div>
                        {% if form.other_materials_raw.errors %}
                        <div class="text-danger small mt-1">{{ form.other_materials_raw.errors[0] }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-2 mt-2">
                    <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('diretoria_eventos') }}">Cancelar</a>
                    {{ form.submit(class="btn btn-primary btn-sm px-3") }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const cateringOptions = [
            {
                selectId: 'include_breakfast',
                fields: [
                    { wrapperId: 'breakfast_description_wrapper', inputId: 'breakfast_description' },
                    { wrapperId: 'cost_breakfast_wrapper', inputId: 'cost_breakfast' },
                    { wrapperId: 'cost_breakfast_unit_wrapper', inputId: 'cost_breakfast_unit' },
                ],
            },
            {
                selectId: 'include_lunch',
                fields: [
                    { wrapperId: 'lunch_description_wrapper', inputId: 'lunch_description' },
                    { wrapperId: 'cost_lunch_wrapper', inputId: 'cost_lunch' },
                    { wrapperId: 'cost_lunch_unit_wrapper', inputId: 'cost_lunch_unit' },
                ],
            },
            {
                selectId: 'include_snack',
                fields: [
                    { wrapperId: 'snack_description_wrapper', inputId: 'snack_description' },
                    { wrapperId: 'cost_snack_wrapper', inputId: 'cost_snack' },
                    { wrapperId: 'cost_snack_unit_wrapper', inputId: 'cost_snack_unit' },
                ],
            },
        ];

        cateringOptions.forEach(({ selectId, fields }) => {
            const select = document.getElementById(selectId);
            if (!select) {
                return;
            }

            const syncVisibility = () => {
                const isActive = select.value === '1';
                fields.forEach(({ wrapperId, inputId }) => {
                    const wrapper = document.getElementById(wrapperId);
                    const input = document.getElementById(inputId);
                    if (!wrapper || !input) {
                        return;
                    }
                    wrapper.classList.toggle('d-none', !isActive);
                    input.disabled = !isActive;
                    if (!isActive) {
                        input.value = '';
                    }
                });
            };

            syncVisibility();
            select.addEventListener('change', syncVisibility);
        });

        const materialsInput = document.getElementById('other_materials_data');
        const materialsContainer = document.getElementById('otherMaterialsContainer');
        const addMaterialBtn = document.getElementById('addMaterialBtn');
        const noMaterialsMessage = document.getElementById('noMaterialsMessage');
        const form = document.getElementById('managementEventForm');

        if (materialsInput && materialsContainer && addMaterialBtn && form) {
            const parseInitialMaterials = () => {
                try {
                    const value = materialsInput.value || '[]';
                    const parsed = JSON.parse(value);
                    if (Array.isArray(parsed)) {
                        return parsed.map(item => ({
                            description: typeof item.description === 'string' ? item.description : '',
                            value: item.value !== undefined && item.value !== null ? String(item.value) : ''
                        }));
                    }
                } catch (error) {
                    console.warn('Não foi possível interpretar os materiais adicionais salvos.', error);
                }
                return [];
            };

            const updateEmptyMessage = () => {
                if (!noMaterialsMessage) {
                    return;
                }
                const hasItems = materialsContainer.querySelectorAll('.material-row').length > 0;
                noMaterialsMessage.classList.toggle('d-none', hasItems);
            };

            const createMaterialRow = (data = {}) => {
                const row = document.createElement('div');
                row.className = 'material-row border rounded';
                row.innerHTML = `
                    <div class="row g-1 g-sm-2 align-items-center">
                        <div class="col-12 col-sm-7">
                            <label class="form-label text-muted mb-1">Descrição</label>
                            <input type="text" class="form-control form-control-sm material-description" placeholder="Nome do material">
                        </div>
                        <div class="col-12 col-sm-4">
                            <label class="form-label text-muted mb-1">Valor</label>
                            <input type="number" class="form-control form-control-sm material-value" min="0" step="0.01" placeholder="0,00">
                        </div>
                        <div class="col-12 col-sm-auto d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-danger btn-icon btn-sm remove-material" title="Remover material">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                const descriptionInput = row.querySelector('.material-description');
                const valueInput = row.querySelector('.material-value');
                descriptionInput.value = data.description || '';
                valueInput.value = data.value || '';
                row.querySelector('.remove-material').addEventListener('click', () => {
                    row.remove();
                    updateEmptyMessage();
                });
                return row;
            };

            const materialsState = parseInitialMaterials();

            materialsState.forEach(item => {
                const row = createMaterialRow({
                    description: item.description || '',
                    value: item.value !== undefined && item.value !== null ? item.value : ''
                });
                materialsContainer.appendChild(row);
            });

            updateEmptyMessage();

            addMaterialBtn.addEventListener('click', () => {
                const row = createMaterialRow();
                materialsContainer.appendChild(row);
                updateEmptyMessage();
            });

            form.addEventListener('submit', () => {
                const rows = materialsContainer.querySelectorAll('.material-row');
                const serialized = [];
                rows.forEach(row => {
                    const descriptionInput = row.querySelector('.material-description');
                    const valueInput = row.querySelector('.material-value');
                    const description = descriptionInput.value.trim();
                    const value = valueInput.value.trim();
                    if (description || value) {
                        serialized.push({ description, value });
                    }
                });
                materialsInput.value = JSON.stringify(serialized);
            });
        }
    });
    </script>
{% endblock %}
