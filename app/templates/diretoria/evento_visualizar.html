{% extends "base.html" %}
{% block title %}Visualizar evento - Diretoria JP{% endblock %}

{% macro format_currency(value) %}
    {% set amount = value if value is not none else 0 %}
    R$ {{ "{:,.2f}".format(amount|float).replace(',', 'X').replace('.', ',').replace('X', '.') }}
{% endmacro %}

{% macro format_decimal(value) %}
    {% if value is none %}
        —
    {% else %}
        {% set formatted = "{:,.2f}".format(value|float).replace(',', 'X').replace('.', ',').replace('X', '.') %}
        {% if ',' in formatted %}
            {% set trimmed = formatted.rstrip('0').rstrip(',') %}
        {% else %}
            {% set trimmed = formatted %}
        {% endif %}
        {{ trimmed if trimmed else '0' }}
    {% endif %}
{% endmacro %}

{% block extra_css %}
    {{ super() }}
    <style>
        .event-view {
            color: #212529;
        }

        .event-view .badge {
            letter-spacing: 0.05em;
        }

        .event-view .event-card {
            border: 1px solid rgba(13, 110, 253, 0.1);
            border-radius: 1rem;
            box-shadow: 0 0.75rem 1.75rem rgba(13, 110, 253, 0.08);
            background: linear-gradient(165deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0));
        }

        .event-view .event-card .card-body {
            padding: 1.75rem;
        }

        .event-view .event-meta dt {
            font-size: var(--font-sm);
            font-weight: 600;
            letter-spacing: 0.04em;
            color: #6c757d;
            text-transform: uppercase;
        }

        .event-view .event-meta dd {
            font-size: var(--font-base);
            font-weight: 600;
            color: #1f3a63;
        }

        .event-view .event-description {
            background: #fff;
            border-radius: 1rem;
            border: 1px solid rgba(33, 37, 41, 0.05);
            box-shadow: 0 1rem 2.5rem rgba(15, 23, 42, 0.05);
            padding: 1.5rem;
            font-size: var(--font-base);
            line-height: 1.6;
        }

        /* Tema escuro */
        :root[data-theme="dark"] .event-view {
            color: #e8ecf5;
        }

        :root[data-theme="dark"] .event-view .event-card {
            background: linear-gradient(170deg, rgba(17, 24, 39, 0.9), rgba(17, 24, 39, 0.75));
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 16px 38px rgba(0, 0, 0, 0.45);
        }

        :root[data-theme="dark"] .event-view .event-meta dt {
            color: #9aa6b5;
        }

        :root[data-theme="dark"] .event-view .event-meta dd {
            color: #ffffff;
        }

        :root[data-theme="dark"] .event-view .event-description {
            background: #0f1625;
            border-color: rgba(255, 255, 255, 0.08);
            color: #e8ecf5;
        }

        :root[data-theme="dark"] .event-view .section-heading {
            color: #cfd5e2;
        }

        :root[data-theme="dark"] .event-view .category-card {
            background: linear-gradient(180deg, rgba(15, 22, 35, 0.95), rgba(15, 22, 35, 0.9));
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.45);
        }

        :root[data-theme="dark"] .event-view .category-card .card-header {
            background: rgba(92, 124, 250, 0.08);
            border-color: rgba(255, 255, 255, 0.08);
        }

        :root[data-theme="dark"] .event-view .category-card .card-header .title {
            color: #dce3ff;
        }

        :root[data-theme="dark"] .event-view .category-card thead th {
            color: #9aa6b5;
        }

        :root[data-theme="dark"] .event-view .category-card .empty-state {
            color: #9aa6b5;
        }

        :root[data-theme="dark"] .event-view .photos-wrapper {
            background: linear-gradient(140deg, rgba(92, 124, 250, 0.1), rgba(92, 124, 250, 0.04));
            border-color: rgba(255, 255, 255, 0.08);
        }

        :root[data-theme="dark"] .event-view .photo-card {
            background: #0f1625;
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.45);
        }

        :root[data-theme="dark"] .event-view .photo-card:hover {
            box-shadow: 0 1.25rem 2.5rem rgba(0, 0, 0, 0.5);
        }

        .event-view .event-description.empty {
            color: #6c757d;
            font-style: italic;
            text-align: center;
        }

        .event-view .section-heading {
            font-size: var(--font-base);
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #0d6efd;
        }

        .event-view .category-card {
            border-radius: 1rem;
            border: 1px solid rgba(33, 37, 41, 0.08);
            background: linear-gradient(180deg, rgba(248, 249, 252, 0.9), rgba(255, 255, 255, 0.95));
            box-shadow: 0 0.75rem 1.5rem rgba(15, 23, 42, 0.08);
        }

        .event-view .category-card .card-header {
            border-bottom: 1px solid rgba(13, 110, 253, 0.1);
            background: rgba(13, 110, 253, 0.06);
            padding: 1rem 1.25rem;
        }

        .event-view .category-card .card-header .title {
            font-size: var(--font-base);
            font-weight: 700;
            letter-spacing: 0.06em;
            color: #0d6efd;
            text-transform: uppercase;
        }

        .event-view .category-card .card-body {
            padding: 1.25rem;
        }

        .event-view .category-card table {
            font-size: var(--font-base);
        }

        .event-view .category-card thead th {
            font-size: var(--font-xs);
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #6c757d;
        }

        .event-view .category-card tbody td {
            vertical-align: middle;
        }

        .event-view .category-card .empty-state {
            font-size: var(--font-base);
            color: #6c757d;
            text-align: center;
            padding: 1rem 0;
        }

        .event-view .photos-wrapper {
            border-radius: 1rem;
            background: linear-gradient(140deg, rgba(13, 110, 253, 0.08), rgba(13, 110, 253, 0));
            border: 1px solid rgba(13, 110, 253, 0.12);
            padding: 1.5rem;
        }

        .event-view .photo-card {
            display: flex;
            position: relative;
            border-radius: 0.9rem;
            overflow: hidden;
            background: #fff;
            border: 1px solid rgba(13, 110, 253, 0.12);
            box-shadow: 0 0.75rem 1.5rem rgba(13, 110, 253, 0.12);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            aspect-ratio: var(--photo-aspect-ratio, 4 / 3);
            min-height: 0;
            padding: 0.75rem;
            align-items: center;
            justify-content: center;
        }

        .event-view .photo-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 1rem 2.25rem rgba(13, 110, 253, 0.18);
        }

        .event-view .photo-thumb {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .event-view .photo-thumb img {
            position: relative;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0.75rem;
            box-shadow: 0 0.35rem 1rem rgba(13, 110, 253, 0.12);
            transition: transform 0.25s ease;
        }

        .event-view .photo-card:hover .photo-thumb img {
            transform: scale(1.03);
        }

        .event-view .photos-empty {
            color: #6c757d;
            font-style: italic;
            text-align: center;
        }

        .event-view .action-buttons .btn {
            min-width: 150px;
        }
    </style>
{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid event-view">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
        <div>
            <div class="d-flex flex-wrap align-items-center gap-3">
                <span class="badge bg-primary bg-opacity-10 text-primary fw-semibold">Diretoria JP</span>
                <h1 class="h3 mb-0">{{ event.name }}</h1>
            </div>
            <div class="text-muted small mt-1">
                {{ event_type_labels.get(event.event_type, event.event_type) }} · {{ event.event_date.strftime('%d/%m/%Y') }}
            </div>
        </div>
        <div class="action-buttons d-flex flex-wrap gap-2">
            <a href="{{ url_for('diretoria_eventos_lista') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Voltar para a lista
            </a>
            <a href="{{ url_for('diretoria_eventos_editar', event_id=event.id) }}" class="btn btn-primary">
                <i class="bi bi-pencil"></i> Editar evento
            </a>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-12 col-lg-6">
            <div class="card event-card h-100">
                <div class="card-body">
                    <dl class="row event-meta g-3 mb-0">
                        <div class="col-12 col-sm-6">
                            <dt>Data do evento</dt>
                            <dd>{{ event.event_date.strftime('%d/%m/%Y') }}</dd>
                        </div>
                        <div class="col-12 col-sm-6">
                            <dt>Público participante</dt>
                            <dd>{{ audience_labels.get(event.audience, event.audience) }}</dd>
                        </div>
                        <div class="col-12 col-sm-6">
                            <dt>Número de participantes</dt>
                            <dd>{{ event.participants }}</dd>
                        </div>
                        <div class="col-12 col-sm-6">
                            <dt>Valor total estimado</dt>
                            <dd>{{ format_currency(event.total_cost or 0) }}</dd>
                        </div>
                        <div class="col-12 col-sm-6">
                            <dt>Criado por</dt>
                            <dd>{{ event.created_by.name if event.created_by else '—' }}</dd>
                        </div>
                        <div class="col-12 col-sm-6">
                            <dt>Última atualização</dt>
                            <dd>{{ updated_at_display }}</dd>
                        </div>
                    </dl>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6">
            <div class="event-description{% if not event.description %} empty{% endif %}">
                {% if event.description %}
                    {{ event.description | replace('\n', '<br>') | safe }}
                {% else %}
                    Nenhuma descrição adicional informada para este evento.
                {% endif %}
            </div>
        </div>
    </div>

    <div class="mt-5">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <span class="section-heading">Serviços planejados</span>
            <span class="badge rounded-pill bg-primary bg-opacity-10 text-primary fw-semibold">{{ format_currency(event.total_cost or 0) }}</span>
        </div>
        <div class="row g-4">
            {% for category in categories %}
                <div class="col-12 col-lg-6">
                    <div class="card category-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="title">{{ category.label }}</span>
                            <span class="fw-semibold">{{ format_currency(category.total) }}</span>
                        </div>
                        <div class="card-body">
                            {% if category.entries %}
                                <div class="table-responsive">
                                    <table class="table table-sm align-middle mb-0">
                                        <thead>
                                            <tr>
                                                <th scope="col">Item</th>
                                                <th scope="col" class="text-center">Qtd.</th>
                                                <th scope="col" class="text-end">Valor unit.</th>
                                                <th scope="col" class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in category.entries %}
                                                <tr>
                                                    <td class="fw-semibold">{{ item.name }}</td>
                                                    <td class="text-center">{{ format_decimal(item.quantity) }}</td>
                                                    <td class="text-end">{{ format_currency(item.unit_value) }}</td>
                                                    <td class="text-end fw-semibold">{{ format_currency(item.total) }}</td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="empty-state">Nenhum item registrado nesta categoria.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <div class="mt-5">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
            <span class="section-heading">Galeria do evento</span>
            <span class="text-muted small">Clique em uma imagem para visualizar em nova aba.</span>
        </div>
        <div class="photos-wrapper">
            {% if photos %}
                <div class="row g-3">
                    {% for photo in photos %}
                        <div class="col-12 col-sm-6 col-xl-4">
                            <a class="photo-card" href="{{ photo }}" target="_blank" rel="noopener">
                                <div class="photo-thumb">
                                    <img src="{{ photo }}" alt="Foto do evento {{ loop.index }}">
                                </div>
                            </a>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="photos-empty">Nenhuma foto anexada a este evento.</div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        (() => {
            const clampRatio = (value) => {
                if (!Number.isFinite(value) || value <= 0) {
                    return null;
                }
                const min = 0.35;
                const max = 3.5;
                return Math.min(Math.max(value, min), max);
            };

            document.querySelectorAll('.event-view .photo-card').forEach((card) => {
                const imageEl = card.querySelector('img');
                if (!imageEl) {
                    return;
                }

                const applyRatio = () => {
                    const width = imageEl.naturalWidth;
                    const height = imageEl.naturalHeight;
                    if (!width || !height) {
                        return;
                    }

                    const ratio = clampRatio(width / height);
                    if (ratio) {
                        card.style.setProperty('--photo-aspect-ratio', ratio.toFixed(4));
                    }
                };

                if (imageEl.complete && imageEl.naturalWidth) {
                    applyRatio();
                } else {
                    imageEl.addEventListener('load', applyRatio, { once: true });
                }

                imageEl.addEventListener('error', () => {
                    card.style.removeProperty('--photo-aspect-ratio');
                }, { once: true });
            });
        })();
    </script>
{% endblock %}
