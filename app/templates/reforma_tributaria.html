{% extends "base.html" %}

{% block title %}Reforma Tributária{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
    .rt-video-player iframe {
        border: 0;
    }

    .rt-drive-embed iframe {
        border: 0;
        width: 100%;
        height: 100%;
    }

    .rt-video-item {
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }

    .rt-video-item.active {
        background-color: rgba(11, 40, 139, 0.08);
        box-shadow: inset 2px 0 0 var(--primary);
    }

    .rt-video-item .status-icon {
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .rt-video-item.is-watched .status-icon {
        opacity: 1;
    }

    .rt-video-thumb {
        width: 110px;
    }

    .rt-video-thumb .ratio {
        background: #f1f3f5;
    }

    .rt-module-item {
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
    }

    .rt-module-item.active {
        background-color: rgba(11, 40, 139, 0.08);
        box-shadow: inset 2px 0 0 var(--primary);
    }

    .rt-module-icon {
        width: 42px;
        height: 42px;
        border-radius: 8px;
        background-color: rgba(11, 40, 139, 0.08);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }

    @media (max-width: 991.98px) {
        .rt-video-thumb {
            width: 90px;
        }
    }
</style>
{% endblock %}

{% block content %}
<section class="py-4 py-md-5">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-11 col-xl-10">
                <div class="d-flex align-items-center mb-4 flex-wrap gap-3">
                    <div class="text-primary display-6"><i class="bi bi-film"></i></div>
                    <div>
                        <h1 class="h3 mb-1">Reforma Tributária</h1>
                        <p class="text-muted mb-0">Assista aos materiais preparados pela equipe diretamente pelo portal e acompanhe seu progresso.</p>
                    </div>
                </div>

                {% if can_upload and upload_modules %}
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-body">
                            <form id="rtUploadForm" class="row g-3 align-items-end" enctype="multipart/form-data">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <div class="col-lg-5">
                                    <label for="rtUploadFile" class="form-label mb-1">Selecionar vídeo</label>
                                    <input type="file" class="form-control" id="rtUploadFile" name="video" accept="video/*" required>
                                </div>
                                <div class="col-lg-4">
                                    <label for="rtUploadModule" class="form-label mb-1">Módulo</label>
                                    <select class="form-select" id="rtUploadModule" name="module_id">
                                        {% for module in upload_modules %}
                                            <option value="{{ module.id }}" data-module-name="{{ module.name }}">{{ module.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-lg-3 col-xl-2">
                                    <button type="submit" class="btn btn-primary w-100" id="rtUploadSubmit">
                                        <span class="spinner-border spinner-border-sm me-2 d-none" id="rtUploadSpinner" role="status" aria-hidden="true"></span>
                                        <span id="rtUploadLabel">Enviar vídeo</span>
                                    </button>
                                </div>
                                <input type="hidden" name="module_name" id="rtUploadModuleName">
                            </form>
                            <div class="form-text mt-2">Os vídeos enviados serão disponibilizados para toda a equipe diretamente neste portal.</div>
                            <div class="alert mt-3 d-none" role="alert" id="rtUploadFeedback"></div>
                        </div>
                    </div>
                {% endif %}

                {% if videos %}
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                                <div>
                                    <h2 class="h6 mb-1">Seu progresso</h2>
                                    <p class="text-muted small mb-0">
                                        <span id="rtWatchedCount">{{ watched_count }}</span> de <span id="rtTotalCount">{{ total_videos }}</span> vídeos assistidos
                                    </p>
                                </div>
                                <span class="badge bg-primary-subtle text-primary fw-semibold" id="rtProgressPercent">{{ progress_percent }}%</span>
                            </div>
                            <div class="progress mt-3" style="height: 6px;">
                                <div class="progress-bar" id="rtProgressBar" role="progressbar" style="width: {{ progress_percent }}%;" aria-valuemin="0" aria-valuemax="100" aria-valuenow="{{ progress_percent }}"></div>
                            </div>
                        </div>
                    </div>

                    {% set initial_video = selected_video or videos[0] %}
                    {% set initial_watched = initial_video.id in watched_ids %}

                    <div class="row g-4 align-items-start">
                        <div class="col-lg-8">
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-body">
                                    <div class="ratio ratio-16x9 rounded overflow-hidden bg-dark-subtle rt-video-player mb-3">
                                        <iframe
                                            id="rtVideoFrame"
                                            src="{{ initial_video.preview_url }}"
                                            allow="autoplay; fullscreen"
                                            allowfullscreen
                                            loading="lazy"
                                            title="{{ initial_video.name }}"
                                        ></iframe>
                                    </div>
                                    <div class="d-flex flex-wrap gap-3 justify-content-between align-items-start">
                                        <div>
                                            <h2 class="h5 mb-1" id="rtVideoTitle">{{ initial_video.name }}</h2>
                                            {% if initial_video.formatted_duration %}
                                                <span class="badge bg-secondary-subtle text-secondary-emphasis" id="rtVideoDuration">{{ initial_video.formatted_duration }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary-subtle text-secondary-emphasis d-none" id="rtVideoDuration"></span>
                                            {% endif %}
                                        </div>
                                        <button
                                            type="button"
                                            class="btn {% if initial_watched %}btn-outline-secondary{% else %}btn-success{% endif %}"
                                            id="rtWatchToggle"
                                            data-video-id="{{ initial_video.id }}"
                                            aria-pressed="{{ 'true' if initial_watched else 'false' }}"
                                        >
                                            <span class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true" id="rtWatchSpinner"></span>
                                            <i class="bi {% if initial_watched %}bi-arrow-counterclockwise{% else %}bi-check2-circle{% endif %} me-2" id="rtWatchIcon"></i>
                                            <span id="rtWatchLabel">{% if initial_watched %}Marcar como não assistido{% else %}Marcar como assistido{% endif %}</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card shadow-sm border-0 mb-4">
                                <div class="card-header">
                                    <h2 class="h6 mb-0">Módulos</h2>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush" id="rtModuleList">
                                        {% for module in video_groups %}
                                            <button
                                                type="button"
                                                class="list-group-item list-group-item-action d-flex gap-3 align-items-center rt-module-item{% if module.id == selected_group_id %} active{% endif %}"
                                                data-module-id="{{ module.id }}"
                                                data-module-name="{{ module.name }}"
                                                data-video-count="{{ module.videos|length }}"
                                            >
                                                <span class="rt-module-icon text-primary flex-shrink-0">
                                                    <i class="bi {{ module.icon }}"></i>
                                                </span>
                                                <div class="flex-grow-1 text-start">
                                                    <span class="fw-semibold d-block">{{ module.name }}</span>
                                                    <small class="text-muted">{{ module.videos|length }} vídeo{% if module.videos|length != 1 %}s{% endif %}</small>
                                                </div>
                                                <span class="badge {% if module.videos|length %}bg-primary-subtle text-primary{% else %}bg-light text-muted border{% endif %}">{{ module.videos|length }}</span>
                                            </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            <div class="card shadow-sm border-0 h-100">
                                <div class="card-header d-flex align-items-center justify-content-between">
                                    <div>
                                        <h2 class="h6 mb-0">Vídeos</h2>
                                        <small class="text-muted" id="rtActiveModuleLabel">{{ selected_module_name }}</small>
                                    </div>
                                    <span class="badge bg-secondary-subtle text-secondary-emphasis" id="rtModuleVideoCount"></span>
                                </div>
                                <div class="card-body p-0">
                                    <div class="p-3 text-muted small d-none" id="rtEmptyModuleMessage">
                                        Nenhum vídeo disponível neste módulo no momento.
                                    </div>
                                    <div class="list-group list-group-flush" id="rtVideoList">
                                        {% for video in videos %}
                                            {% set watched = video.id in watched_ids %}
                                            <button
                                                type="button"
                                                class="list-group-item list-group-item-action rt-video-item d-flex gap-3 align-items-center{% if video.id == initial_video.id %} active{% endif %}{% if watched %} is-watched{% endif %}{% if selected_group_id and video.module_id != selected_group_id %} d-none{% endif %}"
                                                data-video-id="{{ video.id }}"
                                                data-video-title="{{ video.name }}"
                                                data-preview-url="{{ video.preview_url }}"
                                                data-video-duration="{{ video.formatted_duration or '' }}"
                                                data-module-id="{{ video.module_id }}"
                                                data-module-name="{{ video.module_name }}"
                                            >
                                                <div class="rt-video-thumb flex-shrink-0">
                                                    <div class="ratio ratio-16x9 rounded overflow-hidden border">
                                                        {% if video.thumbnail_link %}
                                                            <img src="{{ video.thumbnail_link }}" alt="Miniatura do vídeo {{ video.name }}" class="w-100 h-100 object-fit-cover" loading="lazy">
                                                        {% else %}
                                                            <div class="d-flex h-100 w-100 align-items-center justify-content-center bg-light">
                                                                <i class="bi bi-play-btn text-primary fs-3"></i>
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="flex-grow-1 text-start">
                                                    <div class="d-flex align-items-center mb-1">
                                                        <i class="bi bi-check-circle-fill text-success status-icon me-2"></i>
                                                        <span class="fw-semibold text-wrap">{{ video.name }}</span>
                                                    </div>
                                                    {% if video.formatted_duration %}
                                                        <small class="text-muted"><i class="bi bi-clock me-1"></i>{{ video.formatted_duration }}</small>
                                                    {% endif %}
                                                </div>
                                            </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% elif folder_embed_url %}
                    <div class="card shadow-sm border-0 mb-4">
                        <div class="card-body">
                            <div class="d-flex align-items-start gap-3 mb-3">
                                <div class="text-primary fs-3"><i class="bi bi-cloud-arrow-down"></i></div>
                                <div>
                                    <h2 class="h6 mb-1">Carregando vídeos diretamente da pasta do Google Drive</h2>
                                    <p class="text-muted small mb-0">A listagem personalizada está indisponível no momento, mas você pode acessar e assistir aos vídeos pelo visualizador incorporado abaixo.</p>
                                </div>
                            </div>
                            <div class="ratio ratio-16x9 rt-drive-embed rounded overflow-hidden border">
                                <iframe
                                    src="{{ folder_embed_url }}"
                                    title="Pasta de vídeos Reforma Tributária"
                                    loading="lazy"
                                    allowfullscreen
                                ></iframe>
                            </div>
                        </div>
                    </div>
                    {% if drive_error %}
                        <div class="alert alert-info d-flex align-items-start" role="alert">
                            <i class="bi bi-info-circle-fill me-2 mt-1"></i>
                            <div>
                                <h2 class="h6 mb-1">Listagem detalhada indisponível</h2>
                                <p class="mb-0 small">{{ drive_error }}</p>
                            </div>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="card shadow-sm border-0">
                        <div class="card-body text-center py-5">
                            <div class="display-6 text-muted mb-3"><i class="bi bi-collection-play"></i></div>
                            <h2 class="h5 mb-2">Nenhum vídeo disponível no momento</h2>
                            <p class="text-muted mb-0">Assim que novos conteúdos forem adicionados à pasta da Reforma Tributária, eles aparecerão automaticamente por aqui.</p>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
{% if videos %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const moduleInfo = {{ module_metadata|tojson }};
        const iframe = document.getElementById('rtVideoFrame');
        const titleEl = document.getElementById('rtVideoTitle');
        const durationBadge = document.getElementById('rtVideoDuration');
        const toggleButton = document.getElementById('rtWatchToggle');
        const toggleIcon = document.getElementById('rtWatchIcon');
        const toggleLabel = document.getElementById('rtWatchLabel');
        const toggleSpinner = document.getElementById('rtWatchSpinner');
        const moduleLabelEl = document.getElementById('rtActiveModuleLabel');
        const moduleCountEl = document.getElementById('rtModuleVideoCount');
        const emptyModuleMessage = document.getElementById('rtEmptyModuleMessage');
        const moduleListEl = document.getElementById('rtModuleList');
        const videoListEl = document.getElementById('rtVideoList');
        const uploadForm = document.getElementById('rtUploadForm');
        const uploadFeedback = document.getElementById('rtUploadFeedback');
        const uploadSpinner = document.getElementById('rtUploadSpinner');
        const uploadLabel = document.getElementById('rtUploadLabel');
        const uploadSubmit = document.getElementById('rtUploadSubmit');
        const uploadModuleSelect = document.getElementById('rtUploadModule');
        const uploadModuleName = document.getElementById('rtUploadModuleName');
        const uploadFileInput = document.getElementById('rtUploadFile');
        const watchedSet = new Set({{ watched_ids|tojson }});
        let totalVideos = {{ total_videos }};
        const totalVideosEl = document.getElementById('rtTotalCount');
        const watchedCountEl = document.getElementById('rtWatchedCount');
        const progressPercentEl = document.getElementById('rtProgressPercent');
        const progressBarEl = document.getElementById('rtProgressBar');
        let activeModuleId = '{{ selected_group_id or '' }}';

        let videoItems = [];
        let moduleButtons = [];

        const updateProgress = () => {
            const watchedCount = watchedSet.size;
            watchedCountEl.textContent = watchedCount;
            if (totalVideosEl) {
                totalVideosEl.textContent = String(totalVideos);
            }
            const percent = totalVideos ? Math.round((watchedCount / totalVideos) * 100) : 0;
            progressPercentEl.textContent = `${percent}%`;
            progressBarEl.style.width = `${percent}%`;
            progressBarEl.setAttribute('aria-valuenow', String(percent));
        };

        const updateModuleCount = (visibleCount) => {
            if (!moduleCountEl) {
                return;
            }
            let label = '';
            if (visibleCount === 0) {
                label = 'Nenhum vídeo';
            } else if (visibleCount === 1) {
                label = '1 vídeo';
            } else {
                label = `${visibleCount} vídeos`;
            }
            moduleCountEl.textContent = label;
        };

        const updateButtonState = (videoId) => {
            const isWatched = watchedSet.has(videoId);
            toggleButton.dataset.videoId = videoId;
            toggleButton.classList.toggle('btn-success', !isWatched);
            toggleButton.classList.toggle('btn-outline-secondary', isWatched);
            toggleButton.setAttribute('aria-pressed', isWatched ? 'true' : 'false');
            toggleIcon.className = isWatched ? 'bi bi-arrow-counterclockwise me-2' : 'bi bi-check2-circle me-2';
            toggleLabel.textContent = isWatched ? 'Marcar como não assistido' : 'Marcar como assistido';
        };

        const activateItem = (item) => {
            videoItems.forEach((btn) => btn.classList.remove('active'));
            item.classList.add('active');
        };

        const selectVideo = (item) => {
            const videoId = item.dataset.videoId;
            const previewUrl = item.dataset.previewUrl;
            const title = item.dataset.videoTitle;
            const duration = item.dataset.videoDuration;
            const moduleName = item.dataset.moduleName;

            iframe.src = previewUrl;
            iframe.title = title;
            titleEl.textContent = title;

            if (duration) {
                durationBadge.textContent = duration;
                durationBadge.classList.remove('d-none');
            } else {
                durationBadge.classList.add('d-none');
            }

            activateItem(item);
            updateButtonState(videoId);
            toggleButton.disabled = false;
            toggleButton.removeAttribute('aria-disabled');
            toggleSpinner.classList.add('d-none');

            if (moduleLabelEl && moduleName) {
                moduleLabelEl.textContent = moduleName;
            }
        };

        const registerVideoItem = (item) => {
            videoItems.push(item);
            item.addEventListener('click', () => selectVideo(item));
        };

        const filterVideos = (moduleId, moduleName) => {
            activeModuleId = moduleId;
            moduleButtons.forEach((button) => {
                button.classList.toggle('active', button.dataset.moduleId === moduleId);
            });

            if (moduleLabelEl && moduleName) {
                moduleLabelEl.textContent = moduleName;
            }

            const visibleItems = [];
            videoItems.forEach((item) => {
                const matches = !moduleId || item.dataset.moduleId === moduleId;
                item.classList.toggle('d-none', !matches);
                if (matches) {
                    visibleItems.push(item);
                }
            });

            updateModuleCount(visibleItems.length);

            if (!visibleItems.length) {
                emptyModuleMessage.classList.remove('d-none');
                toggleButton.disabled = true;
                toggleButton.setAttribute('aria-disabled', 'true');
                return;
            }

            emptyModuleMessage.classList.add('d-none');
            toggleButton.disabled = false;
            toggleButton.removeAttribute('aria-disabled');

            const activeItem = visibleItems.find((item) => item.classList.contains('active'));
            if (!activeItem) {
                selectVideo(visibleItems[0]);
            }
        };

        const registerModuleButton = (button) => {
            moduleButtons.push(button);
            button.addEventListener('click', () => {
                filterVideos(button.dataset.moduleId, button.dataset.moduleName);
            });
        };

        const updateModuleSummary = (button, count) => {
            if (!button) {
                return;
            }
            button.dataset.videoCount = String(count);
            const badge = button.querySelector('.badge');
            if (badge) {
                badge.textContent = String(count);
                badge.classList.toggle('bg-primary-subtle', count > 0);
                badge.classList.toggle('text-primary', count > 0);
                badge.classList.toggle('bg-light', count === 0);
                badge.classList.toggle('text-muted', count === 0);
                badge.classList.toggle('border', count === 0);
            }
            const summary = button.querySelector('.text-muted');
            if (summary) {
                if (count === 0) {
                    summary.textContent = 'Nenhum vídeo';
                } else if (count === 1) {
                    summary.textContent = '1 vídeo';
                } else {
                    summary.textContent = `${count} vídeos`;
                }
            }
        };

        const ensureModuleButton = (moduleId) => {
            if (!moduleListEl) {
                return null;
            }
            let button = moduleListEl.querySelector(`.rt-module-item[data-module-id="${moduleId}"]`);
            if (button) {
                return button;
            }
            const info = moduleInfo[moduleId];
            if (!info) {
                return null;
            }

            button = document.createElement('button');
            button.type = 'button';
            button.className = 'list-group-item list-group-item-action d-flex gap-3 align-items-center rt-module-item';
            button.dataset.moduleId = moduleId;
            button.dataset.moduleName = info.name;
            button.dataset.videoCount = '0';

            const iconWrapper = document.createElement('span');
            iconWrapper.className = 'rt-module-icon text-primary flex-shrink-0';
            const icon = document.createElement('i');
            icon.className = `bi ${info.icon}`;
            iconWrapper.appendChild(icon);

            const infoWrapper = document.createElement('div');
            infoWrapper.className = 'flex-grow-1 text-start';
            const nameSpan = document.createElement('span');
            nameSpan.className = 'fw-semibold d-block';
            nameSpan.textContent = info.name;
            const summary = document.createElement('small');
            summary.className = 'text-muted';
            summary.textContent = 'Nenhum vídeo';
            infoWrapper.appendChild(nameSpan);
            infoWrapper.appendChild(summary);

            const badge = document.createElement('span');
            badge.className = 'badge bg-light text-muted border';
            badge.textContent = '0';

            button.appendChild(iconWrapper);
            button.appendChild(infoWrapper);
            button.appendChild(badge);

            moduleListEl.appendChild(button);
            registerModuleButton(button);
            return button;
        };

        const createVideoItem = (video) => {
            const button = document.createElement('button');
            button.type = 'button';
            button.className = 'list-group-item list-group-item-action rt-video-item d-flex gap-3 align-items-center';
            button.dataset.videoId = video.id;
            button.dataset.videoTitle = video.name;
            button.dataset.previewUrl = video.preview_url;
            button.dataset.videoDuration = video.formatted_duration || '';
            button.dataset.moduleId = video.module_id;
            button.dataset.moduleName = video.module_name;

            const thumbWrapper = document.createElement('div');
            thumbWrapper.className = 'rt-video-thumb flex-shrink-0';
            const ratio = document.createElement('div');
            ratio.className = 'ratio ratio-16x9 rounded overflow-hidden border';
            if (video.thumbnail_link) {
                const img = document.createElement('img');
                img.src = video.thumbnail_link;
                img.alt = `Miniatura do vídeo ${video.name}`;
                img.className = 'w-100 h-100 object-fit-cover';
                img.loading = 'lazy';
                ratio.appendChild(img);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'd-flex h-100 w-100 align-items-center justify-content-center bg-light';
                const icon = document.createElement('i');
                icon.className = 'bi bi-play-btn text-primary fs-3';
                placeholder.appendChild(icon);
                ratio.appendChild(placeholder);
            }
            thumbWrapper.appendChild(ratio);

            const infoWrapper = document.createElement('div');
            infoWrapper.className = 'flex-grow-1 text-start';
            const titleRow = document.createElement('div');
            titleRow.className = 'd-flex align-items-center mb-1';
            const statusIcon = document.createElement('i');
            statusIcon.className = 'bi bi-check-circle-fill text-success status-icon me-2';
            const titleSpan = document.createElement('span');
            titleSpan.className = 'fw-semibold text-wrap';
            titleSpan.textContent = video.name;
            titleRow.appendChild(statusIcon);
            titleRow.appendChild(titleSpan);
            infoWrapper.appendChild(titleRow);
            if (video.formatted_duration) {
                const duration = document.createElement('small');
                duration.className = 'text-muted';
                const clockIcon = document.createElement('i');
                clockIcon.className = 'bi bi-clock me-1';
                duration.appendChild(clockIcon);
                duration.appendChild(document.createTextNode(video.formatted_duration));
                infoWrapper.appendChild(duration);
            }

            button.appendChild(thumbWrapper);
            button.appendChild(infoWrapper);
            return button;
        };

        const showUploadFeedback = (message, variant) => {
            if (!uploadFeedback) {
                return;
            }
            uploadFeedback.className = `alert alert-${variant} mt-3`;
            uploadFeedback.textContent = message;
            uploadFeedback.classList.remove('d-none');
        };

        const resetUploadFeedback = () => {
            if (!uploadFeedback) {
                return;
            }
            uploadFeedback.classList.add('d-none');
            uploadFeedback.className = 'alert mt-3 d-none';
            uploadFeedback.textContent = '';
        };

        const syncModuleName = () => {
            if (!uploadModuleSelect || !uploadModuleName) {
                return;
            }
            const option = uploadModuleSelect.options[uploadModuleSelect.selectedIndex];
            uploadModuleName.value = option ? (option.dataset.moduleName || option.textContent.trim()) : '';
        };

        document.querySelectorAll('.rt-video-item').forEach((item) => registerVideoItem(item));
        document.querySelectorAll('.rt-module-item').forEach((button) => registerModuleButton(button));

        moduleButtons.forEach((button) => {
            const count = videoItems.filter((item) => item.dataset.moduleId === button.dataset.moduleId).length;
            updateModuleSummary(button, count);
        });

        if (uploadModuleSelect) {
            syncModuleName();
            uploadModuleSelect.addEventListener('change', syncModuleName);
        }

        toggleButton.addEventListener('click', async () => {
            const videoId = toggleButton.dataset.videoId;
            const isWatched = watchedSet.has(videoId);
            const payload = {
                title: titleEl.textContent || ''
            };

            toggleButton.disabled = true;
            toggleSpinner.classList.remove('d-none');

            try {
                const response = await fetch(`/reforma-tributaria/videos/${videoId}/watch`, {
                    method: isWatched ? 'DELETE' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: isWatched ? undefined : JSON.stringify(payload)
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Erro inesperado ao atualizar o status do vídeo.');
                }

                if (data.status === 'watched') {
                    watchedSet.add(videoId);
                } else {
                    watchedSet.delete(videoId);
                }

                document.querySelectorAll(`.rt-video-item[data-video-id="${videoId}"]`).forEach((item) => {
                    item.classList.toggle('is-watched', watchedSet.has(videoId));
                });

                updateButtonState(videoId);
                updateProgress();
            } catch (error) {
                console.error(error);
                alert('Não foi possível atualizar o status do vídeo agora. Tente novamente mais tarde.');
            } finally {
                toggleButton.disabled = false;
                toggleSpinner.classList.add('d-none');
            }
        });

        if (uploadForm && uploadSubmit) {
            uploadForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                resetUploadFeedback();
                if (!uploadFileInput || !uploadFileInput.files || !uploadFileInput.files.length) {
                    showUploadFeedback('Selecione um vídeo para enviar.', 'warning');
                    return;
                }

                uploadSubmit.disabled = true;
                if (uploadSpinner) {
                    uploadSpinner.classList.remove('d-none');
                }
                if (uploadLabel) {
                    uploadLabel.textContent = 'Enviando...';
                }

                const formData = new FormData(uploadForm);

                try {
                    const response = await fetch('/reforma-tributaria/upload', {
                        method: 'POST',
                        body: formData,
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        throw new Error(data.error || 'Não foi possível enviar o vídeo.');
                    }

                    const video = data.video;
                    if (video) {
                        const newItem = createVideoItem(video);
                        if (videoListEl) {
                            videoListEl.prepend(newItem);
                        }
                        registerVideoItem(newItem);

                        const moduleButton = ensureModuleButton(video.module_id);
                        if (moduleButton) {
                            const nextCount = parseInt(moduleButton.dataset.videoCount || '0', 10) + 1;
                            updateModuleSummary(moduleButton, nextCount);
                        }

                        totalVideos += 1;
                        watchedSet.delete(video.id);
                        updateProgress();

                        if (!activeModuleId || activeModuleId === video.module_id) {
                            filterVideos(video.module_id, video.module_name);
                            selectVideo(newItem);
                        } else {
                            filterVideos(activeModuleId, moduleLabelEl ? moduleLabelEl.textContent : '');
                        }

                        showUploadFeedback(data.message || 'Vídeo enviado com sucesso.', 'success');
                    }

                    uploadForm.reset();
                    if (uploadModuleSelect) {
                        uploadModuleSelect.dispatchEvent(new Event('change'));
                    }
                } catch (error) {
                    console.error(error);
                    showUploadFeedback(error.message || 'Não foi possível enviar o vídeo.', 'danger');
                } finally {
                    uploadSubmit.disabled = false;
                    if (uploadSpinner) {
                        uploadSpinner.classList.add('d-none');
                    }
                    if (uploadLabel) {
                        uploadLabel.textContent = 'Enviar vídeo';
                    }
                }
            });
        }

        updateModuleCount(
            videoItems.filter((item) => !item.classList.contains('d-none')).length
        );
        filterVideos(activeModuleId, moduleLabelEl ? moduleLabelEl.textContent : '');
        updateProgress();
    });
</script>
{% endif %}
{% endblock %}
