{% extends "base.html" %}

{% block title %}Tarefas - {{ tag.nome }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='tasks.css') }}">
{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<section class="kanban" data-realtime data-realtime-scopes="tasks" data-current-user="{{ current_user.id }}">
  <div class="kanban-header">
    <h2><i class="bi bi-kanban"></i>Tarefas - {{ tag.nome }}</h2>
    <div class="kanban-actions">
      <form method="get" action="{{ url_for('tasks_sector', tag_id=tag.id) }}" class="assigned-filter" id="assigned-to-me-form">
        <label for="assigned-to-me-checkbox">
          <input type="checkbox" id="assigned-to-me-checkbox" name="assigned_to_me" value="1" {% if assigned_to_me %}checked{% endif %}>
          Ver com meu nome
        </label>
      </form>
      {% if current_user.role == 'admin' %}
      <a href="{{ url_for('tasks_new', tag_id=tag.id) }}" class="btn-new-task">Nova Tarefa</a>
      {% else %}
      <a href="{{ url_for('tasks_new', tag_id=ti_tag_id or tag.id) }}" class="btn-new-task">Nova Tarefa</a>
      {% endif %}
      <a href="{{ url_for('tasks_history', tag_id=tag.id, assigned_to_me=1 if assigned_to_me else None) }}" class="btn-history">Histórico{% if history_count %} ({{ history_count }}){% endif %}</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div style="margin: 1rem 0;">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert" style="margin-bottom: 0.5rem;">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
  {% from "tasks_macros.html" import render_task, render_actions_legend with context %}
  {% set status_meta = {
    'pending': {'label': 'Pendente', 'icon': 'bi-hourglass'},
    'in_progress': {'label': 'Em andamento', 'icon': 'bi-play-circle'},
    'done': {'label': 'Concluída', 'icon': 'bi-check-circle'}
  } %}
  {% set priority_labels = {
    'low': 'Baixa',
    'medium': 'Média',
    'high': 'Alta'
  } %}
  {% set allow_delete = current_user.role == 'admin' %}
  {{ render_actions_legend() }}
  <div class="kanban-board">
    {% for status in TaskStatus %}
    <div class="kanban-column">
      <h3><i class="bi {{ status_meta[status.value].icon }}"></i>{{ status_meta[status.value].label }}</h3>
      <ul class="kanban-list" data-status="{{ status.value }}">
        {% for task in tasks_by_status[status] if not task.is_private or task.created_by == current_user.id %}
          {{ render_task(task, TaskStatus, priority_labels=priority_labels, allow_delete=allow_delete) }}
        {% else %}
          <li class="empty">Nenhuma tarefa.</li>
        {% endfor %}
      </ul>
    </div>
    {% endfor %}
  </div>
{% include "tasks_responses_panel.html" %}
</section>
<script>
  const csrfToken = "{{ csrf_token() }}";
</script>
<script src="{{ url_for('static', filename='javascript/realtime.js') }}"></script>
<script src="{{ url_for('static', filename='javascript/tasks.js') }}"></script>
{% endblock %}
