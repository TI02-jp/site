{% extends "base.html" %}

{% block title %}Procedimentos Operacionais{% endblock %}

{% block sidebar_nav %}
{% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid py-2 px-2">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0"><i class="bi bi-journal-text me-2"></i>Procedimentos Operacionais</h1>
    <div class="d-flex align-items-center gap-2">
      <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#newProcedureModal">
        <i class="bi bi-plus-lg me-1"></i>Novo procedimento
      </button>
      <form class="d-flex" method="get" action="{{ url_for('procedimentos_operacionais') }}">
        <input class="form-control form-control-sm me-2" type="search" name="q" placeholder="Buscar por titulo ou descricao" value="{{ search_term }}">
        <button class="btn btn-outline-primary btn-sm" type="submit"><i class="bi bi-search"></i></button>
      </form>
    </div>
  </div>

  <!-- Modal: Novo Procedimento -->
  <div class="modal fade" id="newProcedureModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl" style="max-width: min(1400px, calc(100vw - 4rem)); margin: 0.5rem auto;">
      <div class="modal-content" style="overflow: hidden;">
        <div class="modal-header">
          <h5 class="modal-title">Novo procedimento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body" style="overflow: hidden;">
          <form method="POST" id="new-proc-form">
            {{ form.hidden_tag() }}
            <div class="mb-3">
              <label class="form-label">{{ form.title.label }}</label>
              {{ form.title(class="form-control", placeholder="Titulo do procedimento") }}
              {% for e in form.title.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <div class="mb-3">
              <label class="form-label">{{ form.descricao.label }}</label>
              <div id="proc-editor-modal" style="height: 48vh;"></div>
              {{ form.descricao(id="proc-descricao", style="display:none;") }}
              <input type="file" id="proc-file-input" accept="image/*,.pdf" style="display:none;">
              <button type="button" id="proc-pdf-btn" class="btn btn-sm btn-outline-secondary mt-2">
                <i class="bi bi-file-pdf me-1"></i>Anexar PDF
              </button>
              <div class="form-text">Cole prints diretamente, use o botao de imagem ou anexe PDFs. Arquivos sao enviados ao salvar o conteudo.</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="new-proc-form" class="btn btn-primary"><i class="bi bi-save me-1"></i>{{ form.submit.label.text }}</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <strong>Procedimentos</strong>
    </div>
    <ul class="list-group list-group-flush">
      {% if procedures %}
        {% for p in procedures %}
        <li class="list-group-item d-flex align-items-center justify-content-between">
          <div>
            <a class="fw-semibold text-decoration-none" href="{{ url_for('procedimentos_operacionais_ver', proc_id=p.id) }}">{{ p.title }}</a>
          </div>
          {% if current_user.role == 'admin' %}
          <form method="post" action="{{ url_for('procedimentos_operacionais_excluir', proc_id=p.id) }}" onsubmit="return confirm('Excluir este procedimento?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i></button>
          </form>
          {% endif %}
        </li>
        {% endfor %}
      {% else %}
        <li class="list-group-item text-muted">Nenhum procedimento encontrado.</li>
      {% endif %}
    </ul>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function(){
  const csrfToken = window.csrfToken;
  function uploadFile(file){
    return new Promise((resolve, reject)=>{
      const data = new FormData();
      data.append('file', file);
      fetch('{{ url_for('upload_file') }}', { method:'POST', headers:{'X-CSRFToken': csrfToken}, body:data })
        .then(r=>r.json()).then(j=>{ if(j.file_url) resolve(j); else reject(j.error||'Falha'); })
        .catch(()=>reject('Erro de rede'));
    });
  }
  let quillInitialized = false;
  function initQuillModal(){
    if(quillInitialized) return;
    const editor = document.querySelector('#proc-editor-modal');
    const hidden = document.querySelector('#proc-descricao');
    const fileInput = document.querySelector('#proc-file-input');
    const pdfBtn = document.querySelector('#proc-pdf-btn');
    if(!editor || !hidden || !fileInput) return;
    function selectLocalFile(){ fileInput.click(); }
    const quill = new Quill(editor, {
      theme: 'snow',
      placeholder: 'Descreva o procedimento. Voce pode colar prints ou anexar PDFs.',
      modules: { toolbar: { container: [ ['bold','italic','underline'], [{list:'ordered'},{list:'bullet'}], ['link','image'], ['clean'] ], handlers: { image: selectLocalFile } } }
    });
    if(hidden.value){ quill.root.innerHTML = hidden.value; }

    // Botao para anexar PDF usando o mesmo seletor de arquivos
    if(pdfBtn){
      pdfBtn.addEventListener('click', ()=>{ fileInput.click(); });
    }

    fileInput.addEventListener('change', ()=>{
      if(fileInput.files && fileInput.files[0]){
        const f = fileInput.files[0];
        const range = quill.getSelection(true) || { index: quill.getLength() };
        const isPdf = f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf');

        if(isPdf){
          const tempText = `[Carregando PDF: ${f.name}...]`;
          quill.insertText(range.index, tempText);
          quill.setSelection(range.index + tempText.length);

          uploadFile(f).then(result=>{
            const currentContents = quill.getText();
            const tempIndex = currentContents.indexOf(tempText);
            if(tempIndex !== -1){
              quill.deleteText(tempIndex, tempText.length);
              quill.insertText(tempIndex, `PDF: ${result.filename}`, 'link', result.file_url);
              quill.insertText(tempIndex + result.filename.length + 5, '\n');
            }
          }).catch(err=>{
            alert('Erro ao enviar PDF: ' + err);
            const currentContents = quill.getText();
            const tempIndex = currentContents.indexOf(tempText);
            if(tempIndex !== -1){
              quill.deleteText(tempIndex, tempText.length);
            }
          });
        } else {
          const reader = new FileReader();
          reader.onload = e => {
            const b64 = e.target.result;
            quill.insertEmbed(range.index, 'image', b64);
            quill.setSelection(range.index + 1);
            // Troca a imagem em base64 pela URL definitiva apos upload
            uploadFile(f).then(result=>{
              const img = quill.root.querySelector(`img[src="${b64}"]`);
              if(img) img.src = result.file_url;
            }).catch(()=>{
              const img = quill.root.querySelector(`img[src="${b64}"]`);
              if(img) img.remove();
            });
          };
          reader.readAsDataURL(f);
        }
        fileInput.value = '';
      }
    });
    document.getElementById('new-proc-form')?.addEventListener('submit', ()=>{ hidden.value = quill.root.innerHTML; });
    quillInitialized = true;
  }
  const modalEl = document.getElementById('newProcedureModal');
  if(modalEl){
    modalEl.addEventListener('shown.bs.modal', initQuillModal);
    {% if form.title.errors or form.descricao.errors %}
    const m = new bootstrap.Modal(modalEl);
    m.show();
    {% endif %}
  }
})();
</script>
{% endblock %}
