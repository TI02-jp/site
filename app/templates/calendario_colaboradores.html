{% extends "base.html" %}
{% block title %}AGENDA{% endblock %}

{% block extra_css %}
    {{ super() }}
    <style>
    .content-breadcrumb { display: none; }
    .content-area { display: flex; }
    .content-area > .content-wrapper {
        flex: 1 1 auto;
        display: flex;
        min-height: 0;
    }
    .content-wrapper { padding: 0; }
    .agenda-calendar {
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        padding: 2rem 2.5rem 1.75rem;
        gap: 1.25rem;
        overflow: hidden;
    }
    .agenda-calendar-header {
        flex: 0 0 auto;
    }
    .agenda-calendar-body {
        flex: 1 1 auto;
        min-height: 0;
        display: flex;
        max-height: calc(100vh - 9rem);
        overflow-y: auto;
    }
    .agenda-calendar-body #calendar {
        flex: 1 1 auto;
        min-height: 0;
    }
    .modal-body { max-height: none; overflow-y: visible; }
    .participant-list { max-height: 200px; overflow-y: auto; }
    .fc .fc-scroller {
        overflow-y: auto !important;
    }
    .fc .fc-daygrid-event-harness { margin-bottom: 0; }
    .fc .fc-daygrid-event,
    .fc .fc-timegrid-event {
        position: relative;
        padding: 0;
        border: none;
        background: transparent;
        width: 100%;
    }
    .fc .fc-daygrid-event { font-size: 0.75rem; }
    .fc .fc-daygrid-event.fc-daygrid-block-event { min-height: 0; }
    .fc .fc-daygrid-event .fc-event-main,
    .fc .fc-timegrid-event .fc-event-main {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.35rem;
        padding: 2px 6px;
        border-radius: 999px;
        background: rgba(13, 110, 253, 0.9);
        color: #fff;
        line-height: 1;
        white-space: nowrap;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.6);
        z-index: 1;
        text-align: left;
    }
    .fc .fc-daygrid-event .fc-event-title,
    .fc .fc-timegrid-event .fc-event-title {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .fc .birthday-event .fc-event-main {
        background: #22c55e;
        color: #fff;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.65);
    }
    .fc .birthday-event .fc-event-main .fc-event-title,
    .fc .birthday-event .fc-event-main .fc-event-time {
        color: inherit;
    }
    .fc .birthday-event .fc-event-dot {
        background-color: #22c55e;
        border-color: #22c55e;
    }
    .badge-birthday {
        background-color: #22c55e;
        color: #fff;
    }
    .badge-vacation {
        background-color: #f58220;
        color: #fff;
    }
    .badge-absence {
        background-color: #ef4444;
        color: #fff;
    }
    .badge-notice {
        background-color: #eab308;
        color: #000;
    }
    .fc .vacation-event .fc-event-main {
        background: #f58220;
        color: #fff;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.65);
    }
    .fc .vacation-event .fc-event-main .fc-event-title,
    .fc .vacation-event .fc-event-main .fc-event-time {
        color: inherit;
    }
    .fc .vacation-event .fc-event-dot {
        background-color: #f58220;
        border-color: #f58220;
    }
    .fc .absence-event .fc-event-main {
        background: #ef4444;
        color: #fff;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.65);
    }
    .fc .absence-event .fc-event-main .fc-event-title,
    .fc .absence-event .fc-event-main .fc-event-time {
        color: inherit;
    }
    .fc .absence-event .fc-event-dot {
        background-color: #ef4444;
        border-color: #ef4444;
    }
    .fc .notice-event .fc-event-main {
        background: #eab308;
        color: #000;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.65);
    }
    .fc .notice-event .fc-event-main .fc-event-title,
    .fc .notice-event .fc-event-main .fc-event-time {
        color: inherit;
    }
    .fc .notice-event .fc-event-dot {
        background-color: #eab308;
        border-color: #eab308;
    }
    .calendar-legend {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        padding: 0.75rem 0;
        align-items: center;
    }
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }
    .legend-color.normal {
        background-color: rgba(13, 110, 253, 0.9);
    }
    .legend-color.birthday {
        background-color: #22c55e;
    }
    .legend-color.vacation {
        background-color: #f58220;
    }
    .legend-color.absence {
        background-color: #ef4444;
    }
    .legend-color.notice {
        background-color: #eab308;
    }
</style>
{% endblock %}

{% block sidebar_nav %}
    {% include 'sidebar_home.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid px-4 agenda-calendar">
    <div class="d-flex justify-content-between align-items-center agenda-calendar-header">
        <h2>AGENDA</h2>
        {% if can_manage %}
        <button id="openEventModal"
                class="btn btn-primary"
                data-bs-toggle="modal"
                data-bs-target="#calendarEventModal">Novo Evento</button>
        {% endif %}
    </div>
    <div class="calendar-legend">
        <div class="legend-item">
            <div class="legend-color normal"></div>
            <span>Agenda</span>
        </div>
        <div class="legend-item">
            <div class="legend-color birthday"></div>
            <span>Aniversário</span>
        </div>
        <div class="legend-item">
            <div class="legend-color vacation"></div>
            <span>Férias</span>
        </div>
        <div class="legend-item">
            <div class="legend-color absence"></div>
            <span>Ausência</span>
        </div>
        <div class="legend-item">
            <div class="legend-color notice"></div>
            <span>Aviso</span>
        </div>
    </div>
    <div class="agenda-calendar-body">
        <div id="calendar"></div>
    </div>

    {% if can_manage %}
    <div class="modal fade" id="calendarEventModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header align-items-start">
                    <h5 class="modal-title">Novo Evento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form method="post">
                    <div class="modal-body text-start">
                        {{ form.csrf_token }}
                        {{ form.event_id(id='event_id') }}
                        <div class="row">
                            <div class="mb-3 col-md-6">
                                {{ form.participants.label(class="form-label") }}
                                <div class="participant-list border rounded p-2">
                                    {% for subfield in form.participants %}
                                        <div class="form-check">
                                            {{ subfield(class="form-check-input", id=subfield.id) }}
                                            <label class="form-check-label" for="{{ subfield.id }}">{{ subfield.label.text }}</label>
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if form.participants.errors %}
                                    <div class="text-danger">{{ form.participants.errors[0] }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-2">
                                    {{ form.is_birthday(class="form-check-input", id="is_birthday") }}
                                    <label class="form-check-label" for="is_birthday">Aniversário</label>
                                </div>
                                <div class="form-check mb-2">
                                    {{ form.is_absence(class="form-check-input", id="is_absence") }}
                                    <label class="form-check-label" for="is_absence">Ausência</label>
                                </div>
                                <div class="form-check mb-2">
                                    {{ form.is_vacation(class="form-check-input", id="is_vacation") }}
                                    <label class="form-check-label" for="is_vacation">Férias</label>
                                </div>
                                <div class="form-check mb-3">
                                    {{ form.is_notice(class="form-check-input", id="is_notice") }}
                                    <label class="form-check-label" for="is_notice">Aviso (Todo o escritório)</label>
                                </div>
                                <div class="mb-3 d-none" id="birthdayUserWrapper">
                                    {{ form.birthday_user_id.label(class="form-label") }}
                                    {{ form.birthday_user_id(class="form-select", id="birthday_user_id") }}
                                    {% if form.birthday_user_id.errors %}
                                        <div class="text-danger">{{ form.birthday_user_id.errors[0] }}</div>
                                    {% endif %}
                                </div>
                                <div class="mb-3 d-none" id="birthdayRecurringWrapper">
                                    <div class="form-check ms-1 mb-2">
                                        {{ form.birthday_recurs_annually(class="form-check-input", id="birthday_recurs_annually") }}
                                        <label class="form-check-label" for="birthday_recurs_annually">Repetir todos os anos</label>
                                    </div>
                                    <div>
                                        {{ form.birthday_recurrence_years.label(class="form-label") }}
                                        {{ form.birthday_recurrence_years(class="form-select", id="birthday_recurrence_years") }}
                                        {% if form.birthday_recurrence_years.errors %}
                                            <div class="text-danger">{{ form.birthday_recurrence_years.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    {{ form.title.label(class="form-label") }}
                                    {{ form.title(class="form-control") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.start_date.label(class="form-label") }}
                                    {{ form.start_date(class="form-control", type="date", id="start_date") }}
                                </div>
                                <div class="mb-3">
                                    {{ form.end_date.label(class="form-label") }}
                                    {{ form.end_date(class="form-control", type="date", id="end_date") }}
                                </div>
                                {% set show_time_fields = form.start_time.data or form.end_time.data or form.start_time.errors or form.end_time.errors %}
                                <div class="row g-3{% if not show_time_fields %} d-none{% endif %}" id="timeFields">
                                    <div class="mb-3 col-md-6">
                                        {{ form.start_time.label(class="form-label") }}
                                        {{ form.start_time(class="form-control", type="time", id="start_time") }}
                                        {% if form.start_time.errors %}
                                            <div class="text-danger">{{ form.start_time.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="mb-3 col-md-6">
                                        {{ form.end_time.label(class="form-label") }}
                                        {{ form.end_time(class="form-control", type="time", id="end_time") }}
                                        {% if form.end_time.errors %}
                                            <div class="text-danger">{{ form.end_time.errors[0] }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            {{ form.description.label(class="form-label") }}
                            {{ form.description(class="form-control") }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header align-items-start">
                    <div class="flex-grow-1">
                        <div id="detailCreator" class="text-muted small d-none mb-1"></div>
                        <div class="d-flex align-items-center gap-2 flex-wrap">
                            <h5 class="modal-title mb-0" id="detailTitle"></h5>
                            <span class="badge badge-birthday d-none" id="detailBirthdayBadge">Aniversário</span>
                            <span class="badge badge-vacation d-none" id="detailVacationBadge">Férias</span>
                            <span class="badge badge-absence d-none" id="detailAbsenceBadge">Ausência</span>
                            <span class="badge badge-notice d-none" id="detailNoticeBadge">Aviso</span>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-start">
                    <ul class="list-group text-start">
                        <li class="list-group-item"><strong>Período:</strong> <span id="detailPeriod"></span></li>
                        <li class="list-group-item"><strong>Participantes:</strong> <span id="detailParticipants"></span></li>
                        <li class="list-group-item d-none" id="detailBirthdayRow"><strong>Aniversariante:</strong> <span id="detailBirthdayName"></span></li>
                    </ul>
                    <div id="detailDescription" class="mt-3 d-none">
                        <h6>Descrição</h6>
                        <p class="mb-0" id="detailDescriptionText"></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <form id="deleteEventForm" method="post" class="d-none">
                        {{ form.csrf_token(id='csrf_token_delete') }}
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    {% if can_manage %}
                    <button type="button" class="btn btn-primary d-none" id="editEventBtn">Editar</button>
                    <button type="button" class="btn btn-danger d-none" id="deleteEventBtn">Excluir</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
@import url('https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/main.min.css');
.fc-daygrid-dot-event { display: flex; align-items: center; padding: 0; border: none; background: none; }
.fc-daygrid-dot-event .fc-event-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 4px; border: none; }
.fc-event-main-custom {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 0.35rem;
    font-size: 0.75rem;
    line-height: 1;
    white-space: nowrap;
    width: 100%;
}
.fc-daygrid-day .fc-event-main-custom { font-size: 0.8rem; }
.fc-event-main-custom .fc-event-creator { font-weight: 600; }
.fc-event-main-custom .fc-event-separator {
    font-weight: 600;
    color: inherit;
}
</style>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/multimonth/index.global.min.js"></script>
    <script>
    function showFlashMessage(message, category = 'success') {
        let container = document.querySelector('.flash-container');
        if (!container) {
            container = document.createElement('div');
            container.className = 'flash-container';
            document.body.appendChild(container);
        }
        const icon = category === 'success' ? 'check-circle-fill' : 'exclamation-triangle-fill';
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${category} alert-dismissible fade show`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `<i class="bi bi-${icon} me-2"></i>${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>`;
        container.appendChild(alertDiv);
        setTimeout(() => {
            bootstrap.Alert.getOrCreateInstance(alertDiv).close();
        }, 3000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        var canManage = {{ 'true' if can_manage else 'false' }};
        var currentEvent = null;
        var currentEventOriginalId = null;
        var MS_IN_DAY = 24 * 60 * 60 * 1000;
        function parseUTCDate(value) {
            if (!value) { return null; }
            var parts = value.split('-').map(function(part) { return parseInt(part, 10); });
            if (parts.length !== 3 || parts.some(isNaN)) { return null; }
            return new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
        }
        function formatUTCDate(date) {
            return date.toISOString().split('T')[0];
        }
        var calendarEl = document.getElementById('calendar');
        function eventStartKey(event) {
            var date = '';
            if (event.extendedProps && event.extendedProps.start_date) {
                date = event.extendedProps.start_date;
            } else if (event.start) {
                date = formatUTCDate(new Date(event.start.valueOf()));
            }
            var time = '';
            if (event.extendedProps && event.extendedProps.start_time) {
                time = event.extendedProps.start_time;
            } else if (!event.allDay && event.start) {
                var hours = String(event.start.getHours()).padStart(2, '0');
                var minutes = String(event.start.getMinutes()).padStart(2, '0');
                time = hours + ':' + minutes;
            }
            return { date: date, time: time };
        }

        function hasTadeuFlag(event) {
            if (!event) { return false; }
            if (event.extendedProps && typeof event.extendedProps.is_tadeu_event !== 'undefined') {
                return Boolean(event.extendedProps.is_tadeu_event);
            }
            if (typeof event.is_tadeu_event !== 'undefined') {
                return Boolean(event.is_tadeu_event);
            }
            return false;
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            fixedWeekCount: false,
            timeZone: '{{ calendar_timezone }}',
            locale: 'pt-br',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridDay,timeGridWeek,dayGridMonth,multiMonthYear'
            },
            navLinks: true,
            expandRows: true,
            height: '100%',
            eventDisplay: 'block',
            eventMaxStack: 8,
            eventOrder: function(a, b) {
                var aKey = eventStartKey(a);
                var bKey = eventStartKey(b);
                if (aKey.date && bKey.date && aKey.date !== bKey.date) {
                    return aKey.date < bKey.date ? -1 : 1;
                }
                if (aKey.date && !bKey.date) { return -1; }
                if (!aKey.date && bKey.date) { return 1; }
                if (aKey.time && bKey.time && aKey.time !== bKey.time) {
                    return aKey.time < bKey.time ? -1 : 1;
                }
                if (aKey.time && !bKey.time) { return 1; }
                if (!aKey.time && bKey.time) { return -1; }
                var aTadeu = hasTadeuFlag(a);
                var bTadeu = hasTadeuFlag(b);
                if (aTadeu !== bTadeu) {
                    return aTadeu ? -1 : 1;
                }
                if (a.allDay && b.allDay) {
                    var aSpan = (a.extendedProps && a.extendedProps.spanDays) ? a.extendedProps.spanDays : 1;
                    var bSpan = (b.extendedProps && b.extendedProps.spanDays) ? b.extendedProps.spanDays : 1;
                    if (aSpan !== bSpan) {
                        return bSpan - aSpan;
                    }
                } else if (a.allDay !== b.allDay) {
                    return a.allDay ? -1 : 1;
                }
                var aTitle = a.title || '';
                var bTitle = b.title || '';
                if (aTitle < bTitle) { return -1; }
                if (aTitle > bTitle) { return 1; }
                return 0;
            },
            buttonText: {
                dayGridDay: 'Dia',
                timeGridWeek: 'Semana',
                dayGridMonth: 'Mês',
                multiMonthYear: 'Ano'
            },
            views: {
                multiMonthYear: {
                    type: 'multiMonth',
                    duration: { years: 1 },
                    multiMonthMaxColumns: 3,
                    multiMonthMinWidth: 220,
                    titleFormat: { year: 'numeric' }
                }
            },
            dateClick: function(info) {
                if (!canManage) { return; }
                openNewEvent(info.dateStr);
            },
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                currentEvent = info.event;
                currentEventOriginalId = currentEvent.extendedProps.originalId || currentEvent.id;
                document.getElementById('detailTitle').textContent = currentEvent.title;
                var birthdayBadge = document.getElementById('detailBirthdayBadge');
                var birthdayRow = document.getElementById('detailBirthdayRow');
                var birthdayNameEl = document.getElementById('detailBirthdayName');
                var isBirthdayEvent = Boolean(
                    (currentEvent.extendedProps && currentEvent.extendedProps.is_birthday) || currentEvent.is_birthday
                );
                if (isBirthdayEvent) {
                    var recurrenceYears = parseInt(
                        currentEvent.extendedProps.birthday_recurrence_years || currentEvent.birthday_recurrence_years || '0',
                        10
                    );
                    if (birthdayBadge) {
                        if (currentEvent.extendedProps.birthday_recurs_annually && recurrenceYears > 0) {
                            var yearsLabel = recurrenceYears === 1 ? '1 ano' : recurrenceYears + ' anos';
                            birthdayBadge.textContent = 'Aniversário (anual por ' + yearsLabel + ')';
                        } else {
                            birthdayBadge.textContent = 'Aniversário';
                        }
                        birthdayBadge.classList.remove('d-none');
                    }
                    if (birthdayRow && birthdayNameEl) {
                        birthdayRow.classList.remove('d-none');
                        var birthdayLabel =
                            currentEvent.extendedProps.birthday_user_name || 'N/A';
                        if (currentEvent.extendedProps.birthday_recurs_annually && recurrenceYears > 0) {
                            var shortYearsLabel = recurrenceYears === 1 ? 'próximo ano' : 'próximos ' + recurrenceYears + ' anos';
                            birthdayLabel += ' • Repetição anual (' + shortYearsLabel + ')';
                        }
                        birthdayNameEl.textContent = birthdayLabel;
                    }
                } else {
                    if (birthdayBadge) {
                        birthdayBadge.classList.add('d-none');
                        birthdayBadge.textContent = 'Aniversário';
                    }
                    if (birthdayRow && birthdayNameEl) {
                        birthdayRow.classList.add('d-none');
                        birthdayNameEl.textContent = '';
                    }
                }
                var vacationBadge = document.getElementById('detailVacationBadge');
                var absenceBadge = document.getElementById('detailAbsenceBadge');
                var noticeBadge = document.getElementById('detailNoticeBadge');
                var isVacationEvent = Boolean(
                    (currentEvent.extendedProps && (
                        currentEvent.extendedProps.is_vacation ||
                        currentEvent.extendedProps.is_vacation_event
                    )) || currentEvent.is_vacation || currentEvent.is_vacation_event
                );
                var isAbsenceEvent = Boolean(
                    (currentEvent.extendedProps && (
                        currentEvent.extendedProps.is_absence ||
                        currentEvent.extendedProps.is_absence_event
                    )) || currentEvent.is_absence || currentEvent.is_absence_event
                );
                var isNoticeEvent = Boolean(
                    (currentEvent.extendedProps && currentEvent.extendedProps.is_notice) || currentEvent.is_notice
                );
                if (vacationBadge) {
                    vacationBadge.classList.toggle('d-none', !isVacationEvent);
                }
                if (absenceBadge) {
                    absenceBadge.classList.toggle('d-none', !isAbsenceEvent);
                }
                if (noticeBadge) {
                    noticeBadge.classList.toggle('d-none', !isNoticeEvent);
                }
                var creatorEl = document.getElementById('detailCreator');
                if (currentEvent.extendedProps.creator) {
                    creatorEl.textContent = 'Criado por: ' + currentEvent.extendedProps.creator;
                    creatorEl.classList.remove('d-none');
                } else {
                    creatorEl.textContent = '';
                    creatorEl.classList.add('d-none');
                }
                var startDate = currentEvent.extendedProps.start_date;
                var endDate = currentEvent.extendedProps.end_date;
                var startTime = currentEvent.extendedProps.start_time;
                var endTime = currentEvent.extendedProps.end_time;
                var display;
                if (startDate === endDate) {
                    display = formatDate(startDate);
                    if (startTime && endTime) {
                        display += ' das ' + startTime + ' às ' + endTime;
                    }
                } else {
                    display = formatDate(startDate) + ' a ' + formatDate(endDate);
                }
                document.getElementById('detailPeriod').textContent = display;
                var participants = currentEvent.extendedProps.participants || [];
                document.getElementById('detailParticipants').textContent = participants.join(', ');
                var description = currentEvent.extendedProps.description || '';
                var descContainer = document.getElementById('detailDescription');
                var descText = document.getElementById('detailDescriptionText');
                if (description.trim()) {
                    descText.textContent = description;
                    descContainer.classList.remove('d-none');
                } else {
                    descText.textContent = '';
                    descContainer.classList.add('d-none');
                }
                if (canManage) {
                    var editBtn = document.getElementById('editEventBtn');
                    var deleteBtn = document.getElementById('deleteEventBtn');
                    var deleteForm = document.getElementById('deleteEventForm');
                    if (currentEvent.extendedProps.can_edit) {
                        editBtn.classList.remove('d-none');
                    } else {
                        editBtn.classList.add('d-none');
                    }
                    if (currentEvent.extendedProps.can_delete) {
                        deleteBtn.classList.remove('d-none');
                        deleteForm.action = '/calendario-eventos/' + currentEventOriginalId + '/delete';
                    } else {
                        deleteBtn.classList.add('d-none');
                    }
                }
                var modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
                modal.show();
            },
            eventContent: function(arg) {
                if (arg.view.type !== 'dayGridDay' && arg.view.type !== 'dayGridMonth') {
                    return;
                }
                var wrapper = document.createElement('div');
                wrapper.className = 'fc-event-main-custom';
                var participants = (arg.event.extendedProps.participants || [])
                    .filter(function(name) { return name && name.trim(); });
                var creator = arg.event.extendedProps.creator;
                var username = '';
                if (participants.length) {
                    username = participants[0];
                    if (participants.length > 1) {
                        username += ' +' + (participants.length - 1);
                    }
                } else if (creator) {
                    username = creator;
                }
                if (username) {
                    var userEl = document.createElement('span');
                    userEl.className = 'fc-event-creator';
                    userEl.textContent = username;
                    wrapper.appendChild(userEl);
                }
                var title = arg.event.title || '';
                if (title) {
                    if (username) {
                        var separator = document.createElement('span');
                        separator.className = 'fc-event-separator';
                        separator.textContent = '•';
                        wrapper.appendChild(separator);
                    }
                    var titleEl = document.createElement('span');
                    titleEl.className = 'fc-event-title';
                    titleEl.textContent = title;
                    wrapper.appendChild(titleEl);
                }
                return { domNodes: [wrapper] };
            }
        });

        calendar.render();

        var eventForm = document.querySelector('#calendarEventModal form');
        var startDateInput = document.getElementById('start_date');
        var endDateInput = document.getElementById('end_date');
        var timeFields = document.getElementById('timeFields');
        var startTimeInput = document.getElementById('start_time');
        var endTimeInput = document.getElementById('end_time');
        var birthdayCheckbox = document.getElementById('is_birthday');
        var birthdayWrapper = document.getElementById('birthdayUserWrapper');
        var birthdaySelect = document.getElementById('birthday_user_id');
        var birthdayRecurringWrapper = document.getElementById('birthdayRecurringWrapper');
        var birthdayRecurringCheckbox = document.getElementById('birthday_recurs_annually');
        var birthdayRecurrenceYearsSelect = document.getElementById('birthday_recurrence_years');
        var absenceCheckbox = document.getElementById('is_absence');
        var vacationCheckbox = document.getElementById('is_vacation');
        var noticeCheckbox = document.getElementById('is_notice');
        var previousBirthdayParticipantId = null;
        var autoBirthdayTitle = '';

        function updateTimeFieldsVisibility() {
            if (!timeFields || !startDateInput || !endDateInput) { return; }
            if (birthdayCheckbox && birthdayCheckbox.checked) {
                timeFields.classList.add('d-none');
                if (startTimeInput) {
                    startTimeInput.value = '';
                    startTimeInput.disabled = true;
                }
                if (endTimeInput) {
                    endTimeInput.value = '';
                    endTimeInput.disabled = true;
                }
                return;
            }
            var startValue = startDateInput.value;
            var endValue = endDateInput.value || startValue;
            var sameDay = Boolean(startValue) && Boolean(endValue) && startValue === endValue;
            if (sameDay) {
                timeFields.classList.remove('d-none');
                if (startTimeInput) { startTimeInput.disabled = false; }
                if (endTimeInput) { endTimeInput.disabled = false; }
            } else {
                timeFields.classList.add('d-none');
                if (startTimeInput) {
                    startTimeInput.value = '';
                    startTimeInput.disabled = true;
                }
                if (endTimeInput) {
                    endTimeInput.value = '';
                    endTimeInput.disabled = true;
                }
            }
        }

        function setParticipantSelection(userId, shouldSelect) {
            if (!userId) { return; }
            document.querySelectorAll('#calendarEventModal input[name="participants"]').forEach(function(cb) {
                if (parseInt(cb.value, 10) === parseInt(userId, 10)) {
                    cb.checked = shouldSelect;
                }
            });
        }

        function syncBirthdayParticipantSelection(userId) {
            if (!canManage) { return; }
            if (previousBirthdayParticipantId && previousBirthdayParticipantId !== userId) {
                setParticipantSelection(previousBirthdayParticipantId, false);
            }
            if (userId) {
                setParticipantSelection(userId, true);
            }
            previousBirthdayParticipantId = userId || null;
        }

        function applyBirthdayTitle(userId) {
            if (!eventForm || !eventForm.title) { return; }
            var currentTitle = eventForm.title.value.trim();
            var shouldUpdate = currentTitle === '' || currentTitle === autoBirthdayTitle;
            autoBirthdayTitle = '';
            if (userId && birthdaySelect) {
                var selectedOption = birthdaySelect.options[birthdaySelect.selectedIndex];
                if (selectedOption) {
                    autoBirthdayTitle = 'Aniversário - ' + selectedOption.text.trim();
                }
            }
            if (shouldUpdate) {
                eventForm.title.value = autoBirthdayTitle;
            }
        }

        function syncBirthdayRecurrenceControls() {
            if (!birthdayRecurrenceYearsSelect) { return; }
            if (birthdayRecurringCheckbox && birthdayRecurringCheckbox.checked) {
                birthdayRecurrenceYearsSelect.disabled = false;
            } else {
                birthdayRecurrenceYearsSelect.value = '1';
                birthdayRecurrenceYearsSelect.disabled = true;
            }
        }

        function syncBirthdayState() {
            if (!birthdayWrapper || !birthdaySelect || !endDateInput) {
                updateTimeFieldsVisibility();
                return;
            }
            var isBirthday = birthdayCheckbox && birthdayCheckbox.checked;
            if (isBirthday) {
                birthdayWrapper.classList.remove('d-none');
                birthdaySelect.disabled = false;
                if (birthdayRecurringWrapper) {
                    birthdayRecurringWrapper.classList.remove('d-none');
                }
                if (birthdayRecurringCheckbox) {
                    birthdayRecurringCheckbox.disabled = false;
                    if (!birthdayRecurringCheckbox.dataset.userToggled && !birthdayRecurringCheckbox.checked) {
                        birthdayRecurringCheckbox.checked = true;
                    }
                }
                syncBirthdayRecurrenceControls();
                var selectedId = parseInt(birthdaySelect.value || '0', 10) || null;
                if (startDateInput && startDateInput.value) {
                    endDateInput.value = startDateInput.value;
                }
                endDateInput.disabled = true;
                syncBirthdayParticipantSelection(selectedId);
                applyBirthdayTitle(selectedId);
            } else {
                birthdayWrapper.classList.add('d-none');
                birthdaySelect.value = '0';
                endDateInput.disabled = false;
                applyBirthdayTitle(null);
                syncBirthdayParticipantSelection(null);
                if (birthdayRecurringWrapper) {
                    birthdayRecurringWrapper.classList.add('d-none');
                }
                if (birthdayRecurringCheckbox) {
                    birthdayRecurringCheckbox.checked = false;
                    birthdayRecurringCheckbox.disabled = true;
                    delete birthdayRecurringCheckbox.dataset.userToggled;
                }
                if (birthdayRecurrenceYearsSelect) {
                    birthdayRecurrenceYearsSelect.value = '1';
                    birthdayRecurrenceYearsSelect.disabled = true;
                }
            }
            updateTimeFieldsVisibility();
        }

        function handleSpecialCheckboxChange(checkbox, callback) {
            if (!checkbox) { return; }
            checkbox.addEventListener('change', function() {
                if (checkbox.checked) {
                    [birthdayCheckbox, absenceCheckbox, vacationCheckbox, noticeCheckbox].forEach(function(other) {
                        if (other && other !== checkbox) {
                            other.checked = false;
                        }
                    });
                }
                if (typeof callback === 'function') {
                    callback();
                }
                if (checkbox !== birthdayCheckbox) {
                    syncBirthdayState();
                }
                updateTimeFieldsVisibility();
            });
        }

        updateTimeFieldsVisibility();
        if (birthdaySelect && birthdaySelect.value && birthdaySelect.value !== '0') {
            previousBirthdayParticipantId = parseInt(birthdaySelect.value, 10) || null;
        }
        syncBirthdayState();

        if (startDateInput) {
            startDateInput.addEventListener('change', function() {
                if (birthdayCheckbox && birthdayCheckbox.checked && endDateInput) {
                    endDateInput.value = startDateInput.value;
                }
                updateTimeFieldsVisibility();
            });
        }
        if (endDateInput) {
            endDateInput.addEventListener('change', updateTimeFieldsVisibility);
        }
        handleSpecialCheckboxChange(birthdayCheckbox, syncBirthdayState);
        handleSpecialCheckboxChange(absenceCheckbox);
        handleSpecialCheckboxChange(vacationCheckbox);
        handleSpecialCheckboxChange(noticeCheckbox);
        if (birthdayRecurringCheckbox) {
            birthdayRecurringCheckbox.addEventListener('change', function() {
                if (birthdayRecurringCheckbox.checked || !birthdayCheckbox || birthdayCheckbox.checked) {
                    birthdayRecurringCheckbox.dataset.userToggled = '1';
                } else {
                    delete birthdayRecurringCheckbox.dataset.userToggled;
                }
                syncBirthdayRecurrenceControls();
            });
        }
        if (birthdayRecurrenceYearsSelect) {
            birthdayRecurrenceYearsSelect.addEventListener('change', function() {
                birthdayRecurrenceYearsSelect.dataset.userToggled = '1';
            });
        }
        if (birthdaySelect) {
            birthdaySelect.addEventListener('change', function() {
                var selectedId = parseInt(birthdaySelect.value || '0', 10) || null;
                syncBirthdayParticipantSelection(selectedId);
                applyBirthdayTitle(selectedId);
            });
        }

        function cloneEvent(ev) {
            var copy = Object.assign({}, ev);
            if (ev.extendedProps) {
                copy.extendedProps = Object.assign({}, ev.extendedProps);
            }
            return copy;
        }

        function eventPayloadStartKey(ev) {
            var date = '';
            if (ev.start_date) {
                date = ev.start_date;
            } else if (ev.start && typeof ev.start === 'string') {
                date = ev.start.split('T')[0];
            }
            var time = '';
            if (ev.start_time) {
                time = ev.start_time;
            }
            return { date: date, time: time };
        }

        function loadEvents() {
            fetch('/api/calendario-eventos')
                .then(function(resp) { return resp.json(); })
                .then(function(data) {
                    calendar.removeAllEvents();
                    data.sort(function(a, b) {
                        var keyA = eventPayloadStartKey(a);
                        var keyB = eventPayloadStartKey(b);
                        if (keyA.date && keyB.date && keyA.date !== keyB.date) {
                            return keyA.date < keyB.date ? -1 : 1;
                        }
                        if (keyA.date && !keyB.date) { return -1; }
                        if (!keyA.date && keyB.date) { return 1; }
                        if (keyA.time && keyB.time && keyA.time !== keyB.time) {
                            return keyA.time < keyB.time ? -1 : 1;
                        }
                        if (keyA.time && !keyB.time) { return 1; }
                        if (!keyA.time && keyB.time) { return -1; }
                        var aTadeu = Boolean(
                            (a.extendedProps && a.extendedProps.is_tadeu_event) || a.is_tadeu_event
                        );
                        var bTadeu = Boolean(
                            (b.extendedProps && b.extendedProps.is_tadeu_event) || b.is_tadeu_event
                        );
                        if (aTadeu !== bTadeu) {
                            return aTadeu ? -1 : 1;
                        }
                        var titleA = (a.title || '').toLocaleLowerCase();
                        var titleB = (b.title || '').toLocaleLowerCase();
                        if (titleA < titleB) { return -1; }
                        if (titleA > titleB) { return 1; }
                        return 0;
                    });
                    data.forEach(function(ev) {
                        if (!ev.extendedProps) {
                            ev.extendedProps = {};
                        }
                        if (typeof ev.is_tadeu_event !== 'undefined') {
                            ev.extendedProps.is_tadeu_event = ev.is_tadeu_event;
                        }
                        if (typeof ev.is_birthday !== 'undefined') {
                            ev.extendedProps.is_birthday = ev.is_birthday;
                        }
                        if (typeof ev.is_vacation !== 'undefined') {
                            ev.extendedProps.is_vacation = ev.is_vacation;
                        }
                        if (typeof ev.is_absence !== 'undefined') {
                            ev.extendedProps.is_absence = ev.is_absence;
                        }
                        if (typeof ev.is_vacation_event !== 'undefined') {
                            ev.extendedProps.is_vacation_event = ev.is_vacation_event;
                        }
                        if (typeof ev.is_absence_event !== 'undefined') {
                            ev.extendedProps.is_absence_event = ev.is_absence_event;
                        }
                        if (typeof ev.is_notice !== 'undefined') {
                            ev.extendedProps.is_notice = ev.is_notice;
                        }
                        if (typeof ev.birthday_recurs_annually !== 'undefined') {
                            ev.extendedProps.birthday_recurs_annually = ev.birthday_recurs_annually;
                        }
                        if (typeof ev.birthday_recurrence_years !== 'undefined') {
                            ev.extendedProps.birthday_recurrence_years = ev.birthday_recurrence_years;
                        }
                        if (typeof ev.birthday_user_id !== 'undefined') {
                            ev.extendedProps.birthday_user_id = ev.birthday_user_id;
                        }
                        if (typeof ev.birthday_user_name !== 'undefined') {
                            ev.extendedProps.birthday_user_name = ev.birthday_user_name;
                        }
                        if (typeof ev.originalId !== 'undefined') {
                            ev.extendedProps.originalId = ev.originalId;
                        }
                        if (ev.allDay) {
                            var startDate = parseUTCDate(ev.start_date || ev.start);
                            var endDate = parseUTCDate(ev.end_date || ev.end);
                            if (!startDate) {
                                calendar.addEvent(ev);
                                return;
                            }
                            if (!endDate || endDate < startDate) {
                                endDate = new Date(startDate.getTime());
                            }
                            var totalDays = Math.max(1, Math.floor((endDate.getTime() - startDate.getTime()) / MS_IN_DAY) + 1);
                            var current = new Date(startDate.getTime());
                            var segmentIndex = 0;
                            while (current <= endDate) {
                                var segmentStart = new Date(current.getTime());
                                var segmentEnd = new Date(current.getTime());
                                segmentEnd.setUTCDate(segmentEnd.getUTCDate() + 1);
                                var segment = cloneEvent(ev);
                                if (!segment.extendedProps) {
                                    segment.extendedProps = {};
                                }
                                var baseOriginalId = ev.originalId || ev.id;
                                segment.extendedProps.originalId = baseOriginalId;
                                segment.extendedProps.spanDays = totalDays;
                                if (typeof segment.is_tadeu_event !== 'undefined') {
                                    segment.extendedProps.is_tadeu_event = segment.is_tadeu_event;
                                }
                                if (typeof segment.is_birthday !== 'undefined') {
                                    segment.extendedProps.is_birthday = segment.is_birthday;
                                }
                                if (typeof segment.is_notice !== 'undefined') {
                                    segment.extendedProps.is_notice = segment.is_notice;
                                }
                                if (typeof ev.is_notice !== 'undefined') {
                                    segment.extendedProps.is_notice = ev.is_notice;
                                }
                                if (typeof ev.birthday_recurs_annually !== 'undefined') {
                                    segment.extendedProps.birthday_recurs_annually = ev.birthday_recurs_annually;
                                }
                                if (typeof ev.birthday_recurrence_years !== 'undefined') {
                                    segment.extendedProps.birthday_recurrence_years = ev.birthday_recurrence_years;
                                }
                                if (typeof ev.birthday_user_id !== 'undefined') {
                                    segment.extendedProps.birthday_user_id = ev.birthday_user_id;
                                }
                                if (typeof ev.birthday_user_name !== 'undefined') {
                                    segment.extendedProps.birthday_user_name = ev.birthday_user_name;
                                }
                                segment.originalId = baseOriginalId;
                                if (segmentIndex === 0) {
                                    segment.id = ev.id;
                                } else {
                                    segment.id = ev.id + '-seg-' + segmentIndex;
                                }
                                segment.start = formatUTCDate(segmentStart);
                                segment.end = formatUTCDate(segmentEnd);
                                segment.display = 'block';
                                if (typeof ev.is_tadeu_event !== 'undefined') {
                                    segment.is_tadeu_event = ev.is_tadeu_event;
                                }
                                if (typeof ev.is_birthday !== 'undefined') {
                                    segment.is_birthday = ev.is_birthday;
                                }
                                calendar.addEvent(segment);
                                segmentIndex += 1;
                                current.setUTCDate(current.getUTCDate() + 1);
                            }
                        } else {
                            if (!ev.extendedProps) {
                                ev.extendedProps = {};
                            }
                            ev.extendedProps.spanDays = 1;
                            if (typeof ev.is_tadeu_event !== 'undefined') {
                                ev.extendedProps.is_tadeu_event = ev.is_tadeu_event;
                            }
                            if (typeof ev.is_birthday !== 'undefined') {
                                ev.extendedProps.is_birthday = ev.is_birthday;
                            }
                            if (typeof ev.birthday_recurs_annually !== 'undefined') {
                                ev.extendedProps.birthday_recurs_annually = ev.birthday_recurs_annually;
                            }
                            if (typeof ev.birthday_recurrence_years !== 'undefined') {
                                ev.extendedProps.birthday_recurrence_years = ev.birthday_recurrence_years;
                            }
                            if (typeof ev.originalId !== 'undefined') {
                                ev.extendedProps.originalId = ev.originalId;
                            }
                            calendar.addEvent(ev);
                        }
                    });
                });
        }

        function openNewEvent(dateStr) {
            var form = document.querySelector('#calendarEventModal form');
            form.reset();
            document.getElementById('event_id').value = '';
            previousBirthdayParticipantId = null;
            autoBirthdayTitle = '';
            if (birthdayCheckbox) {
                birthdayCheckbox.checked = false;
            }
            if (birthdaySelect) {
                birthdaySelect.value = '0';
            }
            if (birthdayRecurringCheckbox) {
                birthdayRecurringCheckbox.checked = false;
                birthdayRecurringCheckbox.disabled = true;
                delete birthdayRecurringCheckbox.dataset.userToggled;
            }
            if (birthdayWrapper) {
                birthdayWrapper.classList.add('d-none');
            }
            if (birthdayRecurringWrapper) {
                birthdayRecurringWrapper.classList.add('d-none');
            }
            if (birthdayRecurrenceYearsSelect) {
                birthdayRecurrenceYearsSelect.value = '1';
                birthdayRecurrenceYearsSelect.disabled = true;
                delete birthdayRecurrenceYearsSelect.dataset.userToggled;
            }
            if (absenceCheckbox) {
                absenceCheckbox.checked = false;
            }
            if (vacationCheckbox) {
                vacationCheckbox.checked = false;
            }
            if (noticeCheckbox) {
                noticeCheckbox.checked = false;
            }
            if (dateStr) {
                form.start_date.value = dateStr;
                form.end_date.value = dateStr;
            }
            if (startTimeInput) { startTimeInput.value = ''; }
            if (endTimeInput) { endTimeInput.value = ''; }
            document.querySelector('#calendarEventModal .modal-title').textContent = 'Novo Evento';
            document.querySelector('#calendarEventModal input[type="submit"]').value = 'Salvar';
            updateTimeFieldsVisibility();
            syncBirthdayState();
            var modal = new bootstrap.Modal(document.getElementById('calendarEventModal'));
            modal.show();
        }

        function formatDate(value) {
            var parts = value.split('-');
            return parts.reverse().join('/');
        }

        {% if can_manage %}
        var openBtn = document.getElementById('openEventModal');
        if (openBtn) {
            openBtn.addEventListener('click', function() {
                openNewEvent('');
            });
        }

        document.getElementById('editEventBtn').addEventListener('click', function() {
            var detailModal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
            detailModal.hide();
            var form = document.querySelector('#calendarEventModal form');
            var targetId = currentEventOriginalId || currentEvent.id || '';
            document.getElementById('event_id').value = targetId;
            form.title.value = currentEvent.title;
            form.start_date.value = currentEvent.extendedProps.start_date;
            form.end_date.value = currentEvent.extendedProps.end_date;
            if (startTimeInput) {
                startTimeInput.value = currentEvent.extendedProps.start_time || '';
            }
            if (endTimeInput) {
                endTimeInput.value = currentEvent.extendedProps.end_time || '';
            }
            form.description.value = currentEvent.extendedProps.description || '';
            var ids = currentEvent.extendedProps.participant_ids || [];
            document.querySelectorAll('#calendarEventModal input[name="participants"]').forEach(function(cb) {
                cb.checked = ids.includes(parseInt(cb.value));
            });
            if (birthdayCheckbox) {
                birthdayCheckbox.checked = Boolean(
                    currentEvent.extendedProps.is_birthday || currentEvent.is_birthday
                );
            }
            if (birthdaySelect) {
                var birthdayId = currentEvent.extendedProps.birthday_user_id || currentEvent.birthday_user_id || 0;
                birthdaySelect.value = birthdayId ? String(birthdayId) : '0';
            }
            if (absenceCheckbox) {
                absenceCheckbox.checked = Boolean(
                    (currentEvent.extendedProps && (
                        currentEvent.extendedProps.is_absence ||
                        currentEvent.extendedProps.is_absence_event
                    )) || currentEvent.is_absence || currentEvent.is_absence_event
                );
            }
            if (vacationCheckbox) {
                vacationCheckbox.checked = Boolean(
                    (currentEvent.extendedProps && (
                        currentEvent.extendedProps.is_vacation ||
                        currentEvent.extendedProps.is_vacation_event
                    )) || currentEvent.is_vacation || currentEvent.is_vacation_event
                );
            }
            if (noticeCheckbox) {
                noticeCheckbox.checked = Boolean(
                    (currentEvent.extendedProps && currentEvent.extendedProps.is_notice) || currentEvent.is_notice
                );
            }
            if (birthdayRecurringCheckbox) {
                var recursAnnual = Boolean(
                    currentEvent.extendedProps.birthday_recurs_annually || currentEvent.birthday_recurs_annually
                );
                birthdayRecurringCheckbox.checked = recursAnnual;
                if (birthdayCheckbox && birthdayCheckbox.checked) {
                    birthdayRecurringCheckbox.dataset.userToggled = '1';
                } else {
                    delete birthdayRecurringCheckbox.dataset.userToggled;
                }
            }
            if (birthdayRecurrenceYearsSelect) {
                var recurrenceYears = currentEvent.extendedProps.birthday_recurrence_years
                    || currentEvent.birthday_recurrence_years
                    || 1;
                birthdayRecurrenceYearsSelect.value = String(recurrenceYears);
                if (birthdayRecurringCheckbox && birthdayRecurringCheckbox.checked) {
                    birthdayRecurrenceYearsSelect.dataset.userToggled = '1';
                } else {
                    delete birthdayRecurrenceYearsSelect.dataset.userToggled;
                }
            }
            previousBirthdayParticipantId = (birthdaySelect && birthdaySelect.value !== '0')
                ? (parseInt(birthdaySelect.value, 10) || null)
                : null;
            syncBirthdayState();
            updateTimeFieldsVisibility();
            document.querySelector('#calendarEventModal .modal-title').textContent = 'Editar Evento';
            document.querySelector('#calendarEventModal input[type="submit"]').value = 'Salvar';
            var modal = new bootstrap.Modal(document.getElementById('calendarEventModal'));
            modal.show();
        });

        document.getElementById('deleteEventBtn').addEventListener('click', function() {
            if (confirm('Deseja excluir este evento?')) {
                document.getElementById('deleteEventForm').submit();
            }
        });
        {% endif %}

        loadEvents();
    });
    </script>
    {% if show_modal and can_manage %}
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            var modal = new bootstrap.Modal(document.getElementById('calendarEventModal'));
            modal.show();
        });
        </script>
    {% endif %}
{% endblock %}
